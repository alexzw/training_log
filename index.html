<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Training Log</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f5f7;
    --surface: #ffffff;
    --surface2: #f5f5f7;
    --surface3: #e8e8ed;
    --border: rgba(0,0,0,0.08);
    --border2: rgba(0,0,0,0.12);
    --accent: #0071e3;
    --accent-hover: #0077ed;
    --accent-light: rgba(0,113,227,0.08);
    --red: #ff3b30;
    --red-light: rgba(255,59,48,0.1);
    --green: #30d158;
    --green-light: rgba(48,209,88,0.1);
    --orange: #ff9f0a;
    --orange-light: rgba(255,159,10,0.1);
    --text: #1d1d1f;
    --text2: #6e6e73;
    --text3: #a1a1a6;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow: 0 4px 16px rgba(0,0,0,0.08), 0 1px 4px rgba(0,0,0,0.04);
    --shadow-lg: 0 8px 30px rgba(0,0,0,0.10), 0 2px 8px rgba(0,0,0,0.06);
    --radius: 14px;
    --radius-sm: 10px;
    --radius-xs: 8px;
    --sidebar-w: 240px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
    min-height: 100vh;
    font-size: 15px;
    line-height: 1.5;
  }

  /* ─── SIDEBAR ─── */
  .sidebar {
    position: fixed;
    left: 0; top: 0; bottom: 0;
    width: var(--sidebar-w);
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    z-index: 100;
    padding: 0;
  }

  .sidebar-header {
    padding: 28px 20px 20px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 11px;
    text-decoration: none;
  }

  .logo-icon {
    width: 36px;
    height: 36px;
    background: linear-gradient(145deg, #1d1d1f 0%, #3a3a3c 100%);
    border-radius: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }

  .logo-icon svg { width: 20px; height: 20px; }

  .logo-text {
    display: flex;
    flex-direction: column;
    line-height: 1.15;
  }

  .logo-name {
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.2px;
  }

  .logo-sub {
    font-size: 11px;
    color: var(--text3);
    font-weight: 400;
    letter-spacing: 0.1px;
  }

  nav {
    padding: 12px 10px;
    flex: 1;
    overflow-y: auto;
  }

  .nav-section-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text3);
    letter-spacing: 0.5px;
    padding: 10px 10px 4px;
    text-transform: uppercase;
  }

  nav a {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 9px 10px;
    border-radius: var(--radius-xs);
    color: var(--text2);
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.15s ease;
    cursor: pointer;
    margin-bottom: 2px;
  }

  nav a:hover { background: var(--surface3); color: var(--text); }

  nav a.active {
    background: var(--accent-light);
    color: var(--accent);
    font-weight: 600;
  }

  nav a .nav-icon {
    width: 28px;
    height: 28px;
    border-radius: 7px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    flex-shrink: 0;
    background: var(--surface3);
    transition: background 0.15s;
  }

  nav a.active .nav-icon { background: var(--accent); filter: none; }
  nav a.active .nav-icon span { filter: brightness(10); }

  .sidebar-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    font-size: 12px;
    color: var(--text3);
  }

  /* ─── MAIN ─── */
  .main {
    margin-left: var(--sidebar-w);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ─── TOPBAR ─── */
  .topbar {
    position: sticky;
    top: 0;
    background: rgba(245,245,247,0.9);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-bottom: 1px solid var(--border);
    padding: 0 36px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 50;
  }

  .topbar-title {
    font-size: 17px;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.3px;
  }

  .topbar-date {
    font-size: 13px;
    color: var(--text3);
    font-weight: 400;
  }

  .content { padding: 28px 36px; flex: 1; }

  /* ─── PAGES ─── */
  .page { display: none; animation: fadeUp 0.25s ease; }
  .page.active { display: block; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ─── CARDS ─── */
  .card {
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 24px;
    box-shadow: var(--shadow-sm);
  }

  .card-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text2);
    letter-spacing: 0.1px;
    margin-bottom: 18px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* ─── STATS GRID ─── */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 20px 22px;
    box-shadow: var(--shadow-sm);
    transition: box-shadow 0.2s, transform 0.2s;
  }

  .stat-card:hover { box-shadow: var(--shadow); transform: translateY(-1px); }

  .stat-label {
    font-size: 12px;
    font-weight: 500;
    color: var(--text3);
    margin-bottom: 6px;
    letter-spacing: 0.1px;
  }

  .stat-value {
    font-size: 34px;
    font-weight: 700;
    letter-spacing: -1.5px;
    line-height: 1;
    color: var(--text);
    margin-bottom: 4px;
  }

  .stat-unit { font-size: 13px; color: var(--text3); margin-bottom: 6px; }

  .stat-change {
    font-size: 12px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 4px;
  }

  .stat-change.up { color: var(--red); }
  .stat-change.down { color: var(--green); }
  .stat-change.neutral { color: var(--text3); }

  /* ─── DASHBOARD GRID ─── */
  .dashboard-grid {
    display: grid;
    grid-template-columns: 3fr 2fr;
    gap: 16px;
  }

  /* ─── CHART ─── */
  .weight-chart { height: 180px; }
  .chart-svg { width: 100%; height: 100%; overflow: visible; }

  /* ─── FORM ─── */
  .log-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
  }

  .form-group { margin-bottom: 14px; }

  .form-label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: var(--text2);
    margin-bottom: 6px;
  }

  .form-input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: var(--radius-xs);
    color: var(--text);
    padding: 10px 13px;
    font-family: inherit;
    font-size: 14px;
    outline: none;
    transition: border-color 0.15s, box-shadow 0.15s;
    appearance: none;
  }

  .form-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,113,227,0.15);
    background: var(--surface);
  }

  textarea.form-input { resize: vertical; min-height: 90px; line-height: 1.5; }
  select.form-input { cursor: pointer; }

  /* ─── BUTTONS ─── */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 20px;
    font-family: inherit;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    border-radius: 980px;
    transition: all 0.15s ease;
    white-space: nowrap;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
  }

  .btn-primary:hover { background: var(--accent-hover); box-shadow: 0 2px 8px rgba(0,113,227,0.3); }
  .btn-primary:active { transform: scale(0.98); }

  .btn-secondary {
    background: var(--surface3);
    color: var(--text);
  }

  .btn-secondary:hover { background: #dcdce0; }

  .btn-danger {
    background: var(--red-light);
    color: var(--red);
    font-size: 12px;
    padding: 6px 14px;
    border-radius: 6px;
    font-weight: 500;
  }

  .btn-danger:hover { background: rgba(255,59,48,0.18); }

  /* ─── PHOTO UPLOAD ─── */
  .photo-upload-area {
    border: 2px dashed var(--border2);
    border-radius: var(--radius-sm);
    padding: 32px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    background: var(--surface2);
  }

  .photo-upload-area:hover { border-color: var(--accent); background: var(--accent-light); }
  .photo-upload-area input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

  .photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
    margin-top: 14px;
  }

  .photo-item {
    position: relative;
    aspect-ratio: 3/4;
    overflow: hidden;
    background: var(--surface3);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
  }

  .photo-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
  .photo-item:hover img { transform: scale(1.04); }

  .photo-item .photo-date {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.55));
    padding: 20px 10px 8px;
    font-size: 11px;
    color: #fff;
    font-weight: 500;
  }

  .photo-item .photo-delete {
    position: absolute;
    top: 7px; right: 7px;
    background: rgba(255,59,48,0.85);
    color: white;
    border: none;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    font-size: 12px;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  .photo-item:hover .photo-delete { display: flex; }

  /* ─── WORKOUT ENTRIES ─── */
  .workout-list { display: flex; flex-direction: column; gap: 10px; }

  .workout-entry {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px 18px;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 12px;
    align-items: start;
    box-shadow: var(--shadow-sm);
    transition: box-shadow 0.2s;
  }

  .workout-entry:hover { box-shadow: var(--shadow); }

  .workout-entry.rest { opacity: 0.7; }

  .entry-date { font-size: 12px; color: var(--text3); margin-bottom: 4px; font-weight: 400; }

  .entry-title { font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 6px; }

  .entry-meta { display: flex; gap: 6px; flex-wrap: wrap; }

  .entry-tag {
    font-size: 12px;
    font-weight: 500;
    background: var(--accent-light);
    color: var(--accent);
    padding: 3px 10px;
    border-radius: 20px;
  }

  .entry-tag.red { background: var(--red-light); color: var(--red); }
  .entry-tag.green { background: var(--green-light); color: var(--green); }

  .entry-exercises {
    margin-top: 8px;
    font-size: 13px;
    color: var(--text2);
    white-space: pre-line;
    line-height: 1.6;
  }

  .entry-notes {
    margin-top: 5px;
    font-size: 13px;
    color: var(--text3);
    font-style: italic;
  }

  /* ─── PLAN CARDS ─── */
  .plan-phases {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
  }

  .phase-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 22px;
    box-shadow: var(--shadow-sm);
    transition: box-shadow 0.2s, transform 0.2s;
    position: relative;
  }

  .phase-card:hover { box-shadow: var(--shadow); transform: translateY(-2px); }

  .phase-card.active-phase { border-color: var(--accent); border-width: 1.5px; }

  .active-badge {
    display: inline-flex;
    align-items: center;
    background: var(--accent);
    color: #fff;
    font-size: 10px;
    font-weight: 700;
    padding: 3px 9px;
    border-radius: 20px;
    letter-spacing: 0.3px;
    margin-bottom: 12px;
    text-transform: uppercase;
  }

  .phase-name { font-size: 18px; font-weight: 700; letter-spacing: -0.4px; margin-bottom: 4px; }
  .phase-duration { font-size: 12px; color: var(--text3); margin-bottom: 14px; }

  .phase-exercises { list-style: none; display: flex; flex-direction: column; gap: 6px; }

  .phase-exercises li {
    font-size: 13px;
    color: var(--text2);
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }

  .phase-exercises li::before {
    content: '';
    display: block;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--accent);
    flex-shrink: 0;
    margin-top: 6px;
  }

  /* ─── PROGRESS BAR ─── */
  .progress-bar {
    height: 5px;
    background: var(--surface3);
    border-radius: 10px;
    margin-top: 14px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #34aadc);
    border-radius: 10px;
    transition: width 0.6s cubic-bezier(0.22,1,0.36,1);
  }

  /* ─── GOAL CARDS ─── */
  .goal-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 20px;
    align-items: center;
    margin-bottom: 14px;
    box-shadow: var(--shadow-sm);
  }

  .goal-title { font-size: 16px; font-weight: 600; margin-bottom: 5px; }
  .goal-meta { font-size: 13px; color: var(--text2); line-height: 1.5; }

  .goal-circle { width: 70px; height: 70px; position: relative; flex-shrink: 0; }
  .goal-circle svg { transform: rotate(-90deg); }

  .goal-percent {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: -0.5px;
  }

  /* ─── WEIGHT TABLE ─── */
  .weight-table { width: 100%; border-collapse: collapse; }

  .weight-table th {
    font-size: 12px;
    font-weight: 600;
    color: var(--text3);
    text-align: left;
    padding: 8px 14px;
    border-bottom: 1px solid var(--border);
    letter-spacing: 0.2px;
  }

  .weight-table td {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
    color: var(--text);
  }

  .weight-table tr:last-child td { border-bottom: none; }
  .weight-table tbody tr:hover td { background: var(--surface2); }

  /* ─── BADGES ─── */
  .badge {
    display: inline-flex;
    align-items: center;
    font-size: 11px;
    font-weight: 600;
    padding: 3px 9px;
    border-radius: 20px;
  }

  .badge-green { background: var(--green-light); color: var(--green); }
  .badge-orange { background: var(--orange-light); color: var(--orange); }
  .badge-red { background: var(--red-light); color: var(--red); }
  .badge-blue { background: var(--accent-light); color: var(--accent); }

  /* ─── TOAST ─── */
  .toast {
    position: fixed;
    bottom: 28px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: rgba(28,28,30,0.92);
    backdrop-filter: blur(20px);
    color: #fff;
    padding: 12px 22px;
    border-radius: 980px;
    font-size: 14px;
    font-weight: 500;
    transition: transform 0.3s cubic-bezier(0.22,1,0.36,1), opacity 0.3s;
    z-index: 10000;
    opacity: 0;
    white-space: nowrap;
  }

  .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

  /* ─── SECTION TITLE ─── */
  .section-title {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: -0.5px;
    margin-bottom: 16px;
    color: var(--text);
  }

  /* ─── EMPTY STATE ─── */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text3);
    font-size: 14px;
  }

  .empty-state .empty-icon { font-size: 32px; margin-bottom: 10px; }

  /* ─── SEGMENT CONTROL (filter) ─── */
  .segment-control {
    display: inline-flex;
    background: var(--surface3);
    border-radius: 9px;
    padding: 3px;
    gap: 2px;
  }

  .segment-control select {
    background: transparent;
    border: none;
    padding: 6px 12px;
    font-family: inherit;
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    cursor: pointer;
    outline: none;
    border-radius: 7px;
  }

  .segment-control select:focus { background: var(--surface); }

  /* ─── DIVIDER ─── */
  hr.divider { border: none; border-top: 1px solid var(--border); margin: 24px 0; }

  /* ─── BOTTOM NAV (mobile only) ─── */
  .bottom-nav {
    display: none;
  }

  /* ─── RESPONSIVE TABLET ─── */
  @media (max-width: 960px) and (min-width: 601px) {
    :root { --sidebar-w: 200px; }
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .dashboard-grid { grid-template-columns: 1fr; }
    .log-grid { grid-template-columns: 1fr; }
    .content { padding: 20px 24px; }
  }

  /* ─── RESPONSIVE MOBILE ─── */
  @media (max-width: 600px) {
    :root { --sidebar-w: 0px; }

    /* hide sidebar entirely */
    .sidebar { display: none; }

    /* main takes full width */
    .main { margin-left: 0; padding-bottom: 72px; }

    /* topbar */
    .topbar { padding: 0 16px; height: 50px; }
    .topbar-title { font-size: 16px; }
    .topbar-date { font-size: 11px; }

    /* content */
    .content { padding: 14px 14px 16px; }

    /* stats */
    .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
    .stat-card { padding: 14px 16px; }
    .stat-value { font-size: 26px; }

    /* grids → single column */
    .dashboard-grid { grid-template-columns: 1fr; gap: 12px; }
    .log-grid { grid-template-columns: 1fr; gap: 12px; }
    .plan-phases { grid-template-columns: 1fr; }

    /* cards */
    .card { padding: 16px; border-radius: 12px; }
    .card-title { margin-bottom: 14px; }

    /* section title */
    .section-title { font-size: 17px; }

    /* weight chart */
    .weight-chart { height: 150px; }

    /* workout entry */
    .workout-entry { padding: 12px 14px; }

    /* photo grid */
    .photo-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }

    /* buttons */
    .btn { padding: 11px 18px; font-size: 14px; width: 100%; justify-content: center; }
    .btn-danger { width: auto; }

    /* form inputs bigger for touch */
    .form-input { padding: 12px 13px; font-size: 15px; }
    .form-label { font-size: 13px; }

    /* goal card */
    .goal-card { grid-template-columns: 1fr; gap: 12px; }

    /* BMI + calorie row → stack on mobile */
    #bmi-calorie-row { grid-template-columns: 1fr !important; }
    .bmi-card { grid-column: 1 !important; }
    .bmi-value { font-size: 28px; }
    .bmi-labels { font-size: 9px; }
    /* inline height edit — stack on mobile */

    .goal-circle { margin: 0 auto; }

    /* table scroll */
    .weight-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .weight-table { min-width: 360px; }

    /* user dropdown wider */
    .user-dropdown { left: 0; right: 0; border-radius: 0 0 12px 12px; }

    /* bottom nav */
    .bottom-nav {
      display: flex;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 64px;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-top: 1px solid var(--border);
      z-index: 100;
      align-items: stretch;
      padding: 0 4px;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .bottom-nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      cursor: pointer;
      border-radius: 10px;
      transition: background 0.15s;
      padding: 6px 2px;
      color: var(--text3);
      font-size: 10px;
      font-weight: 500;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .bottom-nav-item:active { background: var(--surface3); }
    .bottom-nav-item.active { color: var(--accent); }

    .bottom-nav-icon { font-size: 20px; line-height: 1; }
    .bottom-nav-label { font-size: 9.5px; font-weight: 500; letter-spacing: 0.1px; }

    /* topbar user button on mobile */
    .topbar-user {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 20px;
      background: var(--surface3);
    }

    .topbar-user-avatar {
      width: 24px; height: 24px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-size: 10px; font-weight: 700;
    }

    .topbar-user-name { font-size: 13px; font-weight: 600; color: var(--text); max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* mobile user modal */
    .mobile-user-modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 500;
    }

    .mobile-user-modal.open { display: block; }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(4px);
    }

    .modal-sheet {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background: var(--surface);
      border-radius: 20px 20px 0 0;
      padding: 12px 0 32px;
      box-shadow: 0 -4px 30px rgba(0,0,0,0.12);
      animation: slideSheet 0.28s cubic-bezier(0.22,1,0.36,1);
    }

    @keyframes slideSheet {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .modal-handle {
      width: 36px; height: 4px;
      background: var(--surface3);
      border-radius: 2px;
      margin: 0 auto 16px;
    }

    .modal-title {
      font-size: 13px; font-weight: 600;
      color: var(--text3); text-transform: uppercase;
      letter-spacing: 0.5px; padding: 0 20px 8px;
    }

    .modal-user-item {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 20px; cursor: pointer;
      font-size: 15px; font-weight: 500;
      -webkit-tap-highlight-color: transparent;
    }

    .modal-user-item:active { background: var(--surface2); }
    .modal-user-item.selected { color: var(--accent); }

    .modal-user-avatar {
      width: 36px; height: 36px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-size: 14px; font-weight: 700;
    }

    .modal-check { margin-left: auto; color: var(--accent); font-size: 16px; }
    .modal-del { margin-left: auto; color: var(--red); font-size: 13px; background: var(--red-light); border: none; padding: 4px 10px; border-radius: 8px; font-family: inherit; cursor: pointer; }

    .modal-add-row {
      display: flex; gap: 10px;
      padding: 12px 20px 4px;
      border-top: 1px solid var(--border);
      margin-top: 8px;
    }

    .modal-add-input {
      flex: 1; background: var(--surface2); border: 1px solid var(--border2);
      border-radius: 10px; padding: 10px 14px;
      font-family: inherit; font-size: 15px; color: var(--text); outline: none;
    }

    .modal-add-input:focus { border-color: var(--accent); }

    .modal-add-btn {
      background: var(--accent); color: #fff; border: none;
      border-radius: 10px; padding: 10px 16px;
      font-size: 15px; font-weight: 600; cursor: pointer; font-family: inherit;
    }
  }

  /* ─── CHART TOOLTIP ─── */
  .chart-tooltip {
    position: absolute;
    background: rgba(28,28,30,0.88);
    backdrop-filter: blur(12px);
    color: #fff;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    white-space: nowrap;
    z-index: 10;
  }

  .chart-wrap { position: relative; }

  /* ─── WORKOUT TIMER ─── */
  .timer-display {
    text-align: center;
    padding: 32px 20px;
  }
  .timer-clock {
    font-size: 72px;
    font-weight: 700;
    letter-spacing: -3px;
    color: var(--text);
    font-variant-numeric: tabular-nums;
    line-height: 1;
    margin-bottom: 6px;
  }
  .timer-label {
    font-size: 13px;
    color: var(--text3);
    font-weight: 500;
    margin-bottom: 28px;
  }
  .timer-controls {
    display: flex;
    justify-content: center;
    gap: 14px;
    flex-wrap: wrap;
  }
  .timer-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 13px 28px;
    border-radius: 980px;
    font-size: 15px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.15s;
  }
  .timer-btn-start { background: var(--green); color: #fff; }
  .timer-btn-start:hover { background: #27b84a; }
  .timer-btn-pause { background: var(--orange); color: #fff; }
  .timer-btn-pause:hover { background: #e08c00; }
  .timer-btn-stop { background: var(--red); color: #fff; }
  .timer-btn-stop:hover { background: #e0332a; }
  .timer-btn-resume { background: var(--accent); color: #fff; }
  .timer-btn-resume:hover { background: var(--accent-hover); }

  .workout-set-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr auto;
    gap: 8px;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
  }
  .workout-set-row:last-child { border-bottom: none; }
  .set-input {
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 8px;
    padding: 8px 10px;
    font-size: 13px;
    font-family: inherit;
    color: var(--text);
    width: 100%;
    outline: none;
  }
  .set-input:focus { border-color: var(--accent); }
  .set-del-btn {
    background: none;
    border: none;
    color: var(--text3);
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
    line-height: 1;
    border-radius: 6px;
    transition: color 0.15s;
  }
  .set-del-btn:hover { color: var(--red); }
  .workout-ex-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    margin-bottom: 12px;
    overflow: hidden;
  }
  .workout-ex-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
  }
  .workout-ex-name {
    flex: 1;
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
  }
  .workout-ex-body { padding: 10px 16px 14px; }
  .set-col-labels {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr auto;
    gap: 8px;
    font-size: 11px;
    font-weight: 600;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    padding: 0 0 6px;
  }
  .add-set-btn {
    background: none;
    border: 1.5px dashed var(--border2);
    color: var(--accent);
    border-radius: 8px;
    padding: 7px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    width: 100%;
    margin-top: 8px;
    transition: background 0.12s;
  }
  .add-set-btn:hover { background: var(--accent-light); }
  .add-ex-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 13px;
    background: var(--accent-light);
    color: var(--accent);
    border: none;
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    margin-top: 4px;
  }
  .add-ex-btn:hover { background: rgba(0,113,227,0.14); }
  .timer-status-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text3);
    margin-bottom: 8px;
  }
  .status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--text3);
  }
  .status-dot.running { background: var(--green); box-shadow: 0 0 0 3px rgba(48,209,88,0.2); animation: pulse 1.5s infinite; }
  .status-dot.paused { background: var(--orange); }
  @keyframes pulse { 0%,100%{ box-shadow: 0 0 0 3px rgba(48,209,88,0.2); } 50%{ box-shadow: 0 0 0 6px rgba(48,209,88,0.1); } }

  /* ─── EXERCISE LIBRARY ─── */
  .lib-search {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .lib-search-input {
    flex: 1;
    min-width: 160px;
    background: var(--surface);
    border: 1.5px solid var(--border2);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 14px;
    font-family: inherit;
    color: var(--text);
    outline: none;
  }
  .lib-search-input:focus { border-color: var(--accent); }
  .lib-filter-select {
    background: var(--surface);
    border: 1.5px solid var(--border2);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 13px;
    font-family: inherit;
    color: var(--text);
    outline: none;
    cursor: pointer;
  }
  .ex-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px 18px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: box-shadow 0.15s, transform 0.15s;
  }
  .ex-card:hover { box-shadow: var(--shadow); transform: translateY(-1px); }
  .ex-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
  .ex-card-name { font-size: 15px; font-weight: 600; flex: 1; }
  .ex-card-muscle { font-size: 11px; font-weight: 600; color: var(--accent); background: var(--accent-light); padding: 2px 9px; border-radius: 20px; }
  .ex-card-desc { font-size: 13px; color: var(--text2); line-height: 1.5; }
  .ex-card-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
  .ex-tag { font-size: 11px; color: var(--text3); background: var(--surface2); padding: 2px 8px; border-radius: 6px; }
  .ex-detail-modal {
    position: fixed; inset: 0; z-index: 600;
    background: rgba(0,0,0,0.3); backdrop-filter: blur(6px);
    display: none; align-items: flex-end; justify-content: center;
  }
  .ex-detail-modal.open { display: flex; }
  .ex-detail-sheet {
    background: var(--surface);
    border-radius: 20px 20px 0 0;
    width: 100%; max-width: 640px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 20px 24px 40px;
    animation: slideSheet 0.28s cubic-bezier(0.22,1,0.36,1);
  }
  .ex-step {
    display: flex; gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  .ex-step:last-child { border-bottom: none; }
  .ex-step-num {
    width: 26px; height: 26px; border-radius: 50%;
    background: var(--accent); color: #fff;
    font-size: 12px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; margin-top: 2px;
  }
  .ex-step-text { font-size: 14px; color: var(--text2); line-height: 1.6; }
  .muscle-chip { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 500; background: var(--surface2); border: 1px solid var(--border2); padding: 4px 10px; border-radius: 20px; margin: 3px; color: var(--text2); }

  /* ─── MOBILE: workout timer adjustments ─── */
  @media (max-width: 600px) {
    .timer-clock { font-size: 52px; }
    .workout-set-row { grid-template-columns: 2fr 1fr 1fr auto; }
    .set-col-labels { grid-template-columns: 2fr 1fr 1fr auto; }
    .workout-set-row .rpe-col { display: none; }
    .set-col-labels .rpe-col { display: none; }
  }

  /* ─── DYNAMIC EXERCISE LIST (log page) ─── */
  .ex-list-row {
    display: grid;
    grid-template-columns: 1fr 58px 68px 30px;
    gap: 6px;
    align-items: center;
    margin-bottom: 6px;
  }
  .ex-list-col-label {
    display: grid;
    grid-template-columns: 1fr 58px 68px 30px;
    gap: 6px;
    font-size: 10px; font-weight: 600; color: var(--text3);
    text-transform: uppercase; letter-spacing: 0.4px;
    margin-bottom: 4px;
  }
  .ex-list-input {
    background: var(--surface2); border: 1px solid var(--border2);
    border-radius: 8px; padding: 9px 8px; font-size: 13px;
    font-family: inherit; color: var(--text); width: 100%; outline: none;
  }
  .ex-list-input:focus { border-color: var(--accent); background: var(--surface); }
  .ex-add-row { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
  .ex-add-btn-outline {
    flex: 1; padding: 10px; border-radius: 8px; font-size: 13px;
    font-weight: 600; cursor: pointer; font-family: inherit; border: 1.5px dashed var(--border2);
    background: none; color: var(--text2); transition: all 0.12s;
  }
  .ex-add-btn-outline:hover { background: var(--surface2); border-color: var(--accent); color: var(--accent); }
  .ex-add-btn-lib {
    flex: 1; padding: 10px; border-radius: 8px; font-size: 13px;
    font-weight: 600; cursor: pointer; font-family: inherit; border: none;
    background: var(--accent-light); color: var(--accent); transition: background 0.12s;
  }
  .ex-add-btn-lib:hover { background: rgba(0,113,227,0.14); }
  .copy-btn {
    padding: 7px 12px; font-size: 12px; font-weight: 600;
    background: var(--surface2); border: 1px solid var(--border2);
    border-radius: 8px; cursor: pointer; font-family: inherit; color: var(--text2);
    transition: all 0.12s; white-space: nowrap;
  }
  .copy-btn:hover { background: var(--surface3); color: var(--text); }

  /* ─── WEIGHT DIFF BADGE ─── */
  .weight-diff-badge {
    display: inline-flex; align-items: center; gap: 3px;
    font-size: 12px; font-weight: 700;
    padding: 2px 9px; border-radius: 20px; margin-left: 8px;
    vertical-align: middle; transition: all 0.25s;
  }
  .wdb-down { background: var(--green-light); color: var(--green); }
  .wdb-up   { background: var(--red-light); color: var(--red); }
  .wdb-flat { background: var(--surface3); color: var(--text3); }

  /* ─── REST TIMER ─── */
  .rest-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 16px 18px; margin-bottom: 14px; }
  .rest-progress { height: 5px; background: var(--surface3); border-radius: 3px; margin-bottom: 10px; overflow: hidden; }
  .rest-bar { height: 100%; background: var(--accent); border-radius: 3px; transition: width 1s linear, background 0.4s; }
  .rest-bar.urgent { background: var(--red); }
  .rest-clock-display { font-size: 48px; font-weight: 700; letter-spacing: -2px; font-variant-numeric: tabular-nums; text-align: center; line-height: 1; margin: 4px 0 10px; }
  .rest-clock-display.urgent { color: var(--red); animation: blink 0.8s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .rest-presets { display: flex; gap: 7px; justify-content: center; flex-wrap: wrap; margin-bottom: 10px; }
  .rest-pre-btn {
    padding: 7px 14px; border-radius: 980px; border: 1.5px solid var(--border2);
    background: var(--surface2); color: var(--text2); font-size: 13px; font-weight: 600;
    cursor: pointer; font-family: inherit; transition: all 0.12s;
  }
  .rest-pre-btn.on, .rest-pre-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
  .rest-btns { display: flex; gap: 8px; justify-content: center; }
  .rest-go-btn { padding: 9px 24px; border-radius: 980px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; background: var(--green); color: #fff; transition: background 0.12s; }
  .rest-go-btn:hover { background: #27b84a; }
  .rest-go-btn.paused { background: var(--accent); }
  .rest-reset-btn { padding: 9px 18px; border-radius: 980px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; background: var(--surface3); color: var(--text2); }

  /* ─── PERIOD PAGE ─── */
  .period-tab-bar {
    display: flex; gap: 0; background: var(--surface3); border-radius: 10px;
    padding: 3px; margin-bottom: 16px;
  }
  .period-tab {
    flex: 1; padding: 8px 12px; border-radius: 8px; border: none; font-size: 13px;
    font-weight: 600; cursor: pointer; font-family: inherit; color: var(--text3);
    background: none; transition: all 0.18s; text-align: center;
  }
  .period-tab.active { background: var(--surface); color: var(--text); box-shadow: var(--shadow-sm); }

  /* Calendar dot grid (60-day strip) */
  .period-strip {
    display: grid; grid-template-columns: repeat(7, 1fr);
    gap: 3px; margin: 8px 0;
  }
  .period-strip-day {
    width: 100%; aspect-ratio: 1; border-radius: 50%;
    background: var(--surface3); display: flex; align-items: center; justify-content: center;
    font-size: 9px; font-weight: 600; color: var(--text3);
    cursor: pointer; transition: all 0.12s; position: relative; min-width: 0;
  }
  .period-strip-day.menstrual { background: #ff6b9d; color: #fff; }
  .period-strip-day.fertile   { background: rgba(52,170,220,0.15); color: var(--accent); border: 1px solid var(--accent); }
  .period-strip-day.ovulation { background: var(--accent); color: #fff; }
  .period-strip-day.predicted { background: rgba(255,107,157,0.15); border: 1px dashed #ff6b9d; color: #ff6b9d; }
  .period-strip-day.today     { outline: 2px solid var(--accent); outline-offset: 1px; }
  .strip-weekday-label { font-size: 9px; font-weight: 700; color: var(--text3); text-align: center; padding: 2px 0; }

  /* Month calendar */
  .period-month-grid {
    display: grid; grid-template-columns: repeat(7, 1fr);
    gap: 2px; margin-top: 6px;
  }
  .period-month-nav {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 10px;
  }
  .period-month-btn {
    background: var(--surface2); border: 1px solid var(--border2); border-radius: 8px;
    padding: 6px 14px; font-size: 14px; cursor: pointer; font-family: inherit;
    color: var(--text2); transition: background 0.12s;
  }
  .period-month-btn:hover { background: var(--surface3); }
  .period-month-title { font-size: 15px; font-weight: 700; color: var(--text); }
  .pm-day-header { font-size: 10px; font-weight: 700; color: var(--text3); text-align: center; padding: 4px 0; }
  .pm-day {
    min-height: 40px; border-radius: 6px; padding: 4px;
    font-size: 12px; font-weight: 600; cursor: pointer;
    transition: background 0.1s; position: relative;
    display: flex; flex-direction: column; align-items: center;
    background: none; border: none; font-family: inherit; color: var(--text2);
  }
  .pm-day:hover { background: var(--surface3); }
  .pm-day.today { color: var(--accent); font-weight: 800; }
  .pm-day.other-month { color: var(--text3); opacity: 0.5; }
  .pm-day.menstrual { background: #ff6b9d22; }
  .pm-day.ovulation { background: rgba(0,113,227,0.1); }
  .pm-day.predicted { background: rgba(255,107,157,0.1); }
  .pm-day-dot { width: 5px; height: 5px; border-radius: 50%; margin-top: 3px; }
  .pm-day-dot.men { background: #ff6b9d; }
  .pm-day-dot.ov  { background: var(--accent); }
  .pm-day-dot.pred { background: #ff6b9d; opacity: 0.5; }

  /* Stats */
  .period-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 14px 0; }
  .period-stat-card {
    background: var(--surface2); border-radius: var(--radius-sm);
    padding: 14px; text-align: center;
  }
  .period-stat-val { font-size: 26px; font-weight: 700; margin-bottom: 2px; }
  .period-stat-lbl { font-size: 10px; color: var(--text3); font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px; line-height: 1.3; }

  /* Log history */
  .period-log-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 13px;
  }
  .period-log-row:last-child { border-bottom: none; }
  .period-dot-sm { width: 8px; height: 8px; border-radius: 50%; background: #ff6b9d; display: inline-block; margin-right: 6px; flex-shrink: 0; }

  /* Entry form */
  .flow-selector { display: flex; gap: 6px; }
  .flow-btn {
    flex: 1; padding: 9px 4px; border-radius: 8px; font-size: 12px; font-weight: 600;
    border: 1.5px solid var(--border2); background: var(--surface2);
    cursor: pointer; font-family: inherit; color: var(--text2); transition: all 0.12s; text-align: center;
  }
  .flow-btn.selected { border-color: #ff6b9d; background: #ff6b9d18; color: #ff6b9d; }
  .symptom-chip {
    padding: 5px 11px; border-radius: 20px; font-size: 12px; font-weight: 500;
    border: 1.5px solid var(--border2); background: var(--surface2);
    cursor: pointer; font-family: inherit; color: var(--text2); transition: all 0.12s;
  }
  .symptom-chip.selected { border-color: #ff6b9d; background: #ff6b9d18; color: #ff6b9d; }

  /* ─── EDIT LOG MODAL ─── */
  .edit-log-modal {
    position: fixed; inset: 0; z-index: 700;
    background: rgba(0,0,0,0.35); backdrop-filter: blur(6px);
    display: none; align-items: flex-end; justify-content: center;
  }
  .edit-log-modal.open { display: flex; }
  .edit-log-sheet {
    background: var(--surface); border-radius: 20px 20px 0 0;
    width: 100%; max-width: 600px; max-height: 88vh; overflow-y: auto;
    padding: 20px 22px 40px; animation: slideSheet 0.28s cubic-bezier(0.22,1,0.36,1);
  }
  @keyframes slideSheet { from{ transform:translateY(60px);opacity:0 } to{ transform:none;opacity:1 } }

  /* ─── DELETE CONFIRM MODAL ─── */
  .delete-modal {
    position: fixed; inset: 0; z-index: 9500;
    display: none; align-items: center; justify-content: center;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(6px);
  }
  .delete-modal.open { display: flex; }
  .delete-modal-box {
    background: var(--surface);
    border-radius: 18px;
    padding: 28px 28px 24px;
    width: min(360px, 90vw);
    box-shadow: var(--shadow-lg);
    animation: fadeUp 0.22s ease;
    text-align: center;
  }
  .delete-modal-icon { font-size: 36px; margin-bottom: 10px; }
  .delete-modal-title { font-size: 17px; font-weight: 700; margin-bottom: 6px; }
  .delete-modal-desc { font-size: 13px; color: var(--text2); margin-bottom: 20px; line-height: 1.5; }
  .delete-modal-actions { display: flex; gap: 10px; margin-top: 16px; }
  .delete-modal-actions .btn { flex: 1; padding: 11px; font-size: 14px; border-radius: 10px; }

  /* ─── LOCK SCREEN ─── */
  .lock-screen {
    position: fixed; inset: 0; z-index: 9000;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
  }
  .lock-screen.hidden { display: none; }
  .lock-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 36px 32px 32px;
    width: 340px;
    box-shadow: var(--shadow-lg);
    text-align: center;
    animation: fadeUp 0.3s ease;
  }
  .lock-avatar {
    width: 64px; height: 64px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 24px; font-weight: 700;
    margin: 0 auto 14px;
  }
  .lock-name { font-size: 20px; font-weight: 700; letter-spacing: -0.4px; margin-bottom: 4px; }
  .lock-hint { font-size: 13px; color: var(--text3); margin-bottom: 22px; }
  .lock-input {
    width: 100%; background: var(--surface2);
    border: 1.5px solid var(--border2);
    border-radius: 10px; padding: 12px 14px;
    font-family: inherit; font-size: 16px;
    color: var(--text); outline: none; text-align: center;
    letter-spacing: 4px; margin-bottom: 12px;
  }
  .lock-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,113,227,0.15); }
  .lock-input.error { border-color: var(--red); box-shadow: 0 0 0 3px rgba(255,59,48,0.15); animation: shake 0.3s; }
  @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }
  .lock-btn {
    width: 100%; padding: 12px; background: var(--accent);
    color: #fff; border: none; border-radius: 10px;
    font-family: inherit; font-size: 15px; font-weight: 600;
    cursor: pointer; margin-bottom: 10px;
  }
  .lock-btn:hover { background: var(--accent-hover); }
  .lock-error { font-size: 13px; color: var(--red); min-height: 18px; margin-bottom: 4px; }
  .lock-users { display: flex; flex-direction: column; gap: 4px; }
  .lock-user-btn {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 14px; border-radius: 10px; cursor: pointer;
    transition: background 0.15s; text-align: left;
    background: none; border: 1px solid var(--border);
    width: 100%; font-family: inherit;
  }
  .lock-user-btn:hover { background: var(--surface2); }
  .lock-user-btn.selected { border-color: var(--accent); background: var(--accent-light); }
  .lock-user-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 12px; font-weight: 700; flex-shrink: 0; }
  .lock-user-info { flex: 1; }
  .lock-user-name { font-size: 14px; font-weight: 600; color: var(--text); }
  .lock-user-hint { font-size: 11px; color: var(--text3); }
  .lock-back { font-size: 13px; color: var(--accent); cursor: pointer; margin-top: 8px; background: none; border: none; font-family: inherit; }
  .lock-back:hover { text-decoration: underline; }
  .lock-divider { border: none; border-top: 1px solid var(--border); margin: 16px 0; }

  /* ─── BMI CARD ─── */
  .bmi-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 22px;
    box-shadow: var(--shadow-sm);
    transition: box-shadow 0.2s, transform 0.2s;
    grid-column: span 2;
  }
  .bmi-card:hover { box-shadow: var(--shadow); transform: translateY(-1px); }
  .bmi-bar-wrap { height: 10px; border-radius: 10px; background: linear-gradient(90deg,#34aadc 0%,#30d158 22%,#30d158 44%,#ff9f0a 66%,#ff3b30 100%); position: relative; margin: 10px 0 6px; overflow: visible; }
  .bmi-marker { position: absolute; top: -4px; width: 18px; height: 18px; background: var(--surface); border: 2.5px solid var(--text); border-radius: 50%; transform: translateX(-50%); box-shadow: 0 1px 4px rgba(0,0,0,0.15); transition: left 0.6s cubic-bezier(0.22,1,0.36,1); }
  .bmi-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text3); }
  .bmi-value-row { display: flex; align-items: baseline; gap: 8px; }
  .bmi-value { font-size: 32px; font-weight: 700; letter-spacing: -1px; }
  .bmi-category { font-size: 13px; font-weight: 600; padding: 3px 10px; border-radius: 20px; }

  /* ─── CALORIE DISPLAY ─── */
  .calorie-tag { display: inline-flex; align-items: center; gap: 5px; font-size: 12px; font-weight: 600; background: rgba(255,159,10,0.12); color: var(--orange); padding: 3px 10px; border-radius: 20px; }
  .calorie-est { font-size: 11px; color: var(--text3); margin-top: 4px; }

  /* ─── SET PASSWORD ─── */
  .pwd-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }

  /* ─── USER SWITCHER ─── */
  .user-switcher {
    padding: 10px 10px 6px;
    border-bottom: 1px solid var(--border);
    position: relative;
  }
  .user-current {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: var(--radius-xs);
    cursor: pointer;
    transition: background 0.15s;
    user-select: none;
  }
  .user-current:hover { background: var(--surface3); }
  .user-avatar {
    width: 30px; height: 30px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 12px; font-weight: 700; flex-shrink: 0;
  }
  .user-info { flex: 1; min-width: 0; }
  .user-name { font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .user-hint { font-size: 11px; color: var(--text3); }
  .user-chevron { color: var(--text3); font-size: 10px; flex-shrink: 0; transition: transform 0.2s; }
  .user-switcher.open .user-chevron { transform: rotate(180deg); }

  .user-dropdown {
    position: absolute;
    left: 10px; right: 10px; top: calc(100% - 2px);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-lg);
    z-index: 200; overflow: hidden;
    display: none;
  }
  .user-dropdown.open { display: block; animation: fadeUp 0.18s ease; }
  .user-dropdown-header {
    padding: 10px 14px 6px;
    font-size: 11px; font-weight: 600; color: var(--text3);
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .user-list { max-height: 180px; overflow-y: auto; }
  .user-item {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 14px; cursor: pointer; transition: background 0.12s;
    font-size: 13px; font-weight: 500; color: var(--text);
  }
  .user-item:hover { background: var(--surface2); }
  .user-item.selected { color: var(--accent); }
  .user-item-avatar {
    width: 26px; height: 26px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 11px; font-weight: 700; flex-shrink: 0;
  }
  .user-item-name { flex: 1; }
  .user-item-check { opacity: 0; color: var(--accent); font-size: 13px; }
  .user-item.selected .user-item-check { opacity: 1; }
  .user-item-del {
    background: none; border: none; color: var(--text3);
    cursor: pointer; font-size: 13px; padding: 2px 5px;
    border-radius: 4px; opacity: 0; line-height: 1;
  }
  .user-item:hover .user-item-del { opacity: 1; }
  .user-item:hover .user-item-check { opacity: 0; }
  .user-item.selected:hover .user-item-check { opacity: 1; }
  .user-drop-divider { border: none; border-top: 1px solid var(--border); margin: 4px 0; }
  .user-add-row {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 14px 12px;
  }
  .user-add-input {
    flex: 1; background: var(--surface2); border: 1px solid var(--border2);
    border-radius: 7px; padding: 7px 10px;
    font-family: inherit; font-size: 13px; color: var(--text); outline: none;
  }
  .user-add-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0,113,227,0.15); }
  .user-add-btn {
    background: var(--accent); color: #fff; border: none;
    border-radius: 7px; padding: 7px 13px;
    font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit;
  }
  .user-add-btn:hover { background: var(--accent-hover); }
  .av-0 { background: linear-gradient(135deg,#0071e3,#34aadc); }
  .av-1 { background: linear-gradient(135deg,#30d158,#00b341); }
  .av-2 { background: linear-gradient(135deg,#ff9f0a,#e06800); }
  .av-3 { background: linear-gradient(135deg,#ff375f,#d4003e); }
  .av-4 { background: linear-gradient(135deg,#bf5af2,#8e40c0); }
  .av-5 { background: linear-gradient(135deg,#5ac8fa,#007aff); }
</style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="sidebar-header">
    <div class="logo" onclick="logoutToLockScreen()" style="cursor:pointer;" title="返回登入畫面">
      <div class="logo-icon">
        <svg viewBox="0 0 20 20" fill="none">
          <path d="M10 2.5C10 2.5 6 5 6 9.5C6 11.5 7.5 13 10 13C12.5 13 14 11.5 14 9.5C14 5 10 2.5 10 2.5Z" fill="white" opacity="0.9"/>
          <path d="M7 13.5C7 13.5 7 16 10 17C13 16 13 13.5 13 13.5" stroke="white" stroke-width="1.2" stroke-linecap="round" opacity="0.6"/>
          <line x1="10" y1="13" x2="10" y2="17" stroke="white" stroke-width="1.3" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="logo-text">
        <span class="logo-name">Training Log</span>
        <span class="logo-sub">健身追蹤</span>
      </div>
    </div>
  </div>

  <!-- USER SWITCHER -->
  <div class="user-switcher" id="userSwitcher">
    <div class="user-current" onclick="toggleUserDropdown()">
      <div class="user-avatar av-0" id="currentAvatar">?</div>
      <div class="user-info">
        <div class="user-name" id="currentUserName">未選擇用戶</div>
        <div class="user-hint">點擊切換用戶</div>
      </div>
      <div class="user-chevron">▼</div>
    </div>
    <div class="user-dropdown" id="userDropdown">
      <div class="user-dropdown-header">切換帳號（需驗證密碼）</div>
      <div class="user-list" id="userList"></div>
      <hr class="user-drop-divider">
      <div class="user-add-row">
        <input class="user-add-input" id="newUserInput" placeholder="輸入新用戶名稱" maxlength="20"
          onkeydown="if(event.key==='Enter') addUser()">
        <button class="user-add-btn" onclick="addUser()">新增</button>
      </div>
    </div>
  </div>

  <nav>
    <div class="nav-section-label">主要</div>
    <a class="active" onclick="navigate('dashboard', this)">
      <span class="nav-icon"><span>📊</span></span>
      <span>總覽</span>
    </a>
    <a onclick="navigate('log', this)">
      <span class="nav-icon"><span>✏️</span></span>
      <span>今日記錄</span>
    </a>
    <a onclick="navigate('workout', this)">
      <span class="nav-icon"><span>⏱️</span></span>
      <span>實時訓練</span>
    </a>
    <a onclick="navigate('library', this)">
      <span class="nav-icon"><span>📚</span></span>
      <span>動作庫</span>
    </a>
    <div class="nav-section-label">記錄</div>
    <a onclick="navigate('history', this)">
      <span class="nav-icon"><span>📋</span></span>
      <span>訓練歷史</span>
    </a>
    <a onclick="navigate('weight', this)">
      <span class="nav-icon"><span>⚖️</span></span>
      <span>體重追蹤</span>
    </a>
    <a onclick="navigate('photos', this)">
      <span class="nav-icon"><span>📷</span></span>
      <span>身材照片</span>
    </a>
    <div class="nav-section-label">規劃</div>
    <a onclick="navigate('plan', this)">
      <span class="nav-icon"><span>🗓</span></span>
      <span>訓練計劃</span>
    </a>
    <a onclick="navigate('goals', this)">
      <span class="nav-icon"><span>🎯</span></span>
      <span>目標追蹤</span>
    </a>
    <a onclick="navigate('period', this)">
      <span class="nav-icon"><span>🌸</span></span>
      <span>生理週期</span>
    </a>
    <div class="nav-section-label">帳號</div>
    <a onclick="navigate('settings', this)">
      <span class="nav-icon"><span>⚙️</span></span>
      <span>用戶設定</span>
    </a>
  </nav>

  <div class="sidebar-footer">
    <span class="sidebar-footer-text" id="sidebarDate"></span>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="pageTitle">總覽</div>
    <div style="display:flex;align-items:center;gap:10px;">
      <span id="syncStatus" style="font-size:12px;font-weight:500;transition:color 0.3s;"></span>
      <div class="topbar-date" id="headerDate"></div>
      <div class="topbar-user" id="topbarUser" onclick="openMobileUserModal()" style="display:none;">
        <div class="topbar-user-avatar av-0" id="topbarAvatar">?</div>
        <span class="topbar-user-name" id="topbarUserName">用戶</span>
      </div>
    </div>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">當前體重</div>
          <div class="stat-value" id="dash-weight">—</div>
          <div class="stat-unit">公斤</div>
          <div class="stat-change neutral" id="dash-weight-change">尚無數據</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">距離目標</div>
          <div class="stat-value" id="dash-remaining">—</div>
          <div class="stat-unit">公斤</div>
          <div class="stat-change neutral" id="dash-target-weight">未設定目標</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">本月訓練</div>
          <div class="stat-value" id="dash-sessions">0</div>
          <div class="stat-unit">次</div>
          <div class="stat-change neutral">本月累計</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">連續訓練</div>
          <div class="stat-value" id="dash-streak">0</div>
          <div class="stat-unit">天</div>
          <div class="stat-change neutral">保持節奏 💪</div>
        </div>
      </div>

      <!-- BMI + Calorie Summary row -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:24px;" id="bmi-calorie-row">
        <div class="bmi-card" style="grid-column:1;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:2px;">
            <div class="stat-label">BMI 身體質量指數</div>
            <div id="bmi-category-badge" class="bmi-category" style="background:#e5e5ea;color:var(--text3);">—</div>
          </div>
          <div class="bmi-value-row">
            <div class="bmi-value" id="bmi-value">—</div>
            <div id="bmi-sub" style="font-size:13px;color:var(--text3);">請在設定中填寫身高</div>
          </div>
          <div class="bmi-bar-wrap" id="bmi-bar-wrap" style="opacity:0.3;">
            <div class="bmi-marker" id="bmi-marker" style="left:50%"></div>
          </div>
          <div class="bmi-labels"><span>偏瘦 &lt;18.5</span><span>正常 18.5–24</span><span>過重 24–27</span><span>肥胖 &gt;27</span></div></div>
        <div class="stat-card" style="grid-column:2;">
          <div class="stat-label">本月消耗熱量</div>
          <div class="stat-value" id="dash-calories">0</div>
          <div class="stat-unit">大卡 kcal</div>
          <div class="stat-change neutral" id="dash-calories-sub">本月累計估算</div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="card">
          <div class="card-title">體重趨勢（近 30 天）</div>
          <div class="weight-chart chart-wrap">
            <svg class="chart-svg" id="weightChart" viewBox="0 0 560 160" preserveAspectRatio="none"></svg>
            <div class="chart-tooltip" id="chartTooltip"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">最近記錄</div>
          <div class="workout-list" id="recent-logs" style="max-height:200px;overflow-y:auto;">
            <div class="empty-state" style="padding:20px 0;">
              <div class="empty-icon">📋</div>尚無記錄
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- LOG TODAY -->
    <div class="page" id="page-log">
      <div class="log-grid">
        <div>
          <div class="card" style="margin-bottom:16px;">
            <div class="card-title">基本資訊</div>
            <div class="form-group">
              <label class="form-label">日期</label>
              <input type="date" class="form-input" id="log-date">
              <input type="hidden" id="log-height">
            </div>
            <div class="form-group">
              <div style="display:flex;align-items:center;margin-bottom:6px;">
                <label class="form-label" style="margin:0;">今日體重（kg）</label>
                <span id="weightDiffBadge" class="weight-diff-badge" style="display:none;"></span>
              </div>
              <input type="number" step="0.1" class="form-input" id="log-weight" placeholder="例：75.5" oninput="updateWeightDiff()">
            </div>
<div class="form-group">
              <label class="form-label">訓練類型</label>
              <select class="form-input" id="log-type">
                <option value="">— 選擇類型 —</option>
                <option value="chest">胸部訓練</option>
                <option value="back">背部訓練</option>
                <option value="legs">腿部訓練</option>
                <option value="shoulders">肩部訓練</option>
                <option value="arms">手臂訓練</option>
                <option value="core">核心訓練</option>
                <option value="cardio">有氧訓練</option>
                <option value="glutes">臀部訓練</option>
                <option value="fullbody">全身訓練</option>
                <option value="rest">休息日</option>
              </select>
            </div>
          </div>
          <div class="card">
            <div class="card-title">訓練時間</div>
            <div class="form-group">
              <label class="form-label">開始</label>
              <input type="time" class="form-input" id="log-start">
            </div>
            <div class="form-group">
              <label class="form-label">結束</label>
              <input type="time" class="form-input" id="log-end">
            </div>
          </div>
        </div>
        <div>
          <div class="card" style="margin-bottom:16px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
              <div class="card-title" style="margin:0;">訓練動作</div>
              <button class="copy-btn" onclick="copyYesterdayExercises()">📋 複製昨日訓練</button>
            </div>
            <div class="ex-list-col-label">
              <span>動作名稱</span><span style="text-align:center;">組數</span><span style="text-align:center;">重量kg</span><span></span>
            </div>
            <div id="logExerciseList"></div>
            <div class="ex-add-row">
              <button class="ex-add-btn-outline" onclick="addLogExRow()">＋ 新增動作</button>
              <button class="ex-add-btn-lib" onclick="toggleLogExPicker()">📚 動作庫</button>
            </div>
            <div id="logExPickerWrap" style="display:none;margin-top:10px;">
              <input type="text" class="form-input" id="logExPickerQ" placeholder="搜尋動作..." oninput="renderLogExPicker()" style="margin-bottom:8px;">
              <div id="logExPickerList" style="max-height:180px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;"></div>
            </div>
            <!-- hidden textarea for compatibility -->
            <textarea id="log-exercises" style="display:none;"></textarea>
            <div class="form-group">
              <label class="form-label">運動時長（分鐘）<span style="color:var(--text3);font-weight:400;font-size:11px;"> 用於計算消耗熱量</span></label>
              <input type="number" class="form-input" id="log-duration" placeholder="例：60" min="1" max="600">
            </div>
            <div class="form-group" id="calorie-preview-group" style="display:none;">
              <div style="background:rgba(255,159,10,0.08);border-radius:10px;padding:12px 14px;">
                <div style="font-size:12px;color:var(--text3);margin-bottom:4px;">預估消耗熱量</div>
                <div style="font-size:22px;font-weight:700;color:var(--orange);" id="calorie-preview">— <span style="font-size:13px;font-weight:400;">kcal</span></div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">備注 / 今日感受</label>
              <textarea class="form-input" id="log-notes" placeholder="今天狀態如何？有什麼突破？" style="min-height:72px;"></textarea>
            </div>
          </div>
          <div class="card">
            <div class="card-title">今日照片（選填）</div>
            <div class="photo-upload-area" id="logPhotoArea">
              <input type="file" accept="image/*" id="log-photo" multiple onchange="handleLogPhoto(event)">
              <div style="font-size:28px;margin-bottom:6px;">📷</div>
              <div style="font-size:13px;color:var(--text3);">點擊上傳今日身材照片</div>
            </div>
            <div id="log-photo-previews" class="photo-grid"></div>
          </div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="saveLog()">儲存今日記錄</button>
    </div>

    <!-- HISTORY -->
    <div class="page" id="page-history">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
        <div class="section-title" style="margin:0;">訓練歷史</div>
        <div class="segment-control">
          <select onchange="renderHistory(this.value)" id="history-filter">
            <option value="all">全部類型</option>
            <option value="chest">胸部</option>
            <option value="back">背部</option>
            <option value="legs">腿部</option>
            <option value="shoulders">肩部</option>
            <option value="arms">手臂</option>
            <option value="core">核心</option>
            <option value="cardio">有氧</option>
            <option value="fullbody">全身</option>
            <option value="rest">休息日</option>
          </select>
        </div>
      </div>
      <div class="workout-list" id="history-list">
        <div class="empty-state"><div class="empty-icon">📋</div>尚無訓練記錄</div>
      </div>
    </div>

    <!-- WEIGHT -->
    <div class="page" id="page-weight">
      <div class="log-grid" style="margin-bottom:18px;">
        <div class="card">
          <div class="card-title">設定目標體重</div>
          <div class="form-group">
            <label class="form-label">目標體重（kg）</label>
            <input type="number" step="0.1" class="form-input" id="target-weight-input" placeholder="例：70.0">
          </div>
          <button class="btn btn-primary" onclick="setTargetWeight()">設定目標</button>
        </div>
        <div class="card">
          <div class="card-title">新增體重記錄</div>
          <div class="form-group">
            <label class="form-label">日期</label>
            <input type="date" class="form-input" id="weight-date-input">
          </div>
          <div class="form-group">
            <label class="form-label">體重（kg）</label>
            <input type="number" step="0.1" class="form-input" id="weight-value-input" placeholder="例：75.5">
          </div>
          <button class="btn btn-primary" onclick="addWeightRecord()">新增</button>
        </div>
      </div>
      <div class="card" style="margin-bottom:18px;">
        <div class="card-title">體重趨勢</div>
        <div class="weight-chart chart-wrap" style="height:200px;">
          <svg class="chart-svg" id="weightChartFull" viewBox="0 0 760 200" preserveAspectRatio="none"></svg>
        </div>
      </div>
      <div class="card">
        <div class="card-title">體重記錄</div>
        <div class="weight-table-wrap">
        <table class="weight-table">
          <thead>
            <tr>
              <th>日期</th><th>體重</th><th>變化</th><th>狀態</th><th></th>
            </tr>
          </thead>
          <tbody id="weight-tbody"></tbody>
        </table>
        </div>
      </div>
    </div>

    <!-- PHOTOS -->
    <div class="page" id="page-photos">
      <div class="card" style="margin-bottom:20px;">
        <div class="card-title">上傳照片</div>
        <div class="photo-upload-area">
          <input type="file" accept="image/*" id="photo-upload" multiple onchange="handlePhotoUpload(event)">
          <div style="font-size:34px;margin-bottom:8px;">📸</div>
          <div style="font-size:14px;font-weight:500;color:var(--text2);">點擊或拖曳上傳</div>
          <div style="font-size:12px;color:var(--text3);margin-top:4px;">支援 JPG、PNG，可一次多選</div>
        </div>
      </div>
      <div class="section-title">所有照片</div>
      <div class="photo-grid" id="all-photos">
        <div class="empty-state" style="grid-column:1/-1;">
          <div class="empty-icon">📷</div>尚無照片
        </div>
      </div>
    </div>

    <!-- PLAN -->
    <div class="page" id="page-plan">
      <div class="card" style="margin-bottom:24px;">
        <div class="card-title">新增訓練計劃</div>
        <div class="log-grid">
          <div>
            <div class="form-group">
              <label class="form-label">計劃名稱</label>
              <input type="text" class="form-input" id="plan-name" placeholder="例：增肌期第一階段">
            </div>
            <div class="form-group">
              <label class="form-label">開始日期</label>
              <input type="date" class="form-input" id="plan-start">
            </div>
            <div class="form-group">
              <label class="form-label">結束日期</label>
              <input type="date" class="form-input" id="plan-end">
            </div>
          </div>
          <div>
            <div class="form-group">
              <label class="form-label">計劃說明 / 訓練重點</label>
              <textarea class="form-input" id="plan-desc" placeholder="描述這個階段的目標和訓練內容..." style="min-height:140px;"></textarea>
            </div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="addPlan()">新增計劃</button>
      </div>
      <div class="section-title">所有計劃</div>
      <div class="plan-phases" id="plan-list">
        <div class="empty-state" style="grid-column:1/-1;">
          <div class="empty-icon">🗓</div>尚無訓練計劃
        </div>
      </div>
    </div>

    <!-- GOALS -->
    <div class="page" id="page-goals">
      <div class="card" style="margin-bottom:20px;">
        <div class="card-title">設定目標</div>
        <div class="log-grid">
          <div>
            <div class="form-group">
              <label class="form-label">目標體重（kg）</label>
              <input type="number" step="0.1" class="form-input" id="goal-weight" placeholder="例：70.0">
            </div>
            <div class="form-group">
              <label class="form-label">目標達成日期</label>
              <input type="date" class="form-input" id="goal-date">
            </div>
          </div>
          <div>
            <div class="form-group">
              <label class="form-label">每週目標訓練次數</label>
              <input type="number" class="form-input" id="goal-sessions" placeholder="例：4" min="1" max="7">
            </div>
            <div class="form-group">
              <label class="form-label">其他目標描述</label>
              <input type="text" class="form-input" id="goal-desc" placeholder="例：深蹲 100kg、體脂 15%">
            </div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="saveGoals()">儲存目標</button>
      </div>
      <div id="goals-display"></div>

    </div>

    <!-- SETTINGS -->
    <div class="page" id="page-settings">

      <!-- Profile -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-title">個人資料</div>
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
          <div class="user-avatar av-0" id="settings-avatar" style="width:52px;height:52px;font-size:20px;">?</div>
          <div>
            <div style="font-size:17px;font-weight:700;" id="settings-username">—</div>
            <div style="font-size:12px;color:var(--text3);">目前登入帳號</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div class="form-group">
            <label class="form-label">身高（cm）</label>
            <input type="number" class="form-input" id="settings-height" placeholder="例：175" min="100" max="250">
          </div>
          <div class="form-group">
            <label class="form-label">年齡</label>
            <input type="number" class="form-input" id="settings-age" placeholder="例：25" min="10" max="100">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">性別 <span style="font-weight:400;color:var(--text3);font-size:11px;">用於年齡調整 BMI 分析</span></label>
          <div style="display:flex;gap:8px;">
            <button class="flow-btn" id="gender-male" onclick="selectGender('male')" style="flex:1;">♂ 男性</button>
            <button class="flow-btn" id="gender-female" onclick="selectGender('female')" style="flex:1;">♀ 女性</button>
            <button class="flow-btn" id="gender-other" onclick="selectGender('other')" style="flex:1;">其他</button>
          </div>
        </div>
        <button class="btn btn-primary" onclick="saveSettingsProfile()" style="width:100%;">儲存個人資料</button>
      </div>

      <!-- Password -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-title">密碼安全</div>
        <div style="font-size:13px;color:var(--text2);margin-bottom:16px;">設定密碼後，每次登入需要輸入密碼才能進入你的帳號。</div>
        <div class="form-group">
          <label class="form-label">目前密碼</label>
          <input type="password" class="form-input" id="settings-pwd-current" placeholder="無密碼請留空" maxlength="20">
        </div>
        <div class="form-group">
          <label class="form-label">新密碼</label>
          <input type="password" class="form-input" id="settings-pwd-new" placeholder="新密碼（留空表示移除密碼）" maxlength="20">
        </div>
        <div class="form-group">
          <label class="form-label">確認新密碼</label>
          <input type="password" class="form-input" id="settings-pwd-confirm" placeholder="再次輸入新密碼" maxlength="20">
        </div>
        <button class="btn btn-primary" onclick="changePasswordFromSettings()">更新密碼</button>
      </div>

      <!-- Danger zone -->
      <div class="card">
        <div class="card-title" style="color:var(--red);">危險區域</div>

        <!-- Logout -->
        <div style="padding:14px 0;border-bottom:1px solid var(--border);">
          <div style="font-size:14px;font-weight:600;margin-bottom:4px;">登出帳號</div>
          <div style="font-size:13px;color:var(--text2);margin-bottom:12px;">返回登入畫面，資料不會遺失。</div>
          <button class="btn" style="background:var(--surface2);color:var(--text);border:1px solid var(--border2);border-radius:10px;" onclick="logoutToLockScreen()">登出此帳號</button>
        </div>

        <!-- Delete account -->
        <div style="padding-top:14px;">
          <div style="font-size:14px;font-weight:600;margin-bottom:4px;color:var(--red);">刪除帳號</div>
          <div style="font-size:13px;color:var(--text2);margin-bottom:12px;">永久刪除此帳號及所有資料，此操作不可復原。</div>
          <div id="delete-self-section">
            <button class="btn" style="background:var(--red-light);color:var(--red);border-radius:10px;" onclick="showDeleteSelfConfirm()">刪除此帳號</button>
          </div>
          <div id="delete-self-confirm" style="display:none;">
            <input type="password" class="form-input" id="delete-self-pwd" placeholder="輸入密碼確認（無密碼留空）" maxlength="20" style="margin-bottom:8px;">
            <div id="delete-self-error" style="font-size:12px;color:var(--red);min-height:16px;margin-bottom:8px;"></div>
            <div style="display:flex;gap:8px;">
              <button class="btn" style="flex:1;background:var(--surface2);color:var(--text);border:1px solid var(--border2);border-radius:10px;" onclick="cancelDeleteSelf()">取消</button>
              <button class="btn" style="flex:1;background:var(--red);color:#fff;border-radius:10px;" onclick="confirmDeleteSelf()">確認刪除</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- WORKOUT TIMER PAGE -->
    <div class="page" id="page-workout">
      <!-- Timer card -->
      <div class="card" style="margin-bottom:16px;">
        <div class="timer-status-bar">
          <div class="status-dot" id="timerDot"></div>
          <span id="timerStatusLabel">尚未開始</span>
        </div>
        <div class="timer-display">
          <div class="timer-clock" id="timerClock">00:00:00</div>
          <div class="timer-label" id="timerSubLabel">按開始計時</div>
        </div>
        <div class="timer-controls" id="timerControls">
          <button class="timer-btn timer-btn-start" onclick="timerStart()">▶ 開始</button>
        </div>
        <div style="display:flex;align-items:center;justify-content:center;gap:24px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
          <div style="text-align:center;">
            <div style="font-size:11px;color:var(--text3);margin-bottom:2px;">組數</div>
            <div style="font-size:22px;font-weight:700;" id="timerSets">0</div>
          </div>
          <div style="width:1px;height:36px;background:var(--border);"></div>
          <div style="text-align:center;">
            <div style="font-size:11px;color:var(--text3);margin-bottom:2px;">動作數</div>
            <div style="font-size:22px;font-weight:700;" id="timerExCount">0</div>
          </div>
          <div style="width:1px;height:36px;background:var(--border);"></div>
          <div style="text-align:center;">
            <div style="font-size:11px;color:var(--text3);margin-bottom:2px;">預估熱量</div>
            <div style="font-size:22px;font-weight:700;" id="timerCalories">0</div>
          </div>
        </div>
      </div>

      <!-- REST TIMER -->
      <div class="rest-card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <div style="font-size:13px;font-weight:600;">⏱ 組間休息</div>
          <span id="restStatusTxt" style="font-size:11px;color:var(--text3);">選擇時長後開始</span>
        </div>
        <div class="rest-progress"><div class="rest-bar" id="restBar" style="width:100%"></div></div>
        <div class="rest-clock-display" id="restClock">01:00</div>
        <div class="rest-presets">
          <button class="rest-pre-btn on" onclick="setRestPreset(30,this)">30s</button>
          <button class="rest-pre-btn" onclick="setRestPreset(60,this)">60s</button>
          <button class="rest-pre-btn" onclick="setRestPreset(90,this)">90s</button>
          <button class="rest-pre-btn" onclick="setRestPreset(120,this)">2分</button>
          <button class="rest-pre-btn" onclick="setRestPreset(180,this)">3分</button>
        </div>
        <div class="rest-btns">
          <button class="rest-go-btn" id="restGoBtn" onclick="toggleRest()">▶ 開始休息</button>
          <button class="rest-reset-btn" onclick="resetRest()">↺ 重置</button>
        </div>
      </div>

      <!-- Exercise list -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <div class="section-title" style="margin:0;">本次訓練動作</div>
        <div style="display:flex;gap:8px;">
          <select class="lib-filter-select" id="workout-type-select" style="font-size:13px;padding:7px 12px;">
            <option value="">— 訓練類型 —</option>
            <option value="chest">胸部</option>
            <option value="back">背部</option>
            <option value="legs">腿部</option>
            <option value="shoulders">肩部</option>
            <option value="arms">手臂</option>
            <option value="core">核心</option>
            <option value="cardio">有氧</option>
            <option value="fullbody">全身</option>
          </select>
        </div>
      </div>

      <div id="workoutExerciseList"></div>

      <button class="add-ex-btn" onclick="addWorkoutExercise()">＋ 新增動作</button>

      <!-- Add exercise modal (inline) -->
      <div id="addExModal" style="display:none;margin-top:12px;">
        <div class="card">
          <div class="card-title">選擇或輸入動作</div>
          <input type="text" class="form-input" id="addExInput" placeholder="搜尋動作名稱..." oninput="filterAddExList()" style="margin-bottom:10px;">
          <div id="addExSuggestions" style="max-height:200px;overflow-y:auto;"></div>
          <div style="display:flex;gap:8px;margin-top:10px;">
            <button class="btn btn-primary" onclick="confirmAddExercise()">新增</button>
            <button class="btn" style="background:var(--surface2);" onclick="document.getElementById('addExModal').style.display='none'">取消</button>
          </div>
        </div>
      </div>
    </div>

    <!-- EXERCISE LIBRARY PAGE -->
    <div class="page" id="page-library">
      <div class="lib-search">
        <input type="text" class="lib-search-input" id="libSearchInput" placeholder="🔍 搜尋動作名稱..." oninput="renderLibrary()">
        <select class="lib-filter-select" id="libMuscleFilter" onchange="renderLibrary()">
          <option value="">全部部位</option>
          <option value="胸部">胸部</option>
          <option value="背部">背部</option>
          <option value="腿部">腿部</option>
          <option value="肩部">肩部</option>
          <option value="手臂">手臂</option>
          <option value="核心">核心</option>
          <option value="臀部">臀部</option>
          <option value="有氧">有氧</option>
        </select>
        <select class="lib-filter-select" id="libTypeFilter" onchange="renderLibrary()">
          <option value="">全部器材</option>
          <option value="槓鈴">槓鈴</option>
          <option value="啞鈴">啞鈴</option>
          <option value="機器">機器</option>
          <option value="徒手">徒手</option>
          <option value="繩索">繩索</option>
        </select>
      </div>
      <div id="libList"></div>
    </div>

    <!-- EXERCISE DETAIL MODAL -->
    <div class="ex-detail-modal" id="exDetailModal">
      <div class="modal-backdrop" onclick="closeExDetail()"></div>
      <div class="ex-detail-sheet" id="exDetailSheet">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <div style="flex:1;">
            <div style="font-size:20px;font-weight:700;margin-bottom:4px;" id="exDetailName"></div>
            <div id="exDetailMuscles" style="display:flex;flex-wrap:wrap;"></div>
          </div>
          <button onclick="closeExDetail()" style="background:var(--surface2);border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;line-height:1;color:var(--text2);">×</button>
        </div>
        <div id="exDetailContent"></div>
        <button class="btn btn-primary" style="width:100%;margin-top:20px;" onclick="addToWorkoutFromLibrary()">＋ 加入本次訓練</button>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<div class="toast" id="toast"></div>

<!-- BOTTOM NAV (mobile) -->
<nav class="bottom-nav" id="bottomNav">
  <div class="bottom-nav-item active" onclick="mobileNavigate('dashboard',this)" data-page="dashboard">
    <span class="bottom-nav-icon">📊</span>
    <span class="bottom-nav-label">總覽</span>
  </div>
  <div class="bottom-nav-item" onclick="mobileNavigate('log',this)" data-page="log">
    <span class="bottom-nav-icon">✏️</span>
    <span class="bottom-nav-label">記錄</span>
  </div>
  <div class="bottom-nav-item" onclick="mobileNavigate('workout',this)" data-page="workout">
    <span class="bottom-nav-icon">⏱️</span>
    <span class="bottom-nav-label">訓練</span>
  </div>
  <div class="bottom-nav-item" onclick="mobileNavigate('weight',this)" data-page="weight">
    <span class="bottom-nav-icon">⚖️</span>
    <span class="bottom-nav-label">體重</span>
  </div>
  <div class="bottom-nav-item" onclick="mobileNavigate('photos',this)" data-page="photos">
    <span class="bottom-nav-icon">📷</span>
    <span class="bottom-nav-label">照片</span>
  </div>
  <div class="bottom-nav-item" onclick="mobileNavigate('goals',this)" data-page="goals">
    <span class="bottom-nav-icon">🎯</span>
    <span class="bottom-nav-label">目標</span>
  </div>
  <div class="bottom-nav-item" onclick="mobileNavigate('settings',this)" data-page="settings">
    <span class="bottom-nav-icon">⚙️</span>
    <span class="bottom-nav-label">設定</span>
  </div>
</nav>

<!-- MOBILE USER MODAL -->
<div class="mobile-user-modal" id="mobileUserModal">
  <div class="modal-backdrop" onclick="closeMobileUserModal()"></div>
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">切換用戶</div>
    <div id="mobileUserList"></div>
    <div class="modal-add-row">
      <input class="modal-add-input" id="mobileNewUserInput" placeholder="新用戶名稱" maxlength="20"
        onkeydown="if(event.key==='Enter') addUserMobile()">
      <button class="modal-add-btn" onclick="addUserMobile()">新增</button>
    </div>
  </div>
</div>

    <!-- PERIOD PAGE -->
    <div class="page" id="page-period">
      <!-- Tab switcher -->
      <div class="period-tab-bar">
        <button class="period-tab active" id="ptab-overview" onclick="switchPeriodTab('overview')">📊 總覽</button>
        <button class="period-tab" id="ptab-month" onclick="switchPeriodTab('month')">📅 月視圖</button>
        <button class="period-tab" id="ptab-log" onclick="switchPeriodTab('log')">✏️ 記錄</button>
      </div>

      <!-- OVERVIEW TAB -->
      <div id="ptab-overview-content">
        <!-- Stats -->
        <div class="period-stat-grid">
          <div class="period-stat-card">
            <div class="period-stat-val" id="periodCycleLen" style="color:#ff6b9d;">—</div>
            <div class="period-stat-lbl">平均週期<br>天數</div>
          </div>
          <div class="period-stat-card">
            <div class="period-stat-val" id="periodNextDays" style="color:var(--accent);">—</div>
            <div class="period-stat-lbl">距下次<br>預測天數</div>
          </div>
          <div class="period-stat-card">
            <div class="period-stat-val" id="periodDuration" style="color:#ff6b9d;">—</div>
            <div class="period-stat-lbl">平均持續<br>天數</div>
          </div>
          <div class="period-stat-card">
            <div class="period-stat-val" id="periodTotalLogs" style="color:var(--text2);">—</div>
            <div class="period-stat-lbl">已記錄<br>週期數</div>
          </div>
        </div>

        <!-- 60-day strip calendar -->
        <div class="card" style="margin-bottom:16px;">
          <div class="card-title">近60天概覽</div>
          <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:4px;">
            <div class="strip-weekday-label">日</div>
            <div class="strip-weekday-label">一</div>
            <div class="strip-weekday-label">二</div>
            <div class="strip-weekday-label">三</div>
            <div class="strip-weekday-label">四</div>
            <div class="strip-weekday-label">五</div>
            <div class="strip-weekday-label">六</div>
          </div>
          <div id="periodCalendar" class="period-strip"></div>
          <div style="display:flex;gap:14px;flex-wrap:wrap;font-size:11px;color:var(--text3);margin-top:10px;padding-top:8px;border-top:1px solid var(--border);">
            <span><span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:#ff6b9d;margin-right:4px;vertical-align:middle;"></span>生理期</span>
            <span><span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:var(--accent);margin-right:4px;vertical-align:middle;"></span>排卵預測</span>
            <span><span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:rgba(52,170,220,0.2);border:1px solid var(--accent);margin-right:4px;vertical-align:middle;"></span>易孕期</span>
            <span><span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:rgba(255,107,157,0.15);border:1px dashed #ff6b9d;margin-right:4px;vertical-align:middle;"></span>下次預測</span>
          </div>
        </div>

        <!-- History list -->
        <div class="card">
          <div class="card-title">歷史記錄</div>
          <div id="periodHistoryList"></div>
        </div>
      </div>

      <!-- MONTH VIEW TAB -->
      <div id="ptab-month-content" style="display:none;">
        <div class="card">
          <div class="period-month-nav">
            <button class="period-month-btn" onclick="periodMonthNav(-1)">‹ 上月</button>
            <div class="period-month-title" id="periodMonthTitle">2025年1月</div>
            <button class="period-month-btn" onclick="periodMonthNav(1)">下月 ›</button>
          </div>
          <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:4px;">
            <div class="pm-day-header">日</div>
            <div class="pm-day-header">一</div>
            <div class="pm-day-header">二</div>
            <div class="pm-day-header">三</div>
            <div class="pm-day-header">四</div>
            <div class="pm-day-header">五</div>
            <div class="pm-day-header">六</div>
          </div>
          <div id="periodMonthGrid" class="period-month-grid"></div>
        </div>
        <div class="card" style="margin-top:14px;" id="periodMonthLogCard" style="display:none;">
          <div class="card-title" id="periodMonthLogTitle"></div>
          <div id="periodMonthLogContent"></div>
        </div>
      </div>

      <!-- LOG TAB -->
      <div id="ptab-log-content" style="display:none;">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
            <div class="card-title" style="margin:0;">記錄</div>
            <div id="periodTodayLabel" style="font-size:12px;color:var(--text3);"></div>
          </div>
          <div class="form-group">
            <label class="form-label">日期</label>
            <input type="date" class="form-input" id="period-date">
          </div>
          <div class="form-group">
            <label class="form-label">生理期流量</label>
            <div class="flow-selector">
              <button class="flow-btn" id="fb-none" onclick="selectPeriodStatus('none')">無</button>
              <button class="flow-btn" id="fb-light" onclick="selectPeriodStatus('light')">少量</button>
              <button class="flow-btn" id="fb-medium" onclick="selectPeriodStatus('medium')">中量</button>
              <button class="flow-btn" id="fb-heavy" onclick="selectPeriodStatus('heavy')">大量</button>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">症狀（可多選）</label>
            <div id="symptomSelector" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;"></div>
          </div>
          <div class="form-group">
            <label class="form-label">備注</label>
            <textarea class="form-input" id="period-note" placeholder="情緒、疼痛程度…" style="min-height:60px;"></textarea>
          </div>
          <button class="btn btn-primary" style="width:100%;" onclick="savePeriodEntry()">儲存記錄</button>
        </div>
      </div>
    </div>

    <!-- EDIT LOG MODAL -->
    <div class="edit-log-modal" id="editLogModal" onclick="if(event.target===this)closeEditLog()">
      <div class="edit-log-sheet">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
          <div style="font-size:17px;font-weight:700;">✏️ 修改記錄</div>
          <button onclick="closeEditLog()" style="background:var(--surface2);border:none;border-radius:50%;width:30px;height:30px;font-size:16px;cursor:pointer;">×</button>
        </div>
        <div class="form-group">
          <label class="form-label">日期</label>
          <input type="date" class="form-input" id="edit-log-date">
        </div>
        <div class="form-group">
          <label class="form-label">訓練類型</label>
          <select class="form-input" id="edit-log-type">
            <option value="">— 選擇類型 —</option>
            <option value="chest">胸部訓練</option>
            <option value="back">背部訓練</option>
            <option value="legs">腿部訓練</option>
            <option value="shoulders">肩部訓練</option>
            <option value="arms">手臂訓練</option>
            <option value="core">核心訓練</option>
            <option value="cardio">有氧訓練</option>
            <option value="glutes">臀部訓練</option>
            <option value="fullbody">全身訓練</option>
            <option value="rest">休息日</option>
          </select>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div class="form-group">
            <label class="form-label">開始時間</label>
            <input type="time" class="form-input" id="edit-log-start">
          </div>
          <div class="form-group">
            <label class="form-label">結束時間</label>
            <input type="time" class="form-input" id="edit-log-end">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">體重（kg）</label>
          <input type="number" step="0.1" class="form-input" id="edit-log-weight" placeholder="例：75.5">
        </div>
        <div class="form-group">
          <label class="form-label">訓練動作</label>
          <textarea class="form-input" id="edit-log-exercises" style="min-height:100px;" placeholder="每行一個動作"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">運動時長（分鐘）</label>
          <input type="number" class="form-input" id="edit-log-duration" placeholder="例：60" min="1" max="600">
        </div>
        <div class="form-group">
          <label class="form-label">備注</label>
          <textarea class="form-input" id="edit-log-notes" style="min-height:60px;"></textarea>
        </div>
        <input type="hidden" id="edit-log-id">
        <div style="display:flex;gap:10px;margin-top:6px;">
          <button class="btn btn-primary" style="flex:1;" onclick="saveEditLog()">儲存修改</button>
          <button class="btn" style="flex:1;background:var(--surface2);" onclick="closeEditLog()">取消</button>
        </div>
      </div>
    </div>

<!-- DELETE CONFIRM MODAL -->
<div class="delete-modal" id="deleteConfirmModal">
  <div class="delete-modal-box">
    <div class="delete-modal-icon">🗑️</div>
    <div class="delete-modal-title">刪除用戶</div>
    <div class="delete-modal-desc">
      輸入 <strong id="delete-modal-name"></strong> 的密碼以確認刪除。<br>
      此操作不可復原，所有資料將永久刪除。
    </div>
    <input type="hidden" id="delete-uid-hidden">
    <input type="password" class="lock-input" id="delete-pwd-input"
      placeholder="輸入密碼確認"
      style="margin-bottom:6px;"
      onkeydown="if(event.key==='Enter') confirmDeleteUser(document.getElementById('delete-uid-hidden').value)">
    <div class="lock-error" id="delete-pwd-error" style="margin-bottom:10px;"></div>
    <div class="delete-modal-actions">
      <button class="btn btn-secondary" onclick="closeDeleteConfirmModal()">取消</button>
      <button class="btn" style="background:var(--red);color:#fff;"
        onclick="confirmDeleteUser(document.getElementById('delete-uid-hidden').value)">確認刪除</button>
    </div>
  </div>
</div>

<!-- LOCK SCREEN -->
<div class="lock-screen" id="lockScreen">
  <div class="lock-box" id="lockBox">
    <!-- user select view -->
    <div id="lockUserSelect">
      <div style="font-size:28px;margin-bottom:10px;">🏋️</div>
      <div class="lock-name">Training Log</div>
      <div class="lock-hint">選擇你的帳號</div>
      <div class="lock-users" id="lockUserList"></div>
      <div class="lock-divider"></div>
      <button class="lock-user-btn" style="justify-content:center;color:var(--accent);border-color:var(--accent-light);background:var(--accent-light);" onclick="showNewUserForm()">＋ 新增用戶</button>
    </div>
    <!-- password entry view -->
    <div id="lockPasswordView" style="display:none;">
      <div class="lock-avatar" id="lockAvatar">?</div>
      <div class="lock-name" id="lockDisplayName">用戶</div>
      <div class="lock-hint" id="lockPwdHint">請輸入密碼</div>
      <input type="password" class="lock-input" id="lockPwdInput" placeholder="••••••" maxlength="20"
        onkeydown="if(event.key==='Enter') submitLockPassword()">
      <div class="lock-error" id="lockError"></div>
      <button class="lock-btn" onclick="submitLockPassword()">解鎖</button>
      <button class="lock-back" onclick="showLockUserSelect()">← 返回選擇帳號</button>
    </div>
    <!-- new user form -->
    <div id="lockNewUserView" style="display:none;">
      <div style="font-size:28px;margin-bottom:10px;">👤</div>
      <div class="lock-name">建立新帳號</div>
      <div class="lock-hint" style="margin-bottom:20px;">設定名稱與密碼</div>
      <input type="text" class="lock-input" id="lockNewName" placeholder="你的名字" maxlength="20"
        style="letter-spacing:0;margin-bottom:10px;" onkeydown="if(event.key==='Enter')document.getElementById('lockNewPwd').focus()">
      <input type="password" class="lock-input" id="lockNewPwd" placeholder="設定密碼（可留空）" maxlength="20"
        onkeydown="if(event.key==='Enter') submitNewUser()">
      <div class="lock-error" id="lockNewError"></div>
      <button class="lock-btn" onclick="submitNewUser()">建立帳號</button>
      <button class="lock-back" onclick="showLockUserSelect()">← 返回</button>
    </div>
  </div>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDepVwacpLIrszDsOEkDx83ak0xgH8_TpI",
  authDomain: "training-log-40f70.firebaseapp.com",
  projectId: "training-log-40f70",
  storageBucket: "training-log-40f70.firebasestorage.app",
  messagingSenderId: "672010716354",
  appId: "1:672010716354:web:c371ced95080267121a75b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// expose to global scope for the main script
window._db = db;
window._firestoreReady = true;
window._fsDoc = doc;
window._fsGetDoc = getDoc;
window._fsSetDoc = setDoc;
window._fsOnSnapshot = onSnapshot;
window._fsCollection = collection;
window._fsGetDocs = getDocs;
window._fsDeleteDoc = deleteDoc;
window._firebaseProjectId = firebaseConfig.projectId;
window.dispatchEvent(new Event('firestore-ready'));
</script>

<script>
// ── MULTI-USER ──
if (!window._firebaseProjectId) window._firebaseProjectId = 'training-log-40f70';
const USERS_KEY = 'tl_users';
const CUR_KEY   = 'tl_current_user';

function reportLockDiag(msg, isError) {
  try {
    const el = document.getElementById('lockNewError');
    if (el) {
      el.textContent = msg;
      el.style.color = isError ? 'var(--red)' : 'var(--text2)';
    }
  } catch (_) {}
  if (isError) console.error('[LOCK]', msg);
  else console.log('[LOCK]', msg);
}

function getUsers() {
  try {
    const raw = localStorage.getItem(USERS_KEY);
    if (!raw) {
      return Array.isArray(window.__cloudUsersCache) ? window.__cloudUsersCache : [];
    }
    const parsed = JSON.parse(raw);
    if (Array.isArray(parsed) && parsed.length > 0) return parsed;
    return Array.isArray(window.__cloudUsersCache) ? window.__cloudUsersCache : parsed;
  } catch (e) {
    console.warn('Invalid local users cache, resetting:', e);
    try { localStorage.removeItem(USERS_KEY); } catch (_) {}
    return Array.isArray(window.__cloudUsersCache) ? window.__cloudUsersCache : [];
  }
}

function saveUsers(users) {
  try {
    localStorage.setItem(USERS_KEY, JSON.stringify(users));
  } catch (e) {
    console.warn('localStorage saveUsers failed:', e);
  }
  // sync to Firestore
  if (window._firestoreReady) {
    window._fsSetDoc(window._fsDoc(window._db, 'app', 'users'), { list: users })
      .catch(e => console.warn('Firestore saveUsers:', e));
  }
}

function getCurrentUserId() {
  return localStorage.getItem(CUR_KEY) || null;
}

function setCurrentUserId(id) {
  localStorage.setItem(CUR_KEY, id);
}

function userDataKey(uid) { return 'tl_data_' + uid; }

function loadUserData(uid) {
  try {
    return JSON.parse(localStorage.getItem(userDataKey(uid)) || 'null') || {
      logs: [], weights: [], photos: [], plans: [], goals: {}
    };
  } catch (e) {
    console.warn('Invalid local user data cache, resetting:', e);
    try { localStorage.removeItem(userDataKey(uid)); } catch (_) {}
    return { logs: [], weights: [], photos: [], plans: [], goals: {} };
  }
}

function saveUserData(uid, d) {
  try {
    localStorage.setItem(userDataKey(uid), JSON.stringify(d));
  } catch (e) {
    console.warn('localStorage saveUserData failed:', e);
  }
  // sync to Firestore (split photos out to avoid 1MB limit — store refs only)
  if (window._firestoreReady) {
    const toStore = {
      logs: d.logs || [],
      weights: d.weights || [],
      plans: d.plans || [],
      goals: d.goals || {},
      // photos stored separately
    };
    window._fsSetDoc(window._fsDoc(window._db, 'users', uid), toStore)
      .catch(e => console.warn('Firestore saveUserData:', e));
    // save photos separately (may be large)
    const photos = (d.photos || []).map(p => ({ src: p.src, date: p.date, name: p.name || '' }));
    window._fsSetDoc(window._fsDoc(window._db, 'photos', uid), { list: photos })
      .catch(e => console.warn('Firestore savePhotos:', e));
  }
}

async function loadUserDataFromFirestore(uid) {
  if (!window._firestoreReady) return null;
  try {
    const [snap, photoSnap] = await Promise.all([
      window._fsGetDoc(window._fsDoc(window._db, 'users', uid)),
      window._fsGetDoc(window._fsDoc(window._db, 'photos', uid))
    ]);
    if (!snap.exists()) return null;
    const d = snap.data();
    if (photoSnap.exists()) d.photos = photoSnap.data().list || [];
    else d.photos = [];
    return d;
  } catch(e) {
    console.warn('Firestore load error:', e);
    return null;
  }
}

async function loadUsersFromFirestore() {
  if (!window._firestoreReady) return null;
  try {
    const snap = await window._fsGetDoc(window._fsDoc(window._db, 'app', 'users'));
    if (snap.exists()) {
      const payload = snap.data() || {};
      if (Array.isArray(payload.list)) return payload.list;
      if (Array.isArray(payload.users)) return payload.users; // legacy/fallback schema
    }

    // Fallback: rebuild user list from /users collection docs
    const colSnap = await window._fsGetDocs(window._fsCollection(window._db, 'users'));
    const rebuilt = [];
    colSnap.forEach(d => {
      const v = d.data() || {};
      rebuilt.push({
        id: d.id,
        name: (typeof v.name === 'string' && v.name.trim()) ? v.name.trim() : d.id
      });
    });
    return rebuilt;
  } catch(e) {
    console.warn('Firestore loadUsers error:', e);
    return null;
  }
}

function _parseUsersFromFirestoreDoc(docJson) {
  const fields = docJson?.fields || {};
  const values = fields.list?.arrayValue?.values || fields.users?.arrayValue?.values || [];
  return values
    .map(v => {
      const f = v?.mapValue?.fields || {};
      const id = f.id?.stringValue || '';
      const name = f.name?.stringValue || id;
      return id ? { id, name } : null;
    })
    .filter(Boolean);
}

async function loadUsersFromFirestoreREST() {
  const projectId = window._firebaseProjectId;
  if (!projectId) return null;
  const base = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents`;
  try {
    const docRes = await fetch(`${base}/app/users`, { cache: 'no-store' });
    if (docRes.ok) {
      const docJson = await docRes.json();
      const users = _parseUsersFromFirestoreDoc(docJson);
      if (users.length > 0) return users;
    }
  } catch (e) {
    console.warn('REST app/users load failed:', e);
  }

  try {
    const listRes = await fetch(`${base}/users?pageSize=100`, { cache: 'no-store' });
    if (!listRes.ok) return null;
    const listJson = await listRes.json();
    const docs = listJson.documents || [];
    const users = docs.map(d => {
      const id = (d.name || '').split('/').pop();
      const name = d.fields?.name?.stringValue || id;
      return id ? { id, name } : null;
    }).filter(Boolean);
    return users;
  } catch (e) {
    console.warn('REST users collection load failed:', e);
    return null;
  }
}

function avatarClass(idx) { return 'av-' + (idx % 6); }

function initials(name) {
  return name.trim().slice(0, 2).toUpperCase() || '?';
}

// ── CURRENT USER STATE ──
let currentUserId = null;
let data = { logs: [], weights: [], photos: [], plans: [], goals: {} };

function save() {
  if (currentUserId) saveUserData(currentUserId, data);
}

// sync indicator
function showSyncing() {
  const el = document.getElementById('syncStatus');
  if (el) { el.textContent = '☁ 同步中…'; el.style.color = 'var(--text3)'; }
}
function showSynced() {
  const el = document.getElementById('syncStatus');
  if (el) { el.textContent = '☁ 已同步'; el.style.color = 'var(--green)';
    setTimeout(() => { if(el) el.textContent = ''; }, 2000); }
}
function showSyncError() {
  const el = document.getElementById('syncStatus');
  if (el) { el.textContent = '⚠ 同步失敗'; el.style.color = 'var(--red)'; }
}

async function saveAndSync() {
  if (!currentUserId) return;
  saveUserData(currentUserId, data);
  if (!window._firestoreReady) return;
  showSyncing();
  try {
    const toStore = { logs: data.logs||[], weights: data.weights||[], plans: data.plans||[], goals: data.goals||{} };
    await window._fsSetDoc(window._fsDoc(window._db, 'users', currentUserId), toStore);
    const photos = (data.photos||[]).map(p=>({src:p.src,date:p.date,name:p.name||''}));
    await window._fsSetDoc(window._fsDoc(window._db, 'photos', currentUserId), {list:photos});
    showSynced();
  } catch(e) {
    console.warn('sync error', e);
    showSyncError();
  }
}

async function switchUser(uid) {
  currentUserId = uid;
  setCurrentUserId(uid);

  // Load from localStorage immediately (fast)
  data = loadUserData(uid);

  const users = getUsers();
  const user = users.find(u => u.id === uid);
  if (user) {
    const idx = users.indexOf(user);
    document.getElementById('currentUserName').textContent = user.name;
    document.getElementById('currentAvatar').textContent = initials(user.name);
    document.getElementById('currentAvatar').className = 'user-avatar ' + avatarClass(idx);
  }

  closeUserDropdown();
  renderUserList();
  renderDashboard();
  syncTopbarUser();
  showToast('已切換到 ' + (user ? user.name : ''));

  // Then fetch fresh data from Firestore
  if (window._firestoreReady) {
    showSyncing();
    const cloudData = await loadUserDataFromFirestore(uid);
    if (cloudData) {
      // merge: cloud wins for non-photo fields, merge photos by date
      data.logs = cloudData.logs || data.logs;
      data.weights = cloudData.weights || data.weights;
      data.plans = cloudData.plans || data.plans;
      data.goals = cloudData.goals || data.goals;
      data.photos = cloudData.photos || data.photos;
      saveUserData(uid, data); // update localStorage
      renderDashboard();
      showSynced();
    } else {
      showSynced();
    }
  }
}

function addUser() {
  const input = document.getElementById('newUserInput');
  const name = input.value.trim();
  if (!name) { input.focus(); return; }

  const users = getUsers();
  if (users.find(u => u.name === name)) {
    showToast('此名稱已存在'); return;
  }

  const uid = 'user_' + Date.now();
  users.push({ id: uid, name });
  saveUsers(users);
  input.value = '';
  renderUserList();
  switchUser(uid);
}

// requestDeleteUser — shows password confirmation modal then deletes
function requestDeleteUser(uid) {
  const users = getUsers();
  if (users.length <= 1) { showToast('至少保留一個用戶'); return; }
  const user = users.find(u => u.id === uid);
  if (!user) return;
  // show delete confirm modal
  showDeleteConfirmModal(uid, user.name);
}

async function confirmDeleteUser(uid) {
  const pwd = document.getElementById('delete-pwd-input').value;
  const valid = await verifyPassword(uid, pwd);
  if (!valid) {
    const inp = document.getElementById('delete-pwd-input');
    inp.classList.add('error');
    document.getElementById('delete-pwd-error').textContent = '密碼錯誤';
    setTimeout(() => inp.classList.remove('error'), 500);
    inp.value = ''; inp.focus();
    return;
  }
  // delete
  let users = getUsers();
  users = users.filter(u => u.id !== uid);
  saveUsers(users);
  localStorage.removeItem(userDataKey(uid));
  localStorage.removeItem(pwdKey(uid));
  if (window._firestoreReady) {
    try {
      await window._fsDeleteDoc(window._fsDoc(window._db, 'users', uid));
      await window._fsDeleteDoc(window._fsDoc(window._db, 'photos', uid));
      await window._fsDeleteDoc(window._fsDoc(window._db, 'passwords', uid));
    } catch(e) { console.warn('delete from firestore:', e); }
  }
  closeDeleteConfirmModal();
  if (currentUserId === uid) {
    logoutToLockScreen();
  } else {
    renderUserList();
    renderMobileUserList();
  }
  showToast('用戶已刪除');
}

function deleteUser(uid) { requestDeleteUser(uid); }

function showDeleteConfirmModal(uid, name) {
  document.getElementById('delete-modal-name').textContent = name;
  document.getElementById('delete-uid-hidden').value = uid;
  document.getElementById('delete-pwd-input').value = '';
  document.getElementById('delete-pwd-error').textContent = '';
  document.getElementById('deleteConfirmModal').classList.add('open');
  document.body.style.overflow = 'hidden';
  setTimeout(() => document.getElementById('delete-pwd-input').focus(), 200);
}

function closeDeleteConfirmModal() {
  document.getElementById('deleteConfirmModal').classList.remove('open');
  document.body.style.overflow = '';
}

function renderUserList() {
  const users = getUsers();
  const el = document.getElementById('userList');

  if (users.length === 0) {
    el.innerHTML = '<div style="padding:10px 14px;font-size:13px;color:var(--text3);">尚無用戶，請新增</div>';
    return;
  }

  el.innerHTML = users.map((u, i) => `
    <div class="user-item ${u.id === currentUserId ? 'selected' : ''}" onclick="requestSwitchUser('${u.id}')">
      <div class="user-item-avatar ${avatarClass(i)}">${initials(u.name)}</div>
      <div class="user-item-name">${u.name}</div>
      <span class="user-item-check">✓</span>
    </div>
  `).join('');
}

function toggleUserDropdown() {
  const sw = document.getElementById('userSwitcher');
  const dd = document.getElementById('userDropdown');
  const isOpen = dd.classList.contains('open');
  if (isOpen) {
    closeUserDropdown();
  } else {
    dd.classList.add('open');
    sw.classList.add('open');
  }
}

function closeUserDropdown() {
  document.getElementById('userDropdown').classList.remove('open');
  document.getElementById('userSwitcher').classList.remove('open');
}

// Close dropdown when clicking outside
document.addEventListener('click', e => {
  if (!document.getElementById('userSwitcher').contains(e.target)) {
    closeUserDropdown();
  }
});

// ── INIT USERS ──
function initUsers() {
  reportLockDiag('初始化中...');
  // ── STEP 1: Show lock screen from localStorage IMMEDIATELY (no waiting) ──
  let users = getUsers();

  // Migrate old single-user data
  const oldData = localStorage.getItem('tl_data');
  if (oldData && users.length === 0) {
    const uid = 'user_' + Date.now();
    users = [{ id: uid, name: '我' }];
    saveUsers(users);
    localStorage.setItem(userDataKey(uid), oldData);
    localStorage.removeItem('tl_data');
    setCurrentUserId(uid);
  }

  // Show lock screen immediately from localStorage — no async, no waiting
  renderLockUserList();
  if (users.length === 0) {
    showNewUserForm();
    reportLockDiag('本機無用戶，改讀雲端...');
    const hint = document.getElementById('lockNewError');
    if (hint) hint.textContent = '正在從雲端讀取用戶...';
  } else {
    showLockUserSelect();
    reportLockDiag('本機已有用戶，已顯示清單');
  }
  renderUserList();
  syncTopbarUser();

  // ── STEP 2: Sync with Firebase in BACKGROUND (never blocks UI) ──
  _syncUsersFromCloud();
  setTimeout(() => { _syncUsersFromCloud(); }, 2000);
}

async function _syncUsersFromCloud() {
  try {
    reportLockDiag('雲端同步中...');
    // Wait for Firebase to be ready (up to 5s), but don't block UI
    if (!window._firestoreReady) {
      await new Promise(resolve => {
        const check = setInterval(() => {
          if (window._firestoreReady) { clearInterval(check); resolve(); }
        }, 200);
        setTimeout(() => { clearInterval(check); resolve(); }, 5000);
      });
    }
    // Retry cloud fetch a few times to avoid cold-start/slow-network misses.
    let cloudUsers = null;
    if (window._firestoreReady) {
      for (let i = 0; i < 3; i++) {
        cloudUsers = await loadUsersFromFirestore();
        if (cloudUsers && cloudUsers.length > 0) break;
        await new Promise(r => setTimeout(r, 1500));
      }
    }
    // Fallback for environments where Firebase SDK is blocked/slow.
    if (!cloudUsers || cloudUsers.length === 0) cloudUsers = await loadUsersFromFirestoreREST();
    if (!cloudUsers || cloudUsers.length === 0) {
      if (getUsers().length === 0) {
        const hint = document.getElementById('lockNewError');
        if (hint) {
          hint.textContent = '讀不到雲端用戶，請檢查 Firestore 規則是否允許讀取 app/users。';
        }
      }
      reportLockDiag('雲端同步失敗：拿不到任何用戶', true);
      return;
    }
    reportLockDiag('雲端同步成功：' + cloudUsers.length + ' 位用戶');
    const localUsers = getUsers();
    const localIds = new Set(localUsers.map(u => u.id));
    let changed = false;
    cloudUsers.forEach(cu => {
      if (!cu || !cu.id) return;
      if (!localIds.has(cu.id)) {
        localUsers.push({ id: cu.id, name: cu.name || cu.id });
        changed = true;
      }
    });
    if (changed || localUsers.length > 0) {
      window.__cloudUsersCache = localUsers;
      if (changed) saveUsers(localUsers);
      renderLockUserList();
      renderUserList();
      showLockUserSelect();
      reportLockDiag('已渲染用戶清單：' + localUsers.length + ' 位');
    }
  } catch(e) {
    console.warn('Background Firebase sync failed:', e);
    reportLockDiag('同步例外：' + (e && e.message ? e.message : e), true);
  }
}

// ── INIT: Run after DOM is ready ──
// Script is now at end of <body>, so DOM is always ready.
// Use requestAnimationFrame to ensure browser has painted first.
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => requestAnimationFrame(initUsers));
} else {
  requestAnimationFrame(initUsers);
}
window.addEventListener('load', () => {
  setTimeout(() => {
    try { initUsers(); } catch (e) { reportLockDiag('load 初始化失敗：' + (e && e.message ? e.message : e), true); }
  }, 800);
});
window.addEventListener('error', (e) => {
  reportLockDiag('JS錯誤：' + (e.message || 'unknown'), true);
});
window.addEventListener('unhandledrejection', (e) => {
  const reason = e && e.reason ? (e.reason.message || String(e.reason)) : 'unknown';
  reportLockDiag('Promise錯誤：' + reason, true);
});

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function escapeHtml(v) {
  return String(v ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function calcDurationMinutes(start, end) {
  if (!start || !end) return null;
  const [sh, sm] = start.split(':').map(Number);
  const [eh, em] = end.split(':').map(Number);
  if ([sh, sm, eh, em].some(Number.isNaN)) return null;
  let mins = (eh * 60 + em) - (sh * 60 + sm);
  if (mins <= 0) mins += 24 * 60;
  return mins;
}

// ── NAV ──
const pageTitles = {
  dashboard:'總覽', log:'今日記錄', history:'訓練歷史',
  weight:'體重追蹤', photos:'身材照片', plan:'訓練計劃', goals:'目標追蹤',
  workout:'實時訓練', library:'動作庫', period:'生理週期', settings:'用戶設定'
};

function navigate(page, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  if (el) el.classList.add('active');
  document.getElementById('pageTitle').textContent = pageTitles[page];
  renderPage(page);
}

function renderPage(p) {
  if (p==='dashboard') renderDashboard();
  if (p==='log') { prefillHeight(); renderLogExerciseList(); updateWeightDiff(); }
  if (p==='history') renderHistory('all');
  if (p==='weight') renderWeightPage();
  if (p==='photos') renderPhotos();
  if (p==='plan') renderPlans();
  if (p==='goals') renderGoals();
  if (p==='settings') renderSettingsPage();
  if (p==='workout') renderWorkoutTimer();
  if (p==='library') renderLibrary();
  if (p==='period') renderPeriod();
}

// ── PRE-FILL HEIGHT ──
function prefillHeight() {
  const h = data.goals && data.goals.height;
  if (h) document.getElementById('log-height').value = h;
}

// ── INIT DATES ──
const today = new Date().toISOString().split('T')[0];
document.getElementById('log-date').value = today;
document.getElementById('weight-date-input').value = today;
const dateStr = new Date().toLocaleDateString('zh-TW',{year:'numeric',month:'long',day:'numeric',weekday:'long'});
document.getElementById('headerDate').textContent = dateStr;
document.getElementById('sidebarDate').textContent = today;

// ── CALORIE PREVIEW ──
function updateCaloriePreview() {
  const dur = parseInt(document.getElementById('log-duration').value)||0;
  const type = document.getElementById('log-type').value;
  const w = parseFloat(document.getElementById('log-weight').value)||data.goals?.lastWeight||70;
  const pg = document.getElementById('calorie-preview-group');
  if (dur > 0 && type && type !== 'rest') {
    const cal = calcCalories(type, dur, w);
    document.getElementById('calorie-preview').innerHTML = cal + ' <span style="font-size:13px;font-weight:400;">kcal</span>';
    pg.style.display = 'block';
  } else {
    pg.style.display = 'none';
  }
}
document.getElementById('log-duration').addEventListener('input', updateCaloriePreview);
document.getElementById('log-type').addEventListener('change', updateCaloriePreview);
document.getElementById('log-weight').addEventListener('input', updateCaloriePreview);

// ── TYPE MAP ──
const typeMap = {
  chest:'胸部訓練', back:'背部訓練', legs:'腿部訓練',
  shoulders:'肩部訓練', arms:'手臂訓練', core:'核心訓練',
  cardio:'有氧訓練', glutes:'臀部訓練', fullbody:'全身訓練', rest:'休息日'
};

// ── LOG TODAY ──
let pendingLogPhotos = [];

function handleLogPhoto(e) {
  Array.from(e.target.files).forEach(f => {
    const r = new FileReader();
    r.onload = ev => {
      pendingLogPhotos.push({src:ev.target.result, date:document.getElementById('log-date').value});
      const preview = document.getElementById('log-photo-previews');
      preview.innerHTML = pendingLogPhotos.map(p =>
        `<div class="photo-item" style="height:110px;"><img src="${p.src}"><div class="photo-date">${p.date}</div></div>`
      ).join('');
    };
    r.readAsDataURL(f);
  });
}

function saveLog() {
  const date = document.getElementById('log-date').value;
  const weight = document.getElementById('log-weight').value;
  const type = document.getElementById('log-type').value;
  const start = document.getElementById('log-start').value;
  const end = document.getElementById('log-end').value;
  const notes = document.getElementById('log-notes').value;
  const height = document.getElementById('log-height').value;
  const duration = document.getElementById('log-duration').value;

  if (!date) { showToast('請選擇日期'); return; }
  if (!type) { showToast('請選擇訓練類型'); return; }
  if ((start && !end) || (!start && end)) { showToast('開始與結束時間請同時填寫'); return; }
  if (height) { data.goals.height = parseFloat(height); }

  const exercisesText = getExercisesText();
  let durationMin = Number.parseInt(duration, 10);
  if (!Number.isFinite(durationMin) || durationMin <= 0) durationMin = null;
  const autoDuration = calcDurationMinutes(start, end);
  if (autoDuration) durationMin = autoDuration;

  data.logs.unshift({
    id: Date.now(), date,
    weight: weight ? parseFloat(weight) : null,
    type, start, end,
    exercises: exercisesText,
    exercises_structured: [...logExercises],
    notes,
    duration: durationMin,
    calories: durationMin && weight ? calcCalories(type, durationMin, parseFloat(weight)||70) : null,
    photos: [...pendingLogPhotos]
  });

  if (weight) {
    const idx = data.weights.findIndex(w => w.date === date);
    if (idx >= 0) data.weights[idx].value = parseFloat(weight);
    else data.weights.push({date, value: parseFloat(weight)});
    data.weights.sort((a,b) => b.date.localeCompare(a.date));
  }

  pendingLogPhotos.forEach(p => data.photos.push(p));
  saveAndSync();

  pendingLogPhotos = [];
  logExercises = [];
  document.getElementById('log-photo-previews').innerHTML = '';
  renderLogExerciseList();
  ['log-notes','log-weight'].forEach(id => document.getElementById(id).value = '');
  const wb = document.getElementById('weightDiffBadge');
  if (wb) wb.style.display = 'none';
  document.getElementById('log-type').value = '';
  document.getElementById('log-start').value = '';
  document.getElementById('log-end').value = '';
  document.getElementById('log-duration').value = '';
  showToast('✓ 記錄已儲存');
}
const MET = {
  chest: 4.0, back: 4.0, legs: 5.5, shoulders: 3.5,
  arms: 3.0, core: 3.8, cardio: 7.0, glutes: 4.5, fullbody: 5.0, rest: 0
};

function calcCalories(type, durationMin, weightKg) {
  const met = MET[type] || 4.0;
  // Cal = MET × weight(kg) × time(hours)
  return Math.round(met * weightKg * (durationMin / 60));
}

// ── PASSWORD SYSTEM ──
// Passwords stored as simple hashes in localStorage (per user)
function pwdKey(uid) { return 'tl_pwd_' + uid; }

async function hashPassword(pwd) {
  if (!pwd) return '';
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pwd));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function setUserPassword(uid, newPwd) {
  const hash = await hashPassword(newPwd);
  localStorage.setItem(pwdKey(uid), hash);
  // sync to Firestore
  if (window._firestoreReady) {
    window._fsSetDoc(window._fsDoc(window._db, 'passwords', uid), { hash })
      .catch(e => console.warn('pwd sync:', e));
  }
}

async function getUserPasswordHash(uid) {
  // check Firestore first for cross-device sync
  if (window._firestoreReady) {
    try {
      const snap = await window._fsGetDoc(window._fsDoc(window._db, 'passwords', uid));
      if (snap.exists()) {
        const hash = snap.data().hash || '';
        localStorage.setItem(pwdKey(uid), hash);
        return hash;
      }
    } catch(e) {}
  }
  return localStorage.getItem(pwdKey(uid)) || '';
}

async function verifyPassword(uid, inputPwd) {
  const stored = await getUserPasswordHash(uid);
  if (!stored) return true; // no password set = always pass
  const inputHash = await hashPassword(inputPwd);
  return inputHash === stored;
}

async function changePassword() {
  const cur = document.getElementById('pwd-current').value;
  const nw = document.getElementById('pwd-new').value;
  const cf = document.getElementById('pwd-confirm').value;

  if (nw !== cf) { showToast('新密碼兩次輸入不一致'); return; }
  const valid = await verifyPassword(currentUserId, cur);
  if (!valid) { showToast('目前密碼錯誤'); return; }
  await setUserPassword(currentUserId, nw);
  document.getElementById('pwd-current').value = '';
  document.getElementById('pwd-new').value = '';
  document.getElementById('pwd-confirm').value = '';
  showToast(nw ? '✓ 密碼已更新' : '✓ 密碼已移除');
}

// ── LOCK SCREEN ──
let lockSelectedUid = null;

function renderLockUserList() {
  const users = getUsers();
  const el = document.getElementById('lockUserList');
  if (!el) { console.warn('lockUserList not in DOM yet'); return; }
  if (users.length === 0) {
    el.innerHTML = '';
    return;
  }
  el.innerHTML = users.map((u, i) => `
    <button class="lock-user-btn ${u.id === lockSelectedUid ? 'selected' : ''}"
      onclick="selectLockUser('${u.id}')">
      <div class="lock-user-avatar ${avatarClass(i)}">${initials(u.name)}</div>
      <div class="lock-user-info">
        <div class="lock-user-name">${u.name}</div>
      </div>
      <span style="color:var(--text3);font-size:18px;">›</span>
    </button>
  `).join('');
}

async function selectLockUser(uid) {
  lockSelectedUid = uid;
  const users = getUsers();
  const user = users.find(u => u.id === uid);
  const idx = users.indexOf(user);
  const hash = await getUserPasswordHash(uid);

  document.getElementById('lockAvatar').textContent = initials(user.name);
  document.getElementById('lockAvatar').className = 'lock-avatar ' + avatarClass(idx);
  document.getElementById('lockDisplayName').textContent = user.name;
  document.getElementById('lockError').textContent = '';

  if (!hash) {
    // No password — unlock immediately
    unlockApp(uid);
  } else {
    document.getElementById('lockPwdHint').textContent = '請輸入密碼';
    document.getElementById('lockPwdInput').value = '';
    document.getElementById('lockUserSelect').style.display = 'none';
    document.getElementById('lockPasswordView').style.display = 'block';
    document.getElementById('lockNewUserView').style.display = 'none';
    setTimeout(() => document.getElementById('lockPwdInput').focus(), 100);
  }
}

async function submitLockPassword() {
  const input = document.getElementById('lockPwdInput');
  const valid = await verifyPassword(lockSelectedUid, input.value);
  if (valid) {
    unlockApp(lockSelectedUid);
  } else {
    input.classList.add('error');
    document.getElementById('lockError').textContent = '密碼錯誤，請再試一次';
    setTimeout(() => input.classList.remove('error'), 500);
    input.value = '';
    input.focus();
  }
}

function unlockApp(uid) {
  document.getElementById('lockScreen').classList.add('hidden');
  switchUser(uid);
}

function showLockUserSelect() {
  const us = document.getElementById('lockUserSelect');
  const pv = document.getElementById('lockPasswordView');
  const nv = document.getElementById('lockNewUserView');
  if (!us || !pv || !nv) { console.warn('Lock screen DOM not ready'); return; }
  us.style.display = 'block';
  pv.style.display = 'none';
  nv.style.display = 'none';
  renderLockUserList();
}

function showNewUserForm() {
  const us = document.getElementById('lockUserSelect');
  const pv = document.getElementById('lockPasswordView');
  const nv = document.getElementById('lockNewUserView');
  if (!us || !pv || !nv) { console.warn('Lock screen DOM not ready'); return; }
  us.style.display = 'none';
  pv.style.display = 'none';
  nv.style.display = 'block';
  const nameEl = document.getElementById('lockNewName');
  const pwdEl = document.getElementById('lockNewPwd');
  const errEl = document.getElementById('lockNewError');
  if (nameEl) nameEl.value = '';
  if (pwdEl) pwdEl.value = '';
  if (errEl) errEl.textContent = '';
  setTimeout(() => nameEl && nameEl.focus(), 100);
}

async function submitNewUser() {
  const name = document.getElementById('lockNewName').value.trim();
  const pwd = document.getElementById('lockNewPwd').value;
  const errEl = document.getElementById('lockNewError');
  if (!name) { errEl.textContent = '請輸入名稱'; return; }
  const users = getUsers();
  if (users.find(u => u.name === name)) { errEl.textContent = '此名稱已存在'; return; }
  const uid = 'user_' + Date.now();
  users.push({ id: uid, name });
  saveUsers(users);
  if (pwd) await setUserPassword(uid, pwd);
  unlockApp(uid);
}


// ── SETTINGS PAGE ──
function renderSettingsPage() {
  const users = getUsers();
  const user = users.find(u => u.id === currentUserId);
  const idx = users.indexOf(user);
  if (user) {
    document.getElementById('settings-username').textContent = user.name;
    document.getElementById('settings-avatar').textContent = initials(user.name);
    document.getElementById('settings-avatar').className = 'user-avatar ' + avatarClass(idx);
  }
  const g = data.goals || {};
  if (g.height) document.getElementById('settings-height').value = g.height;
  if (g.age) document.getElementById('settings-age').value = g.age;
  // Render gender buttons
  ['male','female','other'].forEach(gn => {
    const btn = document.getElementById('gender-'+gn);
    if (btn) btn.classList.toggle('selected', g.gender === gn);
  });
  // clear password fields
  ['settings-pwd-current','settings-pwd-new','settings-pwd-confirm'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
}

function selectGender(g) {
  ['male','female','other'].forEach(k => {
    const btn = document.getElementById('gender-'+k);
    if (btn) btn.classList.remove('selected');
  });
  document.getElementById('gender-'+g)?.classList.add('selected');
  if (!data.goals) data.goals = {};
  data.goals.gender = g;
}

function saveSettingsProfile() {
  const h = parseFloat(document.getElementById('settings-height').value);
  const age = parseInt(document.getElementById('settings-age').value);
  if (!data.goals) data.goals = {};
  if (h && h >= 100 && h <= 250) data.goals.height = h;
  else if (document.getElementById('settings-height').value) { showToast('請輸入有效身高（100-250cm）'); return; }
  if (age && age >= 10 && age <= 100) data.goals.age = age;
  else if (document.getElementById('settings-age').value) { showToast('請輸入有效年齡（10-100）'); return; }
  saveAndSync();
  renderDashboard();
  showToast('✓ 個人資料已儲存，BMI 已更新');
}

async function changePasswordFromSettings() {
  const cur = document.getElementById('settings-pwd-current').value;
  const nw = document.getElementById('settings-pwd-new').value;
  const cf = document.getElementById('settings-pwd-confirm').value;
  if (nw !== cf) { showToast('兩次密碼不一致'); return; }
  const valid = await verifyPassword(currentUserId, cur);
  if (!valid) { showToast('目前密碼錯誤'); return; }
  await setUserPassword(currentUserId, nw);
  ['settings-pwd-current','settings-pwd-new','settings-pwd-confirm'].forEach(id => {
    document.getElementById(id).value = '';
  });
  showToast(nw ? '✓ 密碼已更新' : '✓ 密碼已移除');
}


// ── DELETE SELF ACCOUNT (from settings page) ──
function showDeleteSelfConfirm() {
  document.getElementById('delete-self-section').style.display = 'none';
  document.getElementById('delete-self-confirm').style.display = 'block';
  document.getElementById('delete-self-pwd').value = '';
  document.getElementById('delete-self-error').textContent = '';
  document.getElementById('delete-self-pwd').focus();
}

function cancelDeleteSelf() {
  document.getElementById('delete-self-section').style.display = 'block';
  document.getElementById('delete-self-confirm').style.display = 'none';
}

async function confirmDeleteSelf() {
  const pwd = document.getElementById('delete-self-pwd').value;
  const valid = await verifyPassword(currentUserId, pwd);
  if (!valid) {
    document.getElementById('delete-self-error').textContent = '密碼錯誤';
    document.getElementById('delete-self-pwd').value = '';
    document.getElementById('delete-self-pwd').focus();
    return;
  }
  const users = getUsers();
  if (users.length <= 1) { showToast('至少保留一個帳號'); cancelDeleteSelf(); return; }
  // perform delete
  const uid = currentUserId;
  const remaining = users.filter(u => u.id !== uid);
  saveUsers(remaining);
  localStorage.removeItem(userDataKey(uid));
  localStorage.removeItem(pwdKey(uid));
  if (window._firestoreReady) {
    try {
      await window._fsDeleteDoc(window._fsDoc(window._db, 'users', uid));
      await window._fsDeleteDoc(window._fsDoc(window._db, 'photos', uid));
      await window._fsDeleteDoc(window._fsDoc(window._db, 'passwords', uid));
    } catch(e) { console.warn('delete from firestore:', e); }
  }
  showToast('帳號已刪除');
  logoutToLockScreen();
}

// ── LOGOUT → LOCK SCREEN ──
function logoutToLockScreen() {
  // hide app, show lock screen
  document.getElementById('lockScreen').classList.remove('hidden');
  renderLockUserList();
  showLockUserSelect();
}

// ── SWITCH USER WITH PASSWORD ──
// Called from sidebar user switcher — goes through lock screen
function requestSwitchUser(uid) {
  if (uid === currentUserId) { closeUserDropdown(); return; }
  closeUserDropdown();
  // Show lock screen targeting that user
  document.getElementById('lockScreen').classList.remove('hidden');
  selectLockUser(uid);
}

function requestSwitchUserMobile(uid) {
  if (uid === currentUserId) { closeMobileUserModal(); return; }
  closeMobileUserModal();
  document.getElementById('lockScreen').classList.remove('hidden');
  selectLockUser(uid);
}

// ── DASHBOARD ──
function renderDashboard() {
  const ws = data.weights.sort((a,b) => b.date.localeCompare(a.date));
  const latest = ws[0], prev = ws[1];

  if (latest) {
    document.getElementById('dash-weight').textContent = latest.value.toFixed(1);
    if (prev) {
      const diff = (latest.value - prev.value).toFixed(1);
      const el = document.getElementById('dash-weight-change');
      el.innerHTML = (diff > 0 ? '▲ +' : diff < 0 ? '▼ ' : '') + diff + ' kg 較前次';
      el.className = 'stat-change ' + (diff > 0 ? 'up' : diff < 0 ? 'down' : 'neutral');
    }
  }

  const goal = data.goals;
  if (goal.weight && latest) {
    const rem = (latest.value - goal.weight);
    document.getElementById('dash-remaining').textContent = Math.abs(rem).toFixed(1);
    document.getElementById('dash-target-weight').textContent = '目標：' + goal.weight + ' kg';
  }

  const now = new Date();
  const monthLogs = data.logs.filter(l => {
    const d = new Date(l.date);
    return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear() && l.type && l.type!=='rest';
  });
  document.getElementById('dash-sessions').textContent = monthLogs.length;

  let streak = 0, check = new Date();
  for (let i=0; i<60; i++) {
    const ds = check.toISOString().split('T')[0];
    if (data.logs.find(l => l.date===ds && l.type && l.type!=='rest')) {
      streak++; check.setDate(check.getDate()-1);
    } else break;
  }
  document.getElementById('dash-streak').textContent = streak;

  // Recent
  const recent = data.logs.slice(0,4);
  const rl = document.getElementById('recent-logs');
  rl.innerHTML = recent.length === 0
    ? '<div class="empty-state" style="padding:16px 0;"><div class="empty-icon">📋</div>尚無記錄</div>'
    : recent.map(l => `
        <div class="workout-entry" style="padding:12px 14px;">
          <div>
            <div class="entry-date">${l.date}</div>
            <div class="entry-title" style="font-size:14px;">${typeMap[l.type]||'未知'}</div>
          </div>
          ${l.weight ? `<div style="font-size:15px;font-weight:700;color:var(--accent)">${l.weight}<span style="font-size:11px;color:var(--text3);font-weight:400;"> kg</span></div>` : ''}
        </div>`).join('');

  drawChart('weightChart', ws.slice(0,30).reverse(), 560, 160);

  // BMI — with age adjustment
  const height = data.goals && data.goals.height;
  const age    = data.goals && data.goals.age;
  const gender = data.goals && data.goals.gender;
  const bmiVal  = document.getElementById('bmi-value');
  const bmiCat  = document.getElementById('bmi-category-badge');
  const bmiSub  = document.getElementById('bmi-sub');
  const bmiBar  = document.getElementById('bmi-bar-wrap');
  const bmiMark = document.getElementById('bmi-marker');
  if (latest && height) {
    const bmi = latest.value / ((height/100) ** 2);
    bmiVal.textContent = bmi.toFixed(1);
    bmiBar.style.opacity = '1';
    const pct = Math.min(100, Math.max(0, (bmi - 15) / (35 - 15) * 100));
    bmiMark.style.left = pct + '%';

    // Age-adjusted BMI thresholds
    // Under 18: use WHO child/teen ranges (simplified)
    // 18-64: standard (18.5/24/27/30)
    // 65+: slightly higher thresholds (22/27/30) — muscle loss with age
    // Note: Asian populations often use 23/27.5 (WHO Asia-Pacific guideline)
    let tUnder, tNormal, tOver, catName;
    if (age && age < 18) {
      // Teens: use standard adult thresholds as approximation
      tUnder = 18.5; tNormal = 24; tOver = 27;
    } else if (age && age >= 65) {
      // Elderly: higher thresholds recommended
      tUnder = 22; tNormal = 27; tOver = 30;
    } else {
      // Standard adult (WHO Asian guideline)
      tUnder = 18.5; tNormal = 24; tOver = 27;
    }

    let cat, color, bg, ageNote = '';
    if (bmi < tUnder)      { cat='偏瘦'; color='#34aadc'; bg='rgba(52,170,220,0.12)'; }
    else if (bmi < tNormal){ cat='正常'; color='var(--green)'; bg='var(--green-light)'; }
    else if (bmi < tOver)  { cat='過重'; color='var(--orange)'; bg='var(--orange-light)'; }
    else                   { cat='肥胖'; color='var(--red)'; bg='var(--red-light)'; }

    if (age && age >= 65) ageNote = ' ·長者標準';
    bmiCat.textContent = cat;
    bmiCat.style.color = color;
    bmiCat.style.background = bg;
    let sub = '身高 ' + height + ' cm · 體重 ' + latest.value.toFixed(1) + ' kg';
    if (age) sub += ' · ' + age + '歲' + ageNote;
    bmiSub.textContent = sub;
  } else {
    bmiVal.textContent = '—';
    bmiSub.textContent = height ? '請記錄體重' : '請至用戶設定填寫身高和年齡';
    bmiCat.textContent = '—';
    bmiCat.style.background = '#e5e5ea';
    bmiCat.style.color = 'var(--text3)';
    bmiBar.style.opacity = '0.3';
    bmiMark.style.left = '50%';
  }

  // Monthly calories
  const monthCal = monthLogs.reduce((s, l) => s + (l.calories||0), 0);
  document.getElementById('dash-calories').textContent = monthCal.toLocaleString();
  document.getElementById('dash-calories-sub').textContent = monthCal > 0 ? '本月消耗估算' : '記錄訓練時長以計算';
}

// ── CHART ──
function drawChart(id, weights, W, H) {
  const svg = document.getElementById(id);
  if (!svg || weights.length < 2) { if(svg) svg.innerHTML=''; return; }
  const vals = weights.map(w=>w.value);
  const min = Math.min(...vals)-1.5, max = Math.max(...vals)+1.5;
  const pad = {l:36, r:12, t:12, b:28};
  const cw = W-pad.l-pad.r, ch = H-pad.t-pad.b;
  const x = i => pad.l+(i/(vals.length-1))*cw;
  const y = v => pad.t+ch-((v-min)/(max-min))*ch;

  // grid
  let grid='';
  for(let i=0;i<=3;i++){
    const yv = pad.t+(ch/3)*i;
    const val = (max-(max-min)*i/3).toFixed(1);
    grid+=`<line x1="${pad.l}" y1="${yv}" x2="${W-pad.r}" y2="${yv}" stroke="#e5e5ea" stroke-width="1"/>`;
    grid+=`<text x="${pad.l-6}" y="${yv+4}" text-anchor="end" fill="#a1a1a6" font-size="9.5" font-family="'Noto Sans TC',sans-serif">${val}</text>`;
  }
  // date labels
  let dateLabels='';
  if(weights.length>0){
    [0, Math.floor((weights.length-1)/2), weights.length-1].forEach(i=>{
      if(weights[i]) dateLabels+=`<text x="${x(i)}" y="${H-4}" text-anchor="middle" fill="#a1a1a6" font-size="9" font-family="'Noto Sans TC',sans-serif">${weights[i].date.slice(5)}</text>`;
    });
  }
  // goal line
  const gw = data.goals.weight;
  let goalLine='';
  if(gw && gw>=min && gw<=max){
    const gy=y(gw);
    goalLine=`<line x1="${pad.l}" y1="${gy}" x2="${W-pad.r}" y2="${gy}" stroke="#ff3b30" stroke-width="1.2" stroke-dasharray="5,4" opacity="0.5"/>
    <text x="${W-pad.r+4}" y="${gy+3.5}" fill="#ff3b30" font-size="9" font-family="'Noto Sans TC',sans-serif" opacity="0.7">目標</text>`;
  }
  // area
  const pts = vals.map((v,i)=>`${x(i)},${y(v)}`).join(' ');
  const area = `${x(0)},${H-pad.b} ${pts} ${x(vals.length-1)},${H-pad.b}`;

  svg.innerHTML = `
    <defs>
      <linearGradient id="g_${id}" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#0071e3" stop-opacity="0.12"/>
        <stop offset="100%" stop-color="#0071e3" stop-opacity="0.01"/>
      </linearGradient>
    </defs>
    ${grid}${dateLabels}${goalLine}
    <polygon points="${area}" fill="url(#g_${id})"/>
    <polyline points="${pts}" fill="none" stroke="#0071e3" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
    ${vals.map((v,i)=>`<circle cx="${x(i)}" cy="${y(v)}" r="3.5" fill="#fff" stroke="#0071e3" stroke-width="1.8"/>`).join('')}
  `;
}

// ── HISTORY ──
function renderHistory(filter) {
  filter = filter || document.getElementById('history-filter').value;
  let logs = data.logs.slice();
  if(filter!=="all") logs=logs.filter(l=>l.type===filter);
  const el = document.getElementById('history-list');
  if(logs.length===0){
    el.innerHTML='<div class="empty-state"><div class="empty-icon">📋</div>尚無訓練記錄</div>';
    return;
  }
  el.innerHTML = logs.map(l=>{
    const dur = l.start&&l.end ? calcDur(l.start,l.end) : null;
    const dateText = `${l.date || ''}${l.start ? ' · ' + l.start + (l.end ? ' — ' + l.end : '') : ''}`;
    const safeExercises = escapeHtml(l.exercises || '').replace(/\n/g, '<br>');
    const safeNotes = escapeHtml(l.notes || '').replace(/\n/g, '<br>');
    return `<div class="workout-entry ${l.type==='rest'?'rest':''}">
      <div>
        <div class="entry-date">${escapeHtml(dateText)}</div>
        <div class="entry-title">${escapeHtml(typeMap[l.type]||'未知')}</div>
        <div class="entry-meta">
          ${dur?`<span class="entry-tag">⏱ ${dur}</span>`:''}
          ${l.weight?`<span class="entry-tag">⚖ ${l.weight} kg</span>`:''}
          ${l.photos&&l.photos.length?`<span class="entry-tag green">📷 ${l.photos.length} 張</span>`:''}
          ${l.calories?`<span class="calorie-tag">🔥 ${l.calories} kcal</span>`:''}
        </div>
        ${l.exercises?`<div class="entry-exercises">${safeExercises}</div>`:''}
        ${l.notes?`<div class="entry-notes">${safeNotes}</div>`:''}
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0;">
        <button class="btn" style="padding:6px 12px;font-size:12px;background:var(--accent-light);color:var(--accent);border-radius:8px;" onclick="openEditLog(${l.id})">✏️ 修改</button>
        <button class="btn btn-danger" style="padding:6px 12px;font-size:12px;" onclick="deleteLog(${l.id})">刪除</button>
      </div>
    </div>`;
  }).join('');
}
function calcDur(s,e){
  const [sh,sm]=s.split(':').map(Number), [eh,em]=e.split(':').map(Number);
  let m=(eh*60+em)-(sh*60+sm); if(m<=0) m+=24*60;
  return m>=60 ? Math.floor(m/60)+'小時'+(m%60?m%60+'分':'') : m+'分鐘';
}

function deleteLog(id){
  data.logs=data.logs.filter(l=>l.id!==id); saveAndSync(); renderHistory();
  showToast('已刪除記錄');
}

// ── WEIGHT PAGE ──
function setTargetWeight(){
  const v=parseFloat(document.getElementById('target-weight-input').value);
  if(!v) return;
  data.goals.weight=v; saveAndSync();
  showToast('目標體重設定為 '+v+' kg');
  renderWeightPage();
}

function addWeightRecord(){
  const date=document.getElementById('weight-date-input').value;
  const val=parseFloat(document.getElementById('weight-value-input').value);
  if(!date||!val){showToast('請填寫日期和體重');return;}
  const idx=data.weights.findIndex(w=>w.date===date);
  if(idx>=0) data.weights[idx].value=val;
  else data.weights.push({date,value:val});
  data.weights.sort((a,b)=>b.date.localeCompare(a.date));
  saveAndSync(); renderWeightPage();
  showToast('體重記錄已新增');
}

function renderWeightPage(){
  const weights=data.weights.slice().sort((a,b)=>b.date.localeCompare(a.date));
  const tbody=document.getElementById('weight-tbody');
  if(weights.length===0){
    tbody.innerHTML='<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:32px;">尚無記錄</td></tr>';
  } else {
    tbody.innerHTML=weights.map((w,i)=>{
      const prev=weights[i+1];
      const diff=prev?(w.value-prev.value).toFixed(1):null;
      const goal=data.goals.weight;
      const rem=goal?(w.value-goal).toFixed(1):null;
      let badge='';
      if(rem!==null){
        if(Math.abs(rem)<0.5) badge='<span class="badge badge-green">達標 🎉</span>';
        else if(rem>0) badge=`<span class="badge badge-orange">距目標 -${rem} kg</span>`;
        else badge=`<span class="badge badge-blue">超出 ${Math.abs(rem)} kg</span>`;
      }
      return `<tr>
        <td style="color:var(--text2)">${w.date}</td>
        <td style="font-weight:700;font-size:15px;">${w.value.toFixed(1)} <span style="font-size:12px;font-weight:400;color:var(--text3)">kg</span></td>
        <td style="font-weight:600;color:${diff>0?'var(--red)':diff<0?'var(--green)':'var(--text3)'}">
          ${diff!==null?(diff>0?'▲ +':'▼ ')+diff:''}</td>
        <td>${badge}</td>
        <td><button class="btn btn-danger" onclick="deleteWeight('${w.date}')">刪除</button></td>
      </tr>`;
    }).join('');
  }
  drawChart('weightChartFull', weights.slice().reverse(), 760, 200);
}

function deleteWeight(date){
  data.weights=data.weights.filter(w=>w.date!==date); saveAndSync(); renderWeightPage();
}

// ── PHOTOS ──
function handlePhotoUpload(e){
  Array.from(e.target.files).forEach(f=>{
    const r=new FileReader();
    r.onload=ev=>{
      data.photos.push({src:ev.target.result, date:today, name:f.name});
      saveAndSync(); renderPhotos();
    };
    r.readAsDataURL(f);
  });
}

function renderPhotos(){
  const el=document.getElementById('all-photos');
  if(data.photos.length===0){
    el.innerHTML='<div class="empty-state" style="grid-column:1/-1;"><div class="empty-icon">📷</div>尚無照片</div>';
    return;
  }
  el.innerHTML=data.photos.slice().reverse().map((p,i)=>`
    <div class="photo-item">
      <img src="${p.src}" alt="">
      <div class="photo-date">${p.date}</div>
      <button class="photo-delete" onclick="deletePhoto(${data.photos.length-1-i})">✕</button>
    </div>`).join('');
}

function deletePhoto(idx){ data.photos.splice(idx,1); saveAndSync(); renderPhotos(); }

// ── PLANS ──
function addPlan(){
  const name=document.getElementById('plan-name').value;
  const start=document.getElementById('plan-start').value;
  const end=document.getElementById('plan-end').value;
  const desc=document.getElementById('plan-desc').value;
  if(!name){showToast('請輸入計劃名稱');return;}
  data.plans.unshift({id:Date.now(),name,start,end,desc});
  saveAndSync();
  document.getElementById('plan-name').value='';
  document.getElementById('plan-desc').value='';
  renderPlans(); showToast('訓練計劃已新增');
}

function renderPlans(){
  const el=document.getElementById('plan-list');
  if(data.plans.length===0){
    el.innerHTML='<div class="empty-state" style="grid-column:1/-1;"><div class="empty-icon">🗓</div>尚無訓練計劃</div>';
    return;
  }
  el.innerHTML=data.plans.map(p=>{
    const isActive=p.start&&p.end&&today>=p.start&&today<=p.end;
    const total=p.start&&p.end?Math.ceil((new Date(p.end)-new Date(p.start))/86400000):0;
    const elapsed=p.start?Math.max(0,Math.ceil((new Date(today)-new Date(p.start))/86400000)):0;
    const pct=total>0?Math.min(100,Math.round(elapsed/total*100)):0;
    const safeName = escapeHtml(p.name || '');
    const safeStart = escapeHtml(p.start || '?');
    const safeEnd = escapeHtml(p.end || '?');
    const safeDesc = p.desc
      ? `<ul class="phase-exercises">${p.desc.split('\n').filter(Boolean).map(l=>`<li>${escapeHtml(l)}</li>`).join('')}</ul>`
      : '';
    return `<div class="phase-card ${isActive?'active-phase':''}">
      ${isActive?'<div class="active-badge">進行中</div>':''}
      <div class="phase-name">${safeName}</div>
      <div class="phase-duration">${safeStart} → ${safeEnd}</div>
      ${safeDesc}
      ${total>0?`<div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div style="font-size:11px;color:var(--text3);margin-top:6px;">${pct}% 完成 · 共 ${total} 天</div>`:''}
      <div style="margin-top:14px;">
        <button class="btn btn-danger" onclick="deletePlan(${p.id})">刪除計劃</button>
      </div>
    </div>`;
  }).join('');
}
function deletePlan(id){ data.plans=data.plans.filter(p=>p.id!==id); saveAndSync(); renderPlans(); }

// ── GOALS ──
function saveGoals(){
  const weight=parseFloat(document.getElementById('goal-weight').value);
  const date=document.getElementById('goal-date').value;
  const sessions=parseInt(document.getElementById('goal-sessions').value);
  const desc=document.getElementById('goal-desc').value;
  if(weight) data.goals.weight=weight;
  if(date) data.goals.date=date;
  if(sessions) data.goals.sessions=sessions;
  if(desc) data.goals.desc=desc;
  saveAndSync(); showToast('目標已儲存'); renderGoals();
}

function renderGoals(){
  const g=data.goals;
  if(!g.weight&&!g.sessions){
    document.getElementById('goals-display').innerHTML='<div class="empty-state"><div class="empty-icon">🎯</div>尚未設定目標</div>';
    return;
  }
  const weights=data.weights.sort((a,b)=>b.date.localeCompare(a.date));
  const latest=weights[0];
  let html='';

  if(g.weight&&latest){
    const start=weights[weights.length-1]?.value||latest.value;
    const totalChange=Math.abs(start-g.weight);
    const done=Math.abs(latest.value-g.weight);
    const pct=totalChange>0?Math.max(0,Math.round((1-done/totalChange)*100)):(latest.value===g.weight?100:0);
    const C=2*Math.PI*28, offset=C-(pct/100)*C;
    html+=`<div class="goal-card">
      <div>
        <div class="goal-title">目標體重</div>
        <div class="goal-meta">
          當前 ${latest.value.toFixed(1)} kg &nbsp;→&nbsp; 目標 ${g.weight} kg
          ${g.date?' · 截止日：'+g.date:''}
        </div>
        <div style="margin-top:10px;font-size:13px;color:${latest.value>g.weight?'var(--orange)':'var(--green)'};">
          ${latest.value>g.weight?`還需減少 ${(latest.value-g.weight).toFixed(1)} kg`:latest.value<g.weight?`還需增加 ${(g.weight-latest.value).toFixed(1)} kg`:'🎉 目標已達成！'}
        </div>
      </div>
      <div class="goal-circle">
        <svg viewBox="0 0 70 70" width="70" height="70">
          <circle cx="35" cy="35" r="28" fill="none" stroke="#e5e5ea" stroke-width="6"/>
          <circle cx="35" cy="35" r="28" fill="none" stroke="${pct>=100?'var(--green)':'var(--accent)'}" stroke-width="6"
            stroke-dasharray="${C}" stroke-dashoffset="${offset}" stroke-linecap="round"/>
        </svg>
        <div class="goal-percent" style="color:${pct>=100?'var(--green)':'var(--accent)'}">${pct}%</div>
      </div>
    </div>`;
  }

  if(g.sessions){
    const now=new Date(), ws2=new Date(now);
    ws2.setDate(now.getDate()-now.getDay());
    const weekSess=data.logs.filter(l=>{
      const d=new Date(l.date); return d>=ws2&&l.type&&l.type!=='rest';
    }).length;
    const pct2=Math.min(100,Math.round(weekSess/g.sessions*100));
    const C=2*Math.PI*28, offset=C-(pct2/100)*C;
    html+=`<div class="goal-card">
      <div>
        <div class="goal-title">本週訓練目標</div>
        <div class="goal-meta">
          目標：每週 ${g.sessions} 次 &nbsp;·&nbsp; 本週已完成：${weekSess} 次
          ${g.desc?'<br>'+g.desc:''}
        </div>
      </div>
      <div class="goal-circle">
        <svg viewBox="0 0 70 70" width="70" height="70">
          <circle cx="35" cy="35" r="28" fill="none" stroke="#e5e5ea" stroke-width="6"/>
          <circle cx="35" cy="35" r="28" fill="none" stroke="${pct2>=100?'var(--green)':'#30d158'}" stroke-width="6"
            stroke-dasharray="${C}" stroke-dashoffset="${offset}" stroke-linecap="round"/>
        </svg>
        <div class="goal-percent" style="color:var(--green)">${pct2}%</div>
      </div>
    </div>`;
  }

  document.getElementById('goals-display').innerHTML = html||'<div class="empty-state">請設定目標</div>';
}



// ══════════════════════════════════════════════════════════
// EXERCISE DATABASE
// ══════════════════════════════════════════════════════════
const EXERCISES = [
  // CHEST
  { id:'b1', name:'槓鈴臥推', muscle:'胸部', equipment:'槓鈴', difficulty:'中級',
    desc:'最經典的胸部訓練動作，主要鍛鍊胸大肌，同時刺激三角肌前束與三頭肌。',
    muscles:['胸大肌（主）','三角肌前束','三頭肌'],
    steps:['躺在臥推凳上，雙腳平踩地面，背部自然弓起。','雙手握距略寬於肩，掌心朝前握緊槓鈴。','深吸氣，緩慢將槓鈴下放至乳頭位置，感受胸部拉伸。','用力將槓鈴推起，呼氣，頂端鎖緊收縮胸肌。'],
    tips:['保持肩胛骨收緊貼凳', '不要讓手腕過度後仰', '下放時控制速度約2秒'] },
  { id:'b2', name:'上斜槓鈴臥推', muscle:'胸部', equipment:'槓鈴', difficulty:'中級',
    desc:'針對胸大肌上束，讓胸型更飽滿立體。',
    muscles:['胸大肌上束（主）','三角肌前束','三頭肌'],
    steps:['將凳子調至30-45度角。','以同臥推方式握槓，下放至鎖骨附近。','推起時特別感受上胸收縮。'],
    tips:['角度不超過45度以免變成肩部訓練', '組間可搭配下斜動作平衡發展'] },
  { id:'b3', name:'啞鈴飛鳥', muscle:'胸部', equipment:'啞鈴', difficulty:'初級',
    desc:'孤立胸肌的優質拉伸動作，強調內側收縮感。',
    muscles:['胸大肌（主）'],
    steps:['躺平，雙手各持啞鈴，手臂微彎呈弧形。','慢慢向兩側展開，感受胸部充分拉伸。','收縮胸肌，將啞鈴沿弧線合回起始位置。'],
    tips:['手肘微彎保持固定角度全程', '不要追求重量，感受才是關鍵'] },
  { id:'b4', name:'繩索夾胸', muscle:'胸部', equipment:'繩索', difficulty:'初級',
    desc:'全程保持張力的胸肌孤立動作，適合訓練末段收縮感。',
    muscles:['胸大肌（主）','胸小肌'],
    steps:['將兩側繩索調至高位，站在兩者中間。','雙手握住把手，呈半弓步站姿。','沿弧線將兩手向下向中收，在中間交叉夾緊停頓1秒。','緩慢回到起始位置。'],
    tips:['動作全程保持核心穩定', '夾緊時可做小幅交叉加強收縮'] },
  { id:'b5', name:'雙槓撐體', muscle:'胸部', equipment:'徒手', difficulty:'中級',
    desc:'利用自身體重訓練下胸與三頭，需有一定基礎。',
    muscles:['胸大肌下束（主）','三頭肌','三角肌前束'],
    steps:['握住雙槓，雙臂撐起身體。','身體略微前傾，緩慢下沉至手肘90度。','撐起回到起點，避免鎖死手肘。'],
    tips:['前傾角度越大越針對胸肌', '若覺得困難可先用輔助帶'] },
  { id:'b6', name:'伏地挺身', muscle:'胸部', equipment:'徒手', difficulty:'初級',
    desc:'全身性推力動作，隨時隨地可以練習。',
    muscles:['胸大肌','三頭肌','三角肌前束','核心'],
    steps:['雙手略寬於肩，腳趾撐地，身體呈一直線。','緩慢下降至胸部接近地面。','用力推起，不要聳肩。'],
    tips:['核心全程收緊避免塌腰', '寬手距偏胸，窄手距偏三頭'] },

  // BACK
  { id:'c1', name:'槓鈴硬舉', muscle:'背部', equipment:'槓鈴', difficulty:'高級',
    desc:'全身性複合動作之王，主要鍛鍊下背、臀部與腿後肌，同時需要全身協調。',
    muscles:['豎脊肌（主）','臀大肌','腿後肌','斜方肌'],
    steps:['站在槓鈴前，雙腳與肩同寬，腳尖朝前。','俯身，雙手握槓（正握或正反握），手臂垂直地面。','深吸氣，收緊核心與背部，以臀腿力量將槓鈴提起。','站直後肩胛夾緊，再控制地將槓鈴放回地面。'],
    tips:['全程保持背部平直，嚴禁圓背', '槓鈴貼腿移動，減少槓桿力矩', '初學者先從輕重量掌握動作模式'] },
  { id:'c2', name:'槓鈴俯身划船', muscle:'背部', equipment:'槓鈴', difficulty:'中級',
    desc:'增加背部厚度的黃金動作，主要刺激背闊肌中部與菱形肌。',
    muscles:['背闊肌（主）','菱形肌','二頭肌'],
    steps:['俯身約45度，背部保持平直。','槓鈴位於雙腿間，雙手正握略寬於肩。','以肘為軸，將槓鈴提拉至腹部，頂端夾緊背部。','緩慢放回，感受背闊肌拉伸。'],
    tips:['腰椎要中立，不要圓背', '想像用手肘而非雙手在拉'] },
  { id:'c3', name:'引體向上', muscle:'背部', equipment:'徒手', difficulty:'高級',
    desc:'上肢拉力之王，對背寬發展效果極佳。',
    muscles:['背闊肌（主）','二頭肌','菱形肌'],
    steps:['雙手正握單槓，握距略寬於肩。','以肩胛骨下沉為啟動，將身體拉起至下巴超過單槓。','控制緩慢下降，充分拉伸背闊肌。'],
    tips:['避免借助腿部甩動的慣性', '下放時要完全伸展手臂', '若做不到可先用輔助帶或高位下拉機器'] },
  { id:'c4', name:'高位下拉', muscle:'背部', equipment:'機器', difficulty:'初級',
    desc:'引體向上的機器替代版，適合初學者或體重較重者。',
    muscles:['背闊肌（主）','二頭肌'],
    steps:['坐好調整膝墊固定大腿，握距略寬於肩。','將拉桿拉至鎖骨前方，同時向後仰約15度。','夾緊背部2秒，緩慢放回到起始位置。'],
    tips:['不要讓重量帶著你彈起', '想像手肘插入腰包的感覺'] },
  { id:'c5', name:'坐姿划船', muscle:'背部', equipment:'機器', difficulty:'初級',
    desc:'安全有效的背部厚度動作，適合學習正確划船感受。',
    muscles:['背闊肌中部','菱形肌','二頭肌'],
    steps:['坐於座位上，腳踩踏板，背部挺直。','雙手握把，以肘帶動，將把手拉向腹部。','夾緊肩胛骨停留1秒，再控制放回。'],
    tips:['不要用身體大幅晃動借力', '拉到最後時感受兩邊肩胛骨互相夾緊'] },

  // LEGS
  { id:'d1', name:'槓鈴深蹲', muscle:'腿部', equipment:'槓鈴', difficulty:'高級',
    desc:'下半身訓練的核心動作，同時刺激股四頭、臀部、腿後肌及核心。',
    muscles:['股四頭肌（主）','臀大肌','腿後肌','核心'],
    steps:['將槓鈴置於斜方肌上方，雙腳與肩同寬，腳尖略朝外。','深吸氣，核心收緊，緩慢屈膝下蹲。','大腿至少平行地面，膝蓋對準腳尖方向。','用力站起，呼氣，避免膝蓋內扣。'],
    tips:['腰椎保持中立，嚴禁圓腰', '可先從高箱深蹲或自重深蹲開始', '視線保持前方偏上方'] },
  { id:'d2', name:'腿舉機', muscle:'腿部', equipment:'機器', difficulty:'初級',
    desc:'安全有效訓練股四頭的動作，適合大重量刺激。',
    muscles:['股四頭肌（主）','臀大肌'],
    steps:['坐好調整靠背，雙腳踩踏板與肩同寬。','緩慢彎曲膝蓋至接近胸口。','用力蹬出，不要鎖死膝蓋。'],
    tips:['腳位越低越針對股四頭', '腳位越高越針對臀大肌與腿後'] },
  { id:'d3', name:'羅馬尼亞硬舉', muscle:'腿部', equipment:'槓鈴', difficulty:'中級',
    desc:'主要針對腿後肌與臀部的鉸鏈動作。',
    muscles:['腿後肌（主）','臀大肌','豎脊肌'],
    steps:['站直持槓鈴，雙腳與髖同寬。','以髖為軸，屈髖俯身，槓鈴貼腿下滑。','感受腿後充分拉伸後，啟動臀部推髖站起。'],
    tips:['全程膝蓋只微彎，勿變成深蹲', '俯身時保持背部中立'] },
  { id:'d4', name:'跨步蹲', muscle:'腿部', equipment:'啞鈴', difficulty:'初級',
    desc:'單腿訓練可矯正左右肌力失衡，同時訓練平衡。',
    muscles:['股四頭肌','臀大肌','腿後肌'],
    steps:['雙手持啞鈴，一腳向前跨一大步。','後膝向地面下沉，前膝維持在腳踝正上方。','推回站立，換腳重複。'],
    tips:['步伐要夠大，避免前膝超過腳尖太多', '核心收緊保持上身直立'] },
  { id:'d5', name:'腿彎舉', muscle:'腿部', equipment:'機器', difficulty:'初級',
    desc:'孤立訓練腿後肌的最佳機器動作。',
    muscles:['腿後肌（主）'],
    steps:['俯臥於機器上，腳踝置於滾輪下方。','將腳踝向臀部方向彎曲，頂端停留1秒。','緩慢放回。'],
    tips:['避免臀部抬起借力', '頂端盡量讓腿後完全收縮'] },

  // SHOULDERS
  { id:'e1', name:'槓鈴肩推', muscle:'肩部', equipment:'槓鈴', difficulty:'中級',
    desc:'肩部訓練的基礎複合動作，主要刺激三角肌前束與中束。',
    muscles:['三角肌（主）','三頭肌','斜方肌'],
    steps:['坐姿或站姿均可，將槓鈴置於鎖骨位置。','深吸氣，核心收緊，用力向上推起。','頂端三角肌完全收縮，緩慢下放。'],
    tips:['不要過度後仰借力', '控制下放速度，感受三角肌離心收縮'] },
  { id:'e2', name:'啞鈴側平舉', muscle:'肩部', equipment:'啞鈴', difficulty:'初級',
    desc:'發展三角肌中束、讓肩膀更寬的關鍵動作。',
    muscles:['三角肌中束（主）'],
    steps:['站直持啞鈴，手臂微彎。','以肩為軸，將手臂向兩側舉起至肩膀高度。','小指略高於拇指，緩慢放回。'],
    tips:['不要借助身體搖晃', '舉到肩膀高度即可，過高會轉移至斜方肌', '重量不用大，感受最重要'] },
  { id:'e3', name:'俯身側平舉', muscle:'肩部', equipment:'啞鈴', difficulty:'初級',
    desc:'鍛鍊三角肌後束，改善圓肩體態。',
    muscles:['三角肌後束（主）','菱形肌'],
    steps:['俯身約90度，雙膝微彎。','雙手持啞鈴自然垂下。','以肩為軸，向兩側舉起啞鈴至肩高。','緩慢放回。'],
    tips:['想像兩隻手肘向天花板舉起', '避免用力甩動'] },
  { id:'e4', name:'啞鈴肩推', muscle:'肩部', equipment:'啞鈴', difficulty:'初級',
    desc:'比槓鈴肩推活動範圍更大，可強化肌肉連結感。',
    muscles:['三角肌（主）','三頭肌'],
    steps:['坐姿，啞鈴置於肩旁，掌心朝前。','向上推起，頂端啞鈴略微靠近但不相碰。','緩慢下放至起始位置。'],
    tips:['可以在頂端稍微旋腕增加刺激', '確保坐姿穩定，腰背不要懸空'] },

  // ARMS
  { id:'f1', name:'槓鈴彎舉', muscle:'手臂', equipment:'槓鈴', difficulty:'初級',
    desc:'最基礎且最有效的二頭肌訓練動作。',
    muscles:['肱二頭肌（主）','肱肌'],
    steps:['站直，雙手正握槓鈴，與肩同寬。','以肘為軸，將槓鈴向上彎起至二頭完全收縮。','緩慢放回，完全伸展二頭肌。'],
    tips:['手肘保持固定在體側，不要前後擺動', '頂端停留1秒感受收縮'] },
  { id:'f2', name:'窄握臥推', muscle:'手臂', equipment:'槓鈴', difficulty:'中級',
    desc:'三頭肌的複合動作，同時有一定的胸肌刺激。',
    muscles:['肱三頭肌（主）','胸大肌內側'],
    steps:['握距約與肩同寬或略窄。','下放槓鈴至胸口，肘關節保持緊靠身體。','推起鎖死，感受三頭肌完全收縮。'],
    tips:['手腕要保持中立，不過度外翻', '下放時手肘不要外展過多'] },
  { id:'f3', name:'繩索下壓', muscle:'手臂', equipment:'繩索', difficulty:'初級',
    desc:'三頭肌孤立動作，全程保持張力。',
    muscles:['肱三頭肌（主）'],
    steps:['站於繩索機前，雙手握住V形或繩索把手。','雙臂夾緊體側，向下伸直手臂。','頂端三頭完全鎖死停留1秒，緩慢回放。'],
    tips:['上臂必須保持靜止不動', '下壓到完全伸直才能充分收縮三頭'] },
  { id:'f4', name:'錘式彎舉', muscle:'手臂', equipment:'啞鈴', difficulty:'初級',
    desc:'同時刺激二頭肌與肱橈肌，讓手臂更飽滿。',
    muscles:['肱二頭肌','肱橈肌（主）'],
    steps:['雙手持啞鈴，掌心相對（中立握法）。','以肘為軸，將啞鈴向上彎起。','緩慢放回完全伸展。'],
    tips:['掌心全程保持相對，不要旋轉', '可以交替或同時進行'] },

  // CORE
  { id:'g1', name:'卷腹', muscle:'核心', equipment:'徒手', difficulty:'初級',
    desc:'針對腹直肌上段的基礎動作。',
    muscles:['腹直肌（主）'],
    steps:['仰臥，雙膝彎曲，雙手放於耳旁或交叉胸前。','收縮腹肌，將肩胛骨抬離地面。','頂端停留1秒，緩慢放回，不要讓頭部碰地。'],
    tips:['不是仰臥起坐，只需抬起上背', '頸部放鬆，用腹部發力', '呼氣時用力收縮'] },
  { id:'g2', name:'平板支撐', muscle:'核心', equipment:'徒手', difficulty:'初級',
    desc:'靜態核心穩定訓練，訓練深層核心肌群。',
    muscles:['腹橫肌（主）','豎脊肌','臀肌'],
    steps:['前臂撐地，手肘在肩膀正下方。','腳趾撐地，身體呈一直線。','收緊核心與臀肌，保持呼吸。'],
    tips:['不要讓腰部下沉或臀部抬高', '目視地面保持頸椎中立', '初學者從30秒開始'] },
  { id:'g3', name:'俄羅斯轉體', muscle:'核心', equipment:'徒手', difficulty:'初級',
    desc:'強化腹斜肌的旋轉動作。',
    muscles:['腹外斜肌（主）','腹內斜肌'],
    steps:['坐在地上，雙腿彎曲抬起，身體後仰呈V型。','雙手合十，向左右兩側輪流觸碰地面。'],
    tips:['可手持啞鈴增加阻力', '旋轉來自腰部而非手臂'] },
  { id:'g4', name:'懸吊舉腿', muscle:'核心', equipment:'徒手', difficulty:'中級',
    desc:'強化腹直肌下段的進階動作。',
    muscles:['腹直肌下段（主）','髂腰肌'],
    steps:['懸掛於單槓上，雙腿並攏。','收縮腹肌，將雙腿抬起至水平或更高。','緩慢放回，不要讓身體大幅擺盪。'],
    tips:['若做不到直腿，先從彎腿版本開始', '避免依靠慣性甩腿'] },


  // GLUTES
  { id:'i1', name:'槓鈴臀推', muscle:'臀部', equipment:'槓鈴', difficulty:'中級',
    desc:'臀大肌訓練之王，針對性最強的臀部動作，能有效增加臀圍與翹度。',
    muscles:['臀大肌（主）','腿後肌','核心'],
    steps:['坐在臥推凳前，槓鈴置於髖關節上，可用墊子保護。','背部貼靠凳沿，雙腳平踩地面，膝蓋成90度。','深吸氣，核心收緊，以臀肌發力將髖部向上推至最高點。','頂端臀肌用力夾緊停留1-2秒，緩慢放回不碰地。'],
    tips:['頂端時大腿和軀幹呈一直線', '膝蓋不要內扣，與腳尖同方向', '感受臀肌收縮，非腰部用力'] },
  { id:'i2', name:'啞鈴臀推', muscle:'臀部', equipment:'啞鈴', difficulty:'初級',
    desc:'臀推的入門版本，適合初學者建立臀肌連結感。',
    muscles:['臀大肌（主）','腿後肌'],
    steps:['坐在凳前，啞鈴置於髖部上，雙手扶住。','背靠凳，雙腳踩地膝蓋90度。','臀肌發力將髖部推至最高，頂端夾緊1秒。','緩慢放回。'],
    tips:['先用輕重量熟悉動作感受', '可做單腿版本增加難度'] },
  { id:'i3', name:'保加利亞分腿蹲', muscle:'臀部', equipment:'啞鈴', difficulty:'高級',
    desc:'單腿訓練，臀部與股四頭的複合動作，同時挑戰平衡。',
    muscles:['臀大肌（主）','股四頭肌','腿後肌'],
    steps:['後腳置於凳上，前腳向前踏一大步，雙手持啞鈴。','身體保持直立，後膝向地面下沉。','前腳用力踩地站起，感受臀部收縮。','完成一側後換腳。'],
    tips:['前腳距離凳越遠越針對臀部', '下沉時身體微向前傾', '膝蓋對準腳尖方向'] },
  { id:'i4', name:'臀部後踢（繩索）', muscle:'臀部', equipment:'繩索', difficulty:'初級',
    desc:'孤立訓練臀大肌的全程張力動作，感受感強。',
    muscles:['臀大肌（主）'],
    steps:['站於繩索機前，腳踝綁上繩索套環，雙手扶住支撐點。','核心收緊，保持上身穩定，將腿向後上方踢起。','頂端臀肌夾緊1秒，緩慢放回，不要完全放鬆。'],
    tips:['不要依靠腰部後仰，臀肌主導', '動作幅度不用過大，感受最重要'] },
  { id:'i5', name:'壺鈴深蹲搖擺', muscle:'臀部', equipment:'啞鈴', difficulty:'初級',
    desc:'以臀部為核心的功能性訓練，同時鍛鍊下背與腿後肌。',
    muscles:['臀大肌（主）','腿後肌','豎脊肌'],
    steps:['雙腳寬於肩站立，雙手握壺鈴（啞鈴也可）置於兩腿間。','以髖部後推為主，上身前傾，讓器械向後擺。','收縮臀肌，推髖站起，器械向前擺至肩高。'],
    tips:['用臀部推力而非手臂抬起器械', '每次重複都要感受臀部主導'] },
  { id:'i6', name:'蚌式開合', muscle:'臀部', equipment:'徒手', difficulty:'初級',
    desc:'側臥訓練臀中肌，改善臀部外側線條，預防膝蓋內扣。',
    muscles:['臀中肌（主）','臀小肌'],
    steps:['側臥，雙腿彎曲疊放，像合上的蚌殼。','保持雙腳合攏，上側膝蓋向天花板張開。','頂端停留1秒，感受臀部外側夾緊，緩慢放回。'],
    tips:['可加彈力帶增加阻力', '上身保持穩定，不要旋轉', '每側做15-20次效果最佳'] },
  { id:'i7', name:'臀橋', muscle:'臀部', equipment:'徒手', difficulty:'初級',
    desc:'臀推的徒手版本，適合熱身或初學者建立臀肌連結。',
    muscles:['臀大肌（主）','腿後肌','核心'],
    steps:['仰臥，雙腿彎曲平踩地面，雙臂置於體側。','收縮臀肌，將髖部推離地面至最高點。','頂端夾緊臀肌停留2秒，緩慢放回。'],
    tips:['可單腿進行增加難度', '腹部同步收緊，核心穩定', '感受到腰部而非臀部說明發力不正確'] },
  { id:'i8', name:'深蹲側踢腿', muscle:'臀部', equipment:'徒手', difficulty:'初級',
    desc:'結合深蹲與側踢的複合動作，同時訓練臀大肌與臀中肌。',
    muscles:['臀大肌','臀中肌'],
    steps:['站立，雙腳與肩同寬。','深蹲至大腿與地面平行。','站起的同時，將一腿向側方踢出。','落地重複，或每次換腳。'],
    tips:['保持上身直立', '側踢時感受臀部外側'] },

  // CARDIO
  { id:'h1', name:'跑步機慢跑', muscle:'有氧', equipment:'機器', difficulty:'初級',
    desc:'最普及的有氧訓練，可改善心肺功能與燃燒脂肪。',
    muscles:['全身'],
    steps:['設定速度從步行開始，逐漸提升至慢跑速度。','維持輕鬆可對話的強度（心率約65-75% 最大心率）。','逐漸冷卻，減速至步行結束。'],
    tips:['保持上身直立，不要前傾抓扶手', '穿著合適跑鞋', '每週至少進行3次，每次30分鐘以上'] },
  { id:'h2', name:'跳繩', muscle:'有氧', equipment:'徒手', difficulty:'初級',
    desc:'高效便捷的有氧訓練，熱量消耗高。',
    muscles:['全身','小腿'],
    steps:['雙手握住跳繩把柄，繩子在身後。','小臂帶動手腕旋轉甩繩。','雙腳稍微跳起讓繩子通過，保持輕盈落地。'],
    tips:['落地時用前腳掌緩衝，保護膝蓋', '初學者先練習單次跳，再連續跳', '每次10-15分鐘即可有效鍛鍊'] },
  { id:'h3', name:'划船機', muscle:'有氧', equipment:'機器', difficulty:'初級',
    desc:'全身性有氧訓練，同時鍛鍊上下半身與核心。',
    muscles:['全身','背部','腿部'],
    steps:['固定腳踝，手握把手，身體微前傾。','腿先蹬，然後身體後傾，最後手臂拉向腹部。','逆序放回：手臂先伸，身體前傾，腿再彎曲。'],
    tips:['記住順序：推腿→後仰→拉手', '每分鐘划20-30次是適中速度'] },
];

// ══════════════════════════════════════════════════════════
// WORKOUT TIMER
// ══════════════════════════════════════════════════════════
let timerState = 'idle'; // idle | running | paused
let timerSeconds = 0;
let timerInterval = null;
let workoutExercises = []; // [{name, sets:[{weight,reps,rpe,done}]}]
let currentWorkoutType = '';

function timerStart() {
  timerState = 'running';
  timerInterval = setInterval(timerTick, 1000);
  updateTimerUI();
}

function timerPause() {
  timerState = 'paused';
  clearInterval(timerInterval);
  updateTimerUI();
}

function timerResume() {
  timerState = 'running';
  timerInterval = setInterval(timerTick, 1000);
  updateTimerUI();
}

function timerStop() {
  if (timerSeconds === 0) { showToast('請先開始計時'); return; }
  clearInterval(timerInterval);
  timerState = 'idle';
  // auto-save to log
  autoSaveWorkout();
}

function timerTick() {
  timerSeconds++;
  updateTimerClock();
  updateCaloriesEstimate();
}

function pad(n) { return String(n).padStart(2,'0'); }

function updateTimerClock() {
  const h = Math.floor(timerSeconds/3600);
  const m = Math.floor((timerSeconds%3600)/60);
  const s = timerSeconds%60;
  document.getElementById('timerClock').textContent = h>0
    ? `${pad(h)}:${pad(m)}:${pad(s)}`
    : `${pad(m)}:${pad(s)}`;
}

function updateTimerUI() {
  const dot = document.getElementById('timerDot');
  const label = document.getElementById('timerStatusLabel');
  const sub = document.getElementById('timerSubLabel');
  const ctrl = document.getElementById('timerControls');

  if (timerState === 'running') {
    dot.className = 'status-dot running';
    label.textContent = '訓練進行中';
    sub.textContent = '計時中...';
    ctrl.innerHTML = `
      <button class="timer-btn timer-btn-pause" onclick="timerPause()">⏸ 暫停</button>
      <button class="timer-btn timer-btn-stop" onclick="timerStop()">⏹ 結束並儲存</button>`;
  } else if (timerState === 'paused') {
    dot.className = 'status-dot paused';
    label.textContent = '已暫停';
    sub.textContent = '訓練暫停中';
    ctrl.innerHTML = `
      <button class="timer-btn timer-btn-resume" onclick="timerResume()">▶ 繼續</button>
      <button class="timer-btn timer-btn-stop" onclick="timerStop()">⏹ 結束並儲存</button>`;
  } else {
    dot.className = 'status-dot';
    label.textContent = '尚未開始';
    sub.textContent = '按開始計時';
    ctrl.innerHTML = `<button class="timer-btn timer-btn-start" onclick="timerStart()">▶ 開始</button>`;
  }
}

function updateCaloriesEstimate() {
  const type = document.getElementById('workout-type-select').value || 'fullbody';
  const w = (data.weights[0] && data.weights[0].value) || 70;
  const cal = calcCalories(type, Math.ceil(timerSeconds/60), w);
  document.getElementById('timerCalories').textContent = cal;
}

function updateTimerStats() {
  let totalSets = 0;
  workoutExercises.forEach(ex => { totalSets += ex.sets.length; });
  document.getElementById('timerSets').textContent = totalSets;
  document.getElementById('timerExCount').textContent = workoutExercises.length;
}

function renderWorkoutTimer() {
  updateTimerUI();
  updateTimerClock();
  renderWorkoutExercises();
}

function renderWorkoutExercises() {
  const el = document.getElementById('workoutExerciseList');
  if (workoutExercises.length === 0) {
    el.innerHTML = '<div class="empty-state" style="padding:20px 0;"><div class="empty-icon">🏋️</div>尚未新增動作<br><span style="font-size:12px;">點擊下方按鈕新增，或從動作庫選取</span></div>';
    return;
  }
  el.innerHTML = workoutExercises.map((ex, ei) => `
    <div class="workout-ex-block">
      <div class="workout-ex-header">
        <div class="workout-ex-name">${ex.name}</div>
        <button class="set-del-btn" onclick="removeWorkoutExercise(${ei})" title="移除此動作">🗑</button>
      </div>
      <div class="workout-ex-body">
        <div class="set-col-labels">
          <span>動作/組別</span><span>重量(kg)</span><span>次數</span><span class="rpe-col">RPE</span><span></span>
        </div>
        ${ex.sets.map((s, si) => `
          <div class="workout-set-row">
            <span style="font-size:12px;color:var(--text3);padding:0 4px;">第${si+1}組</span>
            <input class="set-input" type="number" placeholder="kg" value="${s.weight||''}"
              onchange="updateSet(${ei},${si},'weight',this.value)">
            <input class="set-input" type="number" placeholder="次" value="${s.reps||''}"
              onchange="updateSet(${ei},${si},'reps',this.value)">
            <input class="set-input rpe-col" type="number" placeholder="1-10" min="1" max="10" value="${s.rpe||''}"
              onchange="updateSet(${ei},${si},'rpe',this.value)">
            <button class="set-del-btn" onclick="removeSet(${ei},${si})">✕</button>
          </div>`).join('')}
        <button class="add-set-btn" onclick="addSet(${ei})">＋ 新增一組</button>
      </div>
    </div>`).join('');
  updateTimerStats();
}

function addWorkoutExercise() {
  const modal = document.getElementById('addExModal');
  modal.style.display = modal.style.display === 'none' ? 'block' : 'none';
  if (modal.style.display === 'block') {
    document.getElementById('addExInput').value = '';
    filterAddExList();
    setTimeout(() => document.getElementById('addExInput').focus(), 100);
  }
}

function filterAddExList() {
  const q = document.getElementById('addExInput').value.toLowerCase();
  const filtered = EXERCISES.filter(e =>
    e.name.toLowerCase().includes(q) || e.muscle.includes(q)
  );
  const el = document.getElementById('addExSuggestions');
  el.innerHTML = filtered.slice(0,12).map(e => `
    <div onclick="selectExerciseFromList('${e.name}')" style="padding:9px 12px;cursor:pointer;border-radius:8px;font-size:13px;display:flex;justify-content:space-between;align-items:center;transition:background 0.1s;"
      onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background=''">
      <span style="font-weight:500;">${e.name}</span>
      <span style="font-size:11px;color:var(--text3);">${e.muscle} · ${e.equipment}</span>
    </div>`).join('') || '<div style="padding:12px;color:var(--text3);font-size:13px;">找不到動作，將新增自訂動作</div>';
}

function selectExerciseFromList(name) {
  document.getElementById('addExInput').value = name;
}

function confirmAddExercise() {
  const name = document.getElementById('addExInput').value.trim();
  if (!name) return;
  workoutExercises.push({ name, sets: [{ weight:'', reps:'', rpe:'' }] });
  document.getElementById('addExModal').style.display = 'none';
  renderWorkoutExercises();
  showToast('已新增：' + name);
}

function removeWorkoutExercise(ei) {
  workoutExercises.splice(ei, 1);
  renderWorkoutExercises();
}

function addSet(ei) {
  workoutExercises[ei].sets.push({ weight:'', reps:'', rpe:'' });
  renderWorkoutExercises();
}

function removeSet(ei, si) {
  if (workoutExercises[ei].sets.length <= 1) { showToast('至少保留一組'); return; }
  workoutExercises[ei].sets.splice(si, 1);
  renderWorkoutExercises();
}

function updateSet(ei, si, field, val) {
  workoutExercises[ei].sets[si][field] = val;
  updateTimerStats();
}

function autoSaveWorkout() {
  const date = new Date().toISOString().split('T')[0];
  const durationMin = Math.max(1, Math.ceil(timerSeconds / 60));
  const type = document.getElementById('workout-type-select').value || 'fullbody';
  const w = (data.weights[0] && data.weights[0].value) || 70;
  const cal = calcCalories(type, durationMin, w);

  // Build exercises summary text
  const exercisesText = workoutExercises.map(ex => {
    const setsText = ex.sets
      .filter(s => s.reps)
      .map((s,i) => `第${i+1}組${s.weight?` ${s.weight}kg`:''} × ${s.reps}次${s.rpe?` RPE${s.rpe}`:''}`)
      .join('\n');
    return `${ex.name}:\n${setsText || '(無資料)'}`;
  }).join('\n\n');

  const startTime = new Date(Date.now() - timerSeconds * 1000);
  const hh = pad(startTime.getHours()), mm = pad(startTime.getMinutes());
  const endTime = new Date();
  const ehh = pad(endTime.getHours()), emm = pad(endTime.getMinutes());

  data.logs.unshift({
    id: Date.now(), date, type,
    weight: data.weights[0] ? data.weights[0].value : null,
    start: `${hh}:${mm}`,
    end: `${ehh}:${emm}`,
    exercises: exercisesText,
    notes: `實時訓練 · ${durationMin} 分鐘`,
    calories: cal,
    duration: durationMin,
    photos: []
  });

  saveAndSync();

  // Reset timer
  timerSeconds = 0;
  workoutExercises = [];
  updateTimerClock();
  updateTimerUI();
  renderWorkoutExercises();
  showToast(`✓ 訓練已儲存！共 ${durationMin} 分鐘，消耗約 ${cal} kcal`);
  navigate('history', null);
}

// Allow adding from library to workout
let currentLibraryExercise = null;

function addToWorkoutFromLibrary() {
  if (!currentLibraryExercise) return;
  workoutExercises.push({ name: currentLibraryExercise.name, sets: [{ weight:'', reps:'', rpe:'' }] });
  closeExDetail();
  navigate('workout', document.querySelector('nav a[onclick*="workout"]'));
  showToast('已加入訓練：' + currentLibraryExercise.name);
}

// ══════════════════════════════════════════════════════════
// EXERCISE LIBRARY
// ══════════════════════════════════════════════════════════
function renderLibrary() {
  const q = (document.getElementById('libSearchInput')?.value || '').toLowerCase();
  const muscleF = document.getElementById('libMuscleFilter')?.value || '';
  const typeF = document.getElementById('libTypeFilter')?.value || '';

  let filtered = EXERCISES.filter(e => {
    const matchQ = !q || e.name.toLowerCase().includes(q) || e.muscle.includes(q);
    const matchM = !muscleF || e.muscle === muscleF;
    const matchT = !typeF || e.equipment === typeF;
    return matchQ && matchM && matchT;
  });

  const el = document.getElementById('libList');
  if (!el) return;

  if (filtered.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">🔍</div>沒有找到符合的動作</div>';
    return;
  }

  // Group by muscle
  const groups = {};
  filtered.forEach(e => {
    if (!groups[e.muscle]) groups[e.muscle] = [];
    groups[e.muscle].push(e);
  });

  el.innerHTML = Object.entries(groups).map(([muscle, exs]) => `
    <div style="margin-bottom:20px;">
      <div style="font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px;">${muscle}</div>
      ${exs.map(e => `
        <div class="ex-card" onclick="openExDetail('${e.id}')">
          <div class="ex-card-header">
            <div class="ex-card-name">${e.name}</div>
            <div class="ex-card-muscle">${e.muscle}</div>
          </div>
          <div class="ex-card-desc">${e.desc}</div>
          <div class="ex-card-tags">
            <span class="ex-tag">${e.equipment}</span>
            <span class="ex-tag">${e.difficulty}</span>
            ${e.muscles.slice(0,2).map(m=>`<span class="ex-tag">${m}</span>`).join('')}
          </div>
        </div>`).join('')}
    </div>`).join('');
}

function openExDetail(id) {
  const ex = EXERCISES.find(e => e.id === id);
  if (!ex) return;
  currentLibraryExercise = ex;

  document.getElementById('exDetailName').textContent = ex.name;
  document.getElementById('exDetailMuscles').innerHTML = ex.muscles.map(m =>
    `<span class="muscle-chip">${m}</span>`).join('');
  document.getElementById('exDetailContent').innerHTML = `
    <div style="margin-bottom:16px;">
      <div style="font-size:13px;font-weight:600;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">動作說明</div>
      <div style="font-size:14px;color:var(--text2);line-height:1.6;">${ex.desc}</div>
    </div>
    <div style="margin-bottom:16px;">
      <div style="font-size:13px;font-weight:600;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">步驟</div>
      ${ex.steps.map((s,i) => `
        <div class="ex-step">
          <div class="ex-step-num">${i+1}</div>
          <div class="ex-step-text">${s}</div>
        </div>`).join('')}
    </div>
    ${ex.tips ? `
    <div>
      <div style="font-size:13px;font-weight:600;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">技巧提示</div>
      ${ex.tips.map(t => `<div style="display:flex;gap:8px;padding:6px 0;font-size:13px;color:var(--text2);"><span style="color:var(--accent);">✓</span>${t}</div>`).join('')}
    </div>` : ''}
  `;

  document.getElementById('exDetailModal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeExDetail() {
  document.getElementById('exDetailModal').classList.remove('open');
  document.body.style.overflow = '';
}


// ── MOBILE NAV ──
function mobileNavigate(page, el) {
  navigate(page, null);
  document.querySelectorAll('.bottom-nav-item').forEach(i => i.classList.remove('active'));
  if (el) el.classList.add('active');
  // also sync sidebar
  document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
}

function isMobile() { return window.innerWidth <= 600; }

// Show topbar user btn on mobile
function syncTopbarUser() {
  const users = getUsers();
  const user = users.find(u => u.id === currentUserId);
  const idx = users.indexOf(user);
  const el = document.getElementById('topbarUser');
  const av = document.getElementById('topbarAvatar');
  const nm = document.getElementById('topbarUserName');
  if (el) {
    el.style.display = isMobile() ? 'flex' : 'none';
    if (user && av && nm) {
      av.textContent = initials(user.name);
      av.className = 'topbar-user-avatar ' + avatarClass(idx);
      nm.textContent = user.name;
    }
  }
}

window.addEventListener('resize', syncTopbarUser);

// ── MOBILE USER MODAL ──
function openMobileUserModal() {
  renderMobileUserList();
  document.getElementById('mobileUserModal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeMobileUserModal() {
  document.getElementById('mobileUserModal').classList.remove('open');
  document.body.style.overflow = '';
}

function renderMobileUserList() {
  const users = getUsers();
  const el = document.getElementById('mobileUserList');
  if (!el) return;
  if (users.length === 0) {
    el.innerHTML = '<div style="padding:10px 20px;font-size:14px;color:var(--text3);">尚無用戶，請新增</div>';
    return;
  }
  el.innerHTML = users.map((u, i) => `
    <div class="modal-user-item ${u.id === currentUserId ? 'selected' : ''}" onclick="requestSwitchUserMobile('${u.id}')">
      <div class="modal-user-avatar ${avatarClass(i)}">${initials(u.name)}</div>
      <span style="flex:1">${u.name}</span>
      ${u.id === currentUserId ? '<span class="modal-check">✓</span>' : '<span style="color:var(--text3);font-size:16px;">›</span>'}
    </div>
  `).join('');
}

function switchUserMobile(uid) {
  switchUser(uid);
  closeMobileUserModal();
  syncTopbarUser();
}

function addUserMobile() {
  const input = document.getElementById('mobileNewUserInput');
  const name = input.value.trim();
  if (!name) { input.focus(); return; }
  const users = getUsers();
  if (users.find(u => u.name === name)) { showToast('此名稱已存在'); return; }
  const uid = 'user_' + Date.now();
  users.push({ id: uid, name });
  saveUsers(users);
  input.value = '';
  switchUserMobile(uid);
}


// ── REALTIME LISTENER ──
let unsubscribeListener = null;

function startRealtimeSync(uid) {
  if (unsubscribeListener) unsubscribeListener();
  if (!window._firestoreReady) return;

  unsubscribeListener = window._fsOnSnapshot(
    window._fsDoc(window._db, 'users', uid),
    async (snap) => {
      if (!snap.exists() || snap.metadata.hasPendingWrites) return;
      // Another device wrote — pull fresh data
      const cloudData = snap.data();
      const photoSnap = await window._fsGetDoc(window._fsDoc(window._db, 'photos', uid));
      if (photoSnap.exists()) cloudData.photos = photoSnap.data().list || [];
      else cloudData.photos = data.photos || [];

      data.logs    = cloudData.logs    || data.logs;
      data.weights = cloudData.weights || data.weights;
      data.plans   = cloudData.plans   || data.plans;
      data.goals   = cloudData.goals   || data.goals;
      data.photos  = cloudData.photos;
      saveUserData(uid, data);

      // Refresh current visible page quietly
      const activePage = document.querySelector('.page.active');
      if (activePage) {
        const pageId = activePage.id.replace('page-', '');
        renderPage(pageId);
      }
    },
    (err) => console.warn('Realtime listener error:', err)
  );
}


// ══════════════════════════════════════════════════════════
// 1. DYNAMIC EXERCISE LIST (log page)
// ══════════════════════════════════════════════════════════
let logExercises = [];

function addLogExRow(name='', sets='', weight='') {
  logExercises.push({name, sets, weight});
  renderLogExerciseList();
}

function removeLogExRow(i) {
  logExercises.splice(i,1);
  renderLogExerciseList();
}

function updateLogEx(i, field, val) {
  logExercises[i][field] = val;
}

function renderLogExerciseList() {
  const el = document.getElementById('logExerciseList');
  if (!el) return;
  if (logExercises.length === 0) {
    el.innerHTML = '<div style="font-size:13px;color:var(--text3);padding:6px 0 4px;">尚未新增動作，點擊下方按鈕開始</div>';
    return;
  }
  el.innerHTML = logExercises.map((ex,i) => `
    <div class="ex-list-row">
      <input class="ex-list-input" type="text" placeholder="動作名稱" value="${ex.name}"
        oninput="updateLogEx(${i},'name',this.value)" list="exNameDatalist" autocomplete="off">
      <input class="ex-list-input" type="number" placeholder="組" min="1" value="${ex.sets}"
        oninput="updateLogEx(${i},'sets',this.value)" style="text-align:center;">
      <input class="ex-list-input" type="number" placeholder="kg" step="0.5" value="${ex.weight}"
        oninput="updateLogEx(${i},'weight',this.value)" style="text-align:center;">
      <button onclick="removeLogExRow(${i})" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:16px;padding:4px;border-radius:6px;" title="移除">✕</button>
    </div>`).join('');
}

function toggleLogExPicker() {
  const wrap = document.getElementById('logExPickerWrap');
  wrap.style.display = wrap.style.display === 'none' ? 'block' : 'none';
  if (wrap.style.display === 'block') {
    document.getElementById('logExPickerQ').value = '';
    renderLogExPicker();
    setTimeout(() => document.getElementById('logExPickerQ').focus(), 80);
  }
}

function renderLogExPicker() {
  const q = document.getElementById('logExPickerQ').value.toLowerCase();
  const filtered = EXERCISES.filter(e => e.name.toLowerCase().includes(q) || e.muscle.includes(q));
  const el = document.getElementById('logExPickerList');
  el.innerHTML = filtered.slice(0,15).map(e => `
    <div onclick="pickLogEx('${e.name.replace(/'/g,"\\\'")}')"
      style="padding:9px 12px;cursor:pointer;font-size:13px;display:flex;justify-content:space-between;"
      onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background=''">
      <span style="font-weight:500;">${e.name}</span>
      <span style="color:var(--text3);font-size:11px;">${e.muscle} · ${e.equipment}</span>
    </div>`).join('') || '<div style="padding:10px 12px;color:var(--text3);font-size:13px;">找不到動作</div>';
}

function pickLogEx(name) {
  addLogExRow(name,'','');
  document.getElementById('logExPickerWrap').style.display = 'none';
}

function copyYesterdayExercises() {
  const today = new Date().toISOString().split('T')[0];
  const pastLogs = data.logs.filter(l => l.date < today);
  if (pastLogs.length === 0) { showToast('找不到之前的訓練記錄'); return; }
  const last = pastLogs[0];
  if (last.exercises_structured && last.exercises_structured.length > 0) {
    logExercises = last.exercises_structured.map(e => ({...e}));
  } else if (last.exercises) {
    logExercises = last.exercises.split('\n').filter(l=>l.trim()).map(l => {
      const m = l.match(/^(.+?)\s+(\d+)\s*[x×組]\s*(?:[\d.]+\s*kg)?/) ||
                l.match(/^(.+?)\s+(\d+)組\s*(?:×\s*[\d.]+\s*kg)?/);
      return { name: m ? m[1].trim() : l.trim(), sets: m ? m[2] : '', weight: '' };
    });
  } else { showToast('上次記錄沒有訓練動作'); return; }
  renderLogExerciseList();
  showToast(`✓ 已複製 ${last.date} 的訓練（${logExercises.length} 個動作）`);
}

function getExercisesText() {
  return logExercises.map(ex => {
    let s = ex.name || '動作';
    if (ex.sets) s += ` ${ex.sets}組`;
    if (ex.weight) s += ` × ${ex.weight}kg`;
    return s;
  }).join('\n');
}

// Datalist for autocomplete
function buildExDatalist() {
  let dl = document.getElementById('exNameDatalist');
  if (!dl) { dl = document.createElement('datalist'); dl.id = 'exNameDatalist'; document.body.appendChild(dl); }
  dl.innerHTML = EXERCISES.map(e => `<option value="${e.name}">`).join('');
}

// ══════════════════════════════════════════════════════════
// 2. WEIGHT DIFF BADGE
// ══════════════════════════════════════════════════════════
function updateWeightDiff() {
  const val = parseFloat(document.getElementById('log-weight').value);
  const badge = document.getElementById('weightDiffBadge');
  if (!badge) return;
  if (!val || isNaN(val)) { badge.style.display = 'none'; return; }
  const sorted = [...data.weights].sort((a,b) => b.date.localeCompare(a.date));
  const today = new Date().toISOString().split('T')[0];
  const yDate = new Date(Date.now()-86400000).toISOString().split('T')[0];
  const yW = sorted.find(w => w.date <= yDate);
  let diff, label;
  if (yW) {
    diff = val - yW.value; label = '較昨日';
  } else {
    const w7 = sorted.filter(w => {
      const d = new Date(w.date), now = new Date(); d.setDate(d.getDate()+7);
      return w.date < today && d >= now;
    });
    const avg = w7.length ? w7.reduce((s,w)=>s+w.value,0)/w7.length : null;
    if (avg) { diff = val - avg; label = '較上週均'; }
    else if (sorted.length) { diff = val - sorted[0].value; label = '較上次'; }
    else { badge.style.display = 'none'; return; }
  }
  const sign = diff > 0 ? '+' : '';
  badge.textContent = `${sign}${diff.toFixed(1)}kg ${label}`;
  badge.className = 'weight-diff-badge ' + (diff < -0.05 ? 'wdb-down' : diff > 0.05 ? 'wdb-up' : 'wdb-flat');
  badge.style.display = 'inline-flex';
}

// ══════════════════════════════════════════════════════════
// 3. REST TIMER
// ══════════════════════════════════════════════════════════
let _restDur = 30, _restRem = 30, _restTotal = 30, _restRunning = false, _restTmr = null;

function setRestPreset(s, btn) {
  document.querySelectorAll('.rest-pre-btn').forEach(b => b.classList.remove('on'));
  btn && btn.classList.add('on');
  _restDur = s; _restTotal = s;
  if (!_restRunning) { _restRem = s; _renderRestClock(); _renderRestBar(1); }
}

function toggleRest() {
  _restRunning ? _pauseRest() : _startRest();
}

function _startRest() {
  if (_restRem <= 0) { _restRem = _restDur; _restTotal = _restDur; }
  _restRunning = true;
  _setRestBtn('⏸ 暫停','paused');
  document.getElementById('restStatusTxt').textContent = '休息中...';
  _restTmr = setInterval(_restTick, 1000);
}

function _pauseRest() {
  _restRunning = false; clearInterval(_restTmr);
  _setRestBtn('▶ 繼續','');
  document.getElementById('restStatusTxt').textContent = '已暫停';
}

function resetRest() {
  _restRunning = false; clearInterval(_restTmr);
  _restRem = _restDur; _restTotal = _restDur;
  _renderRestClock(); _renderRestBar(1);
  _setRestBtn('▶ 開始休息','');
  const rc = document.getElementById('restClock');
  if (rc) rc.classList.remove('urgent');
  document.getElementById('restStatusTxt').textContent = '選擇時長後開始';
}

function _restTick() {
  _restRem--;
  _renderRestClock();
  _renderRestBar(_restRem / _restTotal);
  const rc = document.getElementById('restClock');
  if (_restRem <= 5) rc && rc.classList.add('urgent');
  if (_restRem <= 0) {
    clearInterval(_restTmr); _restRunning = false;
    rc && rc.classList.remove('urgent');
    _setRestBtn('▶ 再來一次','');
    document.getElementById('restStatusTxt').textContent = '✅ 休息結束！';
    _playBeep(); showToast('✅ 休息結束，繼續加油！');
  }
}

function _renderRestClock() {
  const el = document.getElementById('restClock');
  if (!el) return;
  const m = Math.floor(_restRem/60), s = _restRem%60;
  el.textContent = pad(m)+':'+pad(s);
}

function _renderRestBar(ratio) {
  const bar = document.getElementById('restBar');
  if (!bar) return;
  bar.style.width = (Math.max(0,ratio)*100)+'%';
  bar.className = 'rest-bar'+(ratio<0.15?' urgent':'');
}

function _setRestBtn(txt, cls) {
  const btn = document.getElementById('restGoBtn');
  if (!btn) return;
  btn.textContent = txt;
  btn.className = 'rest-go-btn'+(cls?' '+cls:'');
}

function _playBeep() {
  try {
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    [0,0.18,0.36].forEach(t => {
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = 880;
      g.gain.setValueAtTime(0.28, ctx.currentTime+t);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+t+0.14);
      o.start(ctx.currentTime+t); o.stop(ctx.currentTime+t+0.15);
    });
  } catch(e){}
}

// ══════════════════════════════════════════════════════════
// 4. EDIT LOG
// ══════════════════════════════════════════════════════════
function openEditLog(id) {
  // Normalize: id may be number or string depending on JSON parse
  id = Number(id);
  const log = data.logs.find(l => Number(l.id) === id);
  if (!log) { showToast('找不到此記錄'); return; }
  document.getElementById('edit-log-id').value = id;
  document.getElementById('edit-log-date').value = log.date || '';
  document.getElementById('edit-log-type').value = log.type || '';
  document.getElementById('edit-log-start').value = log.start || '';
  document.getElementById('edit-log-end').value = log.end || '';
  document.getElementById('edit-log-weight').value = log.weight || '';
  // Support both structured and text exercises
  if (log.exercises_structured && log.exercises_structured.length > 0) {
    document.getElementById('edit-log-exercises').value =
      log.exercises_structured.map(e => {
        let s = e.name || '';
        if (e.sets) s += ' ' + e.sets + '組';
        if (e.weight) s += ' × ' + e.weight + 'kg';
        return s;
      }).join('
');
  } else {
    document.getElementById('edit-log-exercises').value = log.exercises || '';
  }
  document.getElementById('edit-log-notes').value = log.notes || '';
  document.getElementById('edit-log-duration').value = log.duration || '';
  document.getElementById('editLogModal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeEditLog() {
  document.getElementById('editLogModal').classList.remove('open');
  document.body.style.overflow = '';
}

function saveEditLog() {
  const id = Number(document.getElementById('edit-log-id').value);
  const log = data.logs.find(l => Number(l.id) === id);
  if (!log) { showToast('找不到記錄，請重試'); return; }
  log.date = document.getElementById('edit-log-date').value;
  log.type = document.getElementById('edit-log-type').value;
  log.start = document.getElementById('edit-log-start').value;
  log.end = document.getElementById('edit-log-end').value;
  log.exercises = document.getElementById('edit-log-exercises').value;
  log.exercises_structured = null; // cleared when manually edited
  log.notes = document.getElementById('edit-log-notes').value;
  const dur = parseInt(document.getElementById('edit-log-duration').value);
  if (dur > 0) log.duration = dur;
  const w = parseFloat(document.getElementById('edit-log-weight').value);
  if (w) {
    log.weight = w;
    // Update weight tracking
    const wIdx = data.weights.findIndex(e => e.date === log.date);
    if (wIdx >= 0) data.weights[wIdx].value = w;
    else { data.weights.push({date:log.date,value:w}); data.weights.sort((a,b)=>b.date.localeCompare(a.date)); }
    // Recalculate calories if duration available
    if (log.duration) log.calories = calcCalories(log.type, log.duration, w);
  }
  // Re-sort logs by date descending
  data.logs.sort((a,b) => b.date.localeCompare(a.date) || Number(b.id) - Number(a.id));
  saveAndSync();
  closeEditLog();
  renderHistory();
  showToast('✓ 記錄已修改');
}

// ══════════════════════════════════════════════════════════
// 5. PERIOD TRACKING
// ══════════════════════════════════════════════════════════
const SYMPTOMS = ['腹痛', '腰痛', '頭痛', '噁心', '疲倦', '情緒低落', '水腫', '食欲增加', '胸部脹痛', '痘痘'];
let _selectedFlow = 'none';
let _periodTab = 'overview';
let _periodMonthOffset = 0; // 0 = current month

function switchPeriodTab(tab) {
  _periodTab = tab;
  ['overview','month','log'].forEach(t => {
    const btn = document.getElementById('ptab-'+t);
    const con = document.getElementById('ptab-'+t+'-content');
    if (btn) btn.classList.toggle('active', t===tab);
    if (con) con.style.display = t===tab ? '' : 'none';
  });
  if (tab === 'month') renderPeriodMonth();
  if (tab === 'log') renderSymptomSelector();
}

function selectPeriodStatus(flow) {
  _selectedFlow = flow;
  ['none','light','medium','heavy'].forEach(k => {
    const btn = document.getElementById('fb-'+k);
    if (btn) btn.classList.toggle('selected', k===flow);
  });
}

function renderSymptomSelector() {
  const el = document.getElementById('symptomSelector');
  if (!el) return;
  const date = document.getElementById('period-date')?.value;
  const existing = date ? (data.period||[]).find(p=>p.date===date) : null;
  const sel = existing?.symptoms || [];
  el.innerHTML = SYMPTOMS.map(s =>
    `<button onclick="this.classList.toggle('selected')" class="symptom-chip${sel.includes(s)?' selected':''}">${s}</button>`
  ).join('');
}

function getSelectedSymptoms() {
  return [...document.querySelectorAll('#symptomSelector .symptom-chip.selected')].map(b=>b.textContent);
}

function savePeriodEntry() {
  if (!data.period) data.period = [];
  const date = document.getElementById('period-date').value;
  if (!date) { showToast('請選擇日期'); return; }
  const existing = data.period.findIndex(p => p.date === date);
  const entry = {
    date, flow: _selectedFlow,
    symptoms: getSelectedSymptoms(),
    note: document.getElementById('period-note').value
  };
  if (existing >= 0) data.period[existing] = entry;
  else { data.period.push(entry); data.period.sort((a,b)=>b.date.localeCompare(a.date)); }
  saveAndSync();
  renderPeriod();
  showToast('✓ 生理週期記錄已儲存');
}

// Compute cycle data (shared)
function _computePeriodData() {
  if (!data.period) data.period = [];
  const menDays = data.period.filter(p=>p.flow&&p.flow!=='none').map(p=>p.date).sort();
  // Detect cycle starts (gap > 7 days = new cycle)
  const cycleStarts = [];
  menDays.forEach((d,i) => {
    if (i===0) { cycleStarts.push(d); return; }
    const gap = (new Date(d)-new Date(menDays[i-1]))/86400000;
    if (gap > 7) cycleStarts.push(d);
  });
  const cycleLen = cycleStarts.length >= 2
    ? Math.round(cycleStarts.slice(1).reduce((sum,d,i)=>(new Date(d)-new Date(cycleStarts[i]))/86400000+sum,0)/(cycleStarts.length-1))
    : null;
  const durations = cycleStarts.map(start => {
    let n=0, d=new Date(start);
    for(let i=0;i<14;i++){
      const ds=d.toISOString().split('T')[0];
      if(data.period.find(p=>p.date===ds&&p.flow&&p.flow!=='none')) n++;
      else if(n>0) break;
      d.setDate(d.getDate()+1);
    }
    return n;
  }).filter(d=>d>0);
  const periodDur = durations.length ? Math.round(durations.reduce((s,d)=>s+d,0)/durations.length) : null;
  const lastStart = cycleStarts[cycleStarts.length-1];
  const today = new Date().toISOString().split('T')[0];
  let nextDays = null;
  if (lastStart && cycleLen) {
    const nextDate = new Date(lastStart); nextDate.setDate(nextDate.getDate()+cycleLen);
    nextDays = Math.round((nextDate-new Date(today))/86400000);
  }
  // Ovulation days
  const ovulationDays = cycleStarts.map(s=>{ const d=new Date(s); d.setDate(d.getDate()+14); return d.toISOString().split('T')[0]; });
  // Fertile window
  const fertileDays = new Set();
  ovulationDays.forEach(ov=>{ for(let i=-2;i<=2;i++){ const d=new Date(ov); d.setDate(d.getDate()+i); fertileDays.add(d.toISOString().split('T')[0]); } });
  // Predicted next period dates
  const predictedDays = new Set();
  if (lastStart && cycleLen) {
    for(let i=0;i<6;i++){ const d=new Date(lastStart); d.setDate(d.getDate()+cycleLen+i); predictedDays.add(d.toISOString().split('T')[0]); }
  }
  return { cycleLen, periodDur, nextDays, cycleStarts, ovulationDays, fertileDays, predictedDays, menDays };
}

function renderPeriod() {
  if (!data.period) data.period = [];
  const today = new Date().toISOString().split('T')[0];
  const dateEl = document.getElementById('period-date');
  if (dateEl && !dateEl.value) dateEl.value = today;

  // Today label
  const todayEntry = data.period.find(p=>p.date===today);
  const todayLabel = document.getElementById('periodTodayLabel');
  if (todayLabel) {
    const flowMap = {light:'少量',medium:'中量',heavy:'大量'};
    todayLabel.textContent = todayEntry && todayEntry.flow && todayEntry.flow!=='none'
      ? `今日：${flowMap[todayEntry.flow]||''}生理期`
      : todayEntry ? '今日：已記錄（無）' : '今日尚未記錄';
  }

  // Pre-fill existing entry
  if (todayEntry) {
    _selectedFlow = todayEntry.flow || 'none';
    selectPeriodStatus(_selectedFlow);
    const noteEl = document.getElementById('period-note');
    if (noteEl) noteEl.value = todayEntry.note || '';
  }
  renderSymptomSelector();

  const pd = _computePeriodData();
  // Update stats
  const cl = document.getElementById('periodCycleLen');
  const nd = document.getElementById('periodNextDays');
  const pdEl = document.getElementById('periodDuration');
  const tl = document.getElementById('periodTotalLogs');
  if (cl) cl.textContent = pd.cycleLen ? pd.cycleLen+'天' : '—';
  if (nd) nd.textContent = pd.nextDays!==null ? (pd.nextDays<=0?'今天!':pd.nextDays+'天') : '—';
  if (pdEl) pdEl.textContent = pd.periodDur ? pd.periodDur+'天' : '—';
  if (tl) tl.textContent = pd.cycleStarts.length+'次';

  // 60-day strip calendar
  const calEl = document.getElementById('periodCalendar');
  if (calEl) {
    // Start from a Sunday, going back ~60 days
    const refDate = new Date(today);
    // Step back to last Sunday (or today if Sunday)
    const dow = refDate.getDay();
    refDate.setDate(refDate.getDate() - dow - 56); // Go back ~8 weeks
    const days = [];
    for (let i=0; i<63; i++) {
      const d = new Date(refDate); d.setDate(refDate.getDate()+i);
      days.push(d.toISOString().split('T')[0]);
    }
    calEl.innerHTML = days.map(d => {
      const entry = data.period.find(p=>p.date===d);
      const isMen = entry && entry.flow && entry.flow!=='none';
      const isOv = pd.ovulationDays.includes(d);
      const isFer = pd.fertileDays.has(d) && !isMen && !isOv;
      const isPred = pd.predictedDays.has(d) && !isMen;
      const isToday = d===today;
      const dn = parseInt(d.split('-')[2]);
      let cls = 'period-strip-day';
      if (isMen) cls += ' menstrual';
      else if (isOv) cls += ' ovulation';
      else if (isFer) cls += ' fertile';
      else if (isPred) cls += ' predicted';
      if (isToday) cls += ' today';
      return `<div class="${cls}" title="${d}" onclick="setEditPeriodDate('${d}')">${dn}</div>`;
    }).join('');
  }

  // History list
  const histEl = document.getElementById('periodHistoryList');
  if (histEl) {
    const entries = data.period.filter(p=>p.flow&&p.flow!=='none').slice(0,20);
    if (!entries.length) {
      histEl.innerHTML = '<div class="empty-state"><div class="empty-icon">🌸</div>尚無生理期記錄<br><span style="font-size:12px;color:var(--text3);">點擊「記錄」標籤開始記錄</span></div>';
    } else {
      const flowMap = {light:'少量',medium:'中量',heavy:'大量'};
      histEl.innerHTML = entries.map(p => `
        <div class="period-log-row">
          <div style="display:flex;align-items:center;flex:1;min-width:0;">
            <span class="period-dot-sm"></span>
            <div>
              <div style="font-weight:600;">${p.date} · ${flowMap[p.flow]||''}</div>
              ${p.symptoms?.length?`<div style="font-size:11px;color:var(--text3);margin-top:2px;">${p.symptoms.join('、')}</div>`:''}
            </div>
          </div>
          <button onclick="setEditPeriodDate('${p.date}')" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:12px;padding:4px 8px;border-radius:6px;">修改</button>
          <button onclick="deletePeriodEntry('${p.date}')" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:13px;padding:4px;">✕</button>
        </div>`).join('');
    }
  }

  // Update month view if visible
  if (_periodTab === 'month') renderPeriodMonth();
}

// ── MONTH VIEW ──
function periodMonthNav(delta) {
  _periodMonthOffset += delta;
  renderPeriodMonth();
}

function renderPeriodMonth() {
  const pd = _computePeriodData();
  const now = new Date();
  now.setMonth(now.getMonth() + _periodMonthOffset);
  const year = now.getFullYear();
  const month = now.getMonth();
  const today = new Date().toISOString().split('T')[0];
  const monthTitle = document.getElementById('periodMonthTitle');
  if (monthTitle) monthTitle.textContent = year+'年'+(month+1)+'月';

  const gridEl = document.getElementById('periodMonthGrid');
  if (!gridEl) return;

  // First day of month
  const firstDay = new Date(year, month, 1);
  const startDow = firstDay.getDay(); // 0=Sun
  const daysInMonth = new Date(year, month+1, 0).getDate();

  let html = '';
  // Empty cells before first day
  for (let i=0; i<startDow; i++) {
    const prevD = new Date(year, month, 1-startDow+i);
    const ds = prevD.toISOString().split('T')[0];
    html += _pmDayCell(ds, prevD.getDate(), 'other-month', pd, today);
  }
  // Days in month
  for (let d=1; d<=daysInMonth; d++) {
    const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    html += _pmDayCell(ds, d, '', pd, today);
  }
  // Fill remaining cells
  const totalCells = startDow + daysInMonth;
  const remaining = (7 - totalCells % 7) % 7;
  for (let i=1; i<=remaining; i++) {
    const nextD = new Date(year, month+1, i);
    const ds = nextD.toISOString().split('T')[0];
    html += _pmDayCell(ds, i, 'other-month', pd, today);
  }
  gridEl.innerHTML = html;
}

function _pmDayCell(ds, dn, extraCls, pd, today) {
  const entry = (data.period||[]).find(p=>p.date===ds);
  const isMen = entry && entry.flow && entry.flow!=='none';
  const isOv = pd.ovulationDays.includes(ds);
  const isPred = pd.predictedDays.has(ds) && !isMen;
  let cls = 'pm-day '+extraCls;
  if (ds===today) cls += ' today';
  if (isMen) cls += ' menstrual';
  else if (isOv) cls += ' ovulation';
  else if (isPred) cls += ' predicted';
  let dot = '';
  if (isMen) dot = '<div class="pm-day-dot men"></div>';
  else if (isOv) dot = '<div class="pm-day-dot ov"></div>';
  else if (isPred) dot = '<div class="pm-day-dot pred"></div>';
  return `<button class="${cls}" onclick="pmDayClick('${ds}')">${dn}${dot}</button>`;
}

function pmDayClick(ds) {
  // Switch to log tab with this date pre-filled
  switchPeriodTab('log');
  const dateEl = document.getElementById('period-date');
  if (dateEl) { dateEl.value = ds; }
  setEditPeriodDate(ds);
}

function setEditPeriodDate(d) {
  const dateEl = document.getElementById('period-date');
  if (dateEl) dateEl.value = d;
  if (_periodTab !== 'log') switchPeriodTab('log');
  const entry = (data.period||[]).find(p=>p.date===d);
  if (entry) {
    _selectedFlow = entry.flow || 'none';
    selectPeriodStatus(_selectedFlow);
    const noteEl = document.getElementById('period-note');
    if (noteEl) noteEl.value = entry.note || '';
  } else {
    _selectedFlow = 'none';
    selectPeriodStatus('none');
    const noteEl = document.getElementById('period-note');
    if (noteEl) noteEl.value = '';
  }
  renderSymptomSelector();
  const entry2 = (data.period||[]).find(p=>p.date===d);
  if (entry2?.symptoms?.length) {
    setTimeout(()=>{
      document.querySelectorAll('#symptomSelector .symptom-chip').forEach(btn=>{
        btn.classList.toggle('selected', entry2.symptoms.includes(btn.textContent));
      });
    }, 50);
  }
}

function deletePeriodEntry(date) {
  data.period = (data.period||[]).filter(p=>p.date!==date);
  saveAndSync(); renderPeriod();
  showToast('已刪除記錄');
}

// ══════════════════════════════════════════════════════════
// UPDATED saveLog — uses logExercises array
// ══════════════════════════════════════════════════════════

// ── INIT ──
buildExDatalist();
renderLogExerciseList();

</script>

</body>
</html>
