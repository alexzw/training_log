<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Training Log</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f5f7;
    --surface: #ffffff;
    --surface2: #f5f5f7;
    --surface3: #e8e8ed;
    --border: rgba(0,0,0,0.08);
    --border2: rgba(0,0,0,0.12);
    --accent: #0071e3;
    --accent-hover: #0077ed;
    --accent-light: rgba(0,113,227,0.08);
    --red: #ff3b30;
    --red-light: rgba(255,59,48,0.1);
    --green: #30d158;
    --green-light: rgba(48,209,88,0.1);
    --orange: #ff9f0a;
    --orange-light: rgba(255,159,10,0.1);
    --text: #1d1d1f;
    --text2: #6e6e73;
    --text3: #a1a1a6;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow: 0 4px 16px rgba(0,0,0,0.08), 0 1px 4px rgba(0,0,0,0.04);
    --shadow-lg: 0 8px 30px rgba(0,0,0,0.10), 0 2px 8px rgba(0,0,0,0.06);
    --radius: 14px;
    --radius-sm: 10px;
    --radius-xs: 8px;
    --sidebar-w: 240px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
    min-height: 100vh;
    font-size: 15px;
    line-height: 1.5;
  }

  /* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
  .sidebar {
    position: fixed;
    left: 0; top: 0; bottom: 0;
    width: var(--sidebar-w);
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    z-index: 100;
    padding: 0;
  }

  .sidebar-header {
    padding: 28px 20px 20px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 11px;
    text-decoration: none;
  }

  .logo-icon {
    width: 36px;
    height: 36px;
    background: linear-gradient(145deg, #1d1d1f 0%, #3a3a3c 100%);
    border-radius: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }

  .logo-icon svg { width: 20px; height: 20px; }

  .logo-text {
    display: flex;
    flex-direction: column;
    line-height: 1.15;
  }

  .logo-name {
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.2px;
  }

  .logo-sub {
    font-size: 11px;
    color: var(--text3);
    font-weight: 400;
    letter-spacing: 0.1px;
  }

  nav {
    padding: 12px 10px;
    flex: 1;
    overflow-y: auto;
  }

  .nav-section-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text3);
    letter-spacing: 0.5px;
    padding: 10px 10px 4px;
    text-transform: uppercase;
  }

  nav a {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 9px 10px;
    border-radius: var(--radius-xs);
    color: var(--text2);
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.15s ease;
    cursor: pointer;
    margin-bottom: 2px;
  }

  nav a:hover { background: var(--surface3); color: var(--text); }

  nav a.active {
    background: var(--accent-light);
    color: var(--accent);
    font-weight: 600;
  }

  nav a .nav-icon {
    width: 28px;
    height: 28px;
    border-radius: 7px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    flex-shrink: 0;
    background: var(--surface3);
    transition: background 0.15s;
  }

  nav a.active .nav-icon { background: var(--accent); filter: none; }
  nav a.active .nav-icon span { filter: brightness(10); }

  .sidebar-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    font-size: 12px;
    color: var(--text3);
  }

  /* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
  .main {
    margin-left: var(--sidebar-w);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ‚îÄ */
  .topbar {
    position: sticky;
    top: 0;
    background: rgba(245,245,247,0.9);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-bottom: 1px solid var(--border);
    padding: 0 36px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 50;
  }

  .topbar-title {
    font-size: 17px;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.3px;
  }

  .topbar-date {
    font-size: 13px;
    color: var(--text3);
    font-weight: 400;
  }

  .content { padding: 28px 36px; flex: 1; }

  /* ‚îÄ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ */
  .page { display: none; animation: fadeUp 0.25s ease; }
  .page.active { display: block; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ‚îÄ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ */
  .card {
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 24px;
    box-shadow: var(--shadow-sm);
  }

  .card-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text2);
    letter-spacing: 0.1px;
    margin-bottom: 18px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* ‚îÄ‚îÄ‚îÄ STATS GRID ‚îÄ‚îÄ‚îÄ */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 20px 22px;
    box-shadow: var(--shadow-sm);
    transition: box-shadow 0.2s, transform 0.2s;
  }

  .stat-card:hover { box-shadow: var(--shadow); transform: translateY(-1px); }

  .stat-label {
    font-size: 12px;
    font-weight: 500;
    color: var(--text3);
    margin-bottom: 6px;
    letter-spacing: 0.1px;
  }

  .stat-value {
    font-size: 34px;
    font-weight: 700;
    letter-spacing: -1.5px;
    line-height: 1;
    color: var(--text);
    margin-bottom: 4px;
  }

  .stat-unit { font-size: 13px; color: var(--text3); margin-bottom: 6px; }

  .stat-change {
    font-size: 12px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 4px;
  }

  .stat-change.up { color: var(--red); }
  .stat-change.down { color: var(--green); }
  .stat-change.neutral { color: var(--text3); }

  /* ‚îÄ‚îÄ‚îÄ DASHBOARD GRID ‚îÄ‚îÄ‚îÄ */
  .dashboard-grid {
    display: grid;
    grid-template-columns: 3fr 2fr;
    gap: 16px;
  }

  /* ‚îÄ‚îÄ‚îÄ CHART ‚îÄ‚îÄ‚îÄ */
  .weight-chart { height: 180px; }
  .chart-svg { width: 100%; height: 100%; overflow: visible; }

  /* ‚îÄ‚îÄ‚îÄ FORM ‚îÄ‚îÄ‚îÄ */
  .log-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
  }

  .form-group { margin-bottom: 14px; }

  .form-label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: var(--text2);
    margin-bottom: 6px;
  }

  .form-input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: var(--radius-xs);
    color: var(--text);
    padding: 10px 13px;
    font-family: inherit;
    font-size: 14px;
    outline: none;
    transition: border-color 0.15s, box-shadow 0.15s;
    appearance: none;
  }

  .form-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,113,227,0.15);
    background: var(--surface);
  }

  textarea.form-input { resize: vertical; min-height: 90px; line-height: 1.5; }
  select.form-input { cursor: pointer; }

  /* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 20px;
    font-family: inherit;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    border-radius: 980px;
    transition: all 0.15s ease;
    white-space: nowrap;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
  }

  .btn-primary:hover { background: var(--accent-hover); box-shadow: 0 2px 8px rgba(0,113,227,0.3); }
  .btn-primary:active { transform: scale(0.98); }

  .btn-secondary {
    background: var(--surface3);
    color: var(--text);
  }

  .btn-secondary:hover { background: #dcdce0; }

  .btn-danger {
    background: var(--red-light);
    color: var(--red);
    font-size: 12px;
    padding: 6px 14px;
    border-radius: 6px;
    font-weight: 500;
  }

  .btn-danger:hover { background: rgba(255,59,48,0.18); }

  /* ‚îÄ‚îÄ‚îÄ PHOTO UPLOAD ‚îÄ‚îÄ‚îÄ */
  .photo-upload-area {
    border: 2px dashed var(--border2);
    border-radius: var(--radius-sm);
    padding: 32px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    background: var(--surface2);
  }

  .photo-upload-area:hover { border-color: var(--accent); background: var(--accent-light); }
  .photo-upload-area input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

  .photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
    margin-top: 14px;
  }

  .photo-item {
    position: relative;
    aspect-ratio: 3/4;
    overflow: hidden;
    background: var(--surface3);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
  }

  .photo-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
  .photo-item:hover img { transform: scale(1.04); }

  .photo-item .photo-date {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.55));
    padding: 20px 10px 8px;
    font-size: 11px;
    color: #fff;
    font-weight: 500;
  }

  .photo-item .photo-delete {
    position: absolute;
    top: 7px; right: 7px;
    background: rgba(255,59,48,0.85);
    color: white;
    border: none;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    font-size: 12px;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  .photo-item:hover .photo-delete { display: flex; }

  /* ‚îÄ‚îÄ‚îÄ WORKOUT ENTRIES ‚îÄ‚îÄ‚îÄ */
  .workout-list { display: flex; flex-direction: column; gap: 10px; }

  .workout-entry {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px 18px;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 12px;
    align-items: start;
    box-shadow: var(--shadow-sm);
    transition: box-shadow 0.2s;
  }

  .workout-entry:hover { box-shadow: var(--shadow); }

  .workout-entry.rest { opacity: 0.7; }

  .entry-date { font-size: 12px; color: var(--text3); margin-bottom: 4px; font-weight: 400; }

  .entry-title { font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 6px; }

  .entry-meta { display: flex; gap: 6px; flex-wrap: wrap; }

  .entry-tag {
    font-size: 12px;
    font-weight: 500;
    background: var(--accent-light);
    color: var(--accent);
    padding: 3px 10px;
    border-radius: 20px;
  }

  .entry-tag.red { background: var(--red-light); color: var(--red); }
  .entry-tag.green { background: var(--green-light); color: var(--green); }

  .entry-exercises {
    margin-top: 8px;
    font-size: 13px;
    color: var(--text2);
    white-space: pre-line;
    line-height: 1.6;
  }

  .entry-notes {
    margin-top: 5px;
    font-size: 13px;
    color: var(--text3);
    font-style: italic;
  }

  /* ‚îÄ‚îÄ‚îÄ PLAN CARDS ‚îÄ‚îÄ‚îÄ */
  .plan-phases {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
  }

  .phase-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 22px;
    box-shadow: var(--shadow-sm);
    transition: box-shadow 0.2s, transform 0.2s;
    position: relative;
  }

  .phase-card:hover { box-shadow: var(--shadow); transform: translateY(-2px); }

  .phase-card.active-phase { border-color: var(--accent); border-width: 1.5px; }

  .active-badge {
    display: inline-flex;
    align-items: center;
    background: var(--accent);
    color: #fff;
    font-size: 10px;
    font-weight: 700;
    padding: 3px 9px;
    border-radius: 20px;
    letter-spacing: 0.3px;
    margin-bottom: 12px;
    text-transform: uppercase;
  }

  .phase-name { font-size: 18px; font-weight: 700; letter-spacing: -0.4px; margin-bottom: 4px; }
  .phase-duration { font-size: 12px; color: var(--text3); margin-bottom: 14px; }

  .phase-exercises { list-style: none; display: flex; flex-direction: column; gap: 6px; }

  .phase-exercises li {
    font-size: 13px;
    color: var(--text2);
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }

  .phase-exercises li::before {
    content: '';
    display: block;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--accent);
    flex-shrink: 0;
    margin-top: 6px;
  }

  /* ‚îÄ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ‚îÄ */
  .progress-bar {
    height: 5px;
    background: var(--surface3);
    border-radius: 10px;
    margin-top: 14px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #34aadc);
    border-radius: 10px;
    transition: width 0.6s cubic-bezier(0.22,1,0.36,1);
  }

  /* ‚îÄ‚îÄ‚îÄ GOAL CARDS ‚îÄ‚îÄ‚îÄ */
  .goal-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 20px;
    align-items: center;
    margin-bottom: 14px;
    box-shadow: var(--shadow-sm);
  }

  .goal-title { font-size: 16px; font-weight: 600; margin-bottom: 5px; }
  .goal-meta { font-size: 13px; color: var(--text2); line-height: 1.5; }

  .goal-circle { width: 70px; height: 70px; position: relative; flex-shrink: 0; }
  .goal-circle svg { transform: rotate(-90deg); }

  .goal-percent {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: -0.5px;
  }

  /* ‚îÄ‚îÄ‚îÄ WEIGHT TABLE ‚îÄ‚îÄ‚îÄ */
  .weight-table { width: 100%; border-collapse: collapse; }

  .weight-table th {
    font-size: 12px;
    font-weight: 600;
    color: var(--text3);
    text-align: left;
    padding: 8px 14px;
    border-bottom: 1px solid var(--border);
    letter-spacing: 0.2px;
  }

  .weight-table td {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
    color: var(--text);
  }

  .weight-table tr:last-child td { border-bottom: none; }
  .weight-table tbody tr:hover td { background: var(--surface2); }

  /* ‚îÄ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ‚îÄ */
  .badge {
    display: inline-flex;
    align-items: center;
    font-size: 11px;
    font-weight: 600;
    padding: 3px 9px;
    border-radius: 20px;
  }

  .badge-green { background: var(--green-light); color: var(--green); }
  .badge-orange { background: var(--orange-light); color: var(--orange); }
  .badge-red { background: var(--red-light); color: var(--red); }
  .badge-blue { background: var(--accent-light); color: var(--accent); }

  /* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
  .toast {
    position: fixed;
    bottom: 28px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: rgba(28,28,30,0.92);
    backdrop-filter: blur(20px);
    color: #fff;
    padding: 12px 22px;
    border-radius: 980px;
    font-size: 14px;
    font-weight: 500;
    transition: transform 0.3s cubic-bezier(0.22,1,0.36,1), opacity 0.3s;
    z-index: 10000;
    opacity: 0;
    white-space: nowrap;
  }

  .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

  /* ‚îÄ‚îÄ‚îÄ SECTION TITLE ‚îÄ‚îÄ‚îÄ */
  .section-title {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: -0.5px;
    margin-bottom: 16px;
    color: var(--text);
  }

  /* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text3);
    font-size: 14px;
  }

  .empty-state .empty-icon { font-size: 32px; margin-bottom: 10px; }

  /* ‚îÄ‚îÄ‚îÄ SEGMENT CONTROL (filter) ‚îÄ‚îÄ‚îÄ */
  .segment-control {
    display: inline-flex;
    background: var(--surface3);
    border-radius: 9px;
    padding: 3px;
    gap: 2px;
  }

  .segment-control select {
    background: transparent;
    border: none;
    padding: 6px 12px;
    font-family: inherit;
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    cursor: pointer;
    outline: none;
    border-radius: 7px;
  }

  .segment-control select:focus { background: var(--surface); }

  /* ‚îÄ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ‚îÄ */
  hr.divider { border: none; border-top: 1px solid var(--border); margin: 24px 0; }

  /* ‚îÄ‚îÄ‚îÄ BOTTOM NAV (mobile only) ‚îÄ‚îÄ‚îÄ */
  .bottom-nav {
    display: none;
  }

  /* ‚îÄ‚îÄ‚îÄ RESPONSIVE TABLET ‚îÄ‚îÄ‚îÄ */
  @media (max-width: 960px) and (min-width: 601px) {
    :root { --sidebar-w: 200px; }
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .dashboard-grid { grid-template-columns: 1fr; }
    .log-grid { grid-template-columns: 1fr; }
    .content { padding: 20px 24px; }
  }

  /* ‚îÄ‚îÄ‚îÄ RESPONSIVE MOBILE ‚îÄ‚îÄ‚îÄ */
  @media (max-width: 600px) {
    :root { --sidebar-w: 0px; }

    /* hide sidebar entirely */
    .sidebar { display: none; }

    /* main takes full width */
    .main { margin-left: 0; padding-bottom: 72px; }

    /* topbar */
    .topbar { padding: 0 16px; height: 50px; }
    .topbar-title { font-size: 16px; }
    .topbar-date { font-size: 11px; }

    /* content */
    .content { padding: 14px 14px 16px; }

    /* stats */
    .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
    .stat-card { padding: 14px 16px; }
    .stat-value { font-size: 26px; }

    /* grids ‚Üí single column */
    .dashboard-grid { grid-template-columns: 1fr; gap: 12px; }
    .log-grid { grid-template-columns: 1fr; gap: 12px; }
    .plan-phases { grid-template-columns: 1fr; }

    /* cards */
    .card { padding: 16px; border-radius: 12px; }
    .card-title { margin-bottom: 14px; }

    /* section title */
    .section-title { font-size: 17px; }

    /* weight chart */
    .weight-chart { height: 150px; }

    /* workout entry */
    .workout-entry { padding: 12px 14px; }

    /* photo grid */
    .photo-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }

    /* buttons */
    .btn { padding: 11px 18px; font-size: 14px; width: 100%; justify-content: center; }
    .btn-danger { width: auto; }

    /* form inputs bigger for touch */
    .form-input { padding: 12px 13px; font-size: 15px; }
    .form-label { font-size: 13px; }

    /* goal card */
    .goal-card { grid-template-columns: 1fr; gap: 12px; }

    /* BMI + calorie row ‚Üí stack on mobile */
    #bmi-calorie-row { grid-template-columns: 1fr !important; }
    .bmi-card { grid-column: 1 !important; }
    .bmi-value { font-size: 28px; }
    .bmi-labels { font-size: 9px; }
    /* inline height edit ‚Äî stack on mobile */

    .goal-circle { margin: 0 auto; }

    /* table scroll */
    .weight-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .weight-table { min-width: 360px; }

    /* user dropdown wider */
    .user-dropdown { left: 0; right: 0; border-radius: 0 0 12px 12px; }

    /* bottom nav */
    .bottom-nav {
      display: flex;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 64px;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-top: 1px solid var(--border);
      z-index: 100;
      align-items: stretch;
      padding: 0 4px;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .bottom-nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      cursor: pointer;
      border-radius: 10px;
      transition: background 0.15s;
      padding: 6px 2px;
      color: var(--text3);
      font-size: 10px;
      font-weight: 500;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .bottom-nav-item:active { background: var(--surface3); }
    .bottom-nav-item.active { color: var(--accent); }

    .bottom-nav-icon { font-size: 20px; line-height: 1; }
    .bottom-nav-label { font-size: 9.5px; font-weight: 500; letter-spacing: 0.1px; }

    /* topbar user button on mobile */
    .topbar-user {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 20px;
      background: var(--surface3);
    }

    .topbar-user-avatar {
      width: 24px; height: 24px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-size: 10px; font-weight: 700;
    }

    .topbar-user-name { font-size: 13px; font-weight: 600; color: var(--text); max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* mobile user modal */
    .mobile-user-modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 500;
    }

    .mobile-user-modal.open { display: block; }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(4px);
    }

    .modal-sheet {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background: var(--surface);
      border-radius: 20px 20px 0 0;
      padding: 12px 0 32px;
      box-shadow: 0 -4px 30px rgba(0,0,0,0.12);
      animation: slideSheet 0.28s cubic-bezier(0.22,1,0.36,1);
    }

    @keyframes slideSheet {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .modal-handle {
      width: 36px; height: 4px;
      background: var(--surface3);
      border-radius: 2px;
      margin: 0 auto 16px;
    }

    .modal-title {
      font-size: 13px; font-weight: 600;
      color: var(--text3); text-transform: uppercase;
      letter-spacing: 0.5px; padding: 0 20px 8px;
    }

    .modal-user-item {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 20px; cursor: pointer;
      font-size: 15px; font-weight: 500;
      -webkit-tap-highlight-color: transparent;
    }

    .modal-user-item:active { background: var(--surface2); }
    .modal-user-item.selected { color: var(--accent); }

    .modal-user-avatar {
      width: 36px; height: 36px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-size: 14px; font-weight: 700;
    }

    .modal-check { margin-left: auto; color: var(--accent); font-size: 16px; }
    .modal-del { margin-left: auto; color: var(--red); font-size: 13px; background: var(--red-light); border: none; padding: 4px 10px; border-radius: 8px; font-family: inherit; cursor: pointer; }

    .modal-add-row {
      display: flex; gap: 10px;
      padding: 12px 20px 4px;
      border-top: 1px solid var(--border);
      margin-top: 8px;
    }

    .modal-add-input {
      flex: 1; background: var(--surface2); border: 1px solid var(--border2);
      border-radius: 10px; padding: 10px 14px;
      font-family: inherit; font-size: 15px; color: var(--text); outline: none;
    }

    .modal-add-input:focus { border-color: var(--accent); }

    .modal-add-btn {
      background: var(--accent); color: #fff; border: none;
      border-radius: 10px; padding: 10px 16px;
      font-size: 15px; font-weight: 600; cursor: pointer; font-family: inherit;
    }
  }

  /* ‚îÄ‚îÄ‚îÄ CHART TOOLTIP ‚îÄ‚îÄ‚îÄ */
  .chart-tooltip {
    position: absolute;
    background: rgba(28,28,30,0.88);
    backdrop-filter: blur(12px);
    color: #fff;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    white-space: nowrap;
    z-index: 10;
  }

  .chart-wrap { position: relative; }



  /* ‚îÄ‚îÄ‚îÄ DYNAMIC EXERCISE LIST (log page) ‚îÄ‚îÄ‚îÄ */
  .ex-list-row {
    display: grid;
    grid-template-columns: 1fr 60px 70px 32px;
    gap: 6px;
    align-items: center;
    margin-bottom: 6px;
  }
  .ex-list-row .set-input {
    padding: 9px 10px;
    font-size: 13px;
  }
  .ex-list-col-label {
    font-size: 10px;
    font-weight: 600;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    display: grid;
    grid-template-columns: 1fr 60px 70px 32px;
    gap: 6px;
    margin-bottom: 4px;
  }
  .ex-list-add-row {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  .weight-diff-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 20px;
    margin-left: 8px;
    transition: all 0.3s;
  }
  .weight-diff-down { background: var(--green-light); color: var(--green); }
  .weight-diff-up { background: var(--red-light); color: var(--red); }
  .weight-diff-flat { background: var(--surface3); color: var(--text3); }

  /* ‚îÄ‚îÄ‚îÄ REST TIMER ‚îÄ‚îÄ‚îÄ */
  .rest-timer-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 18px 20px;
    margin-bottom: 12px;
  }
  .rest-timer-display {
    text-align: center;
    margin: 10px 0;
  }
  .rest-clock {
    font-size: 52px;
    font-weight: 700;
    letter-spacing: -2px;
    font-variant-numeric: tabular-nums;
    line-height: 1;
  }
  .rest-clock.urgent { color: var(--red); animation: pulse-red 0.8s infinite; }
  @keyframes pulse-red { 0%,100%{opacity:1} 50%{opacity:0.5} }
  .rest-presets {
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
    margin: 12px 0 8px;
  }
  .rest-preset-btn {
    padding: 8px 18px;
    border-radius: 980px;
    border: 1.5px solid var(--border2);
    background: var(--surface2);
    color: var(--text);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.15s;
  }
  .rest-preset-btn:hover, .rest-preset-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
  .rest-controls { display: flex; gap: 8px; justify-content: center; margin-top: 8px; }
  .rest-ctrl-btn {
    padding: 9px 22px;
    border-radius: 980px;
    border: none;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.15s;
  }
  .rest-start-btn { background: var(--green); color: #fff; }
  .rest-start-btn:hover { background: #27b84a; }
  .rest-reset-btn { background: var(--surface3); color: var(--text2); }
  .rest-reset-btn:hover { background: var(--surface2); }
  .rest-progress {
    height: 4px;
    background: var(--surface3);
    border-radius: 2px;
    margin-top: 10px;
    overflow: hidden;
  }
  .rest-progress-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    transition: width 1s linear, background 0.5s;
  }
  .rest-progress-bar.urgent { background: var(--red); }

  /* ‚îÄ‚îÄ‚îÄ WORKOUT TIMER ‚îÄ‚îÄ‚îÄ */
  .timer-display {
    text-align: center;
    padding: 32px 20px;
  }
  .timer-clock {
    font-size: 72px;
    font-weight: 700;
    letter-spacing: -3px;
    color: var(--text);
    font-variant-numeric: tabular-nums;
    line-height: 1;
    margin-bottom: 6px;
  }
  .timer-label {
    font-size: 13px;
    color: var(--text3);
    font-weight: 500;
    margin-bottom: 28px;
  }
  .timer-controls {
    display: flex;
    justify-content: center;
    gap: 14px;
    flex-wrap: wrap;
  }
  .timer-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 13px 28px;
    border-radius: 980px;
    font-size: 15px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.15s;
  }
  .timer-btn-start { background: var(--green); color: #fff; }
  .timer-btn-start:hover { background: #27b84a; }
  .timer-btn-pause { background: var(--orange); color: #fff; }
  .timer-btn-pause:hover { background: #e08c00; }
  .timer-btn-stop { background: var(--red); color: #fff; }
  .timer-btn-stop:hover { background: #e0332a; }
  .timer-btn-resume { background: var(--accent); color: #fff; }
  .timer-btn-resume:hover { background: var(--accent-hover); }

  .workout-set-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr auto;
    gap: 8px;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
  }
  .workout-set-row:last-child { border-bottom: none; }
  .set-input {
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 8px;
    padding: 8px 10px;
    font-size: 13px;
    font-family: inherit;
    color: var(--text);
    width: 100%;
    outline: none;
  }
  .set-input:focus { border-color: var(--accent); }
  .set-del-btn {
    background: none;
    border: none;
    color: var(--text3);
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
    line-height: 1;
    border-radius: 6px;
    transition: color 0.15s;
  }
  .set-del-btn:hover { color: var(--red); }
  .workout-ex-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    margin-bottom: 12px;
    overflow: hidden;
  }
  .workout-ex-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
  }
  .workout-ex-name {
    flex: 1;
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
  }
  .workout-ex-body { padding: 10px 16px 14px; }
  .set-col-labels {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr auto;
    gap: 8px;
    font-size: 11px;
    font-weight: 600;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    padding: 0 0 6px;
  }
  .add-set-btn {
    background: none;
    border: 1.5px dashed var(--border2);
    color: var(--accent);
    border-radius: 8px;
    padding: 7px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    width: 100%;
    margin-top: 8px;
    transition: background 0.12s;
  }
  .add-set-btn:hover { background: var(--accent-light); }
  .add-ex-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 13px;
    background: var(--accent-light);
    color: var(--accent);
    border: none;
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    margin-top: 4px;
  }
  .add-ex-btn:hover { background: rgba(0,113,227,0.14); }
  .timer-status-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text3);
    margin-bottom: 8px;
  }
  .status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--text3);
  }
  .status-dot.running { background: var(--green); box-shadow: 0 0 0 3px rgba(48,209,88,0.2); animation: pulse 1.5s infinite; }
  .status-dot.paused { background: var(--orange); }
  @keyframes pulse { 0%,100%{ box-shadow: 0 0 0 3px rgba(48,209,88,0.2); } 50%{ box-shadow: 0 0 0 6px rgba(48,209,88,0.1); } }

  /* ‚îÄ‚îÄ‚îÄ EXERCISE LIBRARY ‚îÄ‚îÄ‚îÄ */
  .lib-search {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .lib-search-input {
    flex: 1;
    min-width: 160px;
    background: var(--surface);
    border: 1.5px solid var(--border2);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 14px;
    font-family: inherit;
    color: var(--text);
    outline: none;
  }
  .lib-search-input:focus { border-color: var(--accent); }
  .lib-filter-select {
    background: var(--surface);
    border: 1.5px solid var(--border2);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 13px;
    font-family: inherit;
    color: var(--text);
    outline: none;
    cursor: pointer;
  }
  .ex-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px 18px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: box-shadow 0.15s, transform 0.15s;
  }
  .ex-card:hover { box-shadow: var(--shadow); transform: translateY(-1px); }
  .ex-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
  .ex-card-name { font-size: 15px; font-weight: 600; flex: 1; }
  .ex-card-muscle { font-size: 11px; font-weight: 600; color: var(--accent); background: var(--accent-light); padding: 2px 9px; border-radius: 20px; }
  .ex-card-desc { font-size: 13px; color: var(--text2); line-height: 1.5; }
  .ex-card-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
  .ex-tag { font-size: 11px; color: var(--text3); background: var(--surface2); padding: 2px 8px; border-radius: 6px; }
  .ex-detail-modal {
    position: fixed; inset: 0; z-index: 600;
    background: rgba(0,0,0,0.3); backdrop-filter: blur(6px);
    display: none; align-items: flex-end; justify-content: center;
  }
  .ex-detail-modal.open { display: flex; }
  .ex-detail-sheet {
    background: var(--surface);
    border-radius: 20px 20px 0 0;
    width: 100%; max-width: 640px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 20px 24px 40px;
    animation: slideSheet 0.28s cubic-bezier(0.22,1,0.36,1);
  }
  .ex-step {
    display: flex; gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  .ex-step:last-child { border-bottom: none; }
  .ex-step-num {
    width: 26px; height: 26px; border-radius: 50%;
    background: var(--accent); color: #fff;
    font-size: 12px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; margin-top: 2px;
  }
  .ex-step-text { font-size: 14px; color: var(--text2); line-height: 1.6; }
  .muscle-chip { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 500; background: var(--surface2); border: 1px solid var(--border2); padding: 4px 10px; border-radius: 20px; margin: 3px; color: var(--text2); }

  /* ‚îÄ‚îÄ‚îÄ MOBILE: workout timer adjustments ‚îÄ‚îÄ‚îÄ */
  @media (max-width: 600px) {
    .timer-clock { font-size: 52px; }
    .workout-set-row { grid-template-columns: 2fr 1fr 1fr auto; }
    .set-col-labels { grid-template-columns: 2fr 1fr 1fr auto; }
    .workout-set-row .rpe-col { display: none; }
    .set-col-labels .rpe-col { display: none; }
  }

  /* ‚îÄ‚îÄ‚îÄ DELETE CONFIRM MODAL ‚îÄ‚îÄ‚îÄ */
  .delete-modal {
    position: fixed; inset: 0; z-index: 9500;
    display: none; align-items: center; justify-content: center;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(6px);
  }
  .delete-modal.open { display: flex; }
  .delete-modal-box {
    background: var(--surface);
    border-radius: 18px;
    padding: 28px 28px 24px;
    width: min(360px, 90vw);
    box-shadow: var(--shadow-lg);
    animation: fadeUp 0.22s ease;
    text-align: center;
  }
  .delete-modal-icon { font-size: 36px; margin-bottom: 10px; }
  .delete-modal-title { font-size: 17px; font-weight: 700; margin-bottom: 6px; }
  .delete-modal-desc { font-size: 13px; color: var(--text2); margin-bottom: 20px; line-height: 1.5; }
  .delete-modal-actions { display: flex; gap: 10px; margin-top: 16px; }
  .delete-modal-actions .btn { flex: 1; padding: 11px; font-size: 14px; border-radius: 10px; }

  /* ‚îÄ‚îÄ‚îÄ LOCK SCREEN ‚îÄ‚îÄ‚îÄ */
  .lock-screen {
    position: fixed; inset: 0; z-index: 9000;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
  }
  .lock-screen.hidden { display: none; }
  .lock-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 36px 32px 32px;
    width: 340px;
    box-shadow: var(--shadow-lg);
    text-align: center;
    animation: fadeUp 0.3s ease;
  }
  .lock-avatar {
    width: 64px; height: 64px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 24px; font-weight: 700;
    margin: 0 auto 14px;
  }
  .lock-name { font-size: 20px; font-weight: 700; letter-spacing: -0.4px; margin-bottom: 4px; }
  .lock-hint { font-size: 13px; color: var(--text3); margin-bottom: 22px; }
  .lock-input {
    width: 100%; background: var(--surface2);
    border: 1.5px solid var(--border2);
    border-radius: 10px; padding: 12px 14px;
    font-family: inherit; font-size: 16px;
    color: var(--text); outline: none; text-align: center;
    letter-spacing: 4px; margin-bottom: 12px;
  }
  .lock-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,113,227,0.15); }
  .lock-input.error { border-color: var(--red); box-shadow: 0 0 0 3px rgba(255,59,48,0.15); animation: shake 0.3s; }
  @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }
  .lock-btn {
    width: 100%; padding: 12px; background: var(--accent);
    color: #fff; border: none; border-radius: 10px;
    font-family: inherit; font-size: 15px; font-weight: 600;
    cursor: pointer; margin-bottom: 10px;
  }
  .lock-btn:hover { background: var(--accent-hover); }
  .lock-error { font-size: 13px; color: var(--red); min-height: 18px; margin-bottom: 4px; }
  .lock-users { display: flex; flex-direction: column; gap: 4px; }
  .lock-user-btn {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 14px; border-radius: 10px; cursor: pointer;
    transition: background 0.15s; text-align: left;
    background: none; border: 1px solid var(--border);
    width: 100%; font-family: inherit;
  }
  .lock-user-btn:hover { background: var(--surface2); }
  .lock-user-btn.selected { border-color: var(--accent); background: var(--accent-light); }
  .lock-user-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 12px; font-weight: 700; flex-shrink: 0; }
  .lock-user-info { flex: 1; }
  .lock-user-name { font-size: 14px; font-weight: 600; color: var(--text); }
  .lock-user-hint { font-size: 11px; color: var(--text3); }
  .lock-back { font-size: 13px; color: var(--accent); cursor: pointer; margin-top: 8px; background: none; border: none; font-family: inherit; }
  .lock-back:hover { text-decoration: underline; }
  .lock-divider { border: none; border-top: 1px solid var(--border); margin: 16px 0; }

  /* ‚îÄ‚îÄ‚îÄ BMI CARD ‚îÄ‚îÄ‚îÄ */
  .bmi-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 22px;
    box-shadow: var(--shadow-sm);
    transition: box-shadow 0.2s, transform 0.2s;
    grid-column: span 2;
  }
  .bmi-card:hover { box-shadow: var(--shadow); transform: translateY(-1px); }
  .bmi-bar-wrap { height: 10px; border-radius: 10px; background: linear-gradient(90deg,#34aadc 0%,#30d158 22%,#30d158 44%,#ff9f0a 66%,#ff3b30 100%); position: relative; margin: 10px 0 6px; overflow: visible; }
  .bmi-marker { position: absolute; top: -4px; width: 18px; height: 18px; background: var(--surface); border: 2.5px solid var(--text); border-radius: 50%; transform: translateX(-50%); box-shadow: 0 1px 4px rgba(0,0,0,0.15); transition: left 0.6s cubic-bezier(0.22,1,0.36,1); }
  .bmi-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text3); }
  .bmi-value-row { display: flex; align-items: baseline; gap: 8px; }
  .bmi-value { font-size: 32px; font-weight: 700; letter-spacing: -1px; }
  .bmi-category { font-size: 13px; font-weight: 600; padding: 3px 10px; border-radius: 20px; }

  /* ‚îÄ‚îÄ‚îÄ CALORIE DISPLAY ‚îÄ‚îÄ‚îÄ */
  .calorie-tag { display: inline-flex; align-items: center; gap: 5px; font-size: 12px; font-weight: 600; background: rgba(255,159,10,0.12); color: var(--orange); padding: 3px 10px; border-radius: 20px; }
  .calorie-est { font-size: 11px; color: var(--text3); margin-top: 4px; }

  /* ‚îÄ‚îÄ‚îÄ SET PASSWORD ‚îÄ‚îÄ‚îÄ */
  .pwd-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }


  /* ‚îÄ‚îÄ‚îÄ USER SWITCHER ‚îÄ‚îÄ‚îÄ */
  .user-switcher {
    padding: 10px 10px 6px;
    border-bottom: 1px solid var(--border);
    position: relative;
  }
  .user-current {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: var(--radius-xs);
    cursor: pointer;
    transition: background 0.15s;
    user-select: none;
  }
  .user-current:hover { background: var(--surface3); }
  .user-avatar {
    width: 30px; height: 30px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 12px; font-weight: 700; flex-shrink: 0;
  }
  .user-info { flex: 1; min-width: 0; }
  .user-name { font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .user-hint { font-size: 11px; color: var(--text3); }
  .user-chevron { color: var(--text3); font-size: 10px; flex-shrink: 0; transition: transform 0.2s; }
  .user-switcher.open .user-chevron { transform: rotate(180deg); }

  .user-dropdown {
    position: absolute;
    left: 10px; right: 10px; top: calc(100% - 2px);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-lg);
    z-index: 200; overflow: hidden;
    display: none;
  }
  .user-dropdown.open { display: block; animation: fadeUp 0.18s ease; }
  .user-dropdown-header {
    padding: 10px 14px 6px;
    font-size: 11px; font-weight: 600; color: var(--text3);
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .user-list { max-height: 180px; overflow-y: auto; }
  .user-item {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 14px; cursor: pointer; transition: background 0.12s;
    font-size: 13px; font-weight: 500; color: var(--text);
  }
  .user-item:hover { background: var(--surface2); }
  .user-item.selected { color: var(--accent); }
  .user-item-avatar {
    width: 26px; height: 26px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 11px; font-weight: 700; flex-shrink: 0;
  }
  .user-item-name { flex: 1; }
  .user-item-check { opacity: 0; color: var(--accent); font-size: 13px; }
  .user-item.selected .user-item-check { opacity: 1; }
  .user-item-del {
    background: none; border: none; color: var(--text3);
    cursor: pointer; font-size: 13px; padding: 2px 5px;
    border-radius: 4px; opacity: 0; line-height: 1;
  }
  .user-item:hover .user-item-del { opacity: 1; }
  .user-item:hover .user-item-check { opacity: 0; }
  .user-item.selected:hover .user-item-check { opacity: 1; }
  .user-drop-divider { border: none; border-top: 1px solid var(--border); margin: 4px 0; }
  .user-add-row {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 14px 12px;
  }
  .user-add-input {
    flex: 1; background: var(--surface2); border: 1px solid var(--border2);
    border-radius: 7px; padding: 7px 10px;
    font-family: inherit; font-size: 13px; color: var(--text); outline: none;
  }
  .user-add-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0,113,227,0.15); }
  .user-add-btn {
    background: var(--accent); color: #fff; border: none;
    border-radius: 7px; padding: 7px 13px;
    font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit;
  }
  .user-add-btn:hover { background: var(--accent-hover); }
  .av-0 { background: linear-gradient(135deg,#0071e3,#34aadc); }
  .av-1 { background: linear-gradient(135deg,#30d158,#00b341); }
  .av-2 { background: linear-gradient(135deg,#ff9f0a,#e06800); }
  .av-3 { background: linear-gradient(135deg,#ff375f,#d4003e); }
  .av-4 { background: linear-gradient(135deg,#bf5af2,#8e40c0); }
  .av-5 { background: linear-gradient(135deg,#5ac8fa,#007aff); }
</style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="sidebar-header">
    <div class="logo" onclick="logoutToLockScreen()" style="cursor:pointer;" title="ËøîÂõûÁôªÂÖ•Áï´Èù¢">
      <div class="logo-icon">
        <svg viewBox="0 0 20 20" fill="none">
          <path d="M10 2.5C10 2.5 6 5 6 9.5C6 11.5 7.5 13 10 13C12.5 13 14 11.5 14 9.5C14 5 10 2.5 10 2.5Z" fill="white" opacity="0.9"/>
          <path d="M7 13.5C7 13.5 7 16 10 17C13 16 13 13.5 13 13.5" stroke="white" stroke-width="1.2" stroke-linecap="round" opacity="0.6"/>
          <line x1="10" y1="13" x2="10" y2="17" stroke="white" stroke-width="1.3" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="logo-text">
        <span class="logo-name">Training Log</span>
        <span class="logo-sub">ÂÅ•Ë∫´ËøΩËπ§</span>
      </div>
    </div>
  </div>

  <!-- USER SWITCHER -->
  <div class="user-switcher" id="userSwitcher">
    <div class="user-current" onclick="toggleUserDropdown()">
      <div class="user-avatar av-0" id="currentAvatar">?</div>
      <div class="user-info">
        <div class="user-name" id="currentUserName">Êú™ÈÅ∏ÊìáÁî®Êà∂</div>
        <div class="user-hint">ÈªûÊìäÂàáÊèõÁî®Êà∂</div>
      </div>
      <div class="user-chevron">‚ñº</div>
    </div>
    <div class="user-dropdown" id="userDropdown">
      <div class="user-dropdown-header">ÂàáÊèõÂ∏≥ËôüÔºàÈúÄÈ©óË≠âÂØÜÁ¢ºÔºâ</div>
      <div class="user-list" id="userList"></div>
      <hr class="user-drop-divider">
      <div class="user-add-row">
        <input class="user-add-input" id="newUserInput" placeholder="Ëº∏ÂÖ•Êñ∞Áî®Êà∂ÂêçÁ®±" maxlength="20"
          onkeydown="if(event.key==='Enter') addUser()">
        <button class="user-add-btn" onclick="addUser()">Êñ∞Â¢û</button>
      </div>
    </div>
  </div>

  <nav>
    <div class="nav-section-label">‰∏ªË¶Å</div>
    <a class="active" onclick="navigate('dashboard', this)">
      <span class="nav-icon"><span>üìä</span></span>
      <span>Á∏ΩË¶Ω</span>
    </a>
    <a onclick="navigate('log', this)">
      <span class="nav-icon"><span>‚úèÔ∏è</span></span>
      <span>‰ªäÊó•Ë®òÈåÑ</span>
    </a>
    <a onclick="navigate('workout', this)">
      <span class="nav-icon"><span>‚è±Ô∏è</span></span>
      <span>ÂØ¶ÊôÇË®ìÁ∑¥</span>
    </a>
    <a onclick="navigate('library', this)">
      <span class="nav-icon"><span>üìö</span></span>
      <span>Âãï‰ΩúÂ∫´</span>
    </a>
    <div class="nav-section-label">Ë®òÈåÑ</div>
    <a onclick="navigate('history', this)">
      <span class="nav-icon"><span>üìã</span></span>
      <span>Ë®ìÁ∑¥Ê≠∑Âè≤</span>
    </a>
    <a onclick="navigate('weight', this)">
      <span class="nav-icon"><span>‚öñÔ∏è</span></span>
      <span>È´îÈáçËøΩËπ§</span>
    </a>
    <a onclick="navigate('photos', this)">
      <span class="nav-icon"><span>üì∑</span></span>
      <span>Ë∫´ÊùêÁÖßÁâá</span>
    </a>
    <div class="nav-section-label">Ë¶èÂäÉ</div>
    <a onclick="navigate('plan', this)">
      <span class="nav-icon"><span>üóì</span></span>
      <span>Ë®ìÁ∑¥Ë®àÂäÉ</span>
    </a>
    <a onclick="navigate('goals', this)">
      <span class="nav-icon"><span>üéØ</span></span>
      <span>ÁõÆÊ®ôËøΩËπ§</span>
    </a>
    <div class="nav-section-label">Â∏≥Ëôü</div>
    <a onclick="navigate('settings', this)">
      <span class="nav-icon"><span>‚öôÔ∏è</span></span>
      <span>Áî®Êà∂Ë®≠ÂÆö</span>
    </a>
  </nav>

  <div class="sidebar-footer">
    <span class="sidebar-footer-text" id="sidebarDate"></span>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="pageTitle">Á∏ΩË¶Ω</div>
    <div style="display:flex;align-items:center;gap:10px;">
      <span id="syncStatus" style="font-size:12px;font-weight:500;transition:color 0.3s;"></span>
      <div class="topbar-date" id="headerDate"></div>
      <div class="topbar-user" id="topbarUser" onclick="openMobileUserModal()" style="display:none;">
        <div class="topbar-user-avatar av-0" id="topbarAvatar">?</div>
        <span class="topbar-user-name" id="topbarUserName">Áî®Êà∂</span>
      </div>
    </div>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Áï∂ÂâçÈ´îÈáç</div>
          <div class="stat-value" id="dash-weight">‚Äî</div>
          <div class="stat-unit">ÂÖ¨Êñ§</div>
          <div class="stat-change neutral" id="dash-weight-change">Â∞öÁÑ°Êï∏Êìö</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Ë∑ùÈõ¢ÁõÆÊ®ô</div>
          <div class="stat-value" id="dash-remaining">‚Äî</div>
          <div class="stat-unit">ÂÖ¨Êñ§</div>
          <div class="stat-change neutral" id="dash-target-weight">Êú™Ë®≠ÂÆöÁõÆÊ®ô</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Êú¨ÊúàË®ìÁ∑¥</div>
          <div class="stat-value" id="dash-sessions">0</div>
          <div class="stat-unit">Ê¨°</div>
          <div class="stat-change neutral">Êú¨ÊúàÁ¥ØË®à</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ÈÄ£Á∫åË®ìÁ∑¥</div>
          <div class="stat-value" id="dash-streak">0</div>
          <div class="stat-unit">Â§©</div>
          <div class="stat-change neutral">‰øùÊåÅÁØÄÂ•è üí™</div>
        </div>
      </div>


      <!-- BMI + Calorie Summary row -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:24px;" id="bmi-calorie-row">
        <div class="bmi-card" style="grid-column:1;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:2px;">
            <div class="stat-label">BMI Ë∫´È´îË≥™ÈáèÊåáÊï∏</div>
            <div id="bmi-category-badge" class="bmi-category" style="background:#e5e5ea;color:var(--text3);">‚Äî</div>
          </div>
          <div class="bmi-value-row">
            <div class="bmi-value" id="bmi-value">‚Äî</div>
            <div id="bmi-sub" style="font-size:13px;color:var(--text3);">Ë´ãÂú®Ë®≠ÂÆö‰∏≠Â°´ÂØ´Ë∫´È´ò</div>
          </div>
          <div class="bmi-bar-wrap" id="bmi-bar-wrap" style="opacity:0.3;">
            <div class="bmi-marker" id="bmi-marker" style="left:50%"></div>
          </div>
          <div class="bmi-labels"><span>ÂÅèÁò¶ &lt;18.5</span><span>Ê≠£Â∏∏ 18.5‚Äì24</span><span>ÈÅéÈáç 24‚Äì27</span><span>ËÇ•ËÉñ &gt;27</span></div></div>
        <div class="stat-card" style="grid-column:2;">
          <div class="stat-label">Êú¨ÊúàÊ∂àËÄóÁÜ±Èáè</div>
          <div class="stat-value" id="dash-calories">0</div>
          <div class="stat-unit">Â§ßÂç° kcal</div>
          <div class="stat-change neutral" id="dash-calories-sub">Êú¨ÊúàÁ¥ØË®à‰º∞ÁÆó</div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="card">
          <div class="card-title">È´îÈáçË∂®Âã¢ÔºàËøë 30 Â§©Ôºâ</div>
          <div class="weight-chart chart-wrap">
            <svg class="chart-svg" id="weightChart" viewBox="0 0 560 160" preserveAspectRatio="none"></svg>
            <div class="chart-tooltip" id="chartTooltip"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">ÊúÄËøëË®òÈåÑ</div>
          <div class="workout-list" id="recent-logs" style="max-height:200px;overflow-y:auto;">
            <div class="empty-state" style="padding:20px 0;">
              <div class="empty-icon">üìã</div>Â∞öÁÑ°Ë®òÈåÑ
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- LOG TODAY -->
    <div class="page" id="page-log">
      <div class="log-grid">
        <div>
          <div class="card" style="margin-bottom:16px;">
            <div class="card-title">Âü∫Êú¨Ë≥áË®ä</div>
            <div class="form-group">
              <label class="form-label">Êó•Êúü</label>
              <input type="date" class="form-input" id="log-date">
              <input type="hidden" id="log-height">
            </div>
            <div class="form-group">
              <div style="display:flex;align-items:center;gap:0;">
                <label class="form-label">‰ªäÊó•È´îÈáçÔºàkgÔºâ</label>
                <span id="weightDiffBadge" style="display:none;" class="weight-diff-badge"></span>
              </div>
              <input type="number" step="0.1" class="form-input" id="log-weight" placeholder="‰æãÔºö75.5" oninput="updateWeightDiff()">
            </div>
<div class="form-group">
              <label class="form-label">Ë®ìÁ∑¥È°ûÂûã</label>
              <select class="form-input" id="log-type">
                <option value="">‚Äî ÈÅ∏ÊìáÈ°ûÂûã ‚Äî</option>
                <option value="chest">ËÉ∏ÈÉ®Ë®ìÁ∑¥</option>
                <option value="back">ËÉåÈÉ®Ë®ìÁ∑¥</option>
                <option value="legs">ËÖøÈÉ®Ë®ìÁ∑¥</option>
                <option value="shoulders">ËÇ©ÈÉ®Ë®ìÁ∑¥</option>
                <option value="arms">ÊâãËáÇË®ìÁ∑¥</option>
                <option value="core">Ê†∏ÂøÉË®ìÁ∑¥</option>
                <option value="cardio">ÊúâÊ∞ßË®ìÁ∑¥</option>
                <option value="fullbody">ÂÖ®Ë∫´Ë®ìÁ∑¥</option>
                <option value="rest">‰ºëÊÅØÊó•</option>
              </select>
            </div>
          </div>
          <div class="card">
            <div class="card-title">Ë®ìÁ∑¥ÊôÇÈñì</div>
            <div class="form-group">
              <label class="form-label">ÈñãÂßã</label>
              <input type="time" class="form-input" id="log-start">
            </div>
            <div class="form-group">
              <label class="form-label">ÁµêÊùü</label>
              <input type="time" class="form-input" id="log-end">
            </div>
          </div>
        </div>
        <div>
          <div class="card" style="margin-bottom:16px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
              <div class="card-title" style="margin:0;">Ë®ìÁ∑¥Âãï‰Ωú</div>
              <button class="btn" style="padding:7px 12px;font-size:12px;background:var(--surface2);border-radius:8px;gap:5px;" onclick="copyYesterdayExercises()">üìã Ë§áË£ΩÊò®Êó•Ë®ìÁ∑¥</button>
            </div>
            <div class="ex-list-col-label">
              <span>Âãï‰ΩúÂêçÁ®±</span><span style="text-align:center;">ÁµÑÊï∏</span><span style="text-align:center;">ÈáçÈáè(kg)</span><span></span>
            </div>
            <div id="logExerciseList"></div>
            <div class="ex-list-add-row">
              <button class="add-set-btn" onclick="addLogExerciseRow()" style="flex:1;">Ôºã Êñ∞Â¢ûÂãï‰Ωú</button>
              <button class="add-set-btn" onclick="openLogExPicker()" style="flex:1;border-style:solid;background:var(--accent-light);color:var(--accent);border-color:transparent;">üìö ÂæûÂãï‰ΩúÂ∫´ÈÅ∏Âèñ</button>
            </div>
            <textarea id="log-exercises" style="display:none;"></textarea>
            <div id="logExPickerWrap" style="display:none;margin-top:10px;">
              <input type="text" class="form-input" id="logExPickerInput" placeholder="ÊêúÂ∞ãÂãï‰Ωú..." oninput="renderLogExPicker()" style="margin-bottom:8px;">
              <div id="logExPickerList" style="max-height:180px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;"></div>
            </div>
            <div class="form-group">
              <label class="form-label">ÈÅãÂãïÊôÇÈï∑ÔºàÂàÜÈêòÔºâ<span style="color:var(--text3);font-weight:400;font-size:11px;"> Áî®ÊñºË®àÁÆóÊ∂àËÄóÁÜ±Èáè</span></label>
              <input type="number" class="form-input" id="log-duration" placeholder="‰æãÔºö60" min="1" max="600">
            </div>
            <div class="form-group" id="calorie-preview-group" style="display:none;">
              <div style="background:rgba(255,159,10,0.08);border-radius:10px;padding:12px 14px;">
                <div style="font-size:12px;color:var(--text3);margin-bottom:4px;">È†ê‰º∞Ê∂àËÄóÁÜ±Èáè</div>
                <div style="font-size:22px;font-weight:700;color:var(--orange);" id="calorie-preview">‚Äî <span style="font-size:13px;font-weight:400;">kcal</span></div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">ÂÇôÊ≥® / ‰ªäÊó•ÊÑüÂèó</label>
              <textarea class="form-input" id="log-notes" placeholder="‰ªäÂ§©ÁãÄÊÖãÂ¶Ç‰ΩïÔºüÊúâ‰ªÄÈ∫ºÁ™ÅÁ†¥Ôºü" style="min-height:72px;"></textarea>
            </div>
          </div>
          <div class="card">
            <div class="card-title">‰ªäÊó•ÁÖßÁâáÔºàÈÅ∏Â°´Ôºâ</div>
            <div class="photo-upload-area" id="logPhotoArea">
              <input type="file" accept="image/*" id="log-photo" multiple onchange="handleLogPhoto(event)">
              <div style="font-size:28px;margin-bottom:6px;">üì∑</div>
              <div style="font-size:13px;color:var(--text3);">ÈªûÊìä‰∏äÂÇ≥‰ªäÊó•Ë∫´ÊùêÁÖßÁâá</div>
            </div>
            <div id="log-photo-previews" class="photo-grid"></div>
          </div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="saveLog()">ÂÑ≤Â≠ò‰ªäÊó•Ë®òÈåÑ</button>
    </div>

    <!-- HISTORY -->
    <div class="page" id="page-history">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
        <div class="section-title" style="margin:0;">Ë®ìÁ∑¥Ê≠∑Âè≤</div>
        <div class="segment-control">
          <select onchange="renderHistory(this.value)" id="history-filter">
            <option value="all">ÂÖ®ÈÉ®È°ûÂûã</option>
            <option value="chest">ËÉ∏ÈÉ®</option>
            <option value="back">ËÉåÈÉ®</option>
            <option value="legs">ËÖøÈÉ®</option>
            <option value="shoulders">ËÇ©ÈÉ®</option>
            <option value="arms">ÊâãËáÇ</option>
            <option value="core">Ê†∏ÂøÉ</option>
            <option value="cardio">ÊúâÊ∞ß</option>
            <option value="fullbody">ÂÖ®Ë∫´</option>
            <option value="rest">‰ºëÊÅØÊó•</option>
          </select>
        </div>
      </div>
      <div class="workout-list" id="history-list">
        <div class="empty-state"><div class="empty-icon">üìã</div>Â∞öÁÑ°Ë®ìÁ∑¥Ë®òÈåÑ</div>
      </div>
    </div>

    <!-- WEIGHT -->
    <div class="page" id="page-weight">
      <div class="log-grid" style="margin-bottom:18px;">
        <div class="card">
          <div class="card-title">Ë®≠ÂÆöÁõÆÊ®ôÈ´îÈáç</div>
          <div class="form-group">
            <label class="form-label">ÁõÆÊ®ôÈ´îÈáçÔºàkgÔºâ</label>
            <input type="number" step="0.1" class="form-input" id="target-weight-input" placeholder="‰æãÔºö70.0">
          </div>
          <button class="btn btn-primary" onclick="setTargetWeight()">Ë®≠ÂÆöÁõÆÊ®ô</button>
        </div>
        <div class="card">
          <div class="card-title">Êñ∞Â¢ûÈ´îÈáçË®òÈåÑ</div>
          <div class="form-group">
            <label class="form-label">Êó•Êúü</label>
            <input type="date" class="form-input" id="weight-date-input">
          </div>
          <div class="form-group">
            <label class="form-label">È´îÈáçÔºàkgÔºâ</label>
            <input type="number" step="0.1" class="form-input" id="weight-value-input" placeholder="‰æãÔºö75.5">
          </div>
          <button class="btn btn-primary" onclick="addWeightRecord()">Êñ∞Â¢û</button>
        </div>
      </div>
      <div class="card" style="margin-bottom:18px;">
        <div class="card-title">È´îÈáçË∂®Âã¢</div>
        <div class="weight-chart chart-wrap" style="height:200px;">
          <svg class="chart-svg" id="weightChartFull" viewBox="0 0 760 200" preserveAspectRatio="none"></svg>
        </div>
      </div>
      <div class="card">
        <div class="card-title">È´îÈáçË®òÈåÑ</div>
        <div class="weight-table-wrap">
        <table class="weight-table">
          <thead>
            <tr>
              <th>Êó•Êúü</th><th>È´îÈáç</th><th>ËÆäÂåñ</th><th>ÁãÄÊÖã</th><th></th>
            </tr>
          </thead>
          <tbody id="weight-tbody"></tbody>
        </table>
        </div>
      </div>
    </div>

    <!-- PHOTOS -->
    <div class="page" id="page-photos">
      <div class="card" style="margin-bottom:20px;">
        <div class="card-title">‰∏äÂÇ≥ÁÖßÁâá</div>
        <div class="photo-upload-area">
          <input type="file" accept="image/*" id="photo-upload" multiple onchange="handlePhotoUpload(event)">
          <div style="font-size:34px;margin-bottom:8px;">üì∏</div>
          <div style="font-size:14px;font-weight:500;color:var(--text2);">ÈªûÊìäÊàñÊãñÊõ≥‰∏äÂÇ≥</div>
          <div style="font-size:12px;color:var(--text3);margin-top:4px;">ÊîØÊè¥ JPG„ÄÅPNGÔºåÂèØ‰∏ÄÊ¨°Â§öÈÅ∏</div>
        </div>
      </div>
      <div class="section-title">ÊâÄÊúâÁÖßÁâá</div>
      <div class="photo-grid" id="all-photos">
        <div class="empty-state" style="grid-column:1/-1;">
          <div class="empty-icon">üì∑</div>Â∞öÁÑ°ÁÖßÁâá
        </div>
      </div>
    </div>

    <!-- PLAN -->
    <div class="page" id="page-plan">
      <div class="card" style="margin-bottom:24px;">
        <div class="card-title">Êñ∞Â¢ûË®ìÁ∑¥Ë®àÂäÉ</div>
        <div class="log-grid">
          <div>
            <div class="form-group">
              <label class="form-label">Ë®àÂäÉÂêçÁ®±</label>
              <input type="text" class="form-input" id="plan-name" placeholder="‰æãÔºöÂ¢ûËÇåÊúüÁ¨¨‰∏ÄÈöéÊÆµ">
            </div>
            <div class="form-group">
              <label class="form-label">ÈñãÂßãÊó•Êúü</label>
              <input type="date" class="form-input" id="plan-start">
            </div>
            <div class="form-group">
              <label class="form-label">ÁµêÊùüÊó•Êúü</label>
              <input type="date" class="form-input" id="plan-end">
            </div>
          </div>
          <div>
            <div class="form-group">
              <label class="form-label">Ë®àÂäÉË™™Êòé / Ë®ìÁ∑¥ÈáçÈªû</label>
              <textarea class="form-input" id="plan-desc" placeholder="ÊèèËø∞ÈÄôÂÄãÈöéÊÆµÁöÑÁõÆÊ®ôÂíåË®ìÁ∑¥ÂÖßÂÆπ..." style="min-height:140px;"></textarea>
            </div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="addPlan()">Êñ∞Â¢ûË®àÂäÉ</button>
      </div>
      <div class="section-title">ÊâÄÊúâË®àÂäÉ</div>
      <div class="plan-phases" id="plan-list">
        <div class="empty-state" style="grid-column:1/-1;">
          <div class="empty-icon">üóì</div>Â∞öÁÑ°Ë®ìÁ∑¥Ë®àÂäÉ
        </div>
      </div>
    </div>

    <!-- GOALS -->
    <div class="page" id="page-goals">
      <div class="card" style="margin-bottom:20px;">
        <div class="card-title">Ë®≠ÂÆöÁõÆÊ®ô</div>
        <div class="log-grid">
          <div>
            <div class="form-group">
              <label class="form-label">ÁõÆÊ®ôÈ´îÈáçÔºàkgÔºâ</label>
              <input type="number" step="0.1" class="form-input" id="goal-weight" placeholder="‰æãÔºö70.0">
            </div>
            <div class="form-group">
              <label class="form-label">ÁõÆÊ®ôÈÅîÊàêÊó•Êúü</label>
              <input type="date" class="form-input" id="goal-date">
            </div>
          </div>
          <div>
            <div class="form-group">
              <label class="form-label">ÊØèÈÄ±ÁõÆÊ®ôË®ìÁ∑¥Ê¨°Êï∏</label>
              <input type="number" class="form-input" id="goal-sessions" placeholder="‰æãÔºö4" min="1" max="7">
            </div>
            <div class="form-group">
              <label class="form-label">ÂÖ∂‰ªñÁõÆÊ®ôÊèèËø∞</label>
              <input type="text" class="form-input" id="goal-desc" placeholder="‰æãÔºöÊ∑±Ëπ≤ 100kg„ÄÅÈ´îËÑÇ 15%">
            </div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="saveGoals()">ÂÑ≤Â≠òÁõÆÊ®ô</button>
      </div>
      <div id="goals-display"></div>

    </div>


    <!-- SETTINGS -->
    <div class="page" id="page-settings">

      <!-- Profile -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-title">ÂÄã‰∫∫Ë≥áÊñô</div>
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
          <div class="user-avatar av-0" id="settings-avatar" style="width:52px;height:52px;font-size:20px;">?</div>
          <div>
            <div style="font-size:17px;font-weight:700;" id="settings-username">‚Äî</div>
            <div style="font-size:12px;color:var(--text3);">ÁõÆÂâçÁôªÂÖ•Â∏≥Ëôü</div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Ë∫´È´òÔºàcmÔºâ<span style="font-weight:400;color:var(--text3);font-size:11px;"> Áî®ÊñºË®àÁÆó BMI</span></label>
          <div style="display:flex;gap:8px;">
            <input type="number" class="form-input" id="settings-height" placeholder="‰æãÔºö175" min="100" max="250">
            <button class="btn btn-primary" onclick="saveSettingsHeight()" style="padding:10px 18px;white-space:nowrap;">ÂÑ≤Â≠ò</button>
          </div>
        </div>
      </div>

      <!-- Password -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-title">ÂØÜÁ¢ºÂÆâÂÖ®</div>
        <div style="font-size:13px;color:var(--text2);margin-bottom:16px;">Ë®≠ÂÆöÂØÜÁ¢ºÂæåÔºåÊØèÊ¨°ÁôªÂÖ•ÈúÄË¶ÅËº∏ÂÖ•ÂØÜÁ¢ºÊâçËÉΩÈÄ≤ÂÖ•‰Ω†ÁöÑÂ∏≥Ëôü„ÄÇ</div>
        <div class="form-group">
          <label class="form-label">ÁõÆÂâçÂØÜÁ¢º</label>
          <input type="password" class="form-input" id="settings-pwd-current" placeholder="ÁÑ°ÂØÜÁ¢ºË´ãÁïôÁ©∫" maxlength="20">
        </div>
        <div class="form-group">
          <label class="form-label">Êñ∞ÂØÜÁ¢º</label>
          <input type="password" class="form-input" id="settings-pwd-new" placeholder="Êñ∞ÂØÜÁ¢ºÔºàÁïôÁ©∫Ë°®Á§∫ÁßªÈô§ÂØÜÁ¢ºÔºâ" maxlength="20">
        </div>
        <div class="form-group">
          <label class="form-label">Á¢∫Ë™çÊñ∞ÂØÜÁ¢º</label>
          <input type="password" class="form-input" id="settings-pwd-confirm" placeholder="ÂÜçÊ¨°Ëº∏ÂÖ•Êñ∞ÂØÜÁ¢º" maxlength="20">
        </div>
        <button class="btn btn-primary" onclick="changePasswordFromSettings()">Êõ¥Êñ∞ÂØÜÁ¢º</button>
      </div>

      <!-- Danger zone -->
      <div class="card">
        <div class="card-title" style="color:var(--red);">Âç±Èö™ÂçÄÂüü</div>

        <!-- Logout -->
        <div style="padding:14px 0;border-bottom:1px solid var(--border);">
          <div style="font-size:14px;font-weight:600;margin-bottom:4px;">ÁôªÂá∫Â∏≥Ëôü</div>
          <div style="font-size:13px;color:var(--text2);margin-bottom:12px;">ËøîÂõûÁôªÂÖ•Áï´Èù¢ÔºåË≥áÊñô‰∏çÊúÉÈÅ∫Â§±„ÄÇ</div>
          <button class="btn" style="background:var(--surface2);color:var(--text);border:1px solid var(--border2);border-radius:10px;" onclick="logoutToLockScreen()">ÁôªÂá∫Ê≠§Â∏≥Ëôü</button>
        </div>

        <!-- Delete account -->
        <div style="padding-top:14px;">
          <div style="font-size:14px;font-weight:600;margin-bottom:4px;color:var(--red);">Âà™Èô§Â∏≥Ëôü</div>
          <div style="font-size:13px;color:var(--text2);margin-bottom:12px;">Ê∞∏‰πÖÂà™Èô§Ê≠§Â∏≥ËôüÂèäÊâÄÊúâË≥áÊñôÔºåÊ≠§Êìç‰Ωú‰∏çÂèØÂæ©Âéü„ÄÇ</div>
          <div id="delete-self-section">
            <button class="btn" style="background:var(--red-light);color:var(--red);border-radius:10px;" onclick="showDeleteSelfConfirm()">Âà™Èô§Ê≠§Â∏≥Ëôü</button>
          </div>
          <div id="delete-self-confirm" style="display:none;">
            <input type="password" class="form-input" id="delete-self-pwd" placeholder="Ëº∏ÂÖ•ÂØÜÁ¢ºÁ¢∫Ë™çÔºàÁÑ°ÂØÜÁ¢ºÁïôÁ©∫Ôºâ" maxlength="20" style="margin-bottom:8px;">
            <div id="delete-self-error" style="font-size:12px;color:var(--red);min-height:16px;margin-bottom:8px;"></div>
            <div style="display:flex;gap:8px;">
              <button class="btn" style="flex:1;background:var(--surface2);color:var(--text);border:1px solid var(--border2);border-radius:10px;" onclick="cancelDeleteSelf()">ÂèñÊ∂à</button>
              <button class="btn" style="flex:1;background:var(--red);color:#fff;border-radius:10px;" onclick="confirmDeleteSelf()">Á¢∫Ë™çÂà™Èô§</button>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- WORKOUT TIMER PAGE -->
    <div class="page" id="page-workout">
      <!-- Timer card -->
      <div class="card" style="margin-bottom:16px;">
        <div class="timer-status-bar">
          <div class="status-dot" id="timerDot"></div>
          <span id="timerStatusLabel">Â∞öÊú™ÈñãÂßã</span>
        </div>
        <div class="timer-display">
          <div class="timer-clock" id="timerClock">00:00:00</div>
          <div class="timer-label" id="timerSubLabel">ÊåâÈñãÂßãË®àÊôÇ</div>
        </div>
        <div class="timer-controls" id="timerControls">
          <button class="timer-btn timer-btn-start" onclick="timerStart()">‚ñ∂ ÈñãÂßã</button>
        </div>
        <div style="display:flex;align-items:center;justify-content:center;gap:24px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
          <div style="text-align:center;">
            <div style="font-size:11px;color:var(--text3);margin-bottom:2px;">ÁµÑÊï∏</div>
            <div style="font-size:22px;font-weight:700;" id="timerSets">0</div>
          </div>
          <div style="width:1px;height:36px;background:var(--border);"></div>
          <div style="text-align:center;">
            <div style="font-size:11px;color:var(--text3);margin-bottom:2px;">Âãï‰ΩúÊï∏</div>
            <div style="font-size:22px;font-weight:700;" id="timerExCount">0</div>
          </div>
          <div style="width:1px;height:36px;background:var(--border);"></div>
          <div style="text-align:center;">
            <div style="font-size:11px;color:var(--text3);margin-bottom:2px;">È†ê‰º∞ÁÜ±Èáè</div>
            <div style="font-size:22px;font-weight:700;" id="timerCalories">0</div>
          </div>
        </div>
      </div>

      <!-- REST TIMER -->
      <div class="rest-timer-card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
          <div style="font-size:13px;font-weight:600;color:var(--text);">‚è± ÁµÑÈñì‰ºëÊÅØË®àÊôÇ</div>
          <span id="restStatusLabel" style="font-size:11px;color:var(--text3);">ÈÅ∏ÊìáÊôÇÈï∑ÈñãÂßã</span>
        </div>
        <div class="rest-progress"><div class="rest-progress-bar" id="restProgressBar" style="width:100%"></div></div>
        <div class="rest-timer-display">
          <div class="rest-clock" id="restClock">01:00</div>
        </div>
        <div class="rest-presets">
          <button class="rest-preset-btn active" onclick="setRestPreset(30,this)">30s</button>
          <button class="rest-preset-btn" onclick="setRestPreset(60,this)">60s</button>
          <button class="rest-preset-btn" onclick="setRestPreset(90,this)">90s</button>
          <button class="rest-preset-btn" onclick="setRestPreset(120,this)">2ÂàÜ</button>
          <button class="rest-preset-btn" onclick="setRestPreset(180,this)">3ÂàÜ</button>
        </div>
        <div class="rest-controls">
          <button class="rest-ctrl-btn rest-start-btn" id="restStartBtn" onclick="toggleRest()">‚ñ∂ ÈñãÂßã‰ºëÊÅØ</button>
          <button class="rest-ctrl-btn rest-reset-btn" onclick="resetRest()">‚Ü∫ ÈáçÁΩÆ</button>
        </div>
      </div>

      <!-- Exercise list -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <div class="section-title" style="margin:0;">Êú¨Ê¨°Ë®ìÁ∑¥Âãï‰Ωú</div>
        <div style="display:flex;gap:8px;">
          <select class="lib-filter-select" id="workout-type-select" style="font-size:13px;padding:7px 12px;">
            <option value="">‚Äî Ë®ìÁ∑¥È°ûÂûã ‚Äî</option>
            <option value="chest">ËÉ∏ÈÉ®</option>
            <option value="back">ËÉåÈÉ®</option>
            <option value="legs">ËÖøÈÉ®</option>
            <option value="shoulders">ËÇ©ÈÉ®</option>
            <option value="arms">ÊâãËáÇ</option>
            <option value="core">Ê†∏ÂøÉ</option>
            <option value="cardio">ÊúâÊ∞ß</option>
            <option value="fullbody">ÂÖ®Ë∫´</option>
          </select>
        </div>
      </div>

      <div id="workoutExerciseList"></div>

      <button class="add-ex-btn" onclick="addWorkoutExercise()">Ôºã Êñ∞Â¢ûÂãï‰Ωú</button>

      <!-- Add exercise modal (inline) -->
      <div id="addExModal" style="display:none;margin-top:12px;">
        <div class="card">
          <div class="card-title">ÈÅ∏ÊìáÊàñËº∏ÂÖ•Âãï‰Ωú</div>
          <input type="text" class="form-input" id="addExInput" placeholder="ÊêúÂ∞ãÂãï‰ΩúÂêçÁ®±..." oninput="filterAddExList()" style="margin-bottom:10px;">
          <div id="addExSuggestions" style="max-height:200px;overflow-y:auto;"></div>
          <div style="display:flex;gap:8px;margin-top:10px;">
            <button class="btn btn-primary" onclick="confirmAddExercise()">Êñ∞Â¢û</button>
            <button class="btn" style="background:var(--surface2);" onclick="document.getElementById('addExModal').style.display='none'">ÂèñÊ∂à</button>
          </div>
        </div>
      </div>
    </div>

    <!-- EXERCISE LIBRARY PAGE -->
    <div class="page" id="page-library">
      <div class="lib-search">
        <input type="text" class="lib-search-input" id="libSearchInput" placeholder="üîç ÊêúÂ∞ãÂãï‰ΩúÂêçÁ®±..." oninput="renderLibrary()">
        <select class="lib-filter-select" id="libMuscleFilter" onchange="renderLibrary()">
          <option value="">ÂÖ®ÈÉ®ÈÉ®‰Ωç</option>
          <option value="ËÉ∏ÈÉ®">ËÉ∏ÈÉ®</option>
          <option value="ËÉåÈÉ®">ËÉåÈÉ®</option>
          <option value="ËÖøÈÉ®">ËÖøÈÉ®</option>
          <option value="ËÇ©ÈÉ®">ËÇ©ÈÉ®</option>
          <option value="ÊâãËáÇ">ÊâãËáÇ</option>
          <option value="Ê†∏ÂøÉ">Ê†∏ÂøÉ</option>
          <option value="ÊúâÊ∞ß">ÊúâÊ∞ß</option>
        </select>
        <select class="lib-filter-select" id="libTypeFilter" onchange="renderLibrary()">
          <option value="">ÂÖ®ÈÉ®Âô®Êùê</option>
          <option value="ÊßìÈà¥">ÊßìÈà¥</option>
          <option value="ÂïûÈà¥">ÂïûÈà¥</option>
          <option value="Ê©üÂô®">Ê©üÂô®</option>
          <option value="ÂæíÊâã">ÂæíÊâã</option>
          <option value="Áπ©Á¥¢">Áπ©Á¥¢</option>
        </select>
      </div>
      <div id="libList"></div>
    </div>

    <!-- EXERCISE DETAIL MODAL -->
    <div class="ex-detail-modal" id="exDetailModal">
      <div class="modal-backdrop" onclick="closeExDetail()"></div>
      <div class="ex-detail-sheet" id="exDetailSheet">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <div style="flex:1;">
            <div style="font-size:20px;font-weight:700;margin-bottom:4px;" id="exDetailName"></div>
            <div id="exDetailMuscles" style="display:flex;flex-wrap:wrap;"></div>
          </div>
          <button onclick="closeExDetail()" style="background:var(--surface2);border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;line-height:1;color:var(--text2);">√ó</button>
        </div>
        <div id="exDetailContent"></div>
        <button class="btn btn-primary" style="width:100%;margin-top:20px;" onclick="addToWorkoutFromLibrary()">Ôºã Âä†ÂÖ•Êú¨Ê¨°Ë®ìÁ∑¥</button>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<div class="toast" id="toast"></div>

<!-- BOTTOM NAV (mobile) -->
<nav class="bottom-nav" id="bottomNav">
  <div class="bottom-nav-item active" onclick="mobileNavigate('dashboard',this)" data-page="dashboard">
    <span class="bottom-nav-icon">üìä</span>
    <span class="bottom-nav-label">Á∏ΩË¶Ω</span>
  </div>
  <div class="bottom-nav-item" onclick="mobileNavigate('log',this)" data-page="log">
    <span class="bottom-nav-icon">‚úèÔ∏è</span>
    <span class="bottom-nav-label">Ë®òÈåÑ</span>
  </div>
  <div class="bottom-nav-item" onclick="mobileNavigate('workout',this)" data-page="workout">
    <span class="bottom-nav-icon">‚è±Ô∏è</span>
    <span class="bottom-nav-label">Ë®ìÁ∑¥</span>
  </div>
  <div class="bottom-nav-item" onclick="mobileNavigate('weight',this)" data-page="weight">
    <span class="bottom-nav-icon">‚öñÔ∏è</span>
    <span class="bottom-nav-label">È´îÈáç</span>
  </div>
  <div class="bottom-nav-item" onclick="mobileNavigate('photos',this)" data-page="photos">
    <span class="bottom-nav-icon">üì∑</span>
    <span class="bottom-nav-label">ÁÖßÁâá</span>
  </div>
  <div class="bottom-nav-item" onclick="mobileNavigate('goals',this)" data-page="goals">
    <span class="bottom-nav-icon">üéØ</span>
    <span class="bottom-nav-label">ÁõÆÊ®ô</span>
  </div>
  <div class="bottom-nav-item" onclick="mobileNavigate('settings',this)" data-page="settings">
    <span class="bottom-nav-icon">‚öôÔ∏è</span>
    <span class="bottom-nav-label">Ë®≠ÂÆö</span>
  </div>
</nav>

<!-- MOBILE USER MODAL -->
<div class="mobile-user-modal" id="mobileUserModal">
  <div class="modal-backdrop" onclick="closeMobileUserModal()"></div>
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">ÂàáÊèõÁî®Êà∂</div>
    <div id="mobileUserList"></div>
    <div class="modal-add-row">
      <input class="modal-add-input" id="mobileNewUserInput" placeholder="Êñ∞Áî®Êà∂ÂêçÁ®±" maxlength="20"
        onkeydown="if(event.key==='Enter') addUserMobile()">
      <button class="modal-add-btn" onclick="addUserMobile()">Êñ∞Â¢û</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDepVwacpLIrszDsOEkDx83ak0xgH8_TpI",
  authDomain: "training-log-40f70.firebaseapp.com",
  projectId: "training-log-40f70",
  storageBucket: "training-log-40f70.firebasestorage.app",
  messagingSenderId: "672010716354",
  appId: "1:672010716354:web:c371ced95080267121a75b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// expose to global scope for the main script
window._db = db;
window._firestoreReady = true;
window._fsDoc = doc;
window._fsGetDoc = getDoc;
window._fsSetDoc = setDoc;
window._fsOnSnapshot = onSnapshot;
window._fsCollection = collection;
window._fsGetDocs = getDocs;
window._fsDeleteDoc = deleteDoc;
window.dispatchEvent(new Event('firestore-ready'));
</script>

<script>
// ‚îÄ‚îÄ MULTI-USER ‚îÄ‚îÄ
const USERS_KEY = 'tl_users';
const CUR_KEY   = 'tl_current_user';

function getUsers() {
  return JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
}

function saveUsers(users) {
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
  // sync to Firestore
  if (window._firestoreReady) {
    window._fsSetDoc(window._fsDoc(window._db, 'app', 'users'), { list: users })
      .catch(e => console.warn('Firestore saveUsers:', e));
  }
}

function getCurrentUserId() {
  return localStorage.getItem(CUR_KEY) || null;
}

function setCurrentUserId(id) {
  localStorage.setItem(CUR_KEY, id);
}

function userDataKey(uid) { return 'tl_data_' + uid; }

function loadUserData(uid) {
  return JSON.parse(localStorage.getItem(userDataKey(uid)) || 'null') || {
    logs: [], weights: [], photos: [], plans: [], goals: {}
  };
}

function saveUserData(uid, d) {
  localStorage.setItem(userDataKey(uid), JSON.stringify(d));
  // sync to Firestore (split photos out to avoid 1MB limit ‚Äî store refs only)
  if (window._firestoreReady) {
    const toStore = {
      logs: d.logs || [],
      weights: d.weights || [],
      plans: d.plans || [],
      goals: d.goals || {},
      // photos stored separately
    };
    window._fsSetDoc(window._fsDoc(window._db, 'users', uid), toStore)
      .catch(e => console.warn('Firestore saveUserData:', e));
    // save photos separately (may be large)
    const photos = (d.photos || []).map(p => ({ src: p.src, date: p.date, name: p.name || '' }));
    window._fsSetDoc(window._fsDoc(window._db, 'photos', uid), { list: photos })
      .catch(e => console.warn('Firestore savePhotos:', e));
  }
}

async function loadUserDataFromFirestore(uid) {
  if (!window._firestoreReady) return null;
  try {
    const [snap, photoSnap] = await Promise.all([
      window._fsGetDoc(window._fsDoc(window._db, 'users', uid)),
      window._fsGetDoc(window._fsDoc(window._db, 'photos', uid))
    ]);
    if (!snap.exists()) return null;
    const d = snap.data();
    if (photoSnap.exists()) d.photos = photoSnap.data().list || [];
    else d.photos = [];
    return d;
  } catch(e) {
    console.warn('Firestore load error:', e);
    return null;
  }
}

async function loadUsersFromFirestore() {
  if (!window._firestoreReady) return null;
  try {
    const snap = await window._fsGetDoc(window._fsDoc(window._db, 'app', 'users'));
    if (!snap.exists()) return null;
    return snap.data().list || [];
  } catch(e) {
    console.warn('Firestore loadUsers error:', e);
    return null;
  }
}

function avatarClass(idx) { return 'av-' + (idx % 6); }

function initials(name) {
  return name.trim().slice(0, 2).toUpperCase() || '?';
}

// ‚îÄ‚îÄ CURRENT USER STATE ‚îÄ‚îÄ
let currentUserId = null;
let data = { logs: [], weights: [], photos: [], plans: [], goals: {} };

function save() {
  if (currentUserId) saveUserData(currentUserId, data);
}

// sync indicator
function showSyncing() {
  const el = document.getElementById('syncStatus');
  if (el) { el.textContent = '‚òÅ ÂêåÊ≠•‰∏≠‚Ä¶'; el.style.color = 'var(--text3)'; }
}
function showSynced() {
  const el = document.getElementById('syncStatus');
  if (el) { el.textContent = '‚òÅ Â∑≤ÂêåÊ≠•'; el.style.color = 'var(--green)';
    setTimeout(() => { if(el) el.textContent = ''; }, 2000); }
}
function showSyncError() {
  const el = document.getElementById('syncStatus');
  if (el) { el.textContent = '‚ö† ÂêåÊ≠•Â§±Êïó'; el.style.color = 'var(--red)'; }
}

async function saveAndSync() {
  if (!currentUserId) return;
  saveUserData(currentUserId, data);
  if (!window._firestoreReady) return;
  showSyncing();
  try {
    const toStore = { logs: data.logs||[], weights: data.weights||[], plans: data.plans||[], goals: data.goals||{} };
    await window._fsSetDoc(window._fsDoc(window._db, 'users', currentUserId), toStore);
    const photos = (data.photos||[]).map(p=>({src:p.src,date:p.date,name:p.name||''}));
    await window._fsSetDoc(window._fsDoc(window._db, 'photos', currentUserId), {list:photos});
    showSynced();
  } catch(e) {
    console.warn('sync error', e);
    showSyncError();
  }
}

async function switchUser(uid) {
  currentUserId = uid;
  setCurrentUserId(uid);

  // Load from localStorage immediately (fast)
  data = loadUserData(uid);

  const users = getUsers();
  const user = users.find(u => u.id === uid);
  if (user) {
    const idx = users.indexOf(user);
    document.getElementById('currentUserName').textContent = user.name;
    document.getElementById('currentAvatar').textContent = initials(user.name);
    document.getElementById('currentAvatar').className = 'user-avatar ' + avatarClass(idx);
  }

  closeUserDropdown();
  renderUserList();
  renderDashboard();
  syncTopbarUser();
  showToast('Â∑≤ÂàáÊèõÂà∞ ' + (user ? user.name : ''));

  // Then fetch fresh data from Firestore
  if (window._firestoreReady) {
    showSyncing();
    const cloudData = await loadUserDataFromFirestore(uid);
    if (cloudData) {
      // merge: cloud wins for non-photo fields, merge photos by date
      data.logs = cloudData.logs || data.logs;
      data.weights = cloudData.weights || data.weights;
      data.plans = cloudData.plans || data.plans;
      data.goals = cloudData.goals || data.goals;
      data.photos = cloudData.photos || data.photos;
      saveUserData(uid, data); // update localStorage
      renderDashboard();
      showSynced();
    } else {
      showSynced();
    }
  }
}

function addUser() {
  const input = document.getElementById('newUserInput');
  const name = input.value.trim();
  if (!name) { input.focus(); return; }

  const users = getUsers();
  if (users.find(u => u.name === name)) {
    showToast('Ê≠§ÂêçÁ®±Â∑≤Â≠òÂú®'); return;
  }

  const uid = 'user_' + Date.now();
  users.push({ id: uid, name });
  saveUsers(users);
  input.value = '';
  renderUserList();
  switchUser(uid);
}

// requestDeleteUser ‚Äî shows password confirmation modal then deletes
function requestDeleteUser(uid) {
  const users = getUsers();
  if (users.length <= 1) { showToast('Ëá≥Â∞ë‰øùÁïô‰∏ÄÂÄãÁî®Êà∂'); return; }
  const user = users.find(u => u.id === uid);
  if (!user) return;
  // show delete confirm modal
  showDeleteConfirmModal(uid, user.name);
}

async function confirmDeleteUser(uid) {
  const pwd = document.getElementById('delete-pwd-input').value;
  const valid = await verifyPassword(uid, pwd);
  if (!valid) {
    const inp = document.getElementById('delete-pwd-input');
    inp.classList.add('error');
    document.getElementById('delete-pwd-error').textContent = 'ÂØÜÁ¢ºÈåØË™§';
    setTimeout(() => inp.classList.remove('error'), 500);
    inp.value = ''; inp.focus();
    return;
  }
  // delete
  let users = getUsers();
  users = users.filter(u => u.id !== uid);
  saveUsers(users);
  localStorage.removeItem(userDataKey(uid));
  localStorage.removeItem(pwdKey(uid));
  if (window._firestoreReady) {
    try {
      await window._fsDeleteDoc(window._fsDoc(window._db, 'users', uid));
      await window._fsDeleteDoc(window._fsDoc(window._db, 'photos', uid));
      await window._fsDeleteDoc(window._fsDoc(window._db, 'passwords', uid));
    } catch(e) { console.warn('delete from firestore:', e); }
  }
  closeDeleteConfirmModal();
  if (currentUserId === uid) {
    logoutToLockScreen();
  } else {
    renderUserList();
    renderMobileUserList();
  }
  showToast('Áî®Êà∂Â∑≤Âà™Èô§');
}

function deleteUser(uid) { requestDeleteUser(uid); }

function showDeleteConfirmModal(uid, name) {
  document.getElementById('delete-modal-name').textContent = name;
  document.getElementById('delete-uid-hidden').value = uid;
  document.getElementById('delete-pwd-input').value = '';
  document.getElementById('delete-pwd-error').textContent = '';
  document.getElementById('deleteConfirmModal').classList.add('open');
  document.body.style.overflow = 'hidden';
  setTimeout(() => document.getElementById('delete-pwd-input').focus(), 200);
}

function closeDeleteConfirmModal() {
  document.getElementById('deleteConfirmModal').classList.remove('open');
  document.body.style.overflow = '';
}

function renderUserList() {
  const users = getUsers();
  const el = document.getElementById('userList');

  if (users.length === 0) {
    el.innerHTML = '<div style="padding:10px 14px;font-size:13px;color:var(--text3);">Â∞öÁÑ°Áî®Êà∂ÔºåË´ãÊñ∞Â¢û</div>';
    return;
  }

  el.innerHTML = users.map((u, i) => `
    <div class="user-item ${u.id === currentUserId ? 'selected' : ''}" onclick="requestSwitchUser('${u.id}')">
      <div class="user-item-avatar ${avatarClass(i)}">${initials(u.name)}</div>
      <div class="user-item-name">${u.name}</div>
      <span class="user-item-check">‚úì</span>
    </div>
  `).join('');
}

function toggleUserDropdown() {
  const sw = document.getElementById('userSwitcher');
  const dd = document.getElementById('userDropdown');
  const isOpen = dd.classList.contains('open');
  if (isOpen) {
    closeUserDropdown();
  } else {
    dd.classList.add('open');
    sw.classList.add('open');
  }
}

function closeUserDropdown() {
  document.getElementById('userDropdown').classList.remove('open');
  document.getElementById('userSwitcher').classList.remove('open');
}

// Close dropdown when clicking outside
document.addEventListener('click', e => {
  if (!document.getElementById('userSwitcher').contains(e.target)) {
    closeUserDropdown();
  }
});

// ‚îÄ‚îÄ INIT USERS ‚îÄ‚îÄ
async function initUsers() {
  let users = getUsers();

  // Migrate old single-user data
  const oldData = localStorage.getItem('tl_data');
  if (oldData && users.length === 0) {
    const uid = 'user_' + Date.now();
    users = [{ id: uid, name: 'Êàë' }];
    saveUsers(users);
    localStorage.setItem(userDataKey(uid), oldData);
    localStorage.removeItem('tl_data');
    setCurrentUserId(uid);
  }

  // Try to pull users list from Firestore (cross-device sync)
  // Use a timeout so a slow network never blocks the lock screen from showing
  if (window._firestoreReady) {
    try {
      const cloudUsers = await Promise.race([
        loadUsersFromFirestore(),
        new Promise(resolve => setTimeout(() => resolve(null), 3000))
      ]);
      if (cloudUsers && cloudUsers.length > 0) {
        const localIds = users.map(u => u.id);
        cloudUsers.forEach(cu => { if (!localIds.includes(cu.id)) users.push(cu); });
        saveUsers(users);
      } else if (users.length > 0) {
        saveUsers(users);
      }
    } catch(e) {
      console.warn('Firestore sync skipped:', e);
    }
  }

  // Always show lock screen
  renderLockUserList();
  if (users.length === 0) {
    showNewUserForm();
  } else {
    showLockUserSelect();
  }

  renderUserList();
  syncTopbarUser();
}

// Show lock screen immediately on load (before async init completes)
document.addEventListener('DOMContentLoaded', () => {
  const ls = document.getElementById('lockScreen');
  if (ls) ls.classList.remove('hidden');
});

// ‚îÄ‚îÄ INIT GUARD ‚îÄ‚îÄ
// type="module" scripts run asynchronously, so timing of 'firestore-ready'
// relative to this script is unpredictable. We handle all cases:
let _initCalled = false;
function safeInitUsers() {
  if (_initCalled) return;
  _initCalled = true;
  initUsers();
}

// Case 1: Firebase module already ran before this script reached here
if (window._firestoreReady) {
  safeInitUsers();
} else {
  // Case 2: Firebase module hasn't run yet ‚Äî listen for the event
  window.addEventListener('firestore-ready', safeInitUsers, { once: true });
  // Case 3: Firebase fails or takes too long ‚Äî run without it after 2.5s
  setTimeout(safeInitUsers, 2500);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
const pageTitles = {
  dashboard:'Á∏ΩË¶Ω', log:'‰ªäÊó•Ë®òÈåÑ', history:'Ë®ìÁ∑¥Ê≠∑Âè≤',
  weight:'È´îÈáçËøΩËπ§', photos:'Ë∫´ÊùêÁÖßÁâá', plan:'Ë®ìÁ∑¥Ë®àÂäÉ', goals:'ÁõÆÊ®ôËøΩËπ§'
};

function navigate(page, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  if (el) el.classList.add('active');
  document.getElementById('pageTitle').textContent = pageTitles[page];
  renderPage(page);
}

function renderPage(p) {
  if (p==='dashboard') renderDashboard();
  if (p==='log') { prefillHeight(); renderLogExerciseList(); updateWeightDiff(); }
  if (p==='history') renderHistory('all');
  if (p==='weight') renderWeightPage();
  if (p==='photos') renderPhotos();
  if (p==='plan') renderPlans();
  if (p==='goals') renderGoals();
  if (p==='settings') renderSettingsPage();
  if (p==='workout') renderWorkoutTimer();
  if (p==='library') renderLibrary();
}

// ‚îÄ‚îÄ PRE-FILL HEIGHT ‚îÄ‚îÄ
function prefillHeight() {
  const h = data.goals && data.goals.height;
  if (h) document.getElementById('log-height').value = h;
}

// ‚îÄ‚îÄ INIT DATES ‚îÄ‚îÄ
const today = new Date().toISOString().split('T')[0];
document.getElementById('log-date').value = today;
document.getElementById('weight-date-input').value = today;
const dateStr = new Date().toLocaleDateString('zh-TW',{year:'numeric',month:'long',day:'numeric',weekday:'long'});
document.getElementById('headerDate').textContent = dateStr;
document.getElementById('sidebarDate').textContent = today;

// ‚îÄ‚îÄ CALORIE PREVIEW ‚îÄ‚îÄ
function updateCaloriePreview() {
  const dur = parseInt(document.getElementById('log-duration').value)||0;
  const type = document.getElementById('log-type').value;
  const w = parseFloat(document.getElementById('log-weight').value)||data.goals?.lastWeight||70;
  const pg = document.getElementById('calorie-preview-group');
  if (dur > 0 && type && type !== 'rest') {
    const cal = calcCalories(type, dur, w);
    document.getElementById('calorie-preview').innerHTML = cal + ' <span style="font-size:13px;font-weight:400;">kcal</span>';
    pg.style.display = 'block';
  } else {
    pg.style.display = 'none';
  }
}
document.getElementById('log-duration').addEventListener('input', updateCaloriePreview);
document.getElementById('log-type').addEventListener('change', updateCaloriePreview);
document.getElementById('log-weight').addEventListener('input', updateCaloriePreview);

// ‚îÄ‚îÄ TYPE MAP ‚îÄ‚îÄ
const typeMap = {
  chest:'ËÉ∏ÈÉ®Ë®ìÁ∑¥', back:'ËÉåÈÉ®Ë®ìÁ∑¥', legs:'ËÖøÈÉ®Ë®ìÁ∑¥',
  shoulders:'ËÇ©ÈÉ®Ë®ìÁ∑¥', arms:'ÊâãËáÇË®ìÁ∑¥', core:'Ê†∏ÂøÉË®ìÁ∑¥',
  cardio:'ÊúâÊ∞ßË®ìÁ∑¥', fullbody:'ÂÖ®Ë∫´Ë®ìÁ∑¥', rest:'‰ºëÊÅØÊó•'
};

// ‚îÄ‚îÄ LOG TODAY ‚îÄ‚îÄ
let pendingLogPhotos = [];

function handleLogPhoto(e) {
  Array.from(e.target.files).forEach(f => {
    const r = new FileReader();
    r.onload = ev => {
      pendingLogPhotos.push({src:ev.target.result, date:document.getElementById('log-date').value});
      const preview = document.getElementById('log-photo-previews');
      preview.innerHTML = pendingLogPhotos.map(p =>
        `<div class="photo-item" style="height:110px;"><img src="${p.src}"><div class="photo-date">${p.date}</div></div>`
      ).join('');
    };
    r.readAsDataURL(f);
  });
}

// ‚îÄ‚îÄ DYNAMIC EXERCISE LIST (log page) ‚îÄ‚îÄ
let logExercises = []; // [{name, sets, weight}]

function addLogExerciseRow(name='', sets='', weight='') {
  logExercises.push({name, sets, weight});
  renderLogExerciseList();
}

function removeLogExerciseRow(i) {
  logExercises.splice(i, 1);
  renderLogExerciseList();
}

function updateLogExercise(i, field, val) {
  logExercises[i][field] = val;
}

function renderLogExerciseList() {
  const el = document.getElementById('logExerciseList');
  if (!el) return;
  if (logExercises.length === 0) {
    el.innerHTML = '<div style="font-size:13px;color:var(--text3);padding:8px 0 4px;">Â∞öÊú™Êñ∞Â¢ûÂãï‰Ωú</div>';
    return;
  }
  el.innerHTML = logExercises.map((ex, i) => `
    <div class="ex-list-row">
      <input class="set-input" type="text" placeholder="Âãï‰ΩúÂêçÁ®±" value="${ex.name}"
        oninput="updateLogExercise(${i},'name',this.value)" list="exNameDatalist">
      <input class="set-input" type="number" placeholder="ÁµÑÊï∏" min="1" value="${ex.sets}"
        oninput="updateLogExercise(${i},'sets',this.value)" style="text-align:center;">
      <input class="set-input" type="number" placeholder="kg" step="0.5" value="${ex.weight}"
        oninput="updateLogExercise(${i},'weight',this.value)" style="text-align:center;">
      <button class="set-del-btn" onclick="removeLogExerciseRow(${i})">‚úï</button>
    </div>`).join('');
}

function openLogExPicker() {
  const wrap = document.getElementById('logExPickerWrap');
  wrap.style.display = wrap.style.display === 'none' ? 'block' : 'none';
  if (wrap.style.display === 'block') {
    document.getElementById('logExPickerInput').value = '';
    renderLogExPicker();
    setTimeout(() => document.getElementById('logExPickerInput').focus(), 100);
  }
}

function renderLogExPicker() {
  const q = document.getElementById('logExPickerInput').value.toLowerCase();
  const filtered = EXERCISES.filter(e =>
    e.name.toLowerCase().includes(q) || e.muscle.includes(q)
  );
  const el = document.getElementById('logExPickerList');
  el.innerHTML = filtered.slice(0,15).map(e => `
    <div onclick="pickLogExercise('${e.name}')"
      style="padding:9px 12px;cursor:pointer;font-size:13px;display:flex;justify-content:space-between;transition:background 0.1s;"
      onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background=''">
      <span style="font-weight:500;">${e.name}</span>
      <span style="color:var(--text3);font-size:11px;">${e.muscle}</span>
    </div>`).join('') || '<div style="padding:10px 12px;font-size:13px;color:var(--text3);">Êâæ‰∏çÂà∞Âãï‰Ωú</div>';
}

function pickLogExercise(name) {
  addLogExerciseRow(name, '', '');
  document.getElementById('logExPickerWrap').style.display = 'none';
}

function copyYesterdayExercises() {
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(today.getDate() - 1);
  const yDate = yesterday.toISOString().split('T')[0];

  // Find most recent log before today
  const pastLogs = data.logs.filter(l => l.date < new Date().toISOString().split('T')[0]);
  if (pastLogs.length === 0) { showToast('Êâæ‰∏çÂà∞‰πãÂâçÁöÑË®ìÁ∑¥Ë®òÈåÑ'); return; }
  const lastLog = pastLogs[0];

  // Parse exercises from the log
  if (lastLog.exercises_structured && lastLog.exercises_structured.length > 0) {
    logExercises = lastLog.exercises_structured.map(e => ({...e}));
  } else if (lastLog.exercises) {
    // Parse from text format
    const lines = lastLog.exercises.split('
').filter(l => l.trim());
    logExercises = lines.map(l => {
      const parts = l.split(/\s+/);
      return { name: parts[0] || l, sets: parts[1] || '', weight: parts[2] || '' };
    });
  } else {
    showToast('‰∏äÊ¨°Ë®òÈåÑÊ≤íÊúâË®ìÁ∑¥Âãï‰Ωú'); return;
  }
  renderLogExerciseList();
  showToast(`‚úì Â∑≤Ë§áË£Ω ${lastLog.date} ÁöÑË®ìÁ∑¥ÔºàÂÖ± ${logExercises.length} ÂÄãÂãï‰ΩúÔºâ`);
}

function getExercisesText() {
  return logExercises.map(ex => {
    let s = ex.name || 'Êú™Áü•Âãï‰Ωú';
    if (ex.sets) s += ` ${ex.sets}ÁµÑ`;
    if (ex.weight) s += ` √ó ${ex.weight}kg`;
    return s;
  }).join('
');
}

// ‚îÄ‚îÄ WEIGHT DIFF ‚îÄ‚îÄ
function updateWeightDiff() {
  const val = parseFloat(document.getElementById('log-weight').value);
  const badge = document.getElementById('weightDiffBadge');
  if (!val || isNaN(val)) { badge.style.display = 'none'; return; }

  const sorted = [...data.weights].sort((a,b) => b.date.localeCompare(a.date));
  const today = new Date().toISOString().split('T')[0];

  // Yesterday's weight
  const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
  const yDate = yesterday.toISOString().split('T')[0];
  const yWeight = sorted.find(w => w.date <= yDate);

  // Last week average (7 days ago)
  const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate()-7);
  const weekAgoDate = weekAgo.toISOString().split('T')[0];
  const weekWeights = sorted.filter(w => w.date <= weekAgoDate && w.date >= new Date(weekAgo.getFullYear(), weekAgo.getMonth(), weekAgo.getDate()-6).toISOString().split('T')[0]);
  const weekAvg = weekWeights.length > 0 ? weekWeights.reduce((s,w)=>s+w.value,0)/weekWeights.length : null;

  let diff, label;
  if (yWeight) {
    diff = val - yWeight.value;
    label = 'ËºÉÊò®Êó•';
  } else if (weekAvg) {
    diff = val - weekAvg;
    label = 'ËºÉ‰∏äÈÄ±Âùá';
  } else if (sorted.length > 0) {
    diff = val - sorted[0].value;
    label = 'ËºÉ‰∏äÊ¨°';
  } else {
    badge.style.display = 'none'; return;
  }

  const sign = diff > 0 ? '+' : '';
  badge.textContent = `${sign}${diff.toFixed(1)}kg ${label}`;
  badge.style.display = 'inline-flex';
  badge.className = 'weight-diff-badge ' + (diff < 0 ? 'weight-diff-down' : diff > 0 ? 'weight-diff-up' : 'weight-diff-flat');
}

function saveLog() {
  const date = document.getElementById('log-date').value;
  const weight = document.getElementById('log-weight').value;
  const type = document.getElementById('log-type').value;
  const start = document.getElementById('log-start').value;
  const end = document.getElementById('log-end').value;
  const notes = document.getElementById('log-notes').value;
  const duration = document.getElementById('log-duration').value;

  if (!date) { showToast('Ë´ãÈÅ∏ÊìáÊó•Êúü'); return; }

  const exercisesText = getExercisesText();

  data.logs.unshift({
    id: Date.now(), date,
    weight: weight ? parseFloat(weight) : null,
    type, start, end,
    exercises: exercisesText,
    exercises_structured: [...logExercises],
    notes,
    duration: duration ? parseInt(duration) : null,
    calories: duration && weight ? calcCalories(type, parseInt(duration), parseFloat(weight)||70) : null,
    photos: [...pendingLogPhotos]
  });

  if (weight) {
    const idx = data.weights.findIndex(w => w.date === date);
    if (idx >= 0) data.weights[idx].value = parseFloat(weight);
    else data.weights.push({date, value: parseFloat(weight)});
    data.weights.sort((a,b) => b.date.localeCompare(a.date));
  }

  pendingLogPhotos.forEach(p => data.photos.push(p));
  saveAndSync();

  pendingLogPhotos = [];
  logExercises = [];
  document.getElementById('log-photo-previews').innerHTML = '';
  renderLogExerciseList();
  ['log-notes','log-weight'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('log-type').value = '';
  document.getElementById('log-start').value = '';
  document.getElementById('log-end').value = '';
  document.getElementById('log-duration').value = '';
  document.getElementById('weightDiffBadge').style.display = 'none';
  showToast('‚úì Ë®òÈåÑÂ∑≤ÂÑ≤Â≠ò');
}


// ‚îÄ‚îÄ CALORIE CALCULATOR ‚îÄ‚îÄ
const MET = {
  chest: 4.0, back: 4.0, legs: 5.5, shoulders: 3.5,
  arms: 3.0, core: 3.8, cardio: 7.0, fullbody: 5.0, rest: 0
};

function calcCalories(type, durationMin, weightKg) {
  const met = MET[type] || 4.0;
  // Cal = MET √ó weight(kg) √ó time(hours)
  return Math.round(met * weightKg * (durationMin / 60));
}

// ‚îÄ‚îÄ PASSWORD SYSTEM ‚îÄ‚îÄ
// Passwords stored as simple hashes in localStorage (per user)
function pwdKey(uid) { return 'tl_pwd_' + uid; }

async function hashPassword(pwd) {
  if (!pwd) return '';
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pwd));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function setUserPassword(uid, newPwd) {
  const hash = await hashPassword(newPwd);
  localStorage.setItem(pwdKey(uid), hash);
  // sync to Firestore
  if (window._firestoreReady) {
    window._fsSetDoc(window._fsDoc(window._db, 'passwords', uid), { hash })
      .catch(e => console.warn('pwd sync:', e));
  }
}

async function getUserPasswordHash(uid) {
  // check Firestore first for cross-device sync
  if (window._firestoreReady) {
    try {
      const snap = await window._fsGetDoc(window._fsDoc(window._db, 'passwords', uid));
      if (snap.exists()) {
        const hash = snap.data().hash || '';
        localStorage.setItem(pwdKey(uid), hash);
        return hash;
      }
    } catch(e) {}
  }
  return localStorage.getItem(pwdKey(uid)) || '';
}

async function verifyPassword(uid, inputPwd) {
  const stored = await getUserPasswordHash(uid);
  if (!stored) return true; // no password set = always pass
  const inputHash = await hashPassword(inputPwd);
  return inputHash === stored;
}

async function changePassword() {
  const cur = document.getElementById('pwd-current').value;
  const nw = document.getElementById('pwd-new').value;
  const cf = document.getElementById('pwd-confirm').value;

  if (nw !== cf) { showToast('Êñ∞ÂØÜÁ¢ºÂÖ©Ê¨°Ëº∏ÂÖ•‰∏ç‰∏ÄËá¥'); return; }
  const valid = await verifyPassword(currentUserId, cur);
  if (!valid) { showToast('ÁõÆÂâçÂØÜÁ¢ºÈåØË™§'); return; }
  await setUserPassword(currentUserId, nw);
  document.getElementById('pwd-current').value = '';
  document.getElementById('pwd-new').value = '';
  document.getElementById('pwd-confirm').value = '';
  showToast(nw ? '‚úì ÂØÜÁ¢ºÂ∑≤Êõ¥Êñ∞' : '‚úì ÂØÜÁ¢ºÂ∑≤ÁßªÈô§');
}

// ‚îÄ‚îÄ LOCK SCREEN ‚îÄ‚îÄ
let lockSelectedUid = null;

function renderLockUserList() {
  const users = getUsers();
  const el = document.getElementById('lockUserList');
  el.innerHTML = users.map((u, i) => `
    <button class="lock-user-btn ${u.id === lockSelectedUid ? 'selected' : ''}"
      onclick="selectLockUser('${u.id}')">
      <div class="lock-user-avatar ${avatarClass(i)}">${initials(u.name)}</div>
      <div class="lock-user-info">
        <div class="lock-user-name">${u.name}</div>
      </div>
      <span style="color:var(--text3);font-size:18px;">‚Ä∫</span>
    </button>
  `).join('');
}

async function selectLockUser(uid) {
  lockSelectedUid = uid;
  const users = getUsers();
  const user = users.find(u => u.id === uid);
  const idx = users.indexOf(user);
  const hash = await getUserPasswordHash(uid);

  document.getElementById('lockAvatar').textContent = initials(user.name);
  document.getElementById('lockAvatar').className = 'lock-avatar ' + avatarClass(idx);
  document.getElementById('lockDisplayName').textContent = user.name;
  document.getElementById('lockError').textContent = '';

  if (!hash) {
    // No password ‚Äî unlock immediately
    unlockApp(uid);
  } else {
    document.getElementById('lockPwdHint').textContent = 'Ë´ãËº∏ÂÖ•ÂØÜÁ¢º';
    document.getElementById('lockPwdInput').value = '';
    document.getElementById('lockUserSelect').style.display = 'none';
    document.getElementById('lockPasswordView').style.display = 'block';
    document.getElementById('lockNewUserView').style.display = 'none';
    setTimeout(() => document.getElementById('lockPwdInput').focus(), 100);
  }
}

async function submitLockPassword() {
  const input = document.getElementById('lockPwdInput');
  const valid = await verifyPassword(lockSelectedUid, input.value);
  if (valid) {
    unlockApp(lockSelectedUid);
  } else {
    input.classList.add('error');
    document.getElementById('lockError').textContent = 'ÂØÜÁ¢ºÈåØË™§ÔºåË´ãÂÜçË©¶‰∏ÄÊ¨°';
    setTimeout(() => input.classList.remove('error'), 500);
    input.value = '';
    input.focus();
  }
}

function unlockApp(uid) {
  document.getElementById('lockScreen').classList.add('hidden');
  switchUser(uid);
}

function showLockUserSelect() {
  document.getElementById('lockUserSelect').style.display = 'block';
  document.getElementById('lockPasswordView').style.display = 'none';
  document.getElementById('lockNewUserView').style.display = 'none';
  renderLockUserList();
}

function showNewUserForm() {
  document.getElementById('lockUserSelect').style.display = 'none';
  document.getElementById('lockPasswordView').style.display = 'none';
  document.getElementById('lockNewUserView').style.display = 'block';
  document.getElementById('lockNewName').value = '';
  document.getElementById('lockNewPwd').value = '';
  document.getElementById('lockNewError').textContent = '';
  setTimeout(() => document.getElementById('lockNewName').focus(), 100);
}

async function submitNewUser() {
  const name = document.getElementById('lockNewName').value.trim();
  const pwd = document.getElementById('lockNewPwd').value;
  const errEl = document.getElementById('lockNewError');
  if (!name) { errEl.textContent = 'Ë´ãËº∏ÂÖ•ÂêçÁ®±'; return; }
  const users = getUsers();
  if (users.find(u => u.name === name)) { errEl.textContent = 'Ê≠§ÂêçÁ®±Â∑≤Â≠òÂú®'; return; }
  const uid = 'user_' + Date.now();
  users.push({ id: uid, name });
  saveUsers(users);
  if (pwd) await setUserPassword(uid, pwd);
  unlockApp(uid);
}


// ‚îÄ‚îÄ SETTINGS PAGE ‚îÄ‚îÄ
function renderSettingsPage() {
  const users = getUsers();
  const user = users.find(u => u.id === currentUserId);
  const idx = users.indexOf(user);
  if (user) {
    document.getElementById('settings-username').textContent = user.name;
    document.getElementById('settings-avatar').textContent = initials(user.name);
    document.getElementById('settings-avatar').className = 'user-avatar ' + avatarClass(idx);
  }
  const h = data.goals && data.goals.height;
  if (h) document.getElementById('settings-height').value = h;
  // clear password fields
  ['settings-pwd-current','settings-pwd-new','settings-pwd-confirm'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
}

function saveSettingsHeight() {
  const val = parseFloat(document.getElementById('settings-height').value);
  if (!val || val < 100 || val > 250) { showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàË∫´È´ò'); return; }
  data.goals.height = val;
  saveAndSync();
  showToast('‚úì Ë∫´È´òÂ∑≤ÂÑ≤Â≠òÔºåBMI Â∑≤Êõ¥Êñ∞');
}

async function changePasswordFromSettings() {
  const cur = document.getElementById('settings-pwd-current').value;
  const nw = document.getElementById('settings-pwd-new').value;
  const cf = document.getElementById('settings-pwd-confirm').value;
  if (nw !== cf) { showToast('ÂÖ©Ê¨°ÂØÜÁ¢º‰∏ç‰∏ÄËá¥'); return; }
  const valid = await verifyPassword(currentUserId, cur);
  if (!valid) { showToast('ÁõÆÂâçÂØÜÁ¢ºÈåØË™§'); return; }
  await setUserPassword(currentUserId, nw);
  ['settings-pwd-current','settings-pwd-new','settings-pwd-confirm'].forEach(id => {
    document.getElementById(id).value = '';
  });
  showToast(nw ? '‚úì ÂØÜÁ¢ºÂ∑≤Êõ¥Êñ∞' : '‚úì ÂØÜÁ¢ºÂ∑≤ÁßªÈô§');
}


// ‚îÄ‚îÄ DELETE SELF ACCOUNT (from settings page) ‚îÄ‚îÄ
function showDeleteSelfConfirm() {
  document.getElementById('delete-self-section').style.display = 'none';
  document.getElementById('delete-self-confirm').style.display = 'block';
  document.getElementById('delete-self-pwd').value = '';
  document.getElementById('delete-self-error').textContent = '';
  document.getElementById('delete-self-pwd').focus();
}

function cancelDeleteSelf() {
  document.getElementById('delete-self-section').style.display = 'block';
  document.getElementById('delete-self-confirm').style.display = 'none';
}

async function confirmDeleteSelf() {
  const pwd = document.getElementById('delete-self-pwd').value;
  const valid = await verifyPassword(currentUserId, pwd);
  if (!valid) {
    document.getElementById('delete-self-error').textContent = 'ÂØÜÁ¢ºÈåØË™§';
    document.getElementById('delete-self-pwd').value = '';
    document.getElementById('delete-self-pwd').focus();
    return;
  }
  const users = getUsers();
  if (users.length <= 1) { showToast('Ëá≥Â∞ë‰øùÁïô‰∏ÄÂÄãÂ∏≥Ëôü'); cancelDeleteSelf(); return; }
  // perform delete
  const uid = currentUserId;
  const remaining = users.filter(u => u.id !== uid);
  saveUsers(remaining);
  localStorage.removeItem(userDataKey(uid));
  localStorage.removeItem(pwdKey(uid));
  if (window._firestoreReady) {
    try {
      await window._fsDeleteDoc(window._fsDoc(window._db, 'users', uid));
      await window._fsDeleteDoc(window._fsDoc(window._db, 'photos', uid));
      await window._fsDeleteDoc(window._fsDoc(window._db, 'passwords', uid));
    } catch(e) { console.warn('delete from firestore:', e); }
  }
  showToast('Â∏≥ËôüÂ∑≤Âà™Èô§');
  logoutToLockScreen();
}

// ‚îÄ‚îÄ LOGOUT ‚Üí LOCK SCREEN ‚îÄ‚îÄ
function logoutToLockScreen() {
  // hide app, show lock screen
  document.getElementById('lockScreen').classList.remove('hidden');
  renderLockUserList();
  showLockUserSelect();
}

// ‚îÄ‚îÄ SWITCH USER WITH PASSWORD ‚îÄ‚îÄ
// Called from sidebar user switcher ‚Äî goes through lock screen
function requestSwitchUser(uid) {
  if (uid === currentUserId) { closeUserDropdown(); return; }
  closeUserDropdown();
  // Show lock screen targeting that user
  document.getElementById('lockScreen').classList.remove('hidden');
  selectLockUser(uid);
}

function requestSwitchUserMobile(uid) {
  if (uid === currentUserId) { closeMobileUserModal(); return; }
  closeMobileUserModal();
  document.getElementById('lockScreen').classList.remove('hidden');
  selectLockUser(uid);
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
function renderDashboard() {
  const ws = data.weights.sort((a,b) => b.date.localeCompare(a.date));
  const latest = ws[0], prev = ws[1];

  if (latest) {
    document.getElementById('dash-weight').textContent = latest.value.toFixed(1);
    if (prev) {
      const diff = (latest.value - prev.value).toFixed(1);
      const el = document.getElementById('dash-weight-change');
      el.innerHTML = (diff > 0 ? '‚ñ≤ +' : diff < 0 ? '‚ñº ' : '') + diff + ' kg ËºÉÂâçÊ¨°';
      el.className = 'stat-change ' + (diff > 0 ? 'up' : diff < 0 ? 'down' : 'neutral');
    }
  }

  const goal = data.goals;
  if (goal.weight && latest) {
    const rem = (latest.value - goal.weight);
    document.getElementById('dash-remaining').textContent = Math.abs(rem).toFixed(1);
    document.getElementById('dash-target-weight').textContent = 'ÁõÆÊ®ôÔºö' + goal.weight + ' kg';
  }

  const now = new Date();
  const monthLogs = data.logs.filter(l => {
    const d = new Date(l.date);
    return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear() && l.type && l.type!=='rest';
  });
  document.getElementById('dash-sessions').textContent = monthLogs.length;

  let streak = 0, check = new Date();
  for (let i=0; i<60; i++) {
    const ds = check.toISOString().split('T')[0];
    if (data.logs.find(l => l.date===ds && l.type && l.type!=='rest')) {
      streak++; check.setDate(check.getDate()-1);
    } else break;
  }
  document.getElementById('dash-streak').textContent = streak;

  // Recent
  const recent = data.logs.slice(0,4);
  const rl = document.getElementById('recent-logs');
  rl.innerHTML = recent.length === 0
    ? '<div class="empty-state" style="padding:16px 0;"><div class="empty-icon">üìã</div>Â∞öÁÑ°Ë®òÈåÑ</div>'
    : recent.map(l => `
        <div class="workout-entry" style="padding:12px 14px;">
          <div>
            <div class="entry-date">${l.date}</div>
            <div class="entry-title" style="font-size:14px;">${typeMap[l.type]||'Êú™Áü•'}</div>
          </div>
          ${l.weight ? `<div style="font-size:15px;font-weight:700;color:var(--accent)">${l.weight}<span style="font-size:11px;color:var(--text3);font-weight:400;"> kg</span></div>` : ''}
        </div>`).join('');

  drawChart('weightChart', ws.slice(0,30).reverse(), 560, 160);

  // BMI
  const height = data.goals && data.goals.height;
  const bmiVal = document.getElementById('bmi-value');
  const bmiCat = document.getElementById('bmi-category-badge');
  const bmiSub = document.getElementById('bmi-sub');
  const bmiBar = document.getElementById('bmi-bar-wrap');
  const bmiMark = document.getElementById('bmi-marker');
  if (latest && height) {
    const bmi = latest.value / ((height/100) ** 2);
    bmiVal.textContent = bmi.toFixed(1);
    bmiBar.style.opacity = '1';
    const pct = Math.min(100, Math.max(0, (bmi - 15) / (35 - 15) * 100));
    bmiMark.style.left = pct + '%';
    let cat, color, bg;
    if (bmi < 18.5)      { cat='ÂÅèÁò¶'; color='#34aadc'; bg='rgba(52,170,220,0.12)'; }
    else if (bmi < 24)   { cat='Ê≠£Â∏∏'; color='var(--green)'; bg='var(--green-light)'; }
    else if (bmi < 27)   { cat='ÈÅéÈáç'; color='var(--orange)'; bg='var(--orange-light)'; }
    else                 { cat='ËÇ•ËÉñ'; color='var(--red)'; bg='var(--red-light)'; }
    bmiCat.textContent = cat;
    bmiCat.style.color = color;
    bmiCat.style.background = bg;
    bmiSub.textContent = 'Ë∫´È´ò ' + height + ' cm ¬∑ È´îÈáç ' + latest.value.toFixed(1) + ' kg';
  } else {
    bmiVal.textContent = '‚Äî';
    bmiSub.textContent = height ? 'Ë´ãË®òÈåÑÈ´îÈáç' : 'Ë´ãËá≥Áî®Êà∂Ë®≠ÂÆöÂ°´ÂØ´Ë∫´È´ò';
    bmiCat.textContent = '‚Äî';
    bmiCat.style.background = '#e5e5ea';
    bmiCat.style.color = 'var(--text3)';
    bmiBar.style.opacity = '0.3';
    bmiMark.style.left = '50%';
  }

  // Monthly calories
  const monthCal = monthLogs.reduce((s, l) => s + (l.calories||0), 0);
  document.getElementById('dash-calories').textContent = monthCal.toLocaleString();
  document.getElementById('dash-calories-sub').textContent = monthCal > 0 ? 'Êú¨ÊúàÊ∂àËÄó‰º∞ÁÆó' : 'Ë®òÈåÑË®ìÁ∑¥ÊôÇÈï∑‰ª•Ë®àÁÆó';
}

// ‚îÄ‚îÄ CHART ‚îÄ‚îÄ
function drawChart(id, weights, W, H) {
  const svg = document.getElementById(id);
  if (!svg || weights.length < 2) { if(svg) svg.innerHTML=''; return; }
  const vals = weights.map(w=>w.value);
  const min = Math.min(...vals)-1.5, max = Math.max(...vals)+1.5;
  const pad = {l:36, r:12, t:12, b:28};
  const cw = W-pad.l-pad.r, ch = H-pad.t-pad.b;
  const x = i => pad.l+(i/(vals.length-1))*cw;
  const y = v => pad.t+ch-((v-min)/(max-min))*ch;

  // grid
  let grid='';
  for(let i=0;i<=3;i++){
    const yv = pad.t+(ch/3)*i;
    const val = (max-(max-min)*i/3).toFixed(1);
    grid+=`<line x1="${pad.l}" y1="${yv}" x2="${W-pad.r}" y2="${yv}" stroke="#e5e5ea" stroke-width="1"/>`;
    grid+=`<text x="${pad.l-6}" y="${yv+4}" text-anchor="end" fill="#a1a1a6" font-size="9.5" font-family="'Noto Sans TC',sans-serif">${val}</text>`;
  }
  // date labels
  let dateLabels='';
  if(weights.length>0){
    [0, Math.floor((weights.length-1)/2), weights.length-1].forEach(i=>{
      if(weights[i]) dateLabels+=`<text x="${x(i)}" y="${H-4}" text-anchor="middle" fill="#a1a1a6" font-size="9" font-family="'Noto Sans TC',sans-serif">${weights[i].date.slice(5)}</text>`;
    });
  }
  // goal line
  const gw = data.goals.weight;
  let goalLine='';
  if(gw && gw>=min && gw<=max){
    const gy=y(gw);
    goalLine=`<line x1="${pad.l}" y1="${gy}" x2="${W-pad.r}" y2="${gy}" stroke="#ff3b30" stroke-width="1.2" stroke-dasharray="5,4" opacity="0.5"/>
    <text x="${W-pad.r+4}" y="${gy+3.5}" fill="#ff3b30" font-size="9" font-family="'Noto Sans TC',sans-serif" opacity="0.7">ÁõÆÊ®ô</text>`;
  }
  // area
  const pts = vals.map((v,i)=>`${x(i)},${y(v)}`).join(' ');
  const area = `${x(0)},${H-pad.b} ${pts} ${x(vals.length-1)},${H-pad.b}`;

  svg.innerHTML = `
    <defs>
      <linearGradient id="g_${id}" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#0071e3" stop-opacity="0.12"/>
        <stop offset="100%" stop-color="#0071e3" stop-opacity="0.01"/>
      </linearGradient>
    </defs>
    ${grid}${dateLabels}${goalLine}
    <polygon points="${area}" fill="url(#g_${id})"/>
    <polyline points="${pts}" fill="none" stroke="#0071e3" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
    ${vals.map((v,i)=>`<circle cx="${x(i)}" cy="${y(v)}" r="3.5" fill="#fff" stroke="#0071e3" stroke-width="1.8"/>`).join('')}
  `;
}

// ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ
function renderHistory(filter) {
  filter = filter || document.getElementById('history-filter').value;
  let logs = data.logs.slice();
  if(filter!=='all') logs=logs.filter(l=>l.type===filter);
  const el = document.getElementById('history-list');
  if(logs.length===0){
    el.innerHTML='<div class="empty-state"><div class="empty-icon">üìã</div>Â∞öÁÑ°Ë®ìÁ∑¥Ë®òÈåÑ</div>';
    return;
  }
  el.innerHTML = logs.map(l=>{
    const dur = l.start&&l.end ? calcDur(l.start,l.end) : null;
    return `<div class="workout-entry ${l.type==='rest'?'rest':''}">
      <div>
        <div class="entry-date">${l.date}${l.start?' ¬∑ '+l.start+(l.end?' ‚Äî '+l.end:''):''}</div>
        <div class="entry-title">${typeMap[l.type]||'Êú™Áü•'}</div>
        <div class="entry-meta">
          ${dur?`<span class="entry-tag">‚è± ${dur}</span>`:''}
          ${l.weight?`<span class="entry-tag">‚öñ ${l.weight} kg</span>`:''}
          ${l.photos&&l.photos.length?`<span class="entry-tag green">üì∑ ${l.photos.length} Âºµ</span>`:''}
          ${l.calories?`<span class="calorie-tag">üî• ${l.calories} kcal</span>`:''}
        </div>
        ${l.exercises?`<div class="entry-exercises">${l.exercises}</div>`:''}
        ${l.notes?`<div class="entry-notes">${l.notes}</div>`:''}
      </div>
      <button class="btn btn-danger" onclick="deleteLog(${l.id})">Âà™Èô§</button>
    </div>`;
  }).join('');
}

function calcDur(s,e){
  const [sh,sm]=s.split(':').map(Number), [eh,em]=e.split(':').map(Number);
  let m=(eh*60+em)-(sh*60+sm); if(m<=0) m+=24*60;
  return m>=60 ? Math.floor(m/60)+'Â∞èÊôÇ'+(m%60?m%60+'ÂàÜ':'') : m+'ÂàÜÈêò';
}

function deleteLog(id){
  data.logs=data.logs.filter(l=>l.id!==id); saveAndSync(); renderHistory();
  showToast('Â∑≤Âà™Èô§Ë®òÈåÑ');
}

// ‚îÄ‚îÄ WEIGHT PAGE ‚îÄ‚îÄ
function setTargetWeight(){
  const v=parseFloat(document.getElementById('target-weight-input').value);
  if(!v) return;
  data.goals.weight=v; saveAndSync();
  showToast('ÁõÆÊ®ôÈ´îÈáçË®≠ÂÆöÁÇ∫ '+v+' kg');
  renderWeightPage();
}

function addWeightRecord(){
  const date=document.getElementById('weight-date-input').value;
  const val=parseFloat(document.getElementById('weight-value-input').value);
  if(!date||!val){showToast('Ë´ãÂ°´ÂØ´Êó•ÊúüÂíåÈ´îÈáç');return;}
  const idx=data.weights.findIndex(w=>w.date===date);
  if(idx>=0) data.weights[idx].value=val;
  else data.weights.push({date,value:val});
  data.weights.sort((a,b)=>b.date.localeCompare(a.date));
  saveAndSync(); renderWeightPage();
  showToast('È´îÈáçË®òÈåÑÂ∑≤Êñ∞Â¢û');
}

function renderWeightPage(){
  const weights=data.weights.slice().sort((a,b)=>b.date.localeCompare(a.date));
  const tbody=document.getElementById('weight-tbody');
  if(weights.length===0){
    tbody.innerHTML='<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:32px;">Â∞öÁÑ°Ë®òÈåÑ</td></tr>';
  } else {
    tbody.innerHTML=weights.map((w,i)=>{
      const prev=weights[i+1];
      const diff=prev?(w.value-prev.value).toFixed(1):null;
      const goal=data.goals.weight;
      const rem=goal?(w.value-goal).toFixed(1):null;
      let badge='';
      if(rem!==null){
        if(Math.abs(rem)<0.5) badge='<span class="badge badge-green">ÈÅîÊ®ô üéâ</span>';
        else if(rem>0) badge=`<span class="badge badge-orange">Ë∑ùÁõÆÊ®ô -${rem} kg</span>`;
        else badge=`<span class="badge badge-blue">Ë∂ÖÂá∫ ${Math.abs(rem)} kg</span>`;
      }
      return `<tr>
        <td style="color:var(--text2)">${w.date}</td>
        <td style="font-weight:700;font-size:15px;">${w.value.toFixed(1)} <span style="font-size:12px;font-weight:400;color:var(--text3)">kg</span></td>
        <td style="font-weight:600;color:${diff>0?'var(--red)':diff<0?'var(--green)':'var(--text3)'}">
          ${diff!==null?(diff>0?'‚ñ≤ +':'‚ñº ')+diff:''}</td>
        <td>${badge}</td>
        <td><button class="btn btn-danger" onclick="deleteWeight('${w.date}')">Âà™Èô§</button></td>
      </tr>`;
    }).join('');
  }
  drawChart('weightChartFull', weights.slice().reverse(), 760, 200);
}

function deleteWeight(date){
  data.weights=data.weights.filter(w=>w.date!==date); saveAndSync(); renderWeightPage();
}

// ‚îÄ‚îÄ PHOTOS ‚îÄ‚îÄ
function handlePhotoUpload(e){
  Array.from(e.target.files).forEach(f=>{
    const r=new FileReader();
    r.onload=ev=>{
      data.photos.push({src:ev.target.result, date:today, name:f.name});
      saveAndSync(); renderPhotos();
    };
    r.readAsDataURL(f);
  });
}

function renderPhotos(){
  const el=document.getElementById('all-photos');
  if(data.photos.length===0){
    el.innerHTML='<div class="empty-state" style="grid-column:1/-1;"><div class="empty-icon">üì∑</div>Â∞öÁÑ°ÁÖßÁâá</div>';
    return;
  }
  el.innerHTML=data.photos.slice().reverse().map((p,i)=>`
    <div class="photo-item">
      <img src="${p.src}" alt="">
      <div class="photo-date">${p.date}</div>
      <button class="photo-delete" onclick="deletePhoto(${data.photos.length-1-i})">‚úï</button>
    </div>`).join('');
}

function deletePhoto(idx){ data.photos.splice(idx,1); saveAndSync(); renderPhotos(); }

// ‚îÄ‚îÄ PLANS ‚îÄ‚îÄ
function addPlan(){
  const name=document.getElementById('plan-name').value;
  const start=document.getElementById('plan-start').value;
  const end=document.getElementById('plan-end').value;
  const desc=document.getElementById('plan-desc').value;
  if(!name){showToast('Ë´ãËº∏ÂÖ•Ë®àÂäÉÂêçÁ®±');return;}
  data.plans.unshift({id:Date.now(),name,start,end,desc});
  saveAndSync();
  document.getElementById('plan-name').value='';
  document.getElementById('plan-desc').value='';
  renderPlans(); showToast('Ë®ìÁ∑¥Ë®àÂäÉÂ∑≤Êñ∞Â¢û');
}

function renderPlans(){
  const el=document.getElementById('plan-list');
  if(data.plans.length===0){
    el.innerHTML='<div class="empty-state" style="grid-column:1/-1;"><div class="empty-icon">üóì</div>Â∞öÁÑ°Ë®ìÁ∑¥Ë®àÂäÉ</div>';
    return;
  }
  el.innerHTML=data.plans.map(p=>{
    const isActive=p.start&&p.end&&today>=p.start&&today<=p.end;
    const total=p.start&&p.end?Math.ceil((new Date(p.end)-new Date(p.start))/86400000):0;
    const elapsed=p.start?Math.max(0,Math.ceil((new Date(today)-new Date(p.start))/86400000)):0;
    const pct=total>0?Math.min(100,Math.round(elapsed/total*100)):0;
    return `<div class="phase-card ${isActive?'active-phase':''}">
      ${isActive?'<div class="active-badge">ÈÄ≤Ë°å‰∏≠</div>':''}
      <div class="phase-name">${p.name}</div>
      <div class="phase-duration">${p.start||'?'} ‚Üí ${p.end||'?'}</div>
      ${p.desc?`<ul class="phase-exercises">${p.desc.split('\n').filter(Boolean).map(l=>`<li>${l}</li>`).join('')}</ul>`:''}
      ${total>0?`<div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div style="font-size:11px;color:var(--text3);margin-top:6px;">${pct}% ÂÆåÊàê ¬∑ ÂÖ± ${total} Â§©</div>`:''}
      <div style="margin-top:14px;">
        <button class="btn btn-danger" onclick="deletePlan(${p.id})">Âà™Èô§Ë®àÂäÉ</button>
      </div>
    </div>`;
  }).join('');
}

function deletePlan(id){ data.plans=data.plans.filter(p=>p.id!==id); saveAndSync(); renderPlans(); }

// ‚îÄ‚îÄ GOALS ‚îÄ‚îÄ
function saveGoals(){
  const weight=parseFloat(document.getElementById('goal-weight').value);
  const date=document.getElementById('goal-date').value;
  const sessions=parseInt(document.getElementById('goal-sessions').value);
  const desc=document.getElementById('goal-desc').value;
  if(weight) data.goals.weight=weight;
  if(date) data.goals.date=date;
  if(sessions) data.goals.sessions=sessions;
  if(desc) data.goals.desc=desc;
  saveAndSync(); showToast('ÁõÆÊ®ôÂ∑≤ÂÑ≤Â≠ò'); renderGoals();
}

function renderGoals(){
  const g=data.goals;
  if(!g.weight&&!g.sessions){
    document.getElementById('goals-display').innerHTML='<div class="empty-state"><div class="empty-icon">üéØ</div>Â∞öÊú™Ë®≠ÂÆöÁõÆÊ®ô</div>';
    return;
  }
  const weights=data.weights.sort((a,b)=>b.date.localeCompare(a.date));
  const latest=weights[0];
  let html='';

  if(g.weight&&latest){
    const start=weights[weights.length-1]?.value||latest.value;
    const totalChange=Math.abs(start-g.weight);
    const done=Math.abs(latest.value-g.weight);
    const pct=totalChange>0?Math.max(0,Math.round((1-done/totalChange)*100)):(latest.value===g.weight?100:0);
    const C=2*Math.PI*28, offset=C-(pct/100)*C;
    html+=`<div class="goal-card">
      <div>
        <div class="goal-title">ÁõÆÊ®ôÈ´îÈáç</div>
        <div class="goal-meta">
          Áï∂Ââç ${latest.value.toFixed(1)} kg &nbsp;‚Üí&nbsp; ÁõÆÊ®ô ${g.weight} kg
          ${g.date?' ¬∑ Êà™Ê≠¢Êó•Ôºö'+g.date:''}
        </div>
        <div style="margin-top:10px;font-size:13px;color:${latest.value>g.weight?'var(--orange)':'var(--green)'};">
          ${latest.value>g.weight?`ÈÇÑÈúÄÊ∏õÂ∞ë ${(latest.value-g.weight).toFixed(1)} kg`:latest.value<g.weight?`ÈÇÑÈúÄÂ¢ûÂä† ${(g.weight-latest.value).toFixed(1)} kg`:'üéâ ÁõÆÊ®ôÂ∑≤ÈÅîÊàêÔºÅ'}
        </div>
      </div>
      <div class="goal-circle">
        <svg viewBox="0 0 70 70" width="70" height="70">
          <circle cx="35" cy="35" r="28" fill="none" stroke="#e5e5ea" stroke-width="6"/>
          <circle cx="35" cy="35" r="28" fill="none" stroke="${pct>=100?'var(--green)':'var(--accent)'}" stroke-width="6"
            stroke-dasharray="${C}" stroke-dashoffset="${offset}" stroke-linecap="round"/>
        </svg>
        <div class="goal-percent" style="color:${pct>=100?'var(--green)':'var(--accent)'}">${pct}%</div>
      </div>
    </div>`;
  }

  if(g.sessions){
    const now=new Date(), ws2=new Date(now);
    ws2.setDate(now.getDate()-now.getDay());
    const weekSess=data.logs.filter(l=>{
      const d=new Date(l.date); return d>=ws2&&l.type&&l.type!=='rest';
    }).length;
    const pct2=Math.min(100,Math.round(weekSess/g.sessions*100));
    const C=2*Math.PI*28, offset=C-(pct2/100)*C;
    html+=`<div class="goal-card">
      <div>
        <div class="goal-title">Êú¨ÈÄ±Ë®ìÁ∑¥ÁõÆÊ®ô</div>
        <div class="goal-meta">
          ÁõÆÊ®ôÔºöÊØèÈÄ± ${g.sessions} Ê¨° &nbsp;¬∑&nbsp; Êú¨ÈÄ±Â∑≤ÂÆåÊàêÔºö${weekSess} Ê¨°
          ${g.desc?'<br>'+g.desc:''}
        </div>
      </div>
      <div class="goal-circle">
        <svg viewBox="0 0 70 70" width="70" height="70">
          <circle cx="35" cy="35" r="28" fill="none" stroke="#e5e5ea" stroke-width="6"/>
          <circle cx="35" cy="35" r="28" fill="none" stroke="${pct2>=100?'var(--green)':'#30d158'}" stroke-width="6"
            stroke-dasharray="${C}" stroke-dashoffset="${offset}" stroke-linecap="round"/>
        </svg>
        <div class="goal-percent" style="color:var(--green)">${pct2}%</div>
      </div>
    </div>`;
  }

  document.getElementById('goals-display').innerHTML = html||'<div class="empty-state">Ë´ãË®≠ÂÆöÁõÆÊ®ô</div>';
}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXERCISE DATABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EXERCISES = [
  // CHEST
  { id:'b1', name:'ÊßìÈà¥Ëá•Êé®', muscle:'ËÉ∏ÈÉ®', equipment:'ÊßìÈà¥', difficulty:'‰∏≠Á¥ö',
    desc:'ÊúÄÁ∂ìÂÖ∏ÁöÑËÉ∏ÈÉ®Ë®ìÁ∑¥Âãï‰ΩúÔºå‰∏ªË¶ÅÈçõÈçäËÉ∏Â§ßËÇåÔºåÂêåÊôÇÂà∫ÊøÄ‰∏âËßíËÇåÂâçÊùüËàá‰∏âÈ†≠ËÇå„ÄÇ',
    muscles:['ËÉ∏Â§ßËÇåÔºà‰∏ªÔºâ','‰∏âËßíËÇåÂâçÊùü','‰∏âÈ†≠ËÇå'],
    steps:['Ë∫∫Âú®Ëá•Êé®Âá≥‰∏äÔºåÈõôËÖ≥Âπ≥Ë∏©Âú∞Èù¢ÔºåËÉåÈÉ®Ëá™ÁÑ∂ÂºìËµ∑„ÄÇ','ÈõôÊâãÊè°Ë∑ùÁï•ÂØ¨ÊñºËÇ©ÔºåÊéåÂøÉÊúùÂâçÊè°Á∑äÊßìÈà¥„ÄÇ','Ê∑±Âê∏Ê∞£ÔºåÁ∑©ÊÖ¢Â∞áÊßìÈà¥‰∏ãÊîæËá≥‰π≥È†≠‰ΩçÁΩÆÔºåÊÑüÂèóËÉ∏ÈÉ®Êãâ‰º∏„ÄÇ','Áî®ÂäõÂ∞áÊßìÈà¥Êé®Ëµ∑ÔºåÂëºÊ∞£ÔºåÈ†ÇÁ´ØÈéñÁ∑äÊî∂Á∏ÆËÉ∏ËÇå„ÄÇ'],
    tips:['‰øùÊåÅËÇ©ËÉõÈ™®Êî∂Á∑äË≤ºÂá≥', '‰∏çË¶ÅËÆìÊâãËÖïÈÅéÂ∫¶Âæå‰ª∞', '‰∏ãÊîæÊôÇÊéßÂà∂ÈÄüÂ∫¶Á¥Ñ2Áßí'] },
  { id:'b2', name:'‰∏äÊñúÊßìÈà¥Ëá•Êé®', muscle:'ËÉ∏ÈÉ®', equipment:'ÊßìÈà¥', difficulty:'‰∏≠Á¥ö',
    desc:'ÈáùÂ∞çËÉ∏Â§ßËÇå‰∏äÊùüÔºåËÆìËÉ∏ÂûãÊõ¥È£ΩÊªøÁ´ãÈ´î„ÄÇ',
    muscles:['ËÉ∏Â§ßËÇå‰∏äÊùüÔºà‰∏ªÔºâ','‰∏âËßíËÇåÂâçÊùü','‰∏âÈ†≠ËÇå'],
    steps:['Â∞áÂá≥Â≠êË™øËá≥30-45Â∫¶Ëßí„ÄÇ','‰ª•ÂêåËá•Êé®ÊñπÂºèÊè°ÊßìÔºå‰∏ãÊîæËá≥ÈéñÈ™®ÈôÑËøë„ÄÇ','Êé®Ëµ∑ÊôÇÁâπÂà•ÊÑüÂèó‰∏äËÉ∏Êî∂Á∏Æ„ÄÇ'],
    tips:['ËßíÂ∫¶‰∏çË∂ÖÈÅé45Â∫¶‰ª•ÂÖçËÆäÊàêËÇ©ÈÉ®Ë®ìÁ∑¥', 'ÁµÑÈñìÂèØÊê≠ÈÖç‰∏ãÊñúÂãï‰ΩúÂπ≥Ë°°ÁôºÂ±ï'] },
  { id:'b3', name:'ÂïûÈà¥È£õÈ≥•', muscle:'ËÉ∏ÈÉ®', equipment:'ÂïûÈà¥', difficulty:'ÂàùÁ¥ö',
    desc:'Â≠§Á´ãËÉ∏ËÇåÁöÑÂÑ™Ë≥™Êãâ‰º∏Âãï‰ΩúÔºåÂº∑Ë™øÂÖßÂÅ¥Êî∂Á∏ÆÊÑü„ÄÇ',
    muscles:['ËÉ∏Â§ßËÇåÔºà‰∏ªÔºâ'],
    steps:['Ë∫∫Âπ≥ÔºåÈõôÊâãÂêÑÊåÅÂïûÈà¥ÔºåÊâãËáÇÂæÆÂΩéÂëàÂºßÂΩ¢„ÄÇ','ÊÖ¢ÊÖ¢ÂêëÂÖ©ÂÅ¥Â±ïÈñãÔºåÊÑüÂèóËÉ∏ÈÉ®ÂÖÖÂàÜÊãâ‰º∏„ÄÇ','Êî∂Á∏ÆËÉ∏ËÇåÔºåÂ∞áÂïûÈà¥Ê≤øÂºßÁ∑öÂêàÂõûËµ∑Âßã‰ΩçÁΩÆ„ÄÇ'],
    tips:['ÊâãËÇòÂæÆÂΩé‰øùÊåÅÂõ∫ÂÆöËßíÂ∫¶ÂÖ®Á®ã', '‰∏çË¶ÅËøΩÊ±ÇÈáçÈáèÔºåÊÑüÂèóÊâçÊòØÈóúÈçµ'] },
  { id:'b4', name:'Áπ©Á¥¢Â§æËÉ∏', muscle:'ËÉ∏ÈÉ®', equipment:'Áπ©Á¥¢', difficulty:'ÂàùÁ¥ö',
    desc:'ÂÖ®Á®ã‰øùÊåÅÂºµÂäõÁöÑËÉ∏ËÇåÂ≠§Á´ãÂãï‰ΩúÔºåÈÅ©ÂêàË®ìÁ∑¥Êú´ÊÆµÊî∂Á∏ÆÊÑü„ÄÇ',
    muscles:['ËÉ∏Â§ßËÇåÔºà‰∏ªÔºâ','ËÉ∏Â∞èËÇå'],
    steps:['Â∞áÂÖ©ÂÅ¥Áπ©Á¥¢Ë™øËá≥È´ò‰ΩçÔºåÁ´ôÂú®ÂÖ©ËÄÖ‰∏≠Èñì„ÄÇ','ÈõôÊâãÊè°‰ΩèÊääÊâãÔºåÂëàÂçäÂºìÊ≠•Á´ôÂßø„ÄÇ','Ê≤øÂºßÁ∑öÂ∞áÂÖ©ÊâãÂêë‰∏ãÂêë‰∏≠Êî∂ÔºåÂú®‰∏≠Èñì‰∫§ÂèâÂ§æÁ∑äÂÅúÈ†ì1Áßí„ÄÇ','Á∑©ÊÖ¢ÂõûÂà∞Ëµ∑Âßã‰ΩçÁΩÆ„ÄÇ'],
    tips:['Âãï‰ΩúÂÖ®Á®ã‰øùÊåÅÊ†∏ÂøÉÁ©©ÂÆö', 'Â§æÁ∑äÊôÇÂèØÂÅöÂ∞èÂπÖ‰∫§ÂèâÂä†Âº∑Êî∂Á∏Æ'] },
  { id:'b5', name:'ÈõôÊßìÊíêÈ´î', muscle:'ËÉ∏ÈÉ®', equipment:'ÂæíÊâã', difficulty:'‰∏≠Á¥ö',
    desc:'Âà©Áî®Ëá™Ë∫´È´îÈáçË®ìÁ∑¥‰∏ãËÉ∏Ëàá‰∏âÈ†≠ÔºåÈúÄÊúâ‰∏ÄÂÆöÂü∫Á§é„ÄÇ',
    muscles:['ËÉ∏Â§ßËÇå‰∏ãÊùüÔºà‰∏ªÔºâ','‰∏âÈ†≠ËÇå','‰∏âËßíËÇåÂâçÊùü'],
    steps:['Êè°‰ΩèÈõôÊßìÔºåÈõôËáÇÊíêËµ∑Ë∫´È´î„ÄÇ','Ë∫´È´îÁï•ÂæÆÂâçÂÇæÔºåÁ∑©ÊÖ¢‰∏ãÊ≤âËá≥ÊâãËÇò90Â∫¶„ÄÇ','ÊíêËµ∑ÂõûÂà∞Ëµ∑ÈªûÔºåÈÅøÂÖçÈéñÊ≠ªÊâãËÇò„ÄÇ'],
    tips:['ÂâçÂÇæËßíÂ∫¶Ë∂äÂ§ßË∂äÈáùÂ∞çËÉ∏ËÇå', 'Ëã•Ë¶∫ÂæóÂõ∞Èõ£ÂèØÂÖàÁî®ËºîÂä©Â∏∂'] },
  { id:'b6', name:'‰ºèÂú∞Êå∫Ë∫´', muscle:'ËÉ∏ÈÉ®', equipment:'ÂæíÊâã', difficulty:'ÂàùÁ¥ö',
    desc:'ÂÖ®Ë∫´ÊÄßÊé®ÂäõÂãï‰ΩúÔºåÈö®ÊôÇÈö®Âú∞ÂèØ‰ª•Á∑¥Áøí„ÄÇ',
    muscles:['ËÉ∏Â§ßËÇå','‰∏âÈ†≠ËÇå','‰∏âËßíËÇåÂâçÊùü','Ê†∏ÂøÉ'],
    steps:['ÈõôÊâãÁï•ÂØ¨ÊñºËÇ©ÔºåËÖ≥Ë∂æÊíêÂú∞ÔºåË∫´È´îÂëà‰∏ÄÁõ¥Á∑ö„ÄÇ','Á∑©ÊÖ¢‰∏ãÈôçËá≥ËÉ∏ÈÉ®Êé•ËøëÂú∞Èù¢„ÄÇ','Áî®ÂäõÊé®Ëµ∑Ôºå‰∏çË¶ÅËÅ≥ËÇ©„ÄÇ'],
    tips:['Ê†∏ÂøÉÂÖ®Á®ãÊî∂Á∑äÈÅøÂÖçÂ°åËÖ∞', 'ÂØ¨ÊâãË∑ùÂÅèËÉ∏ÔºåÁ™ÑÊâãË∑ùÂÅè‰∏âÈ†≠'] },

  // BACK
  { id:'c1', name:'ÊßìÈà¥Á°¨Ëàâ', muscle:'ËÉåÈÉ®', equipment:'ÊßìÈà¥', difficulty:'È´òÁ¥ö',
    desc:'ÂÖ®Ë∫´ÊÄßË§áÂêàÂãï‰Ωú‰πãÁéãÔºå‰∏ªË¶ÅÈçõÈçä‰∏ãËÉå„ÄÅËáÄÈÉ®ËàáËÖøÂæåËÇåÔºåÂêåÊôÇÈúÄË¶ÅÂÖ®Ë∫´ÂçîË™ø„ÄÇ',
    muscles:['Ë±éËÑäËÇåÔºà‰∏ªÔºâ','ËáÄÂ§ßËÇå','ËÖøÂæåËÇå','ÊñúÊñπËÇå'],
    steps:['Á´ôÂú®ÊßìÈà¥ÂâçÔºåÈõôËÖ≥ËàáËÇ©ÂêåÂØ¨ÔºåËÖ≥Â∞ñÊúùÂâç„ÄÇ','‰øØË∫´ÔºåÈõôÊâãÊè°ÊßìÔºàÊ≠£Êè°ÊàñÊ≠£ÂèçÊè°ÔºâÔºåÊâãËáÇÂûÇÁõ¥Âú∞Èù¢„ÄÇ','Ê∑±Âê∏Ê∞£ÔºåÊî∂Á∑äÊ†∏ÂøÉËàáËÉåÈÉ®Ôºå‰ª•ËáÄËÖøÂäõÈáèÂ∞áÊßìÈà¥ÊèêËµ∑„ÄÇ','Á´ôÁõ¥ÂæåËÇ©ËÉõÂ§æÁ∑äÔºåÂÜçÊéßÂà∂Âú∞Â∞áÊßìÈà¥ÊîæÂõûÂú∞Èù¢„ÄÇ'],
    tips:['ÂÖ®Á®ã‰øùÊåÅËÉåÈÉ®Âπ≥Áõ¥ÔºåÂö¥Á¶ÅÂúìËÉå', 'ÊßìÈà¥Ë≤ºËÖøÁßªÂãïÔºåÊ∏õÂ∞ëÊßìÊ°øÂäõÁü©', 'ÂàùÂ≠∏ËÄÖÂÖàÂæûËºïÈáçÈáèÊéåÊè°Âãï‰ΩúÊ®°Âºè'] },
  { id:'c2', name:'ÊßìÈà¥‰øØË∫´ÂàíËàπ', muscle:'ËÉåÈÉ®', equipment:'ÊßìÈà¥', difficulty:'‰∏≠Á¥ö',
    desc:'Â¢ûÂä†ËÉåÈÉ®ÂéöÂ∫¶ÁöÑÈªÉÈáëÂãï‰ΩúÔºå‰∏ªË¶ÅÂà∫ÊøÄËÉåÈóäËÇå‰∏≠ÈÉ®ËàáËè±ÂΩ¢ËÇå„ÄÇ',
    muscles:['ËÉåÈóäËÇåÔºà‰∏ªÔºâ','Ëè±ÂΩ¢ËÇå','‰∫åÈ†≠ËÇå'],
    steps:['‰øØË∫´Á¥Ñ45Â∫¶ÔºåËÉåÈÉ®‰øùÊåÅÂπ≥Áõ¥„ÄÇ','ÊßìÈà¥‰ΩçÊñºÈõôËÖøÈñìÔºåÈõôÊâãÊ≠£Êè°Áï•ÂØ¨ÊñºËÇ©„ÄÇ','‰ª•ËÇòÁÇ∫Ëª∏ÔºåÂ∞áÊßìÈà¥ÊèêÊãâËá≥ËÖπÈÉ®ÔºåÈ†ÇÁ´ØÂ§æÁ∑äËÉåÈÉ®„ÄÇ','Á∑©ÊÖ¢ÊîæÂõûÔºåÊÑüÂèóËÉåÈóäËÇåÊãâ‰º∏„ÄÇ'],
    tips:['ËÖ∞Ê§éË¶Å‰∏≠Á´ãÔºå‰∏çË¶ÅÂúìËÉå', 'ÊÉ≥ÂÉèÁî®ÊâãËÇòËÄåÈùûÈõôÊâãÂú®Êãâ'] },
  { id:'c3', name:'ÂºïÈ´îÂêë‰∏ä', muscle:'ËÉåÈÉ®', equipment:'ÂæíÊâã', difficulty:'È´òÁ¥ö',
    desc:'‰∏äËÇ¢ÊãâÂäõ‰πãÁéãÔºåÂ∞çËÉåÂØ¨ÁôºÂ±ïÊïàÊûúÊ•µ‰Ω≥„ÄÇ',
    muscles:['ËÉåÈóäËÇåÔºà‰∏ªÔºâ','‰∫åÈ†≠ËÇå','Ëè±ÂΩ¢ËÇå'],
    steps:['ÈõôÊâãÊ≠£Êè°ÂñÆÊßìÔºåÊè°Ë∑ùÁï•ÂØ¨ÊñºËÇ©„ÄÇ','‰ª•ËÇ©ËÉõÈ™®‰∏ãÊ≤âÁÇ∫ÂïüÂãïÔºåÂ∞áË∫´È´îÊãâËµ∑Ëá≥‰∏ãÂ∑¥Ë∂ÖÈÅéÂñÆÊßì„ÄÇ','ÊéßÂà∂Á∑©ÊÖ¢‰∏ãÈôçÔºåÂÖÖÂàÜÊãâ‰º∏ËÉåÈóäËÇå„ÄÇ'],
    tips:['ÈÅøÂÖçÂÄüÂä©ËÖøÈÉ®Áî©ÂãïÁöÑÊÖ£ÊÄß', '‰∏ãÊîæÊôÇË¶ÅÂÆåÂÖ®‰º∏Â±ïÊâãËáÇ', 'Ëã•ÂÅö‰∏çÂà∞ÂèØÂÖàÁî®ËºîÂä©Â∏∂ÊàñÈ´ò‰Ωç‰∏ãÊãâÊ©üÂô®'] },
  { id:'c4', name:'È´ò‰Ωç‰∏ãÊãâ', muscle:'ËÉåÈÉ®', equipment:'Ê©üÂô®', difficulty:'ÂàùÁ¥ö',
    desc:'ÂºïÈ´îÂêë‰∏äÁöÑÊ©üÂô®Êõø‰ª£ÁâàÔºåÈÅ©ÂêàÂàùÂ≠∏ËÄÖÊàñÈ´îÈáçËºÉÈáçËÄÖ„ÄÇ',
    muscles:['ËÉåÈóäËÇåÔºà‰∏ªÔºâ','‰∫åÈ†≠ËÇå'],
    steps:['ÂùêÂ•ΩË™øÊï¥ËÜùÂ¢äÂõ∫ÂÆöÂ§ßËÖøÔºåÊè°Ë∑ùÁï•ÂØ¨ÊñºËÇ©„ÄÇ','Â∞áÊãâÊ°øÊãâËá≥ÈéñÈ™®ÂâçÊñπÔºåÂêåÊôÇÂêëÂæå‰ª∞Á¥Ñ15Â∫¶„ÄÇ','Â§æÁ∑äËÉåÈÉ®2ÁßíÔºåÁ∑©ÊÖ¢ÊîæÂõûÂà∞Ëµ∑Âßã‰ΩçÁΩÆ„ÄÇ'],
    tips:['‰∏çË¶ÅËÆìÈáçÈáèÂ∏∂Ëëó‰Ω†ÂΩàËµ∑', 'ÊÉ≥ÂÉèÊâãËÇòÊèíÂÖ•ËÖ∞ÂåÖÁöÑÊÑüË¶∫'] },
  { id:'c5', name:'ÂùêÂßøÂàíËàπ', muscle:'ËÉåÈÉ®', equipment:'Ê©üÂô®', difficulty:'ÂàùÁ¥ö',
    desc:'ÂÆâÂÖ®ÊúâÊïàÁöÑËÉåÈÉ®ÂéöÂ∫¶Âãï‰ΩúÔºåÈÅ©ÂêàÂ≠∏ÁøíÊ≠£Á¢∫ÂàíËàπÊÑüÂèó„ÄÇ',
    muscles:['ËÉåÈóäËÇå‰∏≠ÈÉ®','Ëè±ÂΩ¢ËÇå','‰∫åÈ†≠ËÇå'],
    steps:['ÂùêÊñºÂ∫ß‰Ωç‰∏äÔºåËÖ≥Ë∏©Ë∏èÊùøÔºåËÉåÈÉ®Êå∫Áõ¥„ÄÇ','ÈõôÊâãÊè°ÊääÔºå‰ª•ËÇòÂ∏∂ÂãïÔºåÂ∞áÊääÊâãÊãâÂêëËÖπÈÉ®„ÄÇ','Â§æÁ∑äËÇ©ËÉõÈ™®ÂÅúÁïô1ÁßíÔºåÂÜçÊéßÂà∂ÊîæÂõû„ÄÇ'],
    tips:['‰∏çË¶ÅÁî®Ë∫´È´îÂ§ßÂπÖÊôÉÂãïÂÄüÂäõ', 'ÊãâÂà∞ÊúÄÂæåÊôÇÊÑüÂèóÂÖ©ÈÇäËÇ©ËÉõÈ™®‰∫íÁõ∏Â§æÁ∑ä'] },

  // LEGS
  { id:'d1', name:'ÊßìÈà¥Ê∑±Ëπ≤', muscle:'ËÖøÈÉ®', equipment:'ÊßìÈà¥', difficulty:'È´òÁ¥ö',
    desc:'‰∏ãÂçäË∫´Ë®ìÁ∑¥ÁöÑÊ†∏ÂøÉÂãï‰ΩúÔºåÂêåÊôÇÂà∫ÊøÄËÇ°ÂõõÈ†≠„ÄÅËáÄÈÉ®„ÄÅËÖøÂæåËÇåÂèäÊ†∏ÂøÉ„ÄÇ',
    muscles:['ËÇ°ÂõõÈ†≠ËÇåÔºà‰∏ªÔºâ','ËáÄÂ§ßËÇå','ËÖøÂæåËÇå','Ê†∏ÂøÉ'],
    steps:['Â∞áÊßìÈà¥ÁΩÆÊñºÊñúÊñπËÇå‰∏äÊñπÔºåÈõôËÖ≥ËàáËÇ©ÂêåÂØ¨ÔºåËÖ≥Â∞ñÁï•ÊúùÂ§ñ„ÄÇ','Ê∑±Âê∏Ê∞£ÔºåÊ†∏ÂøÉÊî∂Á∑äÔºåÁ∑©ÊÖ¢Â±àËÜù‰∏ãËπ≤„ÄÇ','Â§ßËÖøËá≥Â∞ëÂπ≥Ë°åÂú∞Èù¢ÔºåËÜùËìãÂ∞çÊ∫ñËÖ≥Â∞ñÊñπÂêë„ÄÇ','Áî®ÂäõÁ´ôËµ∑ÔºåÂëºÊ∞£ÔºåÈÅøÂÖçËÜùËìãÂÖßÊâ£„ÄÇ'],
    tips:['ËÖ∞Ê§é‰øùÊåÅ‰∏≠Á´ãÔºåÂö¥Á¶ÅÂúìËÖ∞', 'ÂèØÂÖàÂæûÈ´òÁÆ±Ê∑±Ëπ≤ÊàñËá™ÈáçÊ∑±Ëπ≤ÈñãÂßã', 'Ë¶ñÁ∑ö‰øùÊåÅÂâçÊñπÂÅè‰∏äÊñπ'] },
  { id:'d2', name:'ËÖøËàâÊ©ü', muscle:'ËÖøÈÉ®', equipment:'Ê©üÂô®', difficulty:'ÂàùÁ¥ö',
    desc:'ÂÆâÂÖ®ÊúâÊïàË®ìÁ∑¥ËÇ°ÂõõÈ†≠ÁöÑÂãï‰ΩúÔºåÈÅ©ÂêàÂ§ßÈáçÈáèÂà∫ÊøÄ„ÄÇ',
    muscles:['ËÇ°ÂõõÈ†≠ËÇåÔºà‰∏ªÔºâ','ËáÄÂ§ßËÇå'],
    steps:['ÂùêÂ•ΩË™øÊï¥Èù†ËÉåÔºåÈõôËÖ≥Ë∏©Ë∏èÊùøËàáËÇ©ÂêåÂØ¨„ÄÇ','Á∑©ÊÖ¢ÂΩéÊõ≤ËÜùËìãËá≥Êé•ËøëËÉ∏Âè£„ÄÇ','Áî®ÂäõËπ¨Âá∫Ôºå‰∏çË¶ÅÈéñÊ≠ªËÜùËìã„ÄÇ'],
    tips:['ËÖ≥‰ΩçË∂ä‰ΩéË∂äÈáùÂ∞çËÇ°ÂõõÈ†≠', 'ËÖ≥‰ΩçË∂äÈ´òË∂äÈáùÂ∞çËáÄÂ§ßËÇåËàáËÖøÂæå'] },
  { id:'d3', name:'ÁæÖÈ¶¨Â∞º‰∫ûÁ°¨Ëàâ', muscle:'ËÖøÈÉ®', equipment:'ÊßìÈà¥', difficulty:'‰∏≠Á¥ö',
    desc:'‰∏ªË¶ÅÈáùÂ∞çËÖøÂæåËÇåËàáËáÄÈÉ®ÁöÑÈâ∏ÈèàÂãï‰Ωú„ÄÇ',
    muscles:['ËÖøÂæåËÇåÔºà‰∏ªÔºâ','ËáÄÂ§ßËÇå','Ë±éËÑäËÇå'],
    steps:['Á´ôÁõ¥ÊåÅÊßìÈà¥ÔºåÈõôËÖ≥ËàáÈ´ñÂêåÂØ¨„ÄÇ','‰ª•È´ñÁÇ∫Ëª∏ÔºåÂ±àÈ´ñ‰øØË∫´ÔºåÊßìÈà¥Ë≤ºËÖø‰∏ãÊªë„ÄÇ','ÊÑüÂèóËÖøÂæåÂÖÖÂàÜÊãâ‰º∏ÂæåÔºåÂïüÂãïËáÄÈÉ®Êé®È´ñÁ´ôËµ∑„ÄÇ'],
    tips:['ÂÖ®Á®ãËÜùËìãÂè™ÂæÆÂΩéÔºåÂãøËÆäÊàêÊ∑±Ëπ≤', '‰øØË∫´ÊôÇ‰øùÊåÅËÉåÈÉ®‰∏≠Á´ã'] },
  { id:'d4', name:'Ë∑®Ê≠•Ëπ≤', muscle:'ËÖøÈÉ®', equipment:'ÂïûÈà¥', difficulty:'ÂàùÁ¥ö',
    desc:'ÂñÆËÖøË®ìÁ∑¥ÂèØÁüØÊ≠£Â∑¶Âè≥ËÇåÂäõÂ§±Ë°°ÔºåÂêåÊôÇË®ìÁ∑¥Âπ≥Ë°°„ÄÇ',
    muscles:['ËÇ°ÂõõÈ†≠ËÇå','ËáÄÂ§ßËÇå','ËÖøÂæåËÇå'],
    steps:['ÈõôÊâãÊåÅÂïûÈà¥Ôºå‰∏ÄËÖ≥ÂêëÂâçË∑®‰∏ÄÂ§ßÊ≠•„ÄÇ','ÂæåËÜùÂêëÂú∞Èù¢‰∏ãÊ≤âÔºåÂâçËÜùÁ∂≠ÊåÅÂú®ËÖ≥Ë∏ùÊ≠£‰∏äÊñπ„ÄÇ','Êé®ÂõûÁ´ôÁ´ãÔºåÊèõËÖ≥ÈáçË§á„ÄÇ'],
    tips:['Ê≠•‰ºêË¶ÅÂ§†Â§ßÔºåÈÅøÂÖçÂâçËÜùË∂ÖÈÅéËÖ≥Â∞ñÂ§™Â§ö', 'Ê†∏ÂøÉÊî∂Á∑ä‰øùÊåÅ‰∏äË∫´Áõ¥Á´ã'] },
  { id:'d5', name:'ËÖøÂΩéËàâ', muscle:'ËÖøÈÉ®', equipment:'Ê©üÂô®', difficulty:'ÂàùÁ¥ö',
    desc:'Â≠§Á´ãË®ìÁ∑¥ËÖøÂæåËÇåÁöÑÊúÄ‰Ω≥Ê©üÂô®Âãï‰Ωú„ÄÇ',
    muscles:['ËÖøÂæåËÇåÔºà‰∏ªÔºâ'],
    steps:['‰øØËá•ÊñºÊ©üÂô®‰∏äÔºåËÖ≥Ë∏ùÁΩÆÊñºÊªæËº™‰∏ãÊñπ„ÄÇ','Â∞áËÖ≥Ë∏ùÂêëËáÄÈÉ®ÊñπÂêëÂΩéÊõ≤ÔºåÈ†ÇÁ´ØÂÅúÁïô1Áßí„ÄÇ','Á∑©ÊÖ¢ÊîæÂõû„ÄÇ'],
    tips:['ÈÅøÂÖçËáÄÈÉ®Êä¨Ëµ∑ÂÄüÂäõ', 'È†ÇÁ´ØÁõ°ÈáèËÆìËÖøÂæåÂÆåÂÖ®Êî∂Á∏Æ'] },

  // SHOULDERS
  { id:'e1', name:'ÊßìÈà¥ËÇ©Êé®', muscle:'ËÇ©ÈÉ®', equipment:'ÊßìÈà¥', difficulty:'‰∏≠Á¥ö',
    desc:'ËÇ©ÈÉ®Ë®ìÁ∑¥ÁöÑÂü∫Á§éË§áÂêàÂãï‰ΩúÔºå‰∏ªË¶ÅÂà∫ÊøÄ‰∏âËßíËÇåÂâçÊùüËàá‰∏≠Êùü„ÄÇ',
    muscles:['‰∏âËßíËÇåÔºà‰∏ªÔºâ','‰∏âÈ†≠ËÇå','ÊñúÊñπËÇå'],
    steps:['ÂùêÂßøÊàñÁ´ôÂßøÂùáÂèØÔºåÂ∞áÊßìÈà¥ÁΩÆÊñºÈéñÈ™®‰ΩçÁΩÆ„ÄÇ','Ê∑±Âê∏Ê∞£ÔºåÊ†∏ÂøÉÊî∂Á∑äÔºåÁî®ÂäõÂêë‰∏äÊé®Ëµ∑„ÄÇ','È†ÇÁ´Ø‰∏âËßíËÇåÂÆåÂÖ®Êî∂Á∏ÆÔºåÁ∑©ÊÖ¢‰∏ãÊîæ„ÄÇ'],
    tips:['‰∏çË¶ÅÈÅéÂ∫¶Âæå‰ª∞ÂÄüÂäõ', 'ÊéßÂà∂‰∏ãÊîæÈÄüÂ∫¶ÔºåÊÑüÂèó‰∏âËßíËÇåÈõ¢ÂøÉÊî∂Á∏Æ'] },
  { id:'e2', name:'ÂïûÈà¥ÂÅ¥Âπ≥Ëàâ', muscle:'ËÇ©ÈÉ®', equipment:'ÂïûÈà¥', difficulty:'ÂàùÁ¥ö',
    desc:'ÁôºÂ±ï‰∏âËßíËÇå‰∏≠Êùü„ÄÅËÆìËÇ©ËÜÄÊõ¥ÂØ¨ÁöÑÈóúÈçµÂãï‰Ωú„ÄÇ',
    muscles:['‰∏âËßíËÇå‰∏≠ÊùüÔºà‰∏ªÔºâ'],
    steps:['Á´ôÁõ¥ÊåÅÂïûÈà¥ÔºåÊâãËáÇÂæÆÂΩé„ÄÇ','‰ª•ËÇ©ÁÇ∫Ëª∏ÔºåÂ∞áÊâãËáÇÂêëÂÖ©ÂÅ¥ËàâËµ∑Ëá≥ËÇ©ËÜÄÈ´òÂ∫¶„ÄÇ','Â∞èÊåáÁï•È´òÊñºÊãáÊåáÔºåÁ∑©ÊÖ¢ÊîæÂõû„ÄÇ'],
    tips:['‰∏çË¶ÅÂÄüÂä©Ë∫´È´îÊêñÊôÉ', 'ËàâÂà∞ËÇ©ËÜÄÈ´òÂ∫¶Âç≥ÂèØÔºåÈÅéÈ´òÊúÉËΩâÁßªËá≥ÊñúÊñπËÇå', 'ÈáçÈáè‰∏çÁî®Â§ßÔºåÊÑüÂèóÊúÄÈáçË¶Å'] },
  { id:'e3', name:'‰øØË∫´ÂÅ¥Âπ≥Ëàâ', muscle:'ËÇ©ÈÉ®', equipment:'ÂïûÈà¥', difficulty:'ÂàùÁ¥ö',
    desc:'ÈçõÈçä‰∏âËßíËÇåÂæåÊùüÔºåÊîπÂñÑÂúìËÇ©È´îÊÖã„ÄÇ',
    muscles:['‰∏âËßíËÇåÂæåÊùüÔºà‰∏ªÔºâ','Ëè±ÂΩ¢ËÇå'],
    steps:['‰øØË∫´Á¥Ñ90Â∫¶ÔºåÈõôËÜùÂæÆÂΩé„ÄÇ','ÈõôÊâãÊåÅÂïûÈà¥Ëá™ÁÑ∂ÂûÇ‰∏ã„ÄÇ','‰ª•ËÇ©ÁÇ∫Ëª∏ÔºåÂêëÂÖ©ÂÅ¥ËàâËµ∑ÂïûÈà¥Ëá≥ËÇ©È´ò„ÄÇ','Á∑©ÊÖ¢ÊîæÂõû„ÄÇ'],
    tips:['ÊÉ≥ÂÉèÂÖ©ÈöªÊâãËÇòÂêëÂ§©Ëä±ÊùøËàâËµ∑', 'ÈÅøÂÖçÁî®ÂäõÁî©Âãï'] },
  { id:'e4', name:'ÂïûÈà¥ËÇ©Êé®', muscle:'ËÇ©ÈÉ®', equipment:'ÂïûÈà¥', difficulty:'ÂàùÁ¥ö',
    desc:'ÊØîÊßìÈà¥ËÇ©Êé®Ê¥ªÂãïÁØÑÂúçÊõ¥Â§ßÔºåÂèØÂº∑ÂåñËÇåËÇâÈÄ£ÁµêÊÑü„ÄÇ',
    muscles:['‰∏âËßíËÇåÔºà‰∏ªÔºâ','‰∏âÈ†≠ËÇå'],
    steps:['ÂùêÂßøÔºåÂïûÈà¥ÁΩÆÊñºËÇ©ÊóÅÔºåÊéåÂøÉÊúùÂâç„ÄÇ','Âêë‰∏äÊé®Ëµ∑ÔºåÈ†ÇÁ´ØÂïûÈà¥Áï•ÂæÆÈù†Ëøë‰ΩÜ‰∏çÁõ∏Á¢∞„ÄÇ','Á∑©ÊÖ¢‰∏ãÊîæËá≥Ëµ∑Âßã‰ΩçÁΩÆ„ÄÇ'],
    tips:['ÂèØ‰ª•Âú®È†ÇÁ´ØÁ®çÂæÆÊóãËÖïÂ¢ûÂä†Âà∫ÊøÄ', 'Á¢∫‰øùÂùêÂßøÁ©©ÂÆöÔºåËÖ∞ËÉå‰∏çË¶ÅÊá∏Á©∫'] },

  // ARMS
  { id:'f1', name:'ÊßìÈà¥ÂΩéËàâ', muscle:'ÊâãËáÇ', equipment:'ÊßìÈà¥', difficulty:'ÂàùÁ¥ö',
    desc:'ÊúÄÂü∫Á§é‰∏îÊúÄÊúâÊïàÁöÑ‰∫åÈ†≠ËÇåË®ìÁ∑¥Âãï‰Ωú„ÄÇ',
    muscles:['ËÇ±‰∫åÈ†≠ËÇåÔºà‰∏ªÔºâ','ËÇ±ËÇå'],
    steps:['Á´ôÁõ¥ÔºåÈõôÊâãÊ≠£Êè°ÊßìÈà¥ÔºåËàáËÇ©ÂêåÂØ¨„ÄÇ','‰ª•ËÇòÁÇ∫Ëª∏ÔºåÂ∞áÊßìÈà¥Âêë‰∏äÂΩéËµ∑Ëá≥‰∫åÈ†≠ÂÆåÂÖ®Êî∂Á∏Æ„ÄÇ','Á∑©ÊÖ¢ÊîæÂõûÔºåÂÆåÂÖ®‰º∏Â±ï‰∫åÈ†≠ËÇå„ÄÇ'],
    tips:['ÊâãËÇò‰øùÊåÅÂõ∫ÂÆöÂú®È´îÂÅ¥Ôºå‰∏çË¶ÅÂâçÂæåÊì∫Âãï', 'È†ÇÁ´ØÂÅúÁïô1ÁßíÊÑüÂèóÊî∂Á∏Æ'] },
  { id:'f2', name:'Á™ÑÊè°Ëá•Êé®', muscle:'ÊâãËáÇ', equipment:'ÊßìÈà¥', difficulty:'‰∏≠Á¥ö',
    desc:'‰∏âÈ†≠ËÇåÁöÑË§áÂêàÂãï‰ΩúÔºåÂêåÊôÇÊúâ‰∏ÄÂÆöÁöÑËÉ∏ËÇåÂà∫ÊøÄ„ÄÇ',
    muscles:['ËÇ±‰∏âÈ†≠ËÇåÔºà‰∏ªÔºâ','ËÉ∏Â§ßËÇåÂÖßÂÅ¥'],
    steps:['Êè°Ë∑ùÁ¥ÑËàáËÇ©ÂêåÂØ¨ÊàñÁï•Á™Ñ„ÄÇ','‰∏ãÊîæÊßìÈà¥Ëá≥ËÉ∏Âè£ÔºåËÇòÈóúÁØÄ‰øùÊåÅÁ∑äÈù†Ë∫´È´î„ÄÇ','Êé®Ëµ∑ÈéñÊ≠ªÔºåÊÑüÂèó‰∏âÈ†≠ËÇåÂÆåÂÖ®Êî∂Á∏Æ„ÄÇ'],
    tips:['ÊâãËÖïË¶Å‰øùÊåÅ‰∏≠Á´ãÔºå‰∏çÈÅéÂ∫¶Â§ñÁøª', '‰∏ãÊîæÊôÇÊâãËÇò‰∏çË¶ÅÂ§ñÂ±ïÈÅéÂ§ö'] },
  { id:'f3', name:'Áπ©Á¥¢‰∏ãÂ£ì', muscle:'ÊâãËáÇ', equipment:'Áπ©Á¥¢', difficulty:'ÂàùÁ¥ö',
    desc:'‰∏âÈ†≠ËÇåÂ≠§Á´ãÂãï‰ΩúÔºåÂÖ®Á®ã‰øùÊåÅÂºµÂäõ„ÄÇ',
    muscles:['ËÇ±‰∏âÈ†≠ËÇåÔºà‰∏ªÔºâ'],
    steps:['Á´ôÊñºÁπ©Á¥¢Ê©üÂâçÔºåÈõôÊâãÊè°‰ΩèVÂΩ¢ÊàñÁπ©Á¥¢ÊääÊâã„ÄÇ','ÈõôËáÇÂ§æÁ∑äÈ´îÂÅ¥ÔºåÂêë‰∏ã‰º∏Áõ¥ÊâãËáÇ„ÄÇ','È†ÇÁ´Ø‰∏âÈ†≠ÂÆåÂÖ®ÈéñÊ≠ªÂÅúÁïô1ÁßíÔºåÁ∑©ÊÖ¢ÂõûÊîæ„ÄÇ'],
    tips:['‰∏äËáÇÂøÖÈ†à‰øùÊåÅÈùúÊ≠¢‰∏çÂãï', '‰∏ãÂ£ìÂà∞ÂÆåÂÖ®‰º∏Áõ¥ÊâçËÉΩÂÖÖÂàÜÊî∂Á∏Æ‰∏âÈ†≠'] },
  { id:'f4', name:'ÈåòÂºèÂΩéËàâ', muscle:'ÊâãËáÇ', equipment:'ÂïûÈà¥', difficulty:'ÂàùÁ¥ö',
    desc:'ÂêåÊôÇÂà∫ÊøÄ‰∫åÈ†≠ËÇåËàáËÇ±Ê©àËÇåÔºåËÆìÊâãËáÇÊõ¥È£ΩÊªø„ÄÇ',
    muscles:['ËÇ±‰∫åÈ†≠ËÇå','ËÇ±Ê©àËÇåÔºà‰∏ªÔºâ'],
    steps:['ÈõôÊâãÊåÅÂïûÈà¥ÔºåÊéåÂøÉÁõ∏Â∞çÔºà‰∏≠Á´ãÊè°Ê≥ïÔºâ„ÄÇ','‰ª•ËÇòÁÇ∫Ëª∏ÔºåÂ∞áÂïûÈà¥Âêë‰∏äÂΩéËµ∑„ÄÇ','Á∑©ÊÖ¢ÊîæÂõûÂÆåÂÖ®‰º∏Â±ï„ÄÇ'],
    tips:['ÊéåÂøÉÂÖ®Á®ã‰øùÊåÅÁõ∏Â∞çÔºå‰∏çË¶ÅÊóãËΩâ', 'ÂèØ‰ª•‰∫§ÊõøÊàñÂêåÊôÇÈÄ≤Ë°å'] },

  // CORE
  { id:'g1', name:'Âç∑ËÖπ', muscle:'Ê†∏ÂøÉ', equipment:'ÂæíÊâã', difficulty:'ÂàùÁ¥ö',
    desc:'ÈáùÂ∞çËÖπÁõ¥ËÇå‰∏äÊÆµÁöÑÂü∫Á§éÂãï‰Ωú„ÄÇ',
    muscles:['ËÖπÁõ¥ËÇåÔºà‰∏ªÔºâ'],
    steps:['‰ª∞Ëá•ÔºåÈõôËÜùÂΩéÊõ≤ÔºåÈõôÊâãÊîæÊñºËÄ≥ÊóÅÊàñ‰∫§ÂèâËÉ∏Ââç„ÄÇ','Êî∂Á∏ÆËÖπËÇåÔºåÂ∞áËÇ©ËÉõÈ™®Êä¨Èõ¢Âú∞Èù¢„ÄÇ','È†ÇÁ´ØÂÅúÁïô1ÁßíÔºåÁ∑©ÊÖ¢ÊîæÂõûÔºå‰∏çË¶ÅËÆìÈ†≠ÈÉ®Á¢∞Âú∞„ÄÇ'],
    tips:['‰∏çÊòØ‰ª∞Ëá•Ëµ∑ÂùêÔºåÂè™ÈúÄÊä¨Ëµ∑‰∏äËÉå', 'È†∏ÈÉ®ÊîæÈ¨ÜÔºåÁî®ËÖπÈÉ®ÁôºÂäõ', 'ÂëºÊ∞£ÊôÇÁî®ÂäõÊî∂Á∏Æ'] },
  { id:'g2', name:'Âπ≥ÊùøÊîØÊíê', muscle:'Ê†∏ÂøÉ', equipment:'ÂæíÊâã', difficulty:'ÂàùÁ¥ö',
    desc:'ÈùúÊÖãÊ†∏ÂøÉÁ©©ÂÆöË®ìÁ∑¥ÔºåË®ìÁ∑¥Ê∑±Â±§Ê†∏ÂøÉËÇåÁæ§„ÄÇ',
    muscles:['ËÖπÊ©´ËÇåÔºà‰∏ªÔºâ','Ë±éËÑäËÇå','ËáÄËÇå'],
    steps:['ÂâçËáÇÊíêÂú∞ÔºåÊâãËÇòÂú®ËÇ©ËÜÄÊ≠£‰∏ãÊñπ„ÄÇ','ËÖ≥Ë∂æÊíêÂú∞ÔºåË∫´È´îÂëà‰∏ÄÁõ¥Á∑ö„ÄÇ','Êî∂Á∑äÊ†∏ÂøÉËàáËáÄËÇåÔºå‰øùÊåÅÂëºÂê∏„ÄÇ'],
    tips:['‰∏çË¶ÅËÆìËÖ∞ÈÉ®‰∏ãÊ≤âÊàñËáÄÈÉ®Êä¨È´ò', 'ÁõÆË¶ñÂú∞Èù¢‰øùÊåÅÈ†∏Ê§é‰∏≠Á´ã', 'ÂàùÂ≠∏ËÄÖÂæû30ÁßíÈñãÂßã'] },
  { id:'g3', name:'‰øÑÁæÖÊñØËΩâÈ´î', muscle:'Ê†∏ÂøÉ', equipment:'ÂæíÊâã', difficulty:'ÂàùÁ¥ö',
    desc:'Âº∑ÂåñËÖπÊñúËÇåÁöÑÊóãËΩâÂãï‰Ωú„ÄÇ',
    muscles:['ËÖπÂ§ñÊñúËÇåÔºà‰∏ªÔºâ','ËÖπÂÖßÊñúËÇå'],
    steps:['ÂùêÂú®Âú∞‰∏äÔºåÈõôËÖøÂΩéÊõ≤Êä¨Ëµ∑ÔºåË∫´È´îÂæå‰ª∞ÂëàVÂûã„ÄÇ','ÈõôÊâãÂêàÂçÅÔºåÂêëÂ∑¶Âè≥ÂÖ©ÂÅ¥Ëº™ÊµÅËß∏Á¢∞Âú∞Èù¢„ÄÇ'],
    tips:['ÂèØÊâãÊåÅÂïûÈà¥Â¢ûÂä†ÈòªÂäõ', 'ÊóãËΩâ‰æÜËá™ËÖ∞ÈÉ®ËÄåÈùûÊâãËáÇ'] },
  { id:'g4', name:'Êá∏ÂêäËàâËÖø', muscle:'Ê†∏ÂøÉ', equipment:'ÂæíÊâã', difficulty:'‰∏≠Á¥ö',
    desc:'Âº∑ÂåñËÖπÁõ¥ËÇå‰∏ãÊÆµÁöÑÈÄ≤ÈöéÂãï‰Ωú„ÄÇ',
    muscles:['ËÖπÁõ¥ËÇå‰∏ãÊÆµÔºà‰∏ªÔºâ','È´ÇËÖ∞ËÇå'],
    steps:['Êá∏ÊéõÊñºÂñÆÊßì‰∏äÔºåÈõôËÖø‰∏¶Êîè„ÄÇ','Êî∂Á∏ÆËÖπËÇåÔºåÂ∞áÈõôËÖøÊä¨Ëµ∑Ëá≥Ê∞¥Âπ≥ÊàñÊõ¥È´ò„ÄÇ','Á∑©ÊÖ¢ÊîæÂõûÔºå‰∏çË¶ÅËÆìË∫´È´îÂ§ßÂπÖÊì∫Áõ™„ÄÇ'],
    tips:['Ëã•ÂÅö‰∏çÂà∞Áõ¥ËÖøÔºåÂÖàÂæûÂΩéËÖøÁâàÊú¨ÈñãÂßã', 'ÈÅøÂÖç‰æùÈù†ÊÖ£ÊÄßÁî©ËÖø'] },

  // CARDIO
  { id:'h1', name:'Ë∑ëÊ≠•Ê©üÊÖ¢Ë∑ë', muscle:'ÊúâÊ∞ß', equipment:'Ê©üÂô®', difficulty:'ÂàùÁ¥ö',
    desc:'ÊúÄÊôÆÂèäÁöÑÊúâÊ∞ßË®ìÁ∑¥ÔºåÂèØÊîπÂñÑÂøÉËÇ∫ÂäüËÉΩËàáÁáÉÁáíËÑÇËÇ™„ÄÇ',
    muscles:['ÂÖ®Ë∫´'],
    steps:['Ë®≠ÂÆöÈÄüÂ∫¶ÂæûÊ≠•Ë°åÈñãÂßãÔºåÈÄêÊº∏ÊèêÂçáËá≥ÊÖ¢Ë∑ëÈÄüÂ∫¶„ÄÇ','Á∂≠ÊåÅËºïÈ¨ÜÂèØÂ∞çË©±ÁöÑÂº∑Â∫¶ÔºàÂøÉÁéáÁ¥Ñ65-75% ÊúÄÂ§ßÂøÉÁéáÔºâ„ÄÇ','ÈÄêÊº∏ÂÜ∑ÂçªÔºåÊ∏õÈÄüËá≥Ê≠•Ë°åÁµêÊùü„ÄÇ'],
    tips:['‰øùÊåÅ‰∏äË∫´Áõ¥Á´ãÔºå‰∏çË¶ÅÂâçÂÇæÊäìÊâ∂Êâã', 'Á©øËëóÂêàÈÅ©Ë∑ëÈûã', 'ÊØèÈÄ±Ëá≥Â∞ëÈÄ≤Ë°å3Ê¨°ÔºåÊØèÊ¨°30ÂàÜÈêò‰ª•‰∏ä'] },
  { id:'h2', name:'Ë∑≥Áπ©', muscle:'ÊúâÊ∞ß', equipment:'ÂæíÊâã', difficulty:'ÂàùÁ¥ö',
    desc:'È´òÊïà‰æøÊç∑ÁöÑÊúâÊ∞ßË®ìÁ∑¥ÔºåÁÜ±ÈáèÊ∂àËÄóÈ´ò„ÄÇ',
    muscles:['ÂÖ®Ë∫´','Â∞èËÖø'],
    steps:['ÈõôÊâãÊè°‰ΩèË∑≥Áπ©ÊääÊüÑÔºåÁπ©Â≠êÂú®Ë∫´Âæå„ÄÇ','Â∞èËáÇÂ∏∂ÂãïÊâãËÖïÊóãËΩâÁî©Áπ©„ÄÇ','ÈõôËÖ≥Á®çÂæÆË∑≥Ëµ∑ËÆìÁπ©Â≠êÈÄöÈÅéÔºå‰øùÊåÅËºïÁõàËêΩÂú∞„ÄÇ'],
    tips:['ËêΩÂú∞ÊôÇÁî®ÂâçËÖ≥ÊéåÁ∑©Ë°ùÔºå‰øùË≠∑ËÜùËìã', 'ÂàùÂ≠∏ËÄÖÂÖàÁ∑¥ÁøíÂñÆÊ¨°Ë∑≥ÔºåÂÜçÈÄ£Á∫åË∑≥', 'ÊØèÊ¨°10-15ÂàÜÈêòÂç≥ÂèØÊúâÊïàÈçõÈçä'] },
  { id:'h3', name:'ÂàíËàπÊ©ü', muscle:'ÊúâÊ∞ß', equipment:'Ê©üÂô®', difficulty:'ÂàùÁ¥ö',
    desc:'ÂÖ®Ë∫´ÊÄßÊúâÊ∞ßË®ìÁ∑¥ÔºåÂêåÊôÇÈçõÈçä‰∏ä‰∏ãÂçäË∫´ËàáÊ†∏ÂøÉ„ÄÇ',
    muscles:['ÂÖ®Ë∫´','ËÉåÈÉ®','ËÖøÈÉ®'],
    steps:['Âõ∫ÂÆöËÖ≥Ë∏ùÔºåÊâãÊè°ÊääÊâãÔºåË∫´È´îÂæÆÂâçÂÇæ„ÄÇ','ËÖøÂÖàËπ¨ÔºåÁÑ∂ÂæåË∫´È´îÂæåÂÇæÔºåÊúÄÂæåÊâãËáÇÊãâÂêëËÖπÈÉ®„ÄÇ','ÈÄÜÂ∫èÊîæÂõûÔºöÊâãËáÇÂÖà‰º∏ÔºåË∫´È´îÂâçÂÇæÔºåËÖøÂÜçÂΩéÊõ≤„ÄÇ'],
    tips:['Ë®ò‰ΩèÈ†ÜÂ∫èÔºöÊé®ËÖø‚ÜíÂæå‰ª∞‚ÜíÊãâÊâã', 'ÊØèÂàÜÈêòÂàí20-30Ê¨°ÊòØÈÅ©‰∏≠ÈÄüÂ∫¶'] },
];

// populate exercise name datalist
function populateExDatalist() {
  const dl = document.getElementById('exNameDatalist');
  if (dl) dl.innerHTML = EXERCISES.map(e => `<option value="${e.name}">`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORKOUT TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let timerState = 'idle'; // idle | running | paused
let timerSeconds = 0;
let timerInterval = null;
let workoutExercises = []; // [{name, sets:[{weight,reps,rpe,done}]}]
let currentWorkoutType = '';

function timerStart() {
  timerState = 'running';
  timerInterval = setInterval(timerTick, 1000);
  updateTimerUI();
}

function timerPause() {
  timerState = 'paused';
  clearInterval(timerInterval);
  updateTimerUI();
}

function timerResume() {
  timerState = 'running';
  timerInterval = setInterval(timerTick, 1000);
  updateTimerUI();
}

function timerStop() {
  if (timerSeconds === 0) { showToast('Ë´ãÂÖàÈñãÂßãË®àÊôÇ'); return; }
  clearInterval(timerInterval);
  timerState = 'idle';
  // auto-save to log
  autoSaveWorkout();
}

function timerTick() {
  timerSeconds++;
  updateTimerClock();
  updateCaloriesEstimate();
}

function pad(n) { return String(n).padStart(2,'0'); }

function updateTimerClock() {
  const h = Math.floor(timerSeconds/3600);
  const m = Math.floor((timerSeconds%3600)/60);
  const s = timerSeconds%60;
  document.getElementById('timerClock').textContent = h>0
    ? `${pad(h)}:${pad(m)}:${pad(s)}`
    : `${pad(m)}:${pad(s)}`;
}

function updateTimerUI() {
  const dot = document.getElementById('timerDot');
  const label = document.getElementById('timerStatusLabel');
  const sub = document.getElementById('timerSubLabel');
  const ctrl = document.getElementById('timerControls');

  if (timerState === 'running') {
    dot.className = 'status-dot running';
    label.textContent = 'Ë®ìÁ∑¥ÈÄ≤Ë°å‰∏≠';
    sub.textContent = 'Ë®àÊôÇ‰∏≠...';
    ctrl.innerHTML = `
      <button class="timer-btn timer-btn-pause" onclick="timerPause()">‚è∏ Êö´ÂÅú</button>
      <button class="timer-btn timer-btn-stop" onclick="timerStop()">‚èπ ÁµêÊùü‰∏¶ÂÑ≤Â≠ò</button>`;
  } else if (timerState === 'paused') {
    dot.className = 'status-dot paused';
    label.textContent = 'Â∑≤Êö´ÂÅú';
    sub.textContent = 'Ë®ìÁ∑¥Êö´ÂÅú‰∏≠';
    ctrl.innerHTML = `
      <button class="timer-btn timer-btn-resume" onclick="timerResume()">‚ñ∂ ÁπºÁ∫å</button>
      <button class="timer-btn timer-btn-stop" onclick="timerStop()">‚èπ ÁµêÊùü‰∏¶ÂÑ≤Â≠ò</button>`;
  } else {
    dot.className = 'status-dot';
    label.textContent = 'Â∞öÊú™ÈñãÂßã';
    sub.textContent = 'ÊåâÈñãÂßãË®àÊôÇ';
    ctrl.innerHTML = `<button class="timer-btn timer-btn-start" onclick="timerStart()">‚ñ∂ ÈñãÂßã</button>`;
  }
}

function updateCaloriesEstimate() {
  const type = document.getElementById('workout-type-select').value || 'fullbody';
  const w = (data.weights[0] && data.weights[0].value) || 70;
  const cal = calcCalories(type, Math.ceil(timerSeconds/60), w);
  document.getElementById('timerCalories').textContent = cal;
}

function updateTimerStats() {
  let totalSets = 0;
  workoutExercises.forEach(ex => { totalSets += ex.sets.length; });
  document.getElementById('timerSets').textContent = totalSets;
  document.getElementById('timerExCount').textContent = workoutExercises.length;
}

function renderWorkoutTimer() {
  updateTimerUI();
  updateTimerClock();
  renderWorkoutExercises();
}

function renderWorkoutExercises() {
  const el = document.getElementById('workoutExerciseList');
  if (workoutExercises.length === 0) {
    el.innerHTML = '<div class="empty-state" style="padding:20px 0;"><div class="empty-icon">üèãÔ∏è</div>Â∞öÊú™Êñ∞Â¢ûÂãï‰Ωú<br><span style="font-size:12px;">ÈªûÊìä‰∏ãÊñπÊåâÈàïÊñ∞Â¢ûÔºåÊàñÂæûÂãï‰ΩúÂ∫´ÈÅ∏Âèñ</span></div>';
    return;
  }
  el.innerHTML = workoutExercises.map((ex, ei) => `
    <div class="workout-ex-block">
      <div class="workout-ex-header">
        <div class="workout-ex-name">${ex.name}</div>
        <button class="set-del-btn" onclick="removeWorkoutExercise(${ei})" title="ÁßªÈô§Ê≠§Âãï‰Ωú">üóë</button>
      </div>
      <div class="workout-ex-body">
        <div class="set-col-labels">
          <span>Âãï‰Ωú/ÁµÑÂà•</span><span>ÈáçÈáè(kg)</span><span>Ê¨°Êï∏</span><span class="rpe-col">RPE</span><span></span>
        </div>
        ${ex.sets.map((s, si) => `
          <div class="workout-set-row">
            <span style="font-size:12px;color:var(--text3);padding:0 4px;">Á¨¨${si+1}ÁµÑ</span>
            <input class="set-input" type="number" placeholder="kg" value="${s.weight||''}"
              onchange="updateSet(${ei},${si},'weight',this.value)">
            <input class="set-input" type="number" placeholder="Ê¨°" value="${s.reps||''}"
              onchange="updateSet(${ei},${si},'reps',this.value)">
            <input class="set-input rpe-col" type="number" placeholder="1-10" min="1" max="10" value="${s.rpe||''}"
              onchange="updateSet(${ei},${si},'rpe',this.value)">
            <button class="set-del-btn" onclick="removeSet(${ei},${si})">‚úï</button>
          </div>`).join('')}
        <button class="add-set-btn" onclick="addSet(${ei})">Ôºã Êñ∞Â¢û‰∏ÄÁµÑ</button>
      </div>
    </div>`).join('');
  updateTimerStats();
}

function addWorkoutExercise() {
  const modal = document.getElementById('addExModal');
  modal.style.display = modal.style.display === 'none' ? 'block' : 'none';
  if (modal.style.display === 'block') {
    document.getElementById('addExInput').value = '';
    filterAddExList();
    setTimeout(() => document.getElementById('addExInput').focus(), 100);
  }
}

function filterAddExList() {
  const q = document.getElementById('addExInput').value.toLowerCase();
  const filtered = EXERCISES.filter(e =>
    e.name.toLowerCase().includes(q) || e.muscle.includes(q)
  );
  const el = document.getElementById('addExSuggestions');
  el.innerHTML = filtered.slice(0,12).map(e => `
    <div onclick="selectExerciseFromList('${e.name}')" style="padding:9px 12px;cursor:pointer;border-radius:8px;font-size:13px;display:flex;justify-content:space-between;align-items:center;transition:background 0.1s;"
      onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background=''">
      <span style="font-weight:500;">${e.name}</span>
      <span style="font-size:11px;color:var(--text3);">${e.muscle} ¬∑ ${e.equipment}</span>
    </div>`).join('') || '<div style="padding:12px;color:var(--text3);font-size:13px;">Êâæ‰∏çÂà∞Âãï‰ΩúÔºåÂ∞áÊñ∞Â¢ûËá™Ë®ÇÂãï‰Ωú</div>';
}

function selectExerciseFromList(name) {
  document.getElementById('addExInput').value = name;
}

function confirmAddExercise() {
  const name = document.getElementById('addExInput').value.trim();
  if (!name) return;
  workoutExercises.push({ name, sets: [{ weight:'', reps:'', rpe:'' }] });
  document.getElementById('addExModal').style.display = 'none';
  renderWorkoutExercises();
  showToast('Â∑≤Êñ∞Â¢ûÔºö' + name);
}

function removeWorkoutExercise(ei) {
  workoutExercises.splice(ei, 1);
  renderWorkoutExercises();
}

function addSet(ei) {
  workoutExercises[ei].sets.push({ weight:'', reps:'', rpe:'' });
  renderWorkoutExercises();
}

function removeSet(ei, si) {
  if (workoutExercises[ei].sets.length <= 1) { showToast('Ëá≥Â∞ë‰øùÁïô‰∏ÄÁµÑ'); return; }
  workoutExercises[ei].sets.splice(si, 1);
  renderWorkoutExercises();
}

function updateSet(ei, si, field, val) {
  workoutExercises[ei].sets[si][field] = val;
  updateTimerStats();
}

function autoSaveWorkout() {
  const date = new Date().toISOString().split('T')[0];
  const durationMin = Math.max(1, Math.ceil(timerSeconds / 60));
  const type = document.getElementById('workout-type-select').value || 'fullbody';
  const w = (data.weights[0] && data.weights[0].value) || 70;
  const cal = calcCalories(type, durationMin, w);

  // Build exercises summary text
  const exercisesText = workoutExercises.map(ex => {
    const setsText = ex.sets
      .filter(s => s.reps)
      .map((s,i) => `Á¨¨${i+1}ÁµÑ${s.weight?` ${s.weight}kg`:''} √ó ${s.reps}Ê¨°${s.rpe?` RPE${s.rpe}`:''}`)
      .join('\n');
    return `${ex.name}:\n${setsText || '(ÁÑ°Ë≥áÊñô)'}`;
  }).join('\n\n');

  const startTime = new Date(Date.now() - timerSeconds * 1000);
  const hh = pad(startTime.getHours()), mm = pad(startTime.getMinutes());
  const endTime = new Date();
  const ehh = pad(endTime.getHours()), emm = pad(endTime.getMinutes());

  data.logs.unshift({
    id: Date.now(), date, type,
    weight: data.weights[0] ? data.weights[0].value : null,
    start: `${hh}:${mm}`,
    end: `${ehh}:${emm}`,
    exercises: exercisesText,
    notes: `ÂØ¶ÊôÇË®ìÁ∑¥ ¬∑ ${durationMin} ÂàÜÈêò`,
    calories: cal,
    duration: durationMin,
    photos: []
  });

  saveAndSync();

  // Reset timer
  timerSeconds = 0;
  workoutExercises = [];
  updateTimerClock();
  updateTimerUI();
  renderWorkoutExercises();
  showToast(`‚úì Ë®ìÁ∑¥Â∑≤ÂÑ≤Â≠òÔºÅÂÖ± ${durationMin} ÂàÜÈêòÔºåÊ∂àËÄóÁ¥Ñ ${cal} kcal`);
  navigate('history', null);
}

// Allow adding from library to workout
let currentLibraryExercise = null;

function addToWorkoutFromLibrary() {
  if (!currentLibraryExercise) return;
  workoutExercises.push({ name: currentLibraryExercise.name, sets: [{ weight:'', reps:'', rpe:'' }] });
  closeExDetail();
  navigate('workout', document.querySelector('nav a[onclick*="workout"]'));
  showToast('Â∑≤Âä†ÂÖ•Ë®ìÁ∑¥Ôºö' + currentLibraryExercise.name);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXERCISE LIBRARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLibrary() {
  const q = (document.getElementById('libSearchInput')?.value || '').toLowerCase();
  const muscleF = document.getElementById('libMuscleFilter')?.value || '';
  const typeF = document.getElementById('libTypeFilter')?.value || '';

  let filtered = EXERCISES.filter(e => {
    const matchQ = !q || e.name.toLowerCase().includes(q) || e.muscle.includes(q);
    const matchM = !muscleF || e.muscle === muscleF;
    const matchT = !typeF || e.equipment === typeF;
    return matchQ && matchM && matchT;
  });

  const el = document.getElementById('libList');
  if (!el) return;

  if (filtered.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">üîç</div>Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÁöÑÂãï‰Ωú</div>';
    return;
  }

  // Group by muscle
  const groups = {};
  filtered.forEach(e => {
    if (!groups[e.muscle]) groups[e.muscle] = [];
    groups[e.muscle].push(e);
  });

  el.innerHTML = Object.entries(groups).map(([muscle, exs]) => `
    <div style="margin-bottom:20px;">
      <div style="font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px;">${muscle}</div>
      ${exs.map(e => `
        <div class="ex-card" onclick="openExDetail('${e.id}')">
          <div class="ex-card-header">
            <div class="ex-card-name">${e.name}</div>
            <div class="ex-card-muscle">${e.muscle}</div>
          </div>
          <div class="ex-card-desc">${e.desc}</div>
          <div class="ex-card-tags">
            <span class="ex-tag">${e.equipment}</span>
            <span class="ex-tag">${e.difficulty}</span>
            ${e.muscles.slice(0,2).map(m=>`<span class="ex-tag">${m}</span>`).join('')}
          </div>
        </div>`).join('')}
    </div>`).join('');
}

function openExDetail(id) {
  const ex = EXERCISES.find(e => e.id === id);
  if (!ex) return;
  currentLibraryExercise = ex;

  document.getElementById('exDetailName').textContent = ex.name;
  document.getElementById('exDetailMuscles').innerHTML = ex.muscles.map(m =>
    `<span class="muscle-chip">${m}</span>`).join('');
  document.getElementById('exDetailContent').innerHTML = `
    <div style="margin-bottom:16px;">
      <div style="font-size:13px;font-weight:600;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">Âãï‰ΩúË™™Êòé</div>
      <div style="font-size:14px;color:var(--text2);line-height:1.6;">${ex.desc}</div>
    </div>
    <div style="margin-bottom:16px;">
      <div style="font-size:13px;font-weight:600;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">Ê≠•È©ü</div>
      ${ex.steps.map((s,i) => `
        <div class="ex-step">
          <div class="ex-step-num">${i+1}</div>
          <div class="ex-step-text">${s}</div>
        </div>`).join('')}
    </div>
    ${ex.tips ? `
    <div>
      <div style="font-size:13px;font-weight:600;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">ÊäÄÂ∑ßÊèêÁ§∫</div>
      ${ex.tips.map(t => `<div style="display:flex;gap:8px;padding:6px 0;font-size:13px;color:var(--text2);"><span style="color:var(--accent);">‚úì</span>${t}</div>`).join('')}
    </div>` : ''}
  `;

  document.getElementById('exDetailModal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeExDetail() {
  document.getElementById('exDetailModal').classList.remove('open');
  document.body.style.overflow = '';
}



// ‚îÄ‚îÄ REST TIMER ‚îÄ‚îÄ
let restDuration = 30;   // seconds selected
let restRemaining = 30;
let restRunning = false;
let restInterval = null;
let restTotal = 30;

function setRestPreset(seconds, btn) {
  document.querySelectorAll('.rest-preset-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  restDuration = seconds;
  restTotal = seconds;
  if (!restRunning) {
    restRemaining = seconds;
    updateRestClock();
    updateRestProgress(1);
  }
}

function toggleRest() {
  if (restRunning) {
    pauseRest();
  } else {
    startRest();
  }
}

function startRest() {
  if (restRemaining <= 0) {
    restRemaining = restDuration;
    restTotal = restDuration;
  }
  restRunning = true;
  document.getElementById('restStartBtn').textContent = '‚è∏ Êö´ÂÅú';
  document.getElementById('restStatusLabel').textContent = '‰ºëÊÅØ‰∏≠...';
  restInterval = setInterval(restTick, 1000);
}

function pauseRest() {
  restRunning = false;
  clearInterval(restInterval);
  document.getElementById('restStartBtn').textContent = '‚ñ∂ ÁπºÁ∫å';
  document.getElementById('restStatusLabel').textContent = 'Â∑≤Êö´ÂÅú';
}

function resetRest() {
  restRunning = false;
  clearInterval(restInterval);
  restRemaining = restDuration;
  restTotal = restDuration;
  updateRestClock();
  updateRestProgress(1);
  document.getElementById('restStartBtn').textContent = '‚ñ∂ ÈñãÂßã‰ºëÊÅØ';
  document.getElementById('restStatusLabel').textContent = 'ÈÅ∏ÊìáÊôÇÈï∑ÈñãÂßã';
  document.getElementById('restClock').classList.remove('urgent');
}

function restTick() {
  restRemaining--;
  updateRestClock();
  updateRestProgress(restRemaining / restTotal);

  if (restRemaining <= 5) {
    document.getElementById('restClock').classList.add('urgent');
  }

  if (restRemaining <= 0) {
    clearInterval(restInterval);
    restRunning = false;
    document.getElementById('restClock').classList.remove('urgent');
    document.getElementById('restStartBtn').textContent = '‚ñ∂ ÂÜç‰æÜ‰∏ÄÊ¨°';
    document.getElementById('restStatusLabel').textContent = '‰ºëÊÅØÁµêÊùüÔºÅ';
    // play a beep if possible
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      [0, 0.15, 0.3].forEach(t => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.frequency.value = 880;
        gain.gain.setValueAtTime(0.3, ctx.currentTime + t);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + t + 0.12);
        osc.start(ctx.currentTime + t);
        osc.stop(ctx.currentTime + t + 0.12);
      });
    } catch(e) {}
    showToast('‚úÖ ‰ºëÊÅØÁµêÊùüÔºåÁπºÁ∫åÂä†Ê≤πÔºÅ');
  }
}

function updateRestClock() {
  const m = Math.floor(restRemaining / 60);
  const s = restRemaining % 60;
  const el = document.getElementById('restClock');
  if (el) el.textContent = `${pad(m)}:${pad(s)}`;
}

function updateRestProgress(ratio) {
  const bar = document.getElementById('restProgressBar');
  if (!bar) return;
  bar.style.width = (ratio * 100) + '%';
  bar.className = 'rest-progress-bar' + (ratio < 0.15 ? ' urgent' : '');
}


// ‚îÄ‚îÄ MOBILE NAV ‚îÄ‚îÄ
function mobileNavigate(page, el) {
  navigate(page, null);
  document.querySelectorAll('.bottom-nav-item').forEach(i => i.classList.remove('active'));
  if (el) el.classList.add('active');
  // also sync sidebar
  document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
}

function isMobile() { return window.innerWidth <= 600; }

// Show topbar user btn on mobile
function syncTopbarUser() {
  const users = getUsers();
  const user = users.find(u => u.id === currentUserId);
  const idx = users.indexOf(user);
  const el = document.getElementById('topbarUser');
  const av = document.getElementById('topbarAvatar');
  const nm = document.getElementById('topbarUserName');
  if (el) {
    el.style.display = isMobile() ? 'flex' : 'none';
    if (user && av && nm) {
      av.textContent = initials(user.name);
      av.className = 'topbar-user-avatar ' + avatarClass(idx);
      nm.textContent = user.name;
    }
  }
}

window.addEventListener('resize', syncTopbarUser);

// ‚îÄ‚îÄ MOBILE USER MODAL ‚îÄ‚îÄ
function openMobileUserModal() {
  renderMobileUserList();
  document.getElementById('mobileUserModal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeMobileUserModal() {
  document.getElementById('mobileUserModal').classList.remove('open');
  document.body.style.overflow = '';
}

function renderMobileUserList() {
  const users = getUsers();
  const el = document.getElementById('mobileUserList');
  if (!el) return;
  if (users.length === 0) {
    el.innerHTML = '<div style="padding:10px 20px;font-size:14px;color:var(--text3);">Â∞öÁÑ°Áî®Êà∂ÔºåË´ãÊñ∞Â¢û</div>';
    return;
  }
  el.innerHTML = users.map((u, i) => `
    <div class="modal-user-item ${u.id === currentUserId ? 'selected' : ''}" onclick="requestSwitchUserMobile('${u.id}')">
      <div class="modal-user-avatar ${avatarClass(i)}">${initials(u.name)}</div>
      <span style="flex:1">${u.name}</span>
      ${u.id === currentUserId ? '<span class="modal-check">‚úì</span>' : '<span style="color:var(--text3);font-size:16px;">‚Ä∫</span>'}
    </div>
  `).join('');
}

function switchUserMobile(uid) {
  switchUser(uid);
  closeMobileUserModal();
  syncTopbarUser();
}

function addUserMobile() {
  const input = document.getElementById('mobileNewUserInput');
  const name = input.value.trim();
  if (!name) { input.focus(); return; }
  const users = getUsers();
  if (users.find(u => u.name === name)) { showToast('Ê≠§ÂêçÁ®±Â∑≤Â≠òÂú®'); return; }
  const uid = 'user_' + Date.now();
  users.push({ id: uid, name });
  saveUsers(users);
  input.value = '';
  switchUserMobile(uid);
}


// ‚îÄ‚îÄ REALTIME LISTENER ‚îÄ‚îÄ
let unsubscribeListener = null;

function startRealtimeSync(uid) {
  if (unsubscribeListener) unsubscribeListener();
  if (!window._firestoreReady) return;

  unsubscribeListener = window._fsOnSnapshot(
    window._fsDoc(window._db, 'users', uid),
    async (snap) => {
      if (!snap.exists() || snap.metadata.hasPendingWrites) return;
      // Another device wrote ‚Äî pull fresh data
      const cloudData = snap.data();
      const photoSnap = await window._fsGetDoc(window._fsDoc(window._db, 'photos', uid));
      if (photoSnap.exists()) cloudData.photos = photoSnap.data().list || [];
      else cloudData.photos = data.photos || [];

      data.logs    = cloudData.logs    || data.logs;
      data.weights = cloudData.weights || data.weights;
      data.plans   = cloudData.plans   || data.plans;
      data.goals   = cloudData.goals   || data.goals;
      data.photos  = cloudData.photos;
      saveUserData(uid, data);

      // Refresh current visible page quietly
      const activePage = document.querySelector('.page.active');
      if (activePage) {
        const pageId = activePage.id.replace('page-', '');
        renderPage(pageId);
      }
    },
    (err) => console.warn('Realtime listener error:', err)
  );
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
populateExDatalist();
renderLogExerciseList();

</script>


<!-- DELETE CONFIRM MODAL -->
<div class="delete-modal" id="deleteConfirmModal">
  <div class="delete-modal-box">
    <div class="delete-modal-icon">üóëÔ∏è</div>
    <div class="delete-modal-title">Âà™Èô§Áî®Êà∂</div>
    <div class="delete-modal-desc">
      Ëº∏ÂÖ• <strong id="delete-modal-name"></strong> ÁöÑÂØÜÁ¢º‰ª•Á¢∫Ë™çÂà™Èô§„ÄÇ<br>
      Ê≠§Êìç‰Ωú‰∏çÂèØÂæ©ÂéüÔºåÊâÄÊúâË≥áÊñôÂ∞áÊ∞∏‰πÖÂà™Èô§„ÄÇ
    </div>
    <input type="hidden" id="delete-uid-hidden">
    <input type="password" class="lock-input" id="delete-pwd-input"
      placeholder="Ëº∏ÂÖ•ÂØÜÁ¢ºÁ¢∫Ë™ç"
      style="margin-bottom:6px;"
      onkeydown="if(event.key==='Enter') confirmDeleteUser(document.getElementById('delete-uid-hidden').value)">
    <div class="lock-error" id="delete-pwd-error" style="margin-bottom:10px;"></div>
    <div class="delete-modal-actions">
      <button class="btn btn-secondary" onclick="closeDeleteConfirmModal()">ÂèñÊ∂à</button>
      <button class="btn" style="background:var(--red);color:#fff;"
        onclick="confirmDeleteUser(document.getElementById('delete-uid-hidden').value)">Á¢∫Ë™çÂà™Èô§</button>
    </div>
  </div>
</div>

<!-- LOCK SCREEN -->
<div class="lock-screen" id="lockScreen"><!-- always visible until unlocked -->
  <div class="lock-box" id="lockBox">
    <!-- user select view -->
    <div id="lockUserSelect">
      <div style="font-size:28px;margin-bottom:10px;">üèãÔ∏è</div>
      <div class="lock-name">Training Log</div>
      <div class="lock-hint">ÈÅ∏Êìá‰Ω†ÁöÑÂ∏≥Ëôü</div>
      <div class="lock-users" id="lockUserList"></div>
      <div class="lock-divider"></div>
      <button class="lock-user-btn" style="justify-content:center;color:var(--accent);border-color:var(--accent-light);background:var(--accent-light);" onclick="showNewUserForm()">Ôºã Êñ∞Â¢ûÁî®Êà∂</button>
    </div>
    <!-- password entry view -->
    <div id="lockPasswordView" style="display:none;">
      <div class="lock-avatar" id="lockAvatar">?</div>
      <div class="lock-name" id="lockDisplayName">Áî®Êà∂</div>
      <div class="lock-hint" id="lockPwdHint">Ë´ãËº∏ÂÖ•ÂØÜÁ¢º</div>
      <input type="password" class="lock-input" id="lockPwdInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="20"
        onkeydown="if(event.key==='Enter') submitLockPassword()">
      <div class="lock-error" id="lockError"></div>
      <button class="lock-btn" onclick="submitLockPassword()">Ëß£Èéñ</button>
      <button class="lock-back" onclick="showLockUserSelect()">‚Üê ËøîÂõûÈÅ∏ÊìáÂ∏≥Ëôü</button>
    </div>
    <!-- new user form -->
    <div id="lockNewUserView" style="display:none;">
      <div style="font-size:28px;margin-bottom:10px;">üë§</div>
      <div class="lock-name">Âª∫Á´ãÊñ∞Â∏≥Ëôü</div>
      <div class="lock-hint" style="margin-bottom:20px;">Ë®≠ÂÆöÂêçÁ®±ËàáÂØÜÁ¢º</div>
      <input type="text" class="lock-input" id="lockNewName" placeholder="‰Ω†ÁöÑÂêçÂ≠ó" maxlength="20"
        style="letter-spacing:0;margin-bottom:10px;" onkeydown="if(event.key==='Enter')document.getElementById('lockNewPwd').focus()">
      <input type="password" class="lock-input" id="lockNewPwd" placeholder="Ë®≠ÂÆöÂØÜÁ¢ºÔºàÂèØÁïôÁ©∫Ôºâ" maxlength="20"
        onkeydown="if(event.key==='Enter') submitNewUser()">
      <div class="lock-error" id="lockNewError"></div>
      <button class="lock-btn" onclick="submitNewUser()">Âª∫Á´ãÂ∏≥Ëôü</button>
      <button class="lock-back" onclick="showLockUserSelect()">‚Üê ËøîÂõû</button>
    </div>
  </div>
</div>

<datalist id="exNameDatalist"></datalist>
</body>
</html>
