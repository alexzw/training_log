<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Training Log</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --text: #111827;
      --border: #e5e7eb;
      --accent: #2563eb;
      --accent2: #1d4ed8;
      --danger: #dc2626;
      --ok: #059669;
      --radius: 14px;
      --shadow: 0 10px 28px rgba(17,24,39,.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 700px at 10% -10%, #dbeafe 0%, transparent 55%),
                  radial-gradient(1200px 700px at 90% -20%, #dcfce7 0%, transparent 50%),
                  var(--bg);
    }
    .app { max-width: 1120px; margin: 0 auto; padding: 18px; }
    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      background: rgba(255,255,255,.9); border: 1px solid var(--border); box-shadow: var(--shadow);
      border-radius: var(--radius); padding: 12px 14px; position: sticky; top: 12px; z-index: 30;
      backdrop-filter: blur(8px);
    }
    .brand { font-weight: 800; letter-spacing: .2px; }
    .who { font-size: 13px; color: var(--muted); }
    .tabs { display: flex; gap: 8px; flex-wrap: wrap; margin: 14px 0; }
    .tab {
      border: 1px solid var(--border); background: #fff; color: var(--text);
      border-radius: 999px; padding: 8px 14px; cursor: pointer; font-weight: 600;
    }
    .tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .grid { display: grid; gap: 14px; }
    .grid.cols-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
      box-shadow: var(--shadow); padding: 16px;
    }
    .title { font-size: 14px; color: var(--muted); margin-bottom: 10px; font-weight: 700; }
    .value { font-size: 32px; font-weight: 800; letter-spacing: -1px; }
    .page { display: none; }
    .page.active { display: block; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { display:block; font-size: 13px; color: var(--muted); margin-bottom: 6px; font-weight: 700; }
    input, select, textarea {
      width: 100%; border: 1px solid var(--border); border-radius: 10px;
      padding: 10px 12px; font: inherit; background: #fff;
    }
    textarea { min-height: 90px; resize: vertical; }
    .btns { display:flex; gap:10px; flex-wrap: wrap; }
    .btn {
      border: none; border-radius: 10px; padding: 10px 14px; cursor: pointer;
      font-weight: 700;
    }
    .btn.primary { background: var(--accent); color: #fff; }
    .btn.primary:hover { background: var(--accent2); }
    .btn.ghost { border: 1px solid var(--border); background: #fff; }
    .btn.danger { background: #fee2e2; color: var(--danger); }
    .list { display: grid; gap: 10px; }
    .item {
      border: 1px solid var(--border); border-radius: 12px; background:#fff; padding: 12px;
      display:flex; justify-content: space-between; gap: 10px; align-items: flex-start;
    }
    .meta { color: var(--muted); font-size: 13px; }
    .auth {
      position: fixed; inset: 0; background: rgba(15,23,42,.35); backdrop-filter: blur(4px);
      display: grid; place-items: center; z-index: 100;
    }
    .auth-box {
      width: min(560px, calc(100vw - 24px)); background: #fff; border:1px solid var(--border);
      border-radius: 18px; box-shadow: var(--shadow); padding: 18px;
    }
    .diag {
      margin-top: 10px; border: 1px dashed #93c5fd; color: #1e3a8a;
      background: #eff6ff; border-radius: 10px; padding: 8px 10px; font-size: 13px;
      min-height: 36px;
    }
    .error { color: var(--danger); font-size: 13px; min-height: 20px; }
    .ok { color: var(--ok); }
    .hide { display: none !important; }
    @media (max-width: 760px) {
      .grid.cols-3 { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="auth" id="authGate">
    <div class="auth-box">
      <h2 style="margin:0 0 6px;">Training Log</h2>
      <div style="color:#6b7280;margin-bottom:12px;">穩定版登入流程：先可進，再同步。</div>

      <div id="userPicker"></div>

      <div style="display:grid;gap:10px;margin-top:12px;">
        <div class="form-row">
          <div>
            <label for="newUserName">新用戶名稱</label>
            <input id="newUserName" placeholder="例如：Amelie" maxlength="24" />
          </div>
          <div style="display:flex;align-items:end;">
            <button class="btn primary" id="createUserBtn" style="width:100%;">建立本機帳號</button>
          </div>
        </div>
        <div class="btns">
          <button class="btn ghost" id="guestBtn">以訪客模式進入</button>
          <button class="btn ghost" id="refreshCloudBtn">重新抓取雲端用戶</button>
        </div>
      </div>
      <div class="error" id="authError"></div>
      <div class="diag" id="diag">初始化中...</div>
    </div>
  </div>

  <div class="app" id="appRoot">
    <div class="topbar">
      <div class="brand">Training Log</div>
      <div class="who" id="whoami">未登入</div>
    </div>

    <div class="tabs" id="tabs">
      <button class="tab active" data-page="dashboard">總覽</button>
      <button class="tab" data-page="log">新增記錄</button>
      <button class="tab" data-page="history">歷史</button>
      <button class="tab" data-page="weight">體重</button>
      <button class="tab" data-page="settings">設定</button>
    </div>

    <section class="page active" id="page-dashboard">
      <div class="grid cols-3">
        <div class="card"><div class="title">總訓練次數</div><div class="value" id="statLogs">0</div></div>
        <div class="card"><div class="title">最新體重</div><div class="value" id="statWeight">-</div></div>
        <div class="card"><div class="title">本週訓練</div><div class="value" id="statWeek">0</div></div>
      </div>
    </section>

    <section class="page" id="page-log">
      <div class="card">
        <div class="title">新增健身記錄</div>
        <div class="form-row">
          <div>
            <label for="logDate">日期</label>
            <input type="date" id="logDate" />
          </div>
          <div>
            <label for="logType">類型</label>
            <select id="logType">
              <option value="">請選擇</option>
              <option value="胸">胸</option>
              <option value="背">背</option>
              <option value="腿">腿</option>
              <option value="肩">肩</option>
              <option value="手臂">手臂</option>
              <option value="核心">核心</option>
              <option value="有氧">有氧</option>
              <option value="休息">休息</option>
            </select>
          </div>
        </div>
        <div class="form-row" style="margin-top:10px;">
          <div>
            <label for="logDuration">時長（分鐘）</label>
            <input type="number" id="logDuration" min="1" max="600" placeholder="例如 60" />
          </div>
          <div>
            <label for="logWeight">體重（kg，可空）</label>
            <input type="number" step="0.1" id="logWeight" min="20" max="300" placeholder="例如 68.5" />
          </div>
        </div>
        <div style="margin-top:10px;">
          <label for="logNotes">備註</label>
          <textarea id="logNotes" placeholder="今天做了哪些動作、感受如何..."></textarea>
        </div>
        <div class="btns" style="margin-top:12px;">
          <button class="btn primary" id="saveLogBtn">儲存記錄</button>
          <button class="btn ghost" id="clearLogBtn">清空</button>
        </div>
        <div class="error" id="logError"></div>
      </div>
    </section>

    <section class="page" id="page-history">
      <div class="card">
        <div class="title">歷史記錄</div>
        <div class="list" id="historyList"></div>
      </div>
    </section>

    <section class="page" id="page-weight">
      <div class="card">
        <div class="title">體重追蹤</div>
        <div class="form-row">
          <div>
            <label for="weightDate">日期</label>
            <input type="date" id="weightDate" />
          </div>
          <div>
            <label for="weightValue">體重（kg）</label>
            <input type="number" step="0.1" id="weightValue" min="20" max="300" />
          </div>
        </div>
        <div class="btns" style="margin-top:10px;">
          <button class="btn primary" id="addWeightBtn">新增/覆蓋</button>
        </div>
        <div class="error" id="weightError"></div>
        <hr style="border:none;border-top:1px solid var(--border);margin:14px 0;" />
        <div class="list" id="weightList"></div>
      </div>
    </section>

    <section class="page" id="page-settings">
      <div class="card">
        <div class="title">設定</div>
        <div class="btns">
          <button class="btn ghost" id="logoutBtn">回到登入頁</button>
          <button class="btn danger" id="clearLocalBtn">清空此帳號本機資料</button>
        </div>
        <div class="error" id="settingsMsg"></div>
      </div>
    </section>
  </div>

  <script>
    // ===== Storage =====
    const USERS_KEY = 'tl_users_v2';
    const CUR_KEY = 'tl_current_user_v2';
    const DATA_PREFIX = 'tl_data_v2_';
    const PROJECT_ID = 'training-log-40f70';

    const state = {
      users: [],
      currentUserId: null,
      data: { logs: [], weights: [] },
      guestMode: false
    };

    function safeParse(text, fallback) {
      try { return JSON.parse(text); } catch { return fallback; }
    }

    function loadUsers() {
      const arr = safeParse(localStorage.getItem(USERS_KEY) || '[]', []);
      return Array.isArray(arr) ? arr : [];
    }

    function saveUsers(users) {
      try { localStorage.setItem(USERS_KEY, JSON.stringify(users)); } catch (e) { diag('本機儲存用戶失敗: ' + e.message, true); }
    }

    function loadUserData(uid) {
      return safeParse(localStorage.getItem(DATA_PREFIX + uid) || 'null', null) || { logs: [], weights: [] };
    }

    function saveUserData(uid, data) {
      try { localStorage.setItem(DATA_PREFIX + uid, JSON.stringify(data)); } catch (e) { diag('本機儲存資料失敗: ' + e.message, true); }
    }

    function diag(msg, isErr) {
      const el = document.getElementById('diag');
      if (el) {
        el.textContent = msg;
        el.style.color = isErr ? '#b91c1c' : '#1e3a8a';
      }
      if (isErr) console.error(msg); else console.log(msg);
    }

    function setWho() {
      const who = document.getElementById('whoami');
      const user = state.users.find(u => u.id === state.currentUserId);
      if (state.guestMode) who.textContent = '目前：訪客模式';
      else if (user) who.textContent = '目前：' + user.name;
      else who.textContent = '未登入';
    }

    function renderUserPicker() {
      const box = document.getElementById('userPicker');
      if (!box) return;
      if (!state.users.length) {
        box.innerHTML = '<div style="color:#6b7280;font-size:13px;">尚無本機用戶，請建立帳號或使用訪客模式。</div>';
        return;
      }
      box.innerHTML = '<div style="display:grid;gap:8px;">' + state.users.map(u =>
        `<button class="btn ghost" data-uid="${u.id}" style="text-align:left;">使用 ${escapeHtml(u.name)} 進入</button>`
      ).join('') + '</div>';
      box.querySelectorAll('button[data-uid]').forEach(btn => {
        btn.addEventListener('click', () => enterUser(btn.dataset.uid));
      });
    }

    function escapeHtml(s) {
      return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    function enterUser(uid) {
      state.guestMode = false;
      state.currentUserId = uid;
      localStorage.setItem(CUR_KEY, uid);
      state.data = loadUserData(uid);
      document.getElementById('authGate').classList.add('hide');
      setWho();
      renderAll();
    }

    function enterGuestMode() {
      state.guestMode = true;
      state.currentUserId = 'guest';
      state.data = loadUserData('guest');
      document.getElementById('authGate').classList.add('hide');
      setWho();
      renderAll();
    }
    window.enterGuestMode = enterGuestMode;

    function renderDashboard() {
      const logs = state.data.logs || [];
      const weights = [...(state.data.weights || [])].sort((a,b)=>b.date.localeCompare(a.date));
      document.getElementById('statLogs').textContent = logs.length;
      document.getElementById('statWeight').textContent = weights[0] ? (weights[0].value + ' kg') : '-';

      const now = new Date();
      const day = now.getDay();
      const monday = new Date(now);
      monday.setDate(now.getDate() - ((day + 6) % 7));
      monday.setHours(0,0,0,0);
      const weekCount = logs.filter(x => new Date(x.date + 'T00:00:00') >= monday).length;
      document.getElementById('statWeek').textContent = weekCount;
    }

    function renderHistory() {
      const wrap = document.getElementById('historyList');
      const logs = [...(state.data.logs || [])].sort((a,b)=>(b.date+a.id).localeCompare(a.date+b.id));
      if (!logs.length) {
        wrap.innerHTML = '<div class="meta">尚無記錄</div>';
        return;
      }
      wrap.innerHTML = logs.map(l => {
        return `<div class="item">
          <div>
            <div><strong>${escapeHtml(l.date)}</strong> · ${escapeHtml(l.type || '-')}</div>
            <div class="meta">時長 ${l.duration || '-'} 分鐘 · 體重 ${l.weight || '-'} kg</div>
            ${l.notes ? `<div style="margin-top:6px;white-space:pre-wrap;">${escapeHtml(l.notes)}</div>` : ''}
          </div>
          <button class="btn danger" data-del="${l.id}">刪除</button>
        </div>`;
      }).join('');
      wrap.querySelectorAll('button[data-del]').forEach(btn => {
        btn.addEventListener('click', () => {
          state.data.logs = (state.data.logs || []).filter(x => String(x.id) !== String(btn.dataset.del));
          persist();
          renderAll();
        });
      });
    }

    function renderWeightList() {
      const wrap = document.getElementById('weightList');
      const rows = [...(state.data.weights || [])].sort((a,b)=>b.date.localeCompare(a.date));
      if (!rows.length) {
        wrap.innerHTML = '<div class="meta">尚無體重資料</div>';
        return;
      }
      wrap.innerHTML = rows.map(r => `<div class="item"><div><strong>${escapeHtml(r.date)}</strong></div><div>${r.value} kg</div></div>`).join('');
    }

    function persist() {
      const uid = state.guestMode ? 'guest' : state.currentUserId;
      if (!uid) return;
      saveUserData(uid, state.data);
    }

    function renderAll() {
      setWho();
      renderDashboard();
      renderHistory();
      renderWeightList();
    }

    function bindEvents() {
      document.getElementById('guestBtn').addEventListener('click', enterGuestMode);
      document.getElementById('createUserBtn').addEventListener('click', () => {
        const name = document.getElementById('newUserName').value.trim();
        const err = document.getElementById('authError');
        err.textContent = '';
        if (!name) { err.textContent = '請輸入用戶名稱'; return; }
        if (state.users.some(u => u.name === name)) { err.textContent = '此名稱已存在'; return; }
        const uid = 'user_' + Date.now();
        state.users.push({ id: uid, name });
        saveUsers(state.users);
        renderUserPicker();
        enterUser(uid);
      });

      document.getElementById('refreshCloudBtn').addEventListener('click', async () => {
        await syncUsersFromCloud();
      });

      document.getElementById('saveLogBtn').addEventListener('click', () => {
        const date = document.getElementById('logDate').value;
        const type = document.getElementById('logType').value;
        const duration = Number.parseInt(document.getElementById('logDuration').value, 10);
        const weightV = document.getElementById('logWeight').value;
        const notes = document.getElementById('logNotes').value.trim();
        const err = document.getElementById('logError');
        err.textContent = '';

        if (!date) { err.textContent = '請選擇日期'; return; }
        if (!type) { err.textContent = '請選擇類型'; return; }
        if (!Number.isFinite(duration) || duration <= 0) { err.textContent = '請輸入正確時長'; return; }

        const log = {
          id: Date.now(),
          date,
          type,
          duration,
          weight: weightV ? Number.parseFloat(weightV) : null,
          notes
        };
        state.data.logs = [log, ...(state.data.logs || [])];

        if (log.weight) {
          const idx = (state.data.weights || []).findIndex(w => w.date === date);
          if (idx >= 0) state.data.weights[idx].value = log.weight;
          else state.data.weights = [...(state.data.weights || []), { date, value: log.weight }];
        }

        persist();
        renderAll();
        err.innerHTML = '<span class="ok">已儲存</span>';
      });

      document.getElementById('clearLogBtn').addEventListener('click', () => {
        document.getElementById('logType').value = '';
        document.getElementById('logDuration').value = '';
        document.getElementById('logWeight').value = '';
        document.getElementById('logNotes').value = '';
        document.getElementById('logError').textContent = '';
      });

      document.getElementById('addWeightBtn').addEventListener('click', () => {
        const date = document.getElementById('weightDate').value;
        const value = Number.parseFloat(document.getElementById('weightValue').value);
        const err = document.getElementById('weightError');
        err.textContent = '';
        if (!date || !Number.isFinite(value) || value <= 0) { err.textContent = '請輸入正確日期與體重'; return; }
        const list = state.data.weights || [];
        const idx = list.findIndex(x => x.date === date);
        if (idx >= 0) list[idx].value = value;
        else list.push({ date, value });
        state.data.weights = list;
        persist();
        renderAll();
        err.innerHTML = '<span class="ok">已更新</span>';
      });

      document.getElementById('logoutBtn').addEventListener('click', () => {
        document.getElementById('authGate').classList.remove('hide');
        state.currentUserId = null;
        state.guestMode = false;
        setWho();
        renderUserPicker();
      });

      document.getElementById('clearLocalBtn').addEventListener('click', () => {
        const msg = document.getElementById('settingsMsg');
        if (!state.currentUserId) { msg.textContent = '未登入'; return; }
        const uid = state.guestMode ? 'guest' : state.currentUserId;
        localStorage.removeItem(DATA_PREFIX + uid);
        state.data = { logs: [], weights: [] };
        renderAll();
        msg.innerHTML = '<span class="ok">已清空本機資料</span>';
      });

      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          const p = tab.dataset.page;
          document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
          document.getElementById('page-' + p).classList.add('active');
        });
      });
    }

    async function loadUsersFromCloudREST() {
      const base = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents`;
      const r = await fetch(`${base}/app/users`, { cache: 'no-store' });
      if (!r.ok) return [];
      const j = await r.json();
      const values = j?.fields?.list?.arrayValue?.values || [];
      return values.map(v => {
        const f = v?.mapValue?.fields || {};
        const id = f.id?.stringValue || '';
        const name = f.name?.stringValue || id;
        return id ? { id, name } : null;
      }).filter(Boolean);
    }

    async function syncUsersFromCloud() {
      try {
        diag('正在抓取雲端用戶...');
        const cloudUsers = await loadUsersFromCloudREST();
        if (!cloudUsers.length) {
          diag('雲端無可用用戶，仍可使用訪客模式', true);
          return;
        }
        const byId = new Map(state.users.map(u => [u.id, u]));
        cloudUsers.forEach(u => { if (!byId.has(u.id)) byId.set(u.id, u); });
        state.users = [...byId.values()];
        saveUsers(state.users);
        renderUserPicker();
        diag(`雲端同步成功：${cloudUsers.length} 位`);
      } catch (e) {
        diag('雲端同步失敗：' + (e.message || e), true);
      }
    }

    async function boot() {
      bindEvents();
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('logDate').value = today;
      document.getElementById('weightDate').value = today;

      state.users = loadUsers();
      renderUserPicker();
      setWho();

      const remembered = localStorage.getItem(CUR_KEY);
      if (remembered && remembered !== 'guest') {
        const hit = state.users.find(u => u.id === remembered);
        if (hit) {
          enterUser(hit.id);
          diag('已使用上次帳號登入');
          return;
        }
      }

      await syncUsersFromCloud();

      // hard fallback: always allow entering app
      setTimeout(() => {
        const gateVisible = !document.getElementById('authGate').classList.contains('hide');
        if (gateVisible && !state.users.length) {
          diag('自動降級：切換訪客模式');
          enterGuestMode();
        }
      }, 3500);
    }

    window.addEventListener('error', e => diag('JS錯誤：' + (e.message || 'unknown'), true));
    window.addEventListener('unhandledrejection', e => diag('Promise錯誤：' + ((e.reason && e.reason.message) || String(e.reason)), true));
    boot();
  </script>
</body>
</html>